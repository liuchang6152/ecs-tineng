var delUrl=ECS.api.rttUrl+"/mtrlStorage";var searchUrl=ECS.api.rttUrl+"/mtrlStorage";var inUseUrl=ECS.api.commonUrl+"/getInUse";var riskorg_url=ECS.api.bcUrl+"/org/porgName";var riskType_url=ECS.api.bcUrl+"/riskArea/getRiskAreaEnumList?isAll=true";var riskType_url2=ECS.api.bcUrl+"/riskArea/getCategObj?isAll=true";var riskAreaName_url=ECS.api.bcUrl+"/riskArea/getAllList?isAll=true";var oprisktype_url=ECS.api.bcUrl+"/optlRiskZone/getOptlZoneCatgEnumList?isAll=true";var oprisk_url=ECS.api.bcUrl+"/optlRiskZone/getAllList?isAll=true";var RiskAnlsObj_url=ECS.api.bcUrl+"/riskAnlsObj/getRiskObjCatgEnumList?isAll=true";var teskType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=33";var RiskAnlsObjName_url=ECS.api.bcUrl+"/riskAnlsObj/getAllList?isAll=true";var DepositType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=29";var StoreType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=34";var Ranks_url=ECS.api.rttUrl+"/team/getTeamListByOrgId";var exportUrl=ECS.api.rttUrl+"/mtrlStorage/ExportToExcel";var grid=null;var flag=false;var enterpriseCode="";var drtDeptCode="";var riskAreaID="";var optlRiskZoneID="";var nsType;pageflag=true;redisKey="";window.pageLoadMode=PageLoadMode.None;$(function(){var a={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();$("#searchForm").find("input").val("");this.bindUI();$("#bulongType option:first").prop("selected","selected");a.logic.initInUse();a.logic.initTable();a.logic.get_list(riskorg_url,$("#enterpriseCode"));a.logic.select_option(riskType_url,$("#riskAreaCatg"));a.logic.select_option(riskType_url2,$("#riskAreaCatgName"),"ww");a.logic.select_option(oprisktype_url,$("#zoneCatg"));a.logic.select_option(RiskAnlsObj_url,$("#riskAnlsObjCatg"));a.logic.select_option(DepositType_url,$("#storeType"));a.logic.select_option(teskType_url,$("#teskType"));a.logic.select_option(StoreType_url,$("#repoType"));a.logic.bulongType()},table:{},bindUI:function(){$("#bulongType").change(function(){a.logic.bulongType()});$("#teskType").change(function(){var b=$("#teskType option:selected").val();console.log(b);if(b=="1006"){DepositType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=29";StoreType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=34"}else{if(b=="1007"){DepositType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=30";StoreType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=35"}}a.logic.select_option(DepositType_url,$("#storeType"));a.logic.select_option(StoreType_url,$("#repoType"))});$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnToggle").click(function(){if(flag){flag=!flag;$(this).html('<i class="icon-showMore"></i>');$(".search-unfixed").hide()}else{flag=!flag;$(this).html('<i class="icon-hideMore"></i>');$(".search-unfixed").show()}});$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()});$("#reset").click(function(){$("#searchForm")[0].reset();mini.get("enterpriseCode").setValue(ECS.sys.Context.SYS_ENTERPRISE_CODE);mini.get("drtDeptCode").setValue("-1");mini.get("riskAreaCode").disable();mini.get("riskAreaCode").setValue("-1");mini.get("optlRiskCode").disable();mini.get("optlRiskCode").setValue("-1");mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1");mini.get("riskAreaCatgName").setValue("全部");mini.get("ranks").setValue("全部");nsType="0";a.logic.get_list(riskorg_url,$("#enterpriseCode"));a.logic.bulongType()});mini.get("enterpriseCode").on("nodeclick",function(b){if(b.node.orgCode=="-1"){enterpriseCode=""}else{enterpriseCode=b.node.orgCode}a.logic.get_list(riskorg_url,$("#drtDeptCode"),b.node.orgId)});mini.get("drtDeptCode").on("nodeclick",function(b){if(b.node.orgCode=="-1"){drtDeptCode=""}else{drtDeptCode=b.node.orgCode}a.logic.load_risk_menu()});$("#riskAreaCatg").change(function(){a.logic.select_option(riskType_url2+"&riskAreaCatg="+$("#riskAreaCatg").val(),$("#riskAreaCatgName"),"xx")});mini.get("riskAreaCode").on("valuechanged",function(b){if(b.value==""||b.value=="-1"){mini.get("riskAreaCode").setValue("-1");riskAreaID=""}else{riskAreaID=b.selected.riskAreaID}a.logic.load_optrisk_menu()});$("#zoneCatg").change(function(){a.logic.load_optrisk_menu()});mini.get("optlRiskCode").on("valuechanged",function(b){if(b.value==""||b.value=="-1"){mini.get("optlRiskCode").setValue("-1");optlRiskZoneID=""}else{optlRiskZoneID=b.selected.optlRiskZoneID}a.logic.load_rapTypeNameList()});$("#riskAnlsObjCatg").change(function(){a.logic.load_rapTypeNameList()});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){a.data.param=ECS.form.getData("searchForm");a.data.param.bulongType=$("#bulongType option:selected").val();a.data.param.teskType=$("#teskType option:selected").val();console.log(a.data.param.bulongType);a.data.param.enterpriseCode=enterpriseCode;if(mini.get("drtDeptCode").getSelectedNode()&&mini.get("drtDeptCode").getSelectedNode().orgCode!="-1"){a.data.param.drtDeptCode=mini.get("drtDeptCode").getSelectedNode().orgCode}else{a.data.param.drtDeptCode=""}if(mini.get("riskAreaCode").getSelected()&&mini.get("riskAreaCode").getSelected().riskAreaCode!="-1"){a.data.param.riskAreaCode=mini.get("riskAreaCode").getSelected().riskAreaCode}if(mini.get("optlRiskCode").getSelected()&&mini.get("optlRiskCode").getSelected().code!="-1"){a.data.param.optlRiskCode=mini.get("optlRiskCode").getSelected().code}if(mini.get("riskAnlsObjCode").getSelected()&&mini.get("riskAnlsObjCode").getSelected().code!="-1"){a.data.param.riskAnlsObjCode=mini.get("riskAnlsObjCode").getSelected().code}var d=mini.get("riskAreaCatgName").getCheckedNodes(true);if(d.length>0){for(var c=0;c<d.length;c++){(function(e){if(e.categID.indexOf("sm")!=-1){a.data.param.areaSmCatg=e.code}if(e.categID.indexOf("md")!=-1){a.data.param.areaMdCatg=e.code}if(e.categID.indexOf("bg")!=-1){if(e.code!=-1){a.data.param.areaBgCatg=e.code}}})(d[c])}}delete a.data.param.riskAreaCatgName;if(a.data.param.inUse==-1){a.data.param.inUse=""}if(a.data.param.storeType==-1){a.data.param.storeType=""}if(a.data.param.repoType==-1){a.data.param.repoType=""}a.data.param.repoCategory=$("#teskType option:selected").val();a.data.param.subordinateType=$("#bulongType option:selected").val();if(mini.get("ranks").getValue()=="全部"){a.data.param.teamId=""}else{a.data.param.teamId=mini.get("ranks").getValue()}var b=a.logic.setUrlK(a.data.param);window.open(exportUrl+"?"+b)})},data:{param:{}},logic:{setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},bulongType:function(){nsType=$("#bulongType option:selected").val();if(nsType=="0"){mini.get("ranks").disable();$("#riskAnlsObjCatg").attr("disabled",false);$("#optlRiskZoneCatg").attr("disabled",false);mini.get("riskAreaCatgName").enable();$("#riskAreaCatg").attr("disabled",false);$("#zoneCatg").attr("disabled",false)}else{mini.get("drtDeptCode").setValue("");mini.get("ranks").enable();mini.get("riskAreaCatgName").disable();$("#riskAreaCatgName").val("");$("#optlRiskZoneCatg").attr("disabled",true);$("#riskAreaCatg").attr("disabled",true);$("#zoneCatg").attr("disabled",true);$("#optlRiskZoneCatg").html("");$("#riskAnlsObjCatg").attr("disabled",true)}},initInUse:function(){ECS.ui.getCombobox("inUse",inUseUrl,{selectValue:"-1",data:{isAll:true}},null)},initTable:function(){grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList",success:function(b){console.log(b)}})},show_edit:function(b){return ECS.util.editRender(b.row.storageID)},DateTime:function(c){var b="";if(c.row.crtDate){b=c.row.crtDate}return ECS.util.DateTimeRender(b)},mntTime:function(c){var b="";if(c.row.mntDate){b=c.row.mntDate}return ECS.util.DateTimeRender(b)},show_upload:function(b){return"<a href=\"javascript:ECS.util.renderUploader_Page('"+b.row.enterpriseCode+"','"+b.row.storageID+"','"+b.row.storageName+"','3','应急物资存放点配置附件上传')\">上传附件</a>"},get_list:function(c,f,e,b){if(e){var d=c+"?isAll=true&orgPID="+e+"&orgLvl=3"}else{var d=c+"?orgLvl=2"}$.ajax({url:d,type:"GET",success:function(h){if(e){mini.get("drtDeptCode").loadList(h,"orgId","orgPID");mini.get("drtDeptCode").setValue("全部");a.logic.load_risk_menu();b&&b()}else{mini.get("enterpriseCode").loadList(h,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){console.log("是否进入");enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname);a.logic.get_list(riskorg_url,$("#drtDeptCode"),mini.get("enterpriseCode").data[0].orgId)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var g=0;g<h.length;g++){(function(i){if(i.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(i.orgSname);a.logic.get_list(riskorg_url,$("#drtDeptCode"),i.orgId)}})(h[g])}}a.logic.select_options(Ranks_url+"?orgId="+enterpriseCode,$("#ranks"),"xx");grid.load({enterpriseCode:enterpriseCode});b&&b()}}})},select_option:function(c,d,b){$.ajax({url:c,type:"GET",success:function(f){if(b&&(typeof b!="function")){mini.get("riskAreaCatgName").loadList(f,"categID","gcategID");a.logic.load_risk_menu()}else{$(d).html("");for(var e=0;e<f.length;e++){(function(h){if(h.key||h.key==0){var g=$('<option title="'+h.value+'" value="'+h.key+'">'+h.value.substring(0,20)+"</option>")}$(d).append(g)})(f[e])}b&&b()}}})},select_options:function(c,d,b){$.ajax({url:c,type:"GET",success:function(f){console.log(f);if(b&&(typeof b!="function")){mini.get("ranks").loadList(f,"teamID","teamName");a.logic.load_risk_menus()}else{$(d).html("");for(var e=0;e<f.length;e++){(function(h){if(h.crtUserName||h.crtUserName==0){var g=$('<option title="'+h.crtUserName+'" value="'+h.crtUserName+'">'+h.crtUserName.substring(0,20)+"</option>")}$(d).append(g)})(f[e])}b&&b()}mini.get("ranks").setValue("全部")}})},selectCombox:function(b,c){$.ajax({url:b,type:"get",success:function(d){mini.get(c).load(d);mini.get(c).setValue("-1")}})},load_risk_menu:function(){var f=mini.get("ranks").getCheckedNodes(true);var h="";var e="";var b="";if(f.length>0){for(var d=0;d<f.length;d++){(function(i){if(i.categID==""){h="";e="";b=""}else{if(i.categID.indexOf("sm")!=-1){h=i.code}else{if(i.categID.indexOf("md")!=-1){e=i.code}else{if(i.categID.indexOf("bg")!=-1){b=i.code}}}}})(f[d])}}var c=$("#riskAreaCatg").val();if(drtDeptCode){var g=riskAreaName_url+"&enterpriseCode="+enterpriseCode+"&drtDeptCode="+drtDeptCode+"&areaSmCatg="+h+"&areaMdCatg="+e+"&areaBgCatg="+b+"&riskAreaCatg="+c;a.logic.selectCombox(g,"#riskAreaCode");mini.get("riskAreaCode").enable()}else{mini.get("riskAreaCode").disable();mini.get("riskAreaCode").setValue("-1")}mini.get("optlRiskCode").disable();mini.get("optlRiskCode").setValue("-1");mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")},load_risk_menus:function(){var f=mini.get("ranks").getCheckedNodes(true);var h="";var e="";var b="";if(f.length>0){for(var d=0;d<f.length;d++){(function(i){if(i.categID==""){h="";e="";b=""}else{if(i.categID.indexOf("sm")!=-1){h=i.code}else{if(i.categID.indexOf("md")!=-1){e=i.code}else{if(i.categID.indexOf("bg")!=-1){b=i.code}}}}})(f[d])}}var c=$("#riskAreaCatg").val();if(drtDeptCode){var g=riskAreaName_url+"&enterpriseCode="+enterpriseCode+"&drtDeptCode="+drtDeptCode+"&areaSmCatg="+h+"&areaMdCatg="+e+"&areaBgCatg="+b+"&riskAreaCatg="+c;a.logic.selectCombox(g,"#riskAreaCode");mini.get("riskAreaCode").enable()}else{mini.get("riskAreaCode").disable();mini.get("riskAreaCode").setValue("-1")}},load_optrisk_menu:function(){var c=$("#zoneCatg").val();if(riskAreaID){var b=oprisk_url+"&riskAreaID="+riskAreaID+"&zoneCatg="+c;a.logic.selectCombox(b,"#optlRiskCode");mini.get("optlRiskCode").enable()}else{mini.get("optlRiskCode").disable();mini.get("optlRiskCode").setValue("-1")}mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")},load_rapTypeNameList:function(){var b=$("#riskAnlsObjCatg").val(),c=RiskAnlsObjName_url+"&optlRiskZoneID="+optlRiskZoneID+"&riskAnlsObjCatg="+b;if(optlRiskZoneID){a.logic.selectCombox(c,"#riskAnlsObjCode");mini.get("riskAnlsObjCode").enable()}else{mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")}},delAll:function(){var b=new Array();var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.storageID)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:false,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(d){ECS.hideLoading();if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){grid.reload()})}else{d=JSON.parse(d);layer.msg(d.collection.error.message)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},add:function(){var b=PageModelEnum.NewAdd;var c="应急物资存放点新增";a.logic.detail(c,"",b)},edit:function(b){var c=PageModelEnum.Edit;console.log(c);var d="应急物资存放点编辑";a.logic.detail(d,b,c)},detail:function(d,b,c){layer.open({type:2,closeBtn:0,area:["60%","70%"],skin:"new-class",shadeClose:false,title:false,content:"MtrlStorageAddOrEdit.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,storageID:b,title:d};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(1);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(1);window.pageLoadMode=PageLoadMode.None}}}})},search:function(c){a.data.param=ECS.form.getData("searchForm");if(c){a.data.param.sortType=1}a.data.param.bulongType=$("#bulongType option:selected").val();a.data.param.teskType=$("#teskType option:selected").val();console.log(a.data.param.bulongType);a.data.param.enterpriseCode=enterpriseCode;if(mini.get("drtDeptCode").getSelectedNode()&&mini.get("drtDeptCode").getSelectedNode().orgCode!="-1"){a.data.param.drtDeptCode=mini.get("drtDeptCode").getSelectedNode().orgCode}else{a.data.param.drtDeptCode=""}if(mini.get("riskAreaCode").getSelected()&&mini.get("riskAreaCode").getSelected().riskAreaCode!="-1"){a.data.param.riskAreaCode=mini.get("riskAreaCode").getSelected().riskAreaCode}if(mini.get("optlRiskCode").getSelected()&&mini.get("optlRiskCode").getSelected().code!="-1"){a.data.param.optlRiskCode=mini.get("optlRiskCode").getSelected().code}if(mini.get("riskAnlsObjCode").getSelected()&&mini.get("riskAnlsObjCode").getSelected().code!="-1"){a.data.param.riskAnlsObjCode=mini.get("riskAnlsObjCode").getSelected().code}var d=mini.get("riskAreaCatgName").getCheckedNodes(true);if(d.length>0){for(var b=0;b<d.length;b++){(function(e){if(e.categID.indexOf("sm")!=-1){a.data.param.areaSmCatg=e.code}if(e.categID.indexOf("md")!=-1){a.data.param.areaMdCatg=e.code}if(e.categID.indexOf("bg")!=-1){if(e.code!=-1){a.data.param.areaBgCatg=e.code}}})(d[b])}}delete a.data.param.riskAreaCatgName;if(a.data.param.inUse==-1){a.data.param.inUse=""}if(a.data.param.storeType==-1){a.data.param.storeType=""}if(a.data.param.repoType==-1){a.data.param.repoType=""}a.data.param.repoCategory=$("#teskType option:selected").val();a.data.param.subordinateType=$("#bulongType option:selected").val();if(mini.get("ranks").getValue()=="全部"){a.data.param.teamId=""}else{a.data.param.teamId=mini.get("ranks").getValue()}console.log(a.data.param.repoCategory);console.log(a.data.param.subordinateType);console.log(a.data.param.teamId);console.log(a.data.param);grid.load(a.data.param)},imp:function(){var c=ECS.api.rttUrl+"/mtrlStorage/importExcel";var b=ECS.api.rttUrl+"/mtrlStorage/ExportExcel";var e=ECS.api.rttUrl+"/mtrlStorage/importAddAll";var d="../../bc/UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d)}}};a.init();window.page=a});