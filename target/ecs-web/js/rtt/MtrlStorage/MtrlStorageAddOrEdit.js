var addUrl=ECS.api.rttUrl+"/mtrlStorage";var getSingleUrl=ECS.api.rttUrl+"/mtrlStorage";var riskorg_url=ECS.api.bcUrl+"/org/porgName";var riskType_url2=ECS.api.bcUrl+"/riskArea/getCategObj?showPleaseSelect=true";var riskAreaName_url=ECS.api.bcUrl+"/riskArea/getAllList?showPleaseSelect=true";var oprisktype_url=ECS.api.bcUrl+"/optlRiskZone/getOptlZoneCatgEnumList?showPleaseSelect=true";var oprisk_url=ECS.api.bcUrl+"/optlRiskZone/getAllList?showPleaseSelect=true";var RiskAnlsObj_url=ECS.api.bcUrl+"/riskAnlsObj/getRiskObjCatgEnumList?showPleaseSelect=true";var RiskAnlsObjName_url=ECS.api.bcUrl+"/riskAnlsObj/getAllList?showPleaseSelect=true";var Enterprise_url=ECS.api.rttUrl+"/expert/getExpertTypeEnumList";var DepositType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=29";var StoreType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=34";var teskType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=33";var Ranks_url=ECS.api.rttUrl+"/team/getTeamListByOrgId";var enterpriseCode="";var drtDeptCode="";var drtDeptPID="";var riskAreaID="";var optlRiskZoneID="";var riskAnlsObjCode="";var teamId;var repoType,storeTyp;var isNum=0;var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var cate_dt={};$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();b.logic.get_list(riskorg_url,$("#enterpriseCode"));b.logic.select_option(teskType_url,$("#teskType"));b.logic.bulongType();mini.get("ranks").setValue("请选择");b.logic.select_option(DepositType_url,$("#storeType"));b.logic.select_option(StoreType_url,$("#repoType"));mini.get("storageClass").disable();mini.get("enterpriseCode").enable()},bindUI:function(){$("#teskType").change(function(){var c=$("#teskType option:selected").val();if(c=="1006"){DepositType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=29";StoreType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=34"}else{if(c=="1007"){DepositType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=30";StoreType_url=ECS.api.rttUrl+"/mtrlStorage/getListByModelID?businessModelId=35"}}b.logic.select_option(DepositType_url,$("#storeType"));b.logic.select_option(StoreType_url,$("#repoType"))});$("#bulongType").change(function(){isNum++;if(isNum>1){if(pageMode==PageModelEnum.Edit){layer.confirm("确定切换吗？",{btn:["确定","取消"]},function(){layer.closeAll()},function(c){console.log(c);layer.close(c);parent.layer.close(c)})}}b.logic.bulongType()});$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});mini.get("enterpriseCode").on("nodeclick",function(c){enterpriseCode=c.node.orgCode;b.logic.get_list(riskorg_url,$("#drtDeptCode"),c.node.orgId)});mini.get("drtDeptCode").on("nodeclick",function(c){drtDeptCode=c.node.orgCode;$("input[name=drtDeptCode]").next(".has-error").remove();mini.get("storageClass").setValue(c.node.orgSname);b.logic.load_risk_menu("")});mini.get("riskAreaCatgName").on("valuechanged",function(){b.logic.load_risk_menu("")});mini.get("riskAreaCode").on("valuechanged",function(c){if(c.value==""||c.value=="-1"){mini.get("riskAreaCode").setValue("-1");riskAreaID=""}else{riskAreaID=c.selected.riskAreaID}mini.get("storageClass").setValue(c.selected.riskAreaName);b.logic.load_optrisk_menu("");b.logic.load_riskobj_menu("")});mini.get("riskAnlsObjCode").on("valuechanged",function(c){if(c.selected.name!="undefined"){mini.get("storageClass").setValue(c.selected.name)}});$("#optlRiskZoneCatg").change(function(){b.logic.load_optrisk_menu("")});mini.get("optlRiskZoneCode").on("valuechanged",function(c){if(c.value==""||c.value=="-1"){mini.get("optlRiskZoneCode").setValue("-1");optlRiskZoneID="";optlRiskZoneCode=""}else{optlRiskZoneID=c.selected.optlRiskZoneID;optlRiskZoneCode=c.selected.code}mini.get("storageClass").setValue(c.selected.name);b.logic.load_riskobj_menu("")});$("#riskAnlsObjCatg").change(function(){b.logic.load_riskobj_menu("")});mini.get("riskAreaCode").disable();mini.get("optlRiskZoneCode").disable();mini.get("riskAnlsObjCode").disable()},logic:{bulongType:function(){mini.get("ranks").setValue("请选择");nsType=$("#bulongType option:selected").val();console.log(nsType);if(nsType!="-1"){if(nsType=="0"){mini.get("ranks").disable();mini.get("enterpriseCode").enable();mini.get("drtDeptCode").enable();mini.get("riskAreaCatgName").enable();$("#optlRiskZoneCatg").attr("disabled",false);$("#riskAnlsObjCatg").attr("disabled",false)}else{mini.get("drtDeptCode").setValue("");mini.get("ranks").enable();mini.get("enterpriseCode").disable();mini.get("enterpriseCode").setValue("");mini.get("drtDeptCode").disable();mini.get("riskAreaCatgName").disable();$("#riskAreaCatgName").val("");mini.get("riskAreaCode").setValue("");mini.get("riskAreaCode").disable();mini.get("optlRiskZoneCode").setValue("");mini.get("optlRiskZoneCode").disable();mini.get("riskAnlsObjCode").setValue("");mini.get("riskAnlsObjCode").disable();$("#optlRiskZoneCatg").attr("disabled",true);$("#optlRiskZoneCatg").html("");$("#riskAnlsObjCatg").attr("disabled",true);$("#riskAnlsObjCatg").html("");mini.get("storageClass").setValue("")}}$("#ranks").click(function(){b.logic.select_options(Ranks_url,$("#ranks"),"ww")})},save:function(){if($("#bulongType").val()=="-1"){layer.msg("请选择所属企业");return}if($("#teskType").val()=="-1"){layer.msg("请选择业务类型");return}b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}if($("#storeType").val()=="-1"){layer.msg("请选择存放点类型");return}if($("#storageName").val()==""){layer.msg("请输入存放点名称");return}else{if($("#storageName").val().length>50){layer.msg("存放点名称输入过长，请筛减！");return}console.log()}if($("#repoType").val()=="-1"){layer.msg("请选择储存库分类");return}var f=ECS.form.getData("AddOrEditModal");if(mini.get("enterpriseCode").getSelectedNode()){f.enterpriseCode=mini.get("enterpriseCode").getSelectedNode().orgCode}else{f.enterpriseCode=enterpriseCode}if(mini.get("drtDeptCode").getSelectedNode()){f.drtDeptPID=mini.get("drtDeptCode").getSelectedNode().orgPID;f.drtDeptCode=mini.get("drtDeptCode").getSelectedNode().orgCode}else{f.drtDeptPID=drtDeptPID;f.drtDeptCode=drtDeptCode}var e=mini.get("riskAreaCatgName").getCheckedNodes(true);if(e.length>0){for(var d=0;d<e.length;d++){(function(h){if(h.categID.indexOf("sm")!=-1){f.areaSmCatg=h.code}if(h.categID.indexOf("md")!=-1){f.areaMdCatg=h.code}if(h.categID.indexOf("bg")!=-1){f.areaBgCatg=h.code}})(e[d])}}else{if(pageMode==PageModelEnum.Edit){f.areaBgCatg=cate_dt.areaBgCatg;f.areaMdCatg=cate_dt.areaMdCatg;f.areaSmCatg=cate_dt.areaSmCatg}}delete f.riskAreaCatgName;for(var c in f){if(f[c]=="-1"){f[c]=""}}f.subordinateType=$("#bulongType").val()||"";f.repoCategory=$("#teskType").val()||"";if($("#bulongType").val()!="0"){if(mini.get("ranks").getValue()=="请选择"){layer.msg("请选择应急队伍");return}}else{if(mini.get("drtDeptCode").getValue()==""){layer.msg("请选择二级单位");return}}if(mini.get("ranks").getValue()=="请选择"){f.teamId=""}else{f.teamId=mini.get("ranks").getValue()||""}var g="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){g="PUT";window.pageLoadMode=PageLoadMode.Refresh}}console.log(f.subordinateType);$.ajax({url:addUrl,async:false,type:g,data:$.param(f),dataType:"text",success:function(h){console.log(h);if(h.indexOf("collection")<0){layer.msg("保存成功！",{time:2000},function(){b.logic.closeLayer(true)})}else{layer.msg(h.collection.error.message)}},error:function(h){var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;b.logic.select_option(Enterprise_url,$("#mtrlType"));if(pageMode==PageModelEnum.NewAdd){$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});b.logic.select_option(oprisktype_url,$("#optlRiskZoneCatg"));b.logic.select_option(RiskAnlsObj_url,$("#riskAnlsObjCatg"));b.logic.select_option(riskType_url2,$("#riskAreaCatgName"),"xx");$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);return}else{if(pageMode==PageModelEnum.Edit){mini.get("enterpriseCode").disable();mini.get("drtDeptCode").disable();mini.get("riskAreaCatgName").disable();$("#optlRiskZoneCatg").attr("disabled","disabled");$("#riskAnlsObjCatg").attr("disabled","disabled")}}$.ajax({url:getSingleUrl+"/"+c.storageID+"?now="+Math.random(),type:"get",async:true,dataType:"json",success:function(e){console.log("编辑返回的数据是：",e);ECS.form.setData("AddOrEditModal",e);mini.get("enterpriseCode").setValue(e.enterpriseName);enterpriseCode=e.enterpriseCode;mini.get("drtDeptCode").setValue(e.drtDeptName);drtDeptCode=e.drtDeptCode;if(e.drtDeptPID){drtDeptPID=e.drtDeptPID}if(e.subordinateType==1){$("#enterpriseCode-text input").val("");$("#orgName-text input").val("");$("#riskAreaCatgName-text input").val("")}b.logic.load_risk_menu(e.riskAreaCode,e.riskAreaName);b.logic.load_optrisk_menu(e.optlRiskZoneCode,e.optlRiskZoneName);b.logic.load_riskobj_menu(e.riskAnlsObjCode,e.riskAnlsObjName);b.logic.set_default_val($("#optlRiskZoneCatg"),e.optlRiskZoneCatg,e.optlRiskZoneCatgName);b.logic.set_default_val($("#riskAnlsObjCatg"),e.riskAnlsObjCatg,e.riskAnlsObjCatgName);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#bulongType").find("option[value="+e.subordinateType+"]").attr("selected",true);$("#teskType").find("option[value="+e.repoCategory+"]").attr("selected",true);repoType=e.repoType;storeType=e.storeType;var d="";if(e.bgCategName!=null){d+=e.bgCategName}if(e.mdCategName!=null){if(e.bgCategName!=null){d+=","}d+=e.mdCategName}if(e.smCategName!=null){if(e.mdCategName!=null){d+=","}d+=","+e.smCategName}if(e.subordinateType=="0"){mini.get("ranks").disable()}else{teamId=e.teamId;$("#ranks").val(teamId);mini.get("riskAreaCode").disable();b.logic.select_options(Ranks_url,$("#ranks"),"ww")}mini.get("storageClass").setValue(e.riskAnlsObjName);mini.get("riskAreaCatgName").setValue(d);cate_dt.areaBgCatg=e.areaBgCatg;cate_dt.areaMdCatg=e.areaMdCatg;cate_dt.areaSmCatg=e.areaSmCatg;$("#inUse").iCheck("update");mini.get("sortNum").setValue(e.sortNum)},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},set_default_val:function(g,e,f,c){if(f==null){f=""}var d;if(c){d=$('<option value="'+e+'" att_id="'+c+'">'+f+"</option>")}else{d=$('<option value="'+e+'">'+f+"</option>")}$(g).append(d);$(g).val(e)},selectCombox:function(c,d){$.ajax({url:c,type:"get",async:false,success:function(e){mini.get(d).load(e);mini.get(d).setValue("-1")}})},load_optrisk_menu:function(d,e){if(d){mini.get("optlRiskZoneCode").load([{name:e,code:d}]);mini.get("optlRiskZoneCode").setValue(d);return}var f=$("#optlRiskZoneCatg").val();if(riskAreaID){var c=oprisk_url+"&riskAreaID="+riskAreaID+"&zoneCatg="+f;b.logic.selectCombox(c,"#optlRiskZoneCode");mini.get("optlRiskZoneCode").enable()}else{mini.get("optlRiskZoneCode").disable();mini.get("optlRiskZoneCode").setValue("-1")}mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")},load_riskobj_menu:function(e,f){if(e){mini.get("riskAnlsObjCode").load([{name:f,code:e}]);mini.get("riskAnlsObjCode").setValue(e);return}var c=$("#riskAnlsObjCatg").val()||"",d=RiskAnlsObjName_url+"&optlRiskZoneID="+optlRiskZoneID+"&riskAnlsObjCatg="+c;if(optlRiskZoneID){b.logic.selectCombox(d,"#riskAnlsObjCode");mini.get("riskAnlsObjCode").enable();if(f){mini.get("riskAnlsObjCode").setValue(f);mini.get("riskAnlsObjCode").disable()}}else{mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")}},load_risk_menu:function(h,j){if(j){mini.get("riskAreaCode").load([{riskAreaName:j,riskAreaCode:h}]);mini.get("riskAreaCode").setValue(h);return}var f=mini.get("riskAreaCatgName").getCheckedNodes(true);var k="";var e="";var c="";if(f.length>0){for(var d=0;d<f.length;d++){(function(i){if(i.categID==""){k="";e="";c=""}else{if(i.categID.indexOf("sm")!=-1){k=i.code}else{if(i.categID.indexOf("md")!=-1){e=i.code}else{if(i.categID.indexOf("bg")!=-1){c=i.code}}}}})(f[d])}}if(drtDeptCode){var g=riskAreaName_url+"&enterpriseCode="+enterpriseCode+"&drtDeptCode="+drtDeptCode+"&areaSmCatg="+k+"&areaMdCatg="+e+"&areaBgCatg="+c;b.logic.selectCombox(g,"#riskAreaCode");mini.get("riskAreaCode").enable()}else{mini.get("riskAreaCode").disable();mini.get("riskAreaCode").setValue("-1")}mini.get("optlRiskZoneCode").disable();mini.get("optlRiskZoneCode").setValue("-1");mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")},select_option:function(d,e,c){$.ajax({url:d,type:"GET",success:function(g){if(c&&(typeof c!="function")){mini.get("riskAreaCatgName").loadList(g,"categID","gcategID");b.logic.load_risk_menu("")}else{$(e).html("");for(var f=0;f<g.length;f++){(function(i){if(i.key||i.key==0){var h=$('<option value="'+i.key+'">'+i.value+"</option>")}$(e).append(h)})(g[f])}c&&c()}if(storeType){$("#storeType").val(storeType)}if(repoType){$("#repoType").val(repoType)}}})},select_options:function(d,e,c){$.ajax({url:d,type:"GET",success:function(g){console.log(g);if(c&&(typeof c!="function")){mini.get("ranks").loadList(g,"teamID","teamName");b.logic.load_risk_menus()}else{$(e).html("");for(var f=0;f<g.length;f++){(function(i){if(i.crtUserName||i.crtUserName==0){var h=$('<option title="'+i.crtUserName+'" value="'+i.crtUserName+'">'+i.crtUserName.substring(0,20)+"</option>")}$(e).append(h)})(g[f])}c&&c()}mini.get("ranks").setValue("请选择");if(teamId){mini.get("ranks").setValue(teamId)}}})},load_risk_menus:function(){var g=mini.get("ranks").getCheckedNodes(true);var j="";var f="";var c="";if(g.length>0){for(var e=0;e<g.length;e++){(function(i){if(i.categID==""){j="";f="";c=""}else{if(i.categID.indexOf("sm")!=-1){j=i.code}else{if(i.categID.indexOf("md")!=-1){f=i.code}else{if(i.categID.indexOf("bg")!=-1){c=i.code}}}}})(g[e])}}var d=$("#riskAreaCatg").val();if(drtDeptCode){var h=riskAreaName_url+"&enterpriseCode="+enterpriseCode+"&drtDeptCode="+drtDeptCode+"&areaSmCatg="+j+"&areaMdCatg="+f+"&areaBgCatg="+c+"&riskAreaCatg="+d;b.logic.selectCombox(h,"#riskAreaCode");mini.get("riskAreaCode").enable()}else{mini.get("riskAreaCode").disable();mini.get("riskAreaCode").setValue("-1")}},get_list:function(d,g,f,c){if(f){var e=d+"?orgPID="+f+"&orgLvl=3"}else{var e=d+"?orgLvl=2"}$.ajax({url:e,type:"GET",async:false,success:function(i){if(f){mini.get("drtDeptCode").loadList(i,"orgId","orgPID");if(i.length>0){if(i[0].orgPID){for(var h=0;h<i.length;h++){if(i[h].orgId==i[0].orgPID){mini.get("drtDeptCode").setValue(i[h].orgSname);drtDeptCode=i[h].orgCode}}drtDeptPID=i[0].orgPID}else{mini.get("drtDeptCode").setValue(i[0].orgSname);drtDeptCode=i[0].orgCode}}c&&c()}else{mini.get("enterpriseCode").loadList(i,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgCode);b.logic.get_list(riskorg_url,$("#drtDeptCode"),mini.get("enterpriseCode").data[0].orgId)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var h=0;h<i.length;h++){(function(j){if(j.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(j.orgSname);b.logic.get_list(riskorg_url,$("#drtDeptCode"),j.orgId)}})(i[h])}}c&&c()}}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{repoType:{required:true},mtrlType:{required:true},sortNum:{required:true,digits:true,min:0}}})}}};b.init();window.page=b});