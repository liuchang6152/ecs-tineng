var delUrl=ECS.api.rttUrl+"/team";var searchUrl=ECS.api.rttUrl+"/team";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var teamTypeUrl=ECS.api.rttUrl+"/team/getListByParam?param=teamType";var constitutionUrl=ECS.api.rttUrl+"/team/getListByParam?param=constitutionName";var teamLvlUrl=ECS.api.rttUrl+"/team/getListByParam?param=teamLvl";var teamSpecialityUrl=ECS.api.rttUrl+"/team/getListByParam?param=teamSpeciality";var teamPIDNameUrl=ECS.api.rttUrl+"/team/getListByParam?param=teamPIDName";var inUseUrl=ECS.api.commonUrl+"/getInUse";var exportUrl=ECS.api.rttUrl+"/team/ExportToExcel";var pid="";pageflag=true;redisKey="";window.pageLoadMode=PageLoadMode.None;$(function(){var a={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();a.logic.initTable();$("#searchForm").find("input").val("");a.logic.cbxDrtDept();a.logic.initTeamType();a.logic.initConstitution();a.logic.initTeamLvl();a.logic.initTeamSpeciality();a.logic.initInUse();a.logic.teamBaseLvl();a.logic.search()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#constitutionName").on("select2:select",function(b){a.logic.initteamPIDName(b.params.data.id)});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()});$("#btnReset").click(function(){var b=$("#orgID").val();$("#searchForm")[0].reset();if(!ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){$("#orgID").val(b)}$(".select2-selection__rendered").html("可输入").attr("title","可输入")});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){a.data.param=ECS.form.getData("searchForm");a.data.param.orgID=pid;if(a.data.param.orgID=="-1"){a.data.param.orgID=""}if(a.data.param.teamBaseLvl=="-1"){a.data.param.teamBaseLvl=""}if(a.data.param.inUse=="-1"){a.data.param.inUse=""}var b=a.logic.setUrlK(a.data.param);window.open(exportUrl+"?"+b)})},data:{param:{}},logic:{setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},initTable:function(){grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"})},show_edit:function(b){return ECS.util.editRender(b.row.teamID)},show_personnelNum:function(b){return'<a title="人数" href="javascript:window.page.logic.showNum(\''+b.row.orgID+"','"+b.row.teamID+"','1','人员信息')\">"+b.row.personnelNum+"</a>"},show_vehicleNum:function(b){return'<a title="车辆数" href="javascript:window.page.logic.showNum(\''+b.row.orgID+"','"+b.row.teamID+"','2','车辆信息')\">"+b.row.vehicleNum+"</a>"},show_upload:function(b){return"<a href=\"javascript:ECS.util.renderUploader_Page('"+b.row.orgCode+"','"+b.row.teamOrgID+"','"+b.row.teamName+"','2','应急队伍附件上传')\">上传附件</a>"},cbxDrtDept:function(){if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){$("#orgID").attr("disabled",false);ECS.ui.getCombobox("orgID",riskAreaTypeNameUrl,{selectFirstRecord:true,keyField:"orgCode",valueField:"orgSname",codeField:"orgId",valueSField:"orgSname",async:false},null,a.logic.initConstitution)}else{$("#orgID").attr("disabled",true);ECS.ui.getCombobox("orgID",riskAreaTypeNameUrl,{selectValue:ECS.sys.Context.SYS_ENTERPRISE_CODE,keyField:"orgCode",valueField:"orgSname",codeField:"orgId",valueSField:"orgSname",async:false},null,a.logic.initConstitution)}},initTeamType:function(){ECS.ui.getComboSelects(teamTypeUrl,"teamType","ID","NAME",false)},initConstitution:function(){pid=$("#orgID").find("option:selected").attr("code");if(pid=="-1"){pid=""}ECS.ui.getComboSelects(constitutionUrl+"&name="+pid,"constitutionName","ID","NAME",false);a.logic.initteamPIDName("")},initTeamLvl:function(){ECS.ui.getComboSelects(teamLvlUrl,"teamLvlID","ID","NAME",false)},initTeamSpeciality:function(){ECS.ui.getComboSelects(teamSpecialityUrl,"teamSpeciality","NAME","NAME",false)},initteamPIDName:function(b){ECS.ui.getComboSelects(teamPIDNameUrl+"&name="+encodeURI(b)+"&oid="+pid,"teamPIDName","NAME","NAME",false)},initInUse:function(){ECS.ui.getCombobox("inUse",inUseUrl,{selectValue:-1,data:{isAll:true}},null)},teamBaseLvl:function(){ECS.ui.getCombobox("teamBaseLvl",inUseUrl,{selectValue:-1,data:{isAll:true}},null)},delAll:function(){var b=[];var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.teamID)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:true,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(d){ECS.hideLoading();if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){grid.reload({pageIndex:0})})}else{d=JSON.parse(d);layer.msg(d.collection.error.message)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},add:function(){var b=PageModelEnum.NewAdd;var c="队伍新增";a.logic.detail(c,"",b)},edit:function(c){var b=PageModelEnum.Edit;var d="队伍编辑";a.logic.detail(d,c,b)},detail:function(d,c,b){layer.open({type:2,closeBtn:0,area:["800px","530px"],skin:"new-class",shadeClose:false,title:false,content:"TeamAddOrEdit.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:b,teamID:c,title:d};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},showNum:function(b,d,c,e){layer.open({type:2,closeBtn:0,area:["800px","500px"],skin:"new-class",shadeClose:false,title:false,content:"vehicleNum.html?"+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var j=window[g.find("iframe")[0]["name"]];var i={orgID:b,teamID:d,type:c,title:e};j.page.logic.setData(i)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},search:function(b){a.data.param=ECS.form.getData("searchForm");if(b){a.data.param.sortType=1}a.data.param.orgID=pid;if(a.data.param.orgID=="-1"){a.data.param.orgID=""}if(a.data.param.teamBaseLvl=="-1"){a.data.param.teamBaseLvl=""}if(a.data.param.inUse=="-1"){a.data.param.inUse=""}grid.load(a.data.param)},imp:function(){var c=ECS.api.rttUrl+"/team/importExcel";var b=ECS.api.rttUrl+"/team/ExportExcel";var e=ECS.api.rttUrl+"/team/importAddAll";var d="../../bc/UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d)}}};a.init();window.page=a});