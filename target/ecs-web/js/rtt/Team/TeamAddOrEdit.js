var addUrl=ECS.api.rttUrl+"/team";var getSingleUrl=ECS.api.rttUrl+"/team";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var constitutionUrl=ECS.api.rttUrl+"/team/getListByParam?param=constitutionName";var teamPIDNameUrl=ECS.api.rttUrl+"/team/getListByParam?param=teamPIDName";var teamTypeIDUrl=ECS.api.rttUrl+"/team/getListByParam?param=teamType";var teamLvlUrl=ECS.api.rttUrl+"/team/getListByParam?param=teamLvl";var teamSpecialityUrl=ECS.api.rttUrl+"/team/getListByParam?param=teamSpeciality";var teamTypeUrl=ECS.api.rttUrl+"/expert/getExpertTypeEnumList";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;window.ownDetail="";var oid="";$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});$("#teamBaseLvl").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();ECS.sys.RefreshContextFromSYS();b.logic.initTeamTypeID();b.logic.initTeamLvl();b.logic.initTeamSpeciality();b.logic.initTeamType()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});mini.get("teamBuildDate").on("valuechanged",function(c){$("input[name=teamBuildDate]").next(".has-error").remove()});$("#selectOwner").click(function(){b.logic.selectOwner("人员选择(单选)",PageModelEnum.Details)})},logic:{setData:function(g){$("#title-main").text(g.title);pageMode=g.pageMode;if(pageMode==PageModelEnum.NewAdd){if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){ECS.ui.getCombobox("orgIds",riskAreaTypeNameUrl,{selectFirstRecord:true,keyField:"orgCode",codeField:"orgId",valueField:"orgSname",async:false},null,b.logic.initConstitution);$("#orgIds").attr("disabled",false)}else{b.logic.cbxDrtDept(ECS.sys.Context.SYS_ENTERPRISE_CODE)}b.logic.initConstitution();$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#crtUserDept").val(ECS.sys.Context.SYS_ORG_UNIT_NAME);var e=new Date;var f=e.getFullYear();var c=e.getMonth()+1;var d=e.getDate();$("#crtDate").val(f+"-"+c+"-"+d);return}else{b.logic.initConstitution();$("#teamBaseLvl").attr("disabled","disabled");$("#teamBaseLvl").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#orgIds").attr("disabled",true);$("#constitutionNameID").attr("disabled",true)}$.ajax({url:getSingleUrl+"/"+g.teamID+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(h){window.ownDetail={ownerContact:h.teamMobile,userID:h.userID,userName:h.teamManager};ECS.form.setData("AddOrEditModal",h);b.logic.cbxDrtDept(h.orgEntitySet[0].enterpriseCode);mini.get("teamBuildDate").setValue(ECS.util.strToDate(h.teamBuildDate));if(h.teamPID==null){$("#teamPID").attr("disabled","disabled")}$("#crtDate").val(ECS.util.timestampToTime(h.crtDate));$("#inUse").iCheck("update");$("#teamBaseLvl").iCheck("update");ECS.hideLoading()},error:function(h){ECS.hideLoading();var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},cbxDrtDept:function(c){ECS.ui.getCombobox("orgIds",riskAreaTypeNameUrl,{selectValue:c,keyField:"orgCode",codeField:"orgId",valueField:"orgSname",async:false},null,b.logic.initConstitution);$("#orgIds").attr("disabled",true)},initConstitution:function(){window.ownDetail="";$("#teamManager").val("");$("#teamMobile").val("");$("#userID").val("");var c="";if($("#orgIds").find("option:selected").attr("code")){c=$("#orgIds").find("option:selected").attr("code")}else{c=""}ECS.ui.getCombobox("constitutionNameID",constitutionUrl,{keyField:"ID",valueField:"NAME",codeField:"NAME",async:false,data:{name:c}},null,b.logic.initteamPIDName)},initteamPIDName:function(){$("#constitutionName").val($("#constitutionNameID").find("option:selected").attr("code"));$("#teamPID").attr("disabled",false);if($("#constitutionNameID").val()==$("#constitutionNameID option:first").val()){$("#teamPID").attr("disabled","disabled")}ECS.ui.getCombobox("teamPID",teamPIDNameUrl,{keyField:"ID",valueField:"NAME",codeField:"NAME",async:false,data:{name:$("#constitutionNameID").find("option:selected").val(),oid:oid}})},initTeamTypeID:function(){ECS.ui.getCombobox("teamTypeID",teamTypeIDUrl,{selectValue:"",keyField:"ID",valueField:"NAME"},null)},initTeamLvl:function(){ECS.ui.getCombobox("teamLvlID",teamLvlUrl,{selectValue:"",keyField:"ID",valueField:"NAME",codeField:"NAME"})},initTeamSpeciality:function(){ECS.ui.getCombobox("teamSpecialityID",teamSpecialityUrl,{selectValue:"",keyField:"ID",valueField:"NAME",codeField:"NAME"})},initTeamType:function(){ECS.ui.getCombobox("teamType",teamTypeUrl,{selectValue:0},null)},selectOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"../EmrgMtrl/SelectOwner.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,orgCode:$("#orgIds").val(),userInfo:window.ownDetail};i.page.logic.setData(h)},end:function(){$("#teamMobile").val(window.ownDetail.ownerContact);$("#teamManager").val(window.ownDetail.userName);$("#userID").val(window.ownDetail.userID)}})},save:function(){$("#teamSpeciality").val($("#teamSpecialityID").find("option:selected").attr("code"));$("#teamPIDName").val($("#teamPID").find("option:selected").attr("code"));$("#orgNames").val($("#orgIds").find("option:selected").attr("title"));$("#teamLvl").val($("#teamLvlID").find("option:selected").attr("code"));b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var c=ECS.form.getData("AddOrEditModal");if(c.teamBaseLvl>0&&c.teamPID==null){layer.msg("当选中是否班组时，所属应急队伍为必填！");return}var e=[];var d="POST";if(pageMode==PageModelEnum.NewAdd){e.push({enterpriseCode:$("#orgIds").val(),orgID:$("#orgIds").find("option:selected").attr("code")});window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){e.push({enterpriseCode:$("#orgIds").val(),teamID:$("#teamID").val(),orgID:$("#orgIds").find("option:selected").attr("code")});d="PUT";window.pageLoadMode=PageLoadMode.Refresh}}c.orgEntitySet=e;delete c.orgIds;$.ajax({url:addUrl,async:false,type:d,data:JSON.stringify(c),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(f){ECS.hideLoading();if(f.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(f.collection.error.message)}},error:function(f){$("#btnSave").attr("disabled",false);ECS.hideLoading();var g=$.parseJSON(f.responseText);layer.msg(g.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){jQuery.validator.addMethod("ucode",function(d,c,f){var e=new RegExp(f);return e.test(d)},"请输入正确格式!");ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{teamPhone:{required:true,ucode:/^\d{4}$|^([0-9]{3,4}-)?[0-9]{7,9}$/},orgIds:{required:true},teamName:{required:true,maxlength:200},constitutionNameID:{required:true},teamLvlID:{required:true},teamTypeID:{required:true},teamSpecialityID:{required:true},teamManager:{required:true,maxlength:200},teamBuildDate:{required:true},teamMobile:{required:true},teamType:{required:true},teamAddress:{maxlength:200}}})}}};b.init();window.page=b});