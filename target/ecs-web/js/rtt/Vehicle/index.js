var vehicleUrl=ECS.api.rttUrl+"/vehicle";var orgUrl=ECS.api.bcUrl+"/org/porgName";var rescueTeamUrl=ECS.api.rttUrl+"/vehicle/getTeamByOrgCode";var exportFileUrl=ECS.api.rttUrl+"/vehicle/ExportToExcel";var vehicleBigTypeUrl=ECS.api.rttUrl+"/vehicleMaintain/getVehicleBigInfoList";var vehicleSmallTypeUrl=ECS.api.rttUrl+"/vehicleMaintain/";var inUseUrl=ECS.api.commonUrl+"/getInUse";pageflag=true;redisKey="";$(function(){var a={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();this.logic.initPage();a.logic.get_list(orgUrl,$("#orgCode"));this.logic.search();this.bindUI()},table:{},bindUI:function(){$("input").blur(function(){var b=$.trim($(this).val());if(this.name!=null&&this.name!=undefined&&this.name!=""){$(this).val(b);mini.get(this.name).setValue(b)}});$("#btnAdd").click(function(){a.logic.add()});$("#btnDel").click(function(){a.logic.del()});$("#btnQuery").click(function(){a.logic.search()});$("#btnReset").click(function(){a.logic.reset()});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){var c=new mini.Form("searchForm");var d=c.getData();var b=a.logic.setUrlK(d);window.open(exportFileUrl+"?"+b)});mini.get("orgCode").on("valuechanged",function(c){var b=c.value;ECS.util.bindCmb({async:false,ctrId:"vehiclebigID",url:vehicleBigTypeUrl,data:{orgCode:b},idField:"vehicleBigID",textField:"vehicleBigName"},function(d){});ECS.util.bindCmb({ctrId:"teamID",url:rescueTeamUrl,data:{orgCode:b},idField:"teamID",textField:"teamName"},function(){})});mini.get("vehiclebigID").on("valuechanged",function(){var b=mini.get("vehiclebigID").getValue();ECS.util.bindCmb({async:false,ctrId:"vehicleSmallID",url:vehicleSmallTypeUrl+b,idField:"vehicleSmallId",textField:"vehicleSmallName"},function(c){mini.get("vehicleSmallID").setData(c.result)})})},data:{param:{}},logic:{setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},initPage:function(){ECS.util.bindCmb({ctrId:"inUse",url:inUseUrl,data:{isAll:true},idField:"key",textField:"value"},function(){mini.get("inUse").select(0)})},get_list:function(c,f,e,b){if(e){var d=c+"?isAll=true&orgPID="+e+"&orgLvl=3"}else{var d=c+"?orgLvl=2"}$.ajax({async:false,url:d,type:"GET",success:function(h){if(e){mini.get("drtDeptCode").loadList(h,"orgId","orgPID");mini.get("drtDeptCode").setValue("全部");a.logic.load_risk_menu();b&&b()}else{mini.get("orgCode").loadList(h,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("orgCode").data[0].orgCode;mini.get("orgCode").setValue(mini.get("orgCode").data[0].orgCode)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("orgCode").disable();for(var g=0;g<h.length;g++){(function(i){if(i.orgCode==enterpriseCode){mini.get("orgCode").setValue(i.orgCode)}})(h[g])}}if(mini.get("orgCode").value){ECS.util.bindCmb({ctrId:"teamID",url:rescueTeamUrl,data:{orgCode:mini.get("orgCode").value},idField:"teamID",textField:"teamName"},function(){});ECS.util.bindCmb({async:false,ctrId:"vehiclebigID",url:vehicleBigTypeUrl,data:{orgCode:mini.get("orgCode").value},idField:"vehicleBigID",textField:"vehicleBigName"},function(i){})}mini.get("orgCode").doValueChanged();b&&b()}}})},search:function(){var b=mini.get("datagrid");b.set({url:vehicleUrl,ajaxType:"get",dataField:"pageList"});var c=new mini.Form("searchForm");var d=c.getData();if(d.inUse=="-1"){d.inUse=""}b.load(d)},reset:function(){var b=new mini.Form("searchForm");b.reset();a.logic.get_list(orgUrl,$("#orgCode"))},add:function(){ECS.util.detail({url:"VehicleAddOrEdit.html",height:500,width:900,data:{title:"新增应急车辆",pageMode:PageModelEnum.NewAdd}})},edit:function(b){var c=mini.get("datagrid").getRowByUid(b);ECS.util.detail({url:"VehicleAddOrEdit.html",height:500,width:850,data:{title:"编辑应急车辆",pageMode:PageModelEnum.Edit,id:c.vehicleID}})},del:function(){ECS.util.del({url:vehicleUrl,grid:mini.get("datagrid"),idField:"vehicleID"})},imp:function(){var c=ECS.api.rttUrl+"/vehicle/importExcel";var b=ECS.api.rttUrl+"/vehicle/ExportExcel";var e=ECS.api.rttUrl+"/vehicle/importAddAll";var d="../../bc/UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d)},monitorHistory:function(b){var c=mini.get("datagrid").getRowByUid(b);ECS.util.detail({url:"MonitorHistory.html",height:500,width:950,data:{title:"应急车辆检测状态历史记录",pageMode:PageModelEnum.Edit,id:c.vehicleID,vehicleName:c.vehicleName}})},rendererOperate:function(d){var b=d.record._uid;var c=ECS.util.editRenderer(d);return c+'<a href="javascript:window.page.logic.monitorHistory('+b+')" class="ml__10" title="历史记录"><i class="icon-history edit"></i></a>'},showEquipmentEdit:function(b){return'<a title="查看" href="javascript:window.page.logic.showEquipment()"><i class="icon-edit edit"></i></a>'},showEquipment:function(){var b=mini.get("datagrid").getSelected();layer.open({type:2,closeBtn:1,area:["80%","60%"],skin:"new-class",shadeClose:false,title:"车辆装备配置",content:"EquipmentNumber.html?"+Math.random(),success:function(d,e){var c=layer.getChildFrame("body",e);var f=window[d.find("iframe")[0]["name"]];f.page.logic.setData(b.emrgequips)},end:function(){}})},}};a.init();window.page=a});