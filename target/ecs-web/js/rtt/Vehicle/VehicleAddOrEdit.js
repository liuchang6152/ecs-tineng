var vehicleUrl=ECS.api.rttUrl+"/vehicle";var orgUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=1";var rescueTeamUrl=ECS.api.rttUrl+"/vehicle/getTeamByOrgCode";var exportFileUrl=ECS.api.rttUrl+"/vehicle/ExportToExcel";var vehicleBigTypeUrl=ECS.api.rttUrl+"/vehicleMaintain/getVehicleBigInfoList";var vehicleSmallTypeUrl=ECS.api.rttUrl+"/vehicleMaintain/";var orgTypeUrl=ECS.api.rttUrl+"/vehicle/vehicleTypeList";var poactionStatusUrl=ECS.api.rttUrl+"/vehicle/poactionStatus";var exAgentUrl=ECS.api.rttUrl+"/vehicle/exAgent";var listLength=1;var vehicleSmallAttributeLength=0;var attrsData="";var vehicleSmallID="";$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();this.logic.initPage()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){b.logic.closeLayer(false)});$("#selectOwner").click(function(){b.logic.selectOwner()});$("#addNewName").click(function(){b.logic.generateMonitorCfg()});$(document).on("click",".delName",function(){var e=$(this).closest(".row");var c=e.find("input[name^=cfgName]").val();var d=e.find("input[name^=cfgValue]").val();if(c!=""||d!=""){layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(f){e.remove();listLength--;layer.close(f)},function(f){layer.close(f)})}else{e.remove();listLength--}return false});mini.get("orgCode").on("valuechanged",function(d){var c=d.value;ECS.util.bindCmb({async:false,ctrId:"vehiclebigID",url:vehicleBigTypeUrl,data:{orgCode:c},idField:"vehicleBigID",textField:"vehicleBigName"});ECS.util.bindCmb({ctrId:"teamID",url:rescueTeamUrl,data:{orgCode:c},idField:"teamID",textField:"teamName"})});mini.get("vehiclebigID").on("valuechanged",function(){var c=mini.get("vehiclebigID").getValue();b.logic.bindSmallType(c);mini.get("vehicleSmallID").doValueChanged()});mini.get("vehicleSmallID").on("valuechanged",function(c){b.logic.generateTypeCfg(c,attrsData)})},data:{param:{}},logic:{bindSmallType:function(c){ECS.util.bindCmb({async:false,ctrId:"vehicleSmallID",url:vehicleSmallTypeUrl+c,idField:"vehicleSmallId",textField:"vehicleSmallName"},function(d){mini.get("vehicleSmallID").setData(d.result)})},initPage:function(){b.logic.initOrg();$("#attrs").html("");ECS.util.bindCmb({ctrId:"vehicleType",url:orgTypeUrl});ECS.util.bindCmb({ctrId:"poactionStatus",url:poactionStatusUrl});ECS.util.bindCmb({ctrId:"exagentID",url:exAgentUrl,idField:"exagentID",textField:"exAgentName"});mini.get("crtUserName").setValue(ECS.sys.Context.SYS_USER_NAME);mini.get("crtUserDept").setValue(ECS.sys.Context.SYS_ORG_UNIT_NAME);var e=new Date;var f=e.getFullYear();var c=e.getMonth()+1;var d=e.getDate();mini.get("crtDate").setValue(f+"-"+c+"-"+d)},initOrg:function(){$.ajax({url:orgUrl,type:"GET",success:function(d){mini.get("orgCode").loadList(d,"orgCode","porgCode");if(ECS.sys.Context.SYS_IS_HQ){mini.get("orgCode").setValue(d[0].orgCode)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("orgCode").disable();for(var c=0;c<d.length;c++){(function(e){if(e.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("orgCode").setValue(e.orgCode)}})(d[c])}}mini.get("orgCode").doValueChanged()},error:function(c){console.log(c)}})},generateTypeCfg:function(l,q){$("#attrs").html("");if(l.selected==null||l.selected==undefined||l.selected.vehicleSmallAttribute==null||l.selected.vehicleSmallAttribute.length==0){return}var p=l.selected.vehicleSmallAttribute.split(",");vehicleSmallAttributeLength=p.length;var c=[];if(vehicleSmallID==l.value){var h=q.split(",");for(var g=0,j=h.length;g<j;g++){var m=h[g].split(":");var d=m[0];var o="";if(m.length==2){o=m[1]}var f={key:d,value:o};c.push(f)}}else{for(var g=0,j=p.length;g<j;g++){var f={key:p[g],value:""};c.push(f)}}var n="";for(var g=0,j=c.length;g<j;g++){n+='<div class="row"><div class="col-xs-6"><div class="form-group"><label class="control-label col-xs-4">技术属性：</label><div class="col-xs-8"><input name="vehicleSmallAttribute'+g+'" id="vehicleSmallAttribute'+g+'" class="mini-textbox" value="'+c[g].key+'" enabled="false" /></div><span class="span-required">*</span></div></div><div class="col-xs-6"><div class="form-group"><label class="control-label col-xs-4">属性值：</label><div class="col-xs-8"><input name="vehicleSmallAttributeValue'+g+'" id="vehicleSmallAttributeValue'+g+'" maxlength="200" class="mini-textbox" value="'+c[g].value+'" /></div></div></div></div>'}$("#attrs").append(n);mini.parse()},generateHTML:function(f,g,c,d){var e=' <div class="row cfg"><div class="col-xs-6  "><div class="form-group"><label class="control-label col-xs-4">装备名称：</label><div class="col-xs-8"><input name="cfgID'+f+'" id="cfgID'+f+'" class="mini-hidden" value="'+g+'" /><input name="cfgName'+f+'" id="cfgName'+f+'" class="mini-textbox" value="'+c+'"/></div></div></div><div class="col-xs-6"><div class="form-group"><label class="control-label col-xs-4">装备数量：</label><div class="col-xs-6"><input name="cfgValue'+f+'" id="cfgValue'+f+'" class="mini-spinner" minValue="0" maxValue="999999" value="'+d+'"/></div><button class="btn btn-danger delName ml__10" style="width:auto;" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div></div></div>';return e},generateMonitorCfg:function(c){var e=name=value="";if(c!=null&&c!=undefined){e=c.emrgequipId;name=c.emrgequipName;value=c.getEmrgequipAmount}if(c){var d=b.logic.generateHTML(listLength,e,name,value);$("#nameList").before(d);mini.parse()}else{layer.open({type:2,closeBtn:1,area:["100%","100%"],skin:"new-class",shadeClose:false,title:"装备选择组件",content:"SelectEquipment.html?"+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var i=window[g.find("iframe")[0]["name"]]},end:function(){var j=[];$(".cfg").each(function(n){var o=$(this).find("input[name^=cfgID]").val();if(o!=""){j.push({emrgequipId:o})}});var m=[];function g(q,o){for(var n=0;n<o.length;n++){var p=o[n];if(p.emrgequipId==q.emrgEquipID){m.push(q.emrgEquipName);return true}}return false}for(var f=0;f<window.ownDetail.length;f++){var k=window.ownDetail[f];if(!g(k,j)){var l=b.logic.generateHTML(listLength,k.emrgEquipID,k.emrgEquipName,"");var h=$(".first");if(h.length==1&&!mini.get("cfgID0").getValue()){mini.get("cfgID0").setValue(k.emrgEquipID);mini.get("cfgName0").setValue(k.emrgEquipName)}else{$(".first").before(l);mini.parse()}mini.parse()}else{if(window.ownDetail.length>0){layer.msg("该装备已存在！"+m.toString(","),{time:1000})}}}}});mini.parse();listLength++}},setData:function(d){$("#title-main").text(d.title);b.data.param.pageMode=d.pageMode;b.data.param.id=d.id;if(d.pageMode!=PageModelEnum.NewAdd){var c=new mini.Form("AddOrEditModal");mini.get("inUse").setEnabled(true);$.ajax({url:vehicleUrl+"/"+d.id,type:"get",dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(g){g.crtDate=ECS.util.DateRender(g.crtDate);c.setData(g);attrsData=g.vehicleAllattributes;vehicleSmallID=g.vehicleSmallID;var f=g.emrgequips;for(var e=0;e<f.length;e++){b.logic.generateMonitorCfg(f[e])}b.logic.bindSmallType(g.vehiclebigID);mini.get("vehicleSmallID").setValue(g.vehicleSmallID);mini.get("vehicleSmallID").doValueChanged();ECS.hideLoading()},error:function(e){ECS.hideLoading();var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})}},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var e=ECS.form.getData("AddOrEditModal");var d="";for(var c=0;c<vehicleSmallAttributeLength;c++){d+=e["vehicleSmallAttribute"+c]+":"+e["vehicleSmallAttributeValue"+c]+",";delete e["vehicleSmallAttribute"+c];delete e["vehicleSmallAttributeValue"+c]}e.vehicleAllattributes=d.substring(0,d.length-1);e.vehicleCooToPojos={vehicleCooToAddress:e.vehicleCooToAddress,vehicleCooToID:e.vehicleCooToID};delete e.vehicleCooToAddress;delete e.vehicleCooToID;e.emrgequips=[];$(".cfg").each(function(g){var j=$(this).find("input[name^=cfgID]").val();var f=$(this).find("input[name^=cfgName]").val();var h=$(this).find("input[name^=cfgValue]").val();if(j!=""||f!=""||h!=""){e.emrgequips.push({emrgequipId:j,getEmrgequipAmount:h})}});for(var c in e){if(c.indexOf("cfgID")>-1||c.indexOf("cfgName")>-1||c.indexOf("cfgValue")>-1){delete e[c]}}ECS.util.addOrEdit({url:vehicleUrl,data:e,pageMode:b.data.param.pageMode},function(f){if(f.indexOf("collection")<0){layer.msg(f,{time:1000},function(){parent.page.logic.search();b.logic.closeLayer(true)})}else{layer.msg(f.collection.error.message)}})},selectOwner:function(){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"SelectOwner.html?"+Math.random(),success:function(d,e){var c=layer.getChildFrame("body",e);var g=window[d.find("iframe")[0]["name"]];var f={pageMode:PageModelEnum.Details,title:"人员选择",orgCode:mini.get("orgCode").getValue()};g.page.logic.setData(f)},end:function(){mini.get("vehicleMobile").setValue(window.ownDetail.ownerContact);mini.get("vehicleManager").setValue(window.ownDetail.userName);mini.get("userID").setValue(window.ownDetail.userID)}})},closeLayer:function(c){parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{orgCode:{required:true},teamID:{required:true},vehicleName:{required:true},vehicleCode:{required:true},vehicleType:{required:true},exagentID:{required:true},poactionStatus:{required:true},vehicleFullPeople:{required:true,number:true},vehicleManager:{required:true},vehicleMobile:{required:true},vehiclebigID:{required:true},vehicleSmallID:{required:true}}})}}};b.init();window.page=b});