var delUrl=ECS.api.bcUrl+"/user";var searchUrl=ECS.api.bcUrl+"/user";var inUseUrl=ECS.api.commonUrl+"/getInUse";var exportUrl=ECS.api.bcUrl+"/user/ExportToExcel";var porg_url=ECS.api.rttUrl+"/videoSurveullance/getTreeRoot?userName=emergency";var org_url=ECS.api.bcUrl+"/org/porgNameOne";var postNames_url=ECS.api.bcUrl+"/user/getAllPost";var userSex_url=ECS.api.rttUrl+"/expert/getExpertSexEnumList";var userLvl_url=ECS.api.bcUrl+"/user/getAllUserLvl";var userNature_url=ECS.api.bcUrl+"/user/getAllUserNature";window.pageLoadMode=PageLoadMode.None;pageflag=true;pageflag=true;redisKey="";var grid=null;var getNode="-1";var isHiden=true;var flag=false;$(function(){var a={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();$("#searchForm").find("input").val("");a.logic.initTable()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){a.data.param={};a.data.param=ECS.form.getData("searchForm");if(a.data.param.inUse=="-1"){a.data.param.inUse=""}if(mini.get("tree1").getSelectedNode()){a.data.param.orgId=mini.get("tree1").getSelectedNode().orgId}else{a.data.param.orgId=mini.get("tree1").data[0].orgId}if(a.data.param.orgId==-1){a.data.param.orgId=""}var b=a.logic.setUrlK(a.data.param);window.open(exportUrl+"?"+b)});$("#btnToggle").click(function(){if(flag){flag=!flag;$(this).html('<i class="icon-showMore"></i>');$(".search-unfixed").hide()}else{flag=!flag;$(this).html('<i class="icon-hideMore"></i>');$(".search-unfixed").show()}});mini.get("tree1").on("nodeclick",function(b){$.ajax({async:false,url:ECS.api.rttUrl+"/videoSurveullance/getTreeOrgAndChannel?userName=emergency&type=0&id="+mini.get("tree1").getSelectedNode().id,type:"GET",success:function(e){console.log(e);var c=mini.get("tree1");var f=c.getSelectedNode();if(e.length!=0){for(var d=0;d<e.length;d++){c.addNode(e[d],"add",f);if(e[d].type>2){console.log(b)}}$("#filesDataView").hide()}else{$.ajax({async:false,url:ECS.api.rttUrl+"/videoSurveullance/getVideoUrlByChannel?userName=emergency&channel="+mini.get("tree1").getSelectedNode().id,type:"GET",dataType:"text",success:function(g){console.log(g);$("#filesDataView").show();var h="<iframe id='video' src='"+g+"'frameborder = '0' allowfullscreen = 'true' style='width:100%;height: 540px;'></iframe>";$("#filesView").html(h)},error:function(g){alert(g)}})}},error:function(){}})});$("#btnQuery2").click(function(){var b=$.trim($("#tree_val").find("input").val());if(b==""||b=="全部"){mini.get("tree1").clearFilter()}else{b=b.toLowerCase();mini.get("tree1").filter(function(c){var d=c.orgSname?c.orgSname.toLowerCase():"";if(d.indexOf(b)!=-1){return true}})}});$(".btn-toggle").click(function(){if(isHiden){$(".leftNav-body").hide();$(".box-body").css("margin-left","0");$(this).css({left:"0",transform:"rotate(180deg)"})}else{$(".leftNav-body").show();$(".box-body").css("margin-left","280px");$(this).css({left:"263px",transform:"rotate(0deg)"})}isHiden=!isHiden;a.logic.search()})},data:{param:{}},logic:{showFiles:function(b){console.log(ECS.api.rttUrl+"/videoSurveullance/getTreeOrgAndChannel?userName=emergency&type=0&id="+mini.get("tree1"));$.ajax({url:ECS.api.rttUrl+"/videoSurveullance/getTreeOrgAndChannel?userName=emergency&type=0&id="+mini.get("tree1").getSelectedNode().id,type:"GET",success:function(c){console.log(c);var d=mini.decode(c);refreshFiles(d)},error:function(){}})},setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},initTable:function(){a.logic.load_sidebar()},show_edit:function(b){return ECS.util.editRender(b.row.userID)},birthdate:function(b){return ECS.util.timestampToTime(b.row.userBirthday)},workdate:function(b){return ECS.util.timestampToTime(b.row.userJoinDatetime)},load_sidebar:function(){$.ajax({url:porg_url,type:"GET",success:function(b){if(b.length>0){mini.get("tree1").loadList(b,"id","pId");mini.get("tree1").setValue(ECS.sys.Context.SYS_ENTERPRISE_CODE)}else{layer.msg("暂无数据！")}},error:function(){}})},select_option:function(b,c){$.ajax({url:b,type:"GET",success:function(f){$(c).html("");var d=$('<option value="">全部</option>');$(c).append(d);for(var e=0;e<f.length;e++){(function(h){if(h.postID){var g=$('<option value="'+h.postID+'">'+h.postName+"</option>")}if(h.key||h.key==0){var g=$('<option value="'+h.key+'">'+h.value+"</option>")}if(h.UserAttributeID){var g=$('<option value="'+h.UserAttributeID+'">'+h.userAttribute+"</option>")}if(h.userLvlID){var g=$('<option value="'+h.userLvlID+'">'+h.userLvl+"</option>")}if(h.userNatureID){var g=$('<option value="'+h.userNatureID+'">'+h.userNature+"</option>")}$(c).append(g)})(f[e])}}})},delAll:function(){var b=new Array();var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.userID)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:false,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(d){ECS.hideLoading();if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){a.logic.search()})}else{d=JSON.parse(d);layer.msg(d.collection.error.message)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},add:function(){var b=PageModelEnum.NewAdd;var c="应急联系人新增";a.logic.detail(c,"",b)},edit:function(b){var c=PageModelEnum.Edit;var d="应急联系人编辑";a.logic.detail(d,b,c)},detail:function(d,b,c){layer.open({type:2,closeBtn:0,area:["980px","410px"],skin:"new-class",shadeClose:false,title:false,content:"UserAddOrEdit.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,userID:b,title:d,getNode:getNode};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},search:function(b){a.data.param={};a.data.param=ECS.form.getData("searchForm");if(b){a.data.param.sortType="1"}if(a.data.param.inUse=="-1"){a.data.param.inUse=""}if(mini.get("tree1").getSelectedNode()){a.data.param.id=mini.get("tree1").getSelectedNode().id}else{a.data.param.id=mini.get("tree1").data[0].id}if(a.data.param.id==-1){a.data.param.id=""}},initInUse:function(){ECS.ui.getCombobox("inUse",inUseUrl,{selectValue:-1,data:{isAll:true}},null)},imp:function(){var c=ECS.api.bcUrl+"/user/importExcel";var b=ECS.api.bcUrl+"/user/ExportExcel";var e=ECS.api.bcUrl+"/user/importAddAll";var d="../UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d)}}};a.init();window.page=a});