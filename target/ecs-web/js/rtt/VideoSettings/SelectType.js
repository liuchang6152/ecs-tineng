var leftMenuUrl=ECS.api.rttUrl+"/videoSurveullance/getTreeList";var checkListUrl=ECS.api.rttUrl+"/msds/getRightList";var delLinkAll=ECS.api.rttUrl+"/msds/reset";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName";var loadUnitsUrl=ECS.api.rttUrl+"/msds/secunit";window.pageLoadMode=PageLoadMode.None;var orglist=[];var secordOrglist=[];$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();this.bindUI();b.logic.initTable();b.logic.enterprise(riskAreaTypeNameUrl,"enterpriseCode")},table:{},bindUI:function(){$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#btnSave").on("click",function(){b.logic.save()});$("#btnQuery").click(function(){b.logic.load_Tree()});$("#enterpriseCode").change(function(){b.logic.enterprisechanged()})},data:{param:{}},logic:{enterprisechanged:function(){var d=$("#enterpriseCode").val();var c=riskAreaTypeNameUrl+"?isAll=false&orgPID="+d+"&orgLvl=3";b.logic.getsecordEnterPriseSelects(c,"drtDeptCode","orgId","orgSname",false)},enterprise:function(c,d){$.ajax({url:c+"?orgLvl=1",type:"get",success:function(g){var f=[];if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){$.each(g,function(j,k){f.push({id:k.orgId,text:k.orgSname,code:k.orgCode})})}else{var e=JSLINQ(g).Where(function(i){return i.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE}).ToArray();$.each(e,function(j,k){f.push({id:k.orgId,text:k.orgSname,code:k.orgCode})});var h=c+"?isAll=false&orgPID="+e[0].orgId+"&orgLvl=3";b.logic.getsecordEnterPriseSelects(h,"drtDeptCode","orgId","orgSname",false);$("#"+d).attr("disabled","disabled")}orglist=f;orgList=f;$("#"+d).select2({tags:false,data:f,language:{noResults:function(i){return"没有匹配项"}},})},error:function(f){}})},getsecordEnterPriseSelects:function(e,c,f,g,d){console.log(e);$.ajax({url:e,async:false,dataType:"json",success:function(i){console.log(i.length);var h=[];$.each(i,function(j,k){h.push({id:k[f],text:k[g],code:k.orgCode})});secordOrglist=h;$("#"+c).select2({tags:d,data:h,language:{noResults:function(j){return"没有匹配项"}},})},})},initTable:function(){},del_option_checked:function(){if(mini.get("acheck_list").getValue()==""){layer.msg("请选择需要删除的危化品数据！");return false}var c=[];c=mini.get("acheck_list").getValue().split(",");$.ajax({url:delLinkAll+"?treeId="+mini.get("tree1").getSelectedNode().id+"&applicationLevel="+mini.get("tree1").getSelectedNode().obj+"&now="+Math.random(),type:"DELETE",data:JSON.stringify(c),dataType:"text",contentType:"application/json;charset=utf-8",success:function(d){d=JSON.parse(d);if(d.isSuccess){layer.msg(d.message);b.logic.onenode_load_dt()}else{layer.msg(d.message)}}})},onenode_load_dt:function(c){ECS.showLoading();if(!mini.get("tree1").getSelectedNode()){return false}$.ajax({url:checkListUrl+"?treeId="+mini.get("tree1").getSelectedNode().id+"&now="+Math.random(),type:"GET",timeout:5000,success:function(d){ECS.hideLoading();c&&c(d)},error:function(d){ECS.hideLoading();if(d){layer.msg(d,{time:1000})}}})},getLevenName:function(e,c){var d=mini.get("tree1").getParentNode(e);if(d._level>-1){c+="$$"+d.name;b.logic.getLevenName(d,c)}else{reutnName=c}return reutnName},getFulladdress:function(){b.data.param={};if(mini.get("tree1").getSelectedNode()){var g=mini.get("tree1").getSelectedNode();var e=g.name;var c=b.logic.getLevenName(g,e);var f=c.split("$$");var h="";for(var d=f.length;d>0;d--){h+=f[d-1]+(d==1?"":"  --  ")}return h}},save:function(){var c=b.logic.getFulladdress();var d={};if($("#tree1 .mini-tree-nodetext").length>0){d.id=mini.get("tree1").getSelectedNode().id;d.obj=mini.get("tree1").getSelectedNode().obj;d.name=c}parent.ownDetail=d;window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},setData:function(c){console.log(c)},load_Tree:function(c){ECS.showLoading();var d=JSLINQ(orglist).Where(function(e){return e.id==$("#enterpriseCode").val()}).ToArray()[0];if(!d){layer.msg("企业不能为空");ECS.hideLoading();return}if(!$("#drtDeptCode").val()){layer.msg("二级单位不能为空");ECS.hideLoading();return}$.ajax({url:leftMenuUrl+"?orgCode="+d.code+"&treeID="+$("#drtDeptCode").val()+"&now="+Math.random(),type:"GET",timeout:5000,success:function(e){ECS.hideLoading();mini.get("tree1").loadList(e,"id","pid");mini.get("tree1").selectNode(e[0]);$("#tree1").parent().css("overflow-y","auto");c&&c()},error:function(e){ECS.hideLoading();if(e){layer.msg(e,{time:1000})}}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},}};b.init();window.page=b});