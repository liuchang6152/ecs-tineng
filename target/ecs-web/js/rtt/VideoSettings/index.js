var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2&isAll=true";var searchTypeUrl=ECS.api.apUrl+"/event/getconfimPlanDefinition";var smallTypeUrl=ECS.api.apUrl+"/event/getAccidentCategory";var searchUrl=ECS.api.rttUrl+"/videoSurveullance";var exportUrl=ECS.api.rttUrl+"/emergencyEquipment/ExportToExcel";var dept_url=ECS.api.apUrl+"/event/getSecunit";var riskType_url=ECS.api.apUrl+"/event/getRiskArea";var OptRisk_url=ECS.api.apUrl+"/event/getOptRisk";var RiskAnlsObj_url=ECS.api.apUrl+"/event/getRiskAnlsObj";var delUrl=ECS.api.rttUrl+"/videoSurveullance/deleteVideoDeploy";var Enterprise_url=ECS.api.rttUrl+"/expert/getExpertTypeEnumList";var bigUrl=ECS.api.bcUrl+"/busiBgCateg/getListByModelID?businessModelId=32";var mUrl=ECS.api.bcUrl+"/busiBgCateg/getListByBgCode";var stockpilePointTypeUrl=ECS.api.rttUrl+"/mtrlStorage/getStoreTypeEnumList";var stockpileTypeUrl=ECS.api.rttUrl+"/mtrlStorage/getRepoTypeEnumList";var riskorg_url=ECS.api.bcUrl+"/org/porgName";var grid=null;var flag=false;var enterpriseCode="";var drtDeptCode="";window.pageLoadMode=PageLoadMode.None;$(function(){var a={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();a.logic.enterprise(riskorg_url,"enterpriseCode");a.logic.search()},table:{},bindUI:function(){$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;a.logic.closeLayer(false)});$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){console.log($("#drtDeptCode").val());if($("#drtDeptCode").val()!=null&&$("#drtDeptCode").val()!=""){a.logic.add()}else{layer.msg("请选择二级单位");return}});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){var c=ECS.form.getData("searchForm");var b=a.logic.setUrlK(c);window.open(exportUrl+"?"+b)});$("#btnQuery").click(function(){a.logic.search()});$("#btnDel").click(function(){a.logic.delAll()});$("#enterpriseCode").change(function(){a.logic.enterprisechanged()})},data:{param:{}},logic:{enterprisechanged:function(){var c=$("#enterpriseCode").val();var b=riskorg_url+"?isAll=false&orgPID="+c+"&orgLvl=3";a.logic.getsecordEnterPriseSelects(b,"drtDeptCode","orgCode","orgSname",false)},enterprise:function(b,c){$.ajax({url:b+"?orgLvl=1",type:"get",success:function(f){var e=[];if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){$.each(f,function(h,j){e.push({id:j.orgId,text:j.orgSname})})}else{var d=JSLINQ(f).Where(function(h){return h.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE}).ToArray();$.each(d,function(h,j){e.push({id:j.orgId,text:j.orgSname})});var g=b+"?isAll=false&orgPID="+d[0].orgId+"&orgLvl=3";a.logic.getsecordEnterPriseSelects(g,"drtDeptCode","orgCode","orgSname",false);$("#"+c).attr("disabled","disabled")}orgList=e;$("#"+c).select2({tags:false,data:e,language:{noResults:function(h){return"没有匹配项"}},})},error:function(d){}})},getsecordEnterPriseSelects:function(d,b,e,f,c){console.log(d);$("#"+b).html('<option value="" selected="selected">可输入</option>');$.ajax({url:d,async:false,dataType:"json",success:function(h){console.log(h.length);var g=[];$.each(h,function(j,k){g.push({id:k[e],text:k[f]})});$("#"+b).select2({tags:c,data:g,language:{noResults:function(i){return"没有匹配项"}},})},})},setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},show_editeditAttr:function(){return'<a title="编辑" href="javascript:window.page.logic.editAttr()"><i class="icon-edit edit"></i></a>'},editAttr:function(){var b=mini.get("datagrid").getSelected();a.logic.edit(b.survVideoId)},delAttr:function(){var c=mini.get("datagrid").getSelected();var b=[];b.push(c.survVideoId);layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl+"?survVideoId="+c.survVideoId,async:true,dataType:"json",timeout:1000,contentType:"application/json;charset=utf-8",type:"DELETE",success:function(d){if(d.isSuccess){layer.msg("删除成功");a.logic.search()}else{layer.msg("删除失败")}},error:function(d){layer.msg(d.responseText)}})},function(d){layer.close(d)})},delAll:function(){var c=[];var d=grid.getSelecteds();$.each(d,function(e,f){c.push(f.survVideoId)});var b=c.toString(",");if(d.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:false,dataType:"json",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",type:"DELETE",success:function(e){if(e.isSuccess){layer.msg("删除成功");a.logic.search()}else{layer.msg(e.message)}},error:function(e){var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},function(e){layer.close(e)})},getEnterpriseType:function(){$("#drtDeptCode").html('<option value="" selected="selected">可输入</option>');var b=[{text:"队伍",id:1},{text:"企业",id:2}];$("#drtDeptCode").select2({tags:false,data:b,language:{noResults:function(c){return"没有匹配项"}},})},loadmodelType:function(b){ECS.ui.getComboSelects(mUrl+"?businessBgCategCode="+b,"businessMdCategID","businessMdCategCode","businessMdCategName",false)},initTable:function(){a.logic.search()},search:function(b){a.data.param=ECS.form.getData("searchForm");grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"});console.log(a.data.param);if(a.data.param.drtDeptCode=="全部"){a.data.param.drtDeptCode=""}grid.load(a.data.param)},add:function(){var b=PageModelEnum.NewAdd;var c="新增视频配置";a.logic.detail(c,"",b)},edit:function(b){var c=PageModelEnum.Edit;var d="编辑视频配置";a.logic.detail(d,b,c)},detail:function(g,c,f){var e;var d=grid.getSelected();var b=$("#enterpriseCode").val();if($("drtDeptCode").val()){e=$("drtDeptCode").val()}layer.open({type:2,closeBtn:0,area:["80%","80%"],skin:"new-class",shadeClose:false,title:false,content:"AddOrEdit.html?"+Math.random(),success:function(i,j){var h=layer.getChildFrame("body",j);var l=window[i.find("iframe")[0]["name"]];var k={pageMode:f,title:g,riskAreaCode:b,treeID:e,id:c};l.page.logic.setData(k,d)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},closeLayer:function(b){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(index)},imp:function(){layer.open({type:2,closeBtn:0,area:["80%","60%"],skin:"new-class",shadeClose:false,title:false,content:"UploadFile.html?"+Math.random(),success:function(c,d){var b=layer.getChildFrame("body",d);var f=window[c.find("iframe")[0]["name"]];var e={pageMode:PageModelEnum.NewAdd,title:"导入"};f.page.logic.setData(e)},end:function(){a.logic.search()}})}}};a.init();window.page=a});