var grid=null;var video_type=ECS.api.rttUrl+"/videoSurveullance/findSurvVideoType";var videoUrl=ECS.api.rttUrl+"/videoSurveullance/findVideoDeploy";var systemUrl=ECS.api.rttUrl+"/videoSurveullance/findSurvVideoSystem";$(function(){var c=parent.layer.getFrameIndex(window.name);var d="";var b="";var g="";var e=[];var a=[];var f={init:function(){mini.parse();this.bindUI()},table:{},bindUI:function(){$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;f.logic.closeLayer(false)});$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){f.logic.save()});$("#selectMedia").click(function(){f.logic.add("工厂模型位置","",PageModelEnum.NewAdd)});$("#selectPass").click(function(){f.logic.addPass("通道号","",PageModelEnum.NewAdd);return});$("#typeId").change(function(h){e.forEach(function(k,j,i){if($("#typeId").val()==k.id){$("#priorityName").val(k.priorityName);$("#priorityName").attr("key",k.priorityId)}})})},data:{param:{}},logic:{select_option:function(h,i){f.logic.getComboSelects(h,i,"typeId","typeName",true)},select_options:function(h,i){f.logic.getComboSelect_s(h,i,"systemId","systemName",true)},getComboSelects:function(j,h,k,l,i){$("#"+h).html('<option value="" selected="selected">可搜索</option>');$.ajax({url:j,async:false,dataType:"json",success:function(n){var m=[];$.each(n,function(o,p){e.push({id:p[k],text:p[l],priorityName:p.priorityName,priorityId:p.priorityId,});m.push({id:p[k],text:p[l],priorityName:p.priorityName})});$("#"+h).select2({tags:i,data:m,language:{noResults:function(o){return"没有匹配项"}},})},})},getComboSelect_s:function(j,h,k,l,i){$("#"+h).html('<option value="" selected="selected">可搜索</option>');$.ajax({url:j,async:false,dataType:"json",success:function(n){console.log(n);var m=[];$.each(n,function(o,p){a.push({id:p[k],text:p[l],systemName:p.systemName,systemId:p.systemId,});m.push({id:p[k],text:p[l],systemName:p.systemName})});$("#"+h).select2({tags:i,data:m,language:{noResults:function(o){return"没有匹配项"}},})},})},onButtonEdit:function(i){var h=PageModelEnum.NewAdd;var j="选择工厂模型位置";f.logic.detail(j,"",h)},setData:function(i,j){d=i.riskAreaCode;b=i.treeID;g=i.id;$("#title-main").text(i.title);f.data.param.pageMode=i.pageMode;f.data.param.id=i.id;f.logic.select_option(video_type,"typeId");f.logic.select_options(systemUrl,"systemId");if(i.pageMode!=PageModelEnum.NewAdd){var h=new mini.Form("AddOrEditModal");$.ajax({url:videoUrl+"?survVideoId="+i.id,type:"get",dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(k){console.log(i);h.setData(k);ECS.form.setData("AddOrEditModal",k);ECS.hideLoading();$("#name").val(j.name)},error:function(k){ECS.hideLoading();var l=$.parseJSON(k.responseText);layer.msg(l.collection.error.message)}})}},save:function(){console.log(window.ownDetail);var j=ECS.form.getData("AddOrEditModal");console.log(j);if(!j.name){layer.msg("请选择工厂模型位置！");return false}if(!j.survVideoName){layer.msg("请输入视频名称");return false}else{if(j.survVideoName.length>100){layer.msg("视频名称过长，请筛减！");return false}}if(!j.location){layer.msg("请输入位置描述");return false}if(!j.typeId){layer.msg("请选择视频类型");return false}if(!j.systemId){layer.msg("请选择视频系统");return false}if(!j.channel){layer.msg("请输入通道号");return false}console.log(f.data.param.pageMode);var i,h;if(PageModelEnum.Edit==f.data.param.pageMode){i=ECS.api.rttUrl+"/videoSurveullance/updateVideoDeploy";h="put";console.log(g);j.survVideoId=g}else{i=ECS.api.rttUrl+"/videoSurveullance/addVideoDeploy";h="post"}$.ajax({url:i,async:false,data:JSON.stringify(j),dataType:"json",timeout:1000,contentType:"application/json;charset=utf-8",type:h,success:function(k){console.log(k);if(k.isSuccess){layer.msg("保存成功！",{time:1000},function(){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(c)});parent.page.logic.search()}else{layer.msg(k.message,{time:1000});return false}},error:function(k){layer.msg(k.responseText)}});f.logic.formValidate();var j=ECS.form.getData("AddOrEditModal");j.userID=$("#userID").val()},add:function(){var h=PageModelEnum.NewAdd;var j="工厂模型位置";var i=mini.get("enterpriseCode");f.logic.detail(j,"","","",h)},addPass:function(){var h=PageModelEnum.NewAdd;var i="通道号";f.logic.detailPass(i,"","","",h)},detail:function(o,l,m,i,k,h){var n=[];var j="";console.log(d);layer.open({type:2,closeBtn:0,area:["100%","100%"],skin:"new-class",shadeClose:false,title:false,content:"SelectType.html?"+Math.random(),success:function(q,r){var p=layer.getChildFrame("body",r);var t=window[q.find("iframe")[0]["name"]];console.log(parent.nsValue);$("#businessBgCategName").val(parent.nsValue);var s={pageMode:k,riskAreaCode:d,treeID:b,enterpriseCode:m,enterpriseName:i,title:o,keys:j,};t.page.logic.setData(s)},end:function(){$("#name").val(window.ownDetail.name);$("#baseDataId").val(window.ownDetail.id);$("#baseModelCategory").val(window.ownDetail.obj);console.log(parent.ownDetail.passageway);if(window.pageLoadMode==PageLoadMode.Refresh){f.logic.search();window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){f.logic.search();window.pageLoadMode=PageLoadMode.None}}}})},detailPass:function(n,l,m,i,k,h){var j="";layer.open({type:2,closeBtn:0,area:["100%","100%"],skin:"new-class",shadeClose:false,title:false,content:"SelectPass.html?"+Math.random(),success:function(o,p){var r=window[o.find("iframe")[0]["name"]];$("#businessBgCategName").val(parent.nsValue);var q={pageMode:k,riskAreaCode:d,treeID:b,enterpriseCode:m,enterpriseName:i,title:n,keys:j,}},end:function(){console.log(window.passDetail);$("#channel").val(window.passDetail);if(window.pageLoadMode==PageLoadMode.Refresh){f.logic.search();window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){f.logic.search();window.pageLoadMode=PageLoadMode.None}}}})},closeLayer:function(h){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(c)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{equipOwner:{required:true},drtDeptCode:{required:true}}})}}};f.init();window.page=f});