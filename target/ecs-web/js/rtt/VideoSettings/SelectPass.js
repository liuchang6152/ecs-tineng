var delUrl=ECS.api.bcUrl+"/user";var searchUrl=ECS.api.bcUrl+"/user";var inUseUrl=ECS.api.commonUrl+"/getInUse";var exportUrl=ECS.api.bcUrl+"/user/ExportToExcel";var porg_url=ECS.api.rttUrl+"/videoSurveullance/getTreeRoot?userName=emergency";var org_url=ECS.api.bcUrl+"/org/porgNameOne";var postNames_url=ECS.api.bcUrl+"/user/getAllPost";var userSex_url=ECS.api.rttUrl+"/expert/getExpertSexEnumList";var userLvl_url=ECS.api.bcUrl+"/user/getAllUserLvl";var userNature_url=ECS.api.bcUrl+"/user/getAllUserNature";window.pageLoadMode=PageLoadMode.None;pageflag=true;pageflag=true;redisKey="";var grid=null;var getNode="-1";var isHiden=true;var flag=false;var passageway;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();$("#searchForm").find("input").val("");b.logic.initTable()},table:{},bindUI:function(){$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#btnSave").on("click",function(){b.logic.save()});$("#btnExport").click(function(){b.data.param={};b.data.param=ECS.form.getData("searchForm");if(b.data.param.inUse=="-1"){b.data.param.inUse=""}if(mini.get("tree1").getSelectedNode()){b.data.param.orgId=mini.get("tree1").getSelectedNode().orgId}else{b.data.param.orgId=mini.get("tree1").data[0].orgId}if(b.data.param.orgId==-1){b.data.param.orgId=""}var c=b.logic.setUrlK(b.data.param);window.open(exportUrl+"?"+c)});$("#btnToggle").click(function(){if(flag){flag=!flag;$(this).html('<i class="icon-showMore"></i>');$(".search-unfixed").hide()}else{flag=!flag;$(this).html('<i class="icon-hideMore"></i>');$(".search-unfixed").show()}});mini.get("tree1").on("nodeclick",function(g,c){console.log(g);var h=g.params;var f=mini.get("#tree1").getAncestors(g.node);var d="";if(f.length==0){d=g.node.text}else{for(i=0;i<f.length;i++){d=d+f[i].text+"/"}d=d+g.node.text}var j=null;if(f.length>0){j=f[0].id}else{j="0"}$.ajax({url:ECS.api.rttUrl+"/videoSurveullance/getTreeOrgAndChannel?userName=emergency&type=1&id="+mini.get("tree1").getSelectedNode().id,type:"GET",success:function(l){console.log(l);if(l.length==0){$("#filesView").html("");$.ajax({async:false,url:ECS.api.rttUrl+"/videoSurveullance/getVideoByChannels?userName=emergency&id="+mini.get("tree1").getSelectedNode().id,type:"GET",dataType:"text",success:function(o){var q=JSON.parse(o);console.log(q);if(q.length!=0){$("#filesDataView").show();for(var n=0;n<q.length;n++){var p;if(q[n].address!=""){p='<div class="position"><input type="radio" name="bizType" class="itemInput" key="'+q[n].channel+'" checed="true" /><span class="nsSpan">'+q[n].name+"</span></br><span>"+q[n].address+"</span></div>"}else{p='<div class="position"><input type="radio" name="bizType" class="itemInput" key="'+q[n].channel+'" checed="false"/><span class="nsSpan">'+q[n].name+"</span></br><span>"+q[n].address+"</span></div>"}$("#filesView").append(p)}$(":radio[name=bizType]").each(function(){$(this).click(function(){if($(this).attr("checked")){$(":radio[name=bizType]").removeAttr("checked");$(this).attr("checked","checked");console.log(passageway=$(this).attr("key"));passageway=$(this).attr("key")}})})}},error:function(n){alert(n)}})}else{$("#filesDataView").hide()}var e=mini.get("tree1");var m=e.getSelectedNode();for(var k=0;k<l.length;k++){e.addNode(l[k],"add",m)}},error:function(){}})});$("#btnQuery2").click(function(){var c=$.trim($("#tree_val").find("input").val());if(c==""||c=="全部"){mini.get("tree1").clearFilter()}else{c=c.toLowerCase();mini.get("tree1").filter(function(d){var e=d.orgSname?d.orgSname.toLowerCase():"";if(e.indexOf(c)!=-1){return true}})}});$(".btn-toggle").click(function(){if(isHiden){$(".leftNav-body").hide();$(".box-body").css("margin-left","0");$(this).css({left:"0",transform:"rotate(180deg)"})}else{$(".leftNav-body").show();$(".box-body").css("margin-left","280px");$(this).css({left:"263px",transform:"rotate(0deg)"})}isHiden=!isHiden;b.logic.search()})},data:{param:{}},logic:{closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},save:function(){parent.passDetail=passageway;window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},onBeforeTreeLoad:function(f){console.log(f);var c=f.sender;var d=f.node;var g=f.params;g.myField="123"},showFiles:function(c){console.log(ECS.api.rttUrl+"/videoSurveullance/getTreeOrgAndChannel?userName=emergency&type=0&id="+mini.get("tree1"));$.ajax({url:ECS.api.rttUrl+"/videoSurveullance/getTreeOrgAndChannel?userName=emergency&type=0&id="+mini.get("tree1").getSelectedNode().id,type:"GET",success:function(d){console.log(d);var e=mini.decode(d);refreshFiles(e)},error:function(){}})},setUrlK:function(g){var e="",c,d;for(var f in g){if(g.hasOwnProperty(f)){c=f}d=g[f];e+="&"+c+"="+encodeURIComponent(d)}return e.substring(1,e.length)},initTable:function(){b.logic.load_sidebar()},show_edit:function(c){return ECS.util.editRender(c.row.userID)},birthdate:function(c){return ECS.util.timestampToTime(c.row.userBirthday)},workdate:function(c){return ECS.util.timestampToTime(c.row.userJoinDatetime)},load_sidebar:function(){$.ajax({url:porg_url,type:"GET",success:function(c){if(c.length>0){mini.get("tree1").loadList(c,"id","pId");mini.get("tree1").setValue(ECS.sys.Context.SYS_ENTERPRISE_CODE)}else{layer.msg("暂无数据！")}},error:function(){}})},select_option:function(c,d){$.ajax({url:c,type:"GET",success:function(g){$(d).html("");var e=$('<option value="">全部</option>');$(d).append(e);for(var f=0;f<g.length;f++){(function(j){if(j.postID){var h=$('<option value="'+j.postID+'">'+j.postName+"</option>")}if(j.key||j.key==0){var h=$('<option value="'+j.key+'">'+j.value+"</option>")}if(j.UserAttributeID){var h=$('<option value="'+j.UserAttributeID+'">'+j.userAttribute+"</option>")}if(j.userLvlID){var h=$('<option value="'+j.userLvlID+'">'+j.userLvl+"</option>")}if(j.userNatureID){var h=$('<option value="'+j.userNatureID+'">'+j.userNature+"</option>")}$(d).append(h)})(g[f])}}})},delAll:function(){var c=new Array();var d=grid.getSelecteds();$.each(d,function(e,f){c.push(f.userID)});if(c.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:false,data:JSON.stringify(c),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(e){ECS.hideLoading();if(e.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){b.logic.search()})}else{e=JSON.parse(e);layer.msg(e.collection.error.message)}},error:function(e){ECS.hideLoading();var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},function(e){layer.close(e)})},add:function(){var c=PageModelEnum.NewAdd;var d="应急联系人新增";b.logic.detail(d,"",c)},edit:function(c){var d=PageModelEnum.Edit;var e="应急联系人编辑";b.logic.detail(e,c,d)},detail:function(e,c,d){layer.open({type:2,closeBtn:0,area:["980px","410px"],skin:"new-class",shadeClose:false,title:false,content:"UserAddOrEdit.html?"+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var k=window[g.find("iframe")[0]["name"]];var j={pageMode:d,userID:c,title:e,getNode:getNode};k.page.logic.setData(j)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){b.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){b.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},search:function(c){b.data.param={};b.data.param=ECS.form.getData("searchForm");if(c){b.data.param.sortType="1"}if(b.data.param.inUse=="-1"){b.data.param.inUse=""}if(mini.get("tree1").getSelectedNode()){b.data.param.id=mini.get("tree1").getSelectedNode().id}else{b.data.param.id=mini.get("tree1").data[0].id}if(b.data.param.id==-1){b.data.param.id=""}},imp:function(){var d=ECS.api.bcUrl+"/user/importExcel";var c=ECS.api.bcUrl+"/user/ExportExcel";var f=ECS.api.bcUrl+"/user/importAddAll";var e="../UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(d,c,f,e)}}};b.init();window.page=b});