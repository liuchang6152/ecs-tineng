var searchUrl=ECS.api.rttUrl+"/emergencyPlan";var addUrl=ECS.api.apUrl+"/DisposeWarning/RelatedPlan";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var PlanDefinition_url=ECS.api.rttUrl+"/emergencyPlan/enum?enumName=PlanDefinition&isAll=true";var PlanLevel_url=ECS.api.rttUrl+"/emergencyPlan/enum?enumName=PlanLevel&isAll=true";var Category_url=ECS.api.bcUrl+"/accidentCategory/list";var Category_url2=ECS.api.bcUrl+"/accidentCategory/accidentType";var getOrgIdUrl=ECS.api.bcUrl+"/org/getOrgIdByCode";var orgId=null;var grid=null;var planDefinition=null;var EventId=null;window.ownDetail;var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){b.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnDel").click(function(){b.logic.delAll()});$("#btnQuery").click(function(){b.logic.search()});$("#btnReset").click(function(){b.logic.clear_val()});$("#accidentCategoryID").on("change",function(){b.logic.category_menu2()});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)})},data:{param:{},cate_dt:[]},logic:{save:function(){var e="POST";window.pageLoadMode=PageLoadMode.Reload;var c=new Array();var d=grid.getSelecteds();if(d.length==0){layer.msg("请勾选您要的预案选项！");return false}$.each(d,function(f,g){var h={};h.relatedPlanId=null;h.emergencyPlanId=g.emergencyPlanID;h.emergencyPlanName=g.emergencyPlanName;h.eventId=EventId;h.isUsed=0;h.planDefinition=g.planDefinition;c.push(h)});$.ajax({url:addUrl,async:false,type:e,timeout:5000,data:JSON.stringify(c),dataType:"text",contentType:"application/json;charset=utf-8",success:function(f){console.log("返回的数据状态：",f);if(f.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(f.collection.error.message)}},error:function(f){if(f){var g=$.parseJSON(f.responseText);layer.msg(g.collection.error.message)}}})},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;planDefinition=c.planDefinition;EventId=c.EventId;ECS.sys.RefreshContextFromSYS();b.bindUI();b.logic.GetOrgId(function(){b.logic.initTable()})},initTable:function(){grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"});b.logic.select_option(riskAreaTypeNameUrl,"orgID",function(){b.logic.category_menu(function(){b.logic.category_menu2();b.logic.search(true)})});b.logic.planDefinition_menu(function(){$("#planDefinition").val(planDefinition);$("#planDefinition").attr("disabled","disabled")});b.logic.planLevel_menu()},GetOrgId:function(c){$.ajax({url:getOrgIdUrl+"?orgCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE,type:"GET",timeout:5000,success:function(d){orgId=d.orgId;c&&c()}})},clear_val:function(){$("#emergencyPlanName").val("");$("#planDefinition").val("");$("#planLevel").val("");$("#accidentCategoryID").val("");$("#accidentTypeID").val("");b.logic.search(true)},select_option:function(d,e,c){$.ajax({url:d,type:"get",success:function(g){mini.get("orgID").loadList(g,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){mini.get("orgID").setValue(mini.get("orgID").data[0].orgCode);orgId=mini.get("orgID").data[0].orgId}else{mini.get("orgID").disable();for(var f=0;f<g.length;f++){(function(h){if(h.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("orgID").setValue(h.orgSname);orgId=h.orgId}})(g[f])}}c&&c()}})},planDefinition_menu:function(c){$.ajax({url:PlanDefinition_url,type:"get",success:function(e){$("#planDefinition").html("");for(var d=0;d<e.length;d++){(function(g){var f='<option value="'+(g.key==null?"":g.key)+'">'+g.value+"</option>";$("#planDefinition").append(f)})(e[d])}$("#planDefinition").val("");c&&c()}})},planLevel_menu:function(){$.ajax({url:PlanLevel_url,type:"get",success:function(d){$("#planLevel").html("");for(var c=0;c<d.length;c++){(function(f){var e='<option value="'+(f.key==null?"":f.key)+'">'+f.value+"</option>";$("#planLevel").append(e)})(d[c])}$("#planLevel").val("")}})},category_menu:function(c){$.ajax({url:Category_url,type:"get",success:function(e){$("#accidentCategoryID").html("");var f='<option value="">全部</option>';$("#accidentCategoryID").append(f);for(var d=0;d<e.length;d++){(function(h){var g='<option value="'+h.accidentCategoryID+'">'+h.accidentCategoryName+"</option>";$("#accidentCategoryID").append(g)})(e[d])}b.data.cate_dt=e;c&&c()}})},category_menu2:function(c){if($("#accidentCategoryID").val()){$.ajax({url:Category_url2+"?accidentCategoryID="+$("#accidentCategoryID").val(),type:"get",success:function(f){$("#accidentTypeID").html("");var g='<option value="">全部</option>';$("#accidentTypeID").append(g);for(var e=0;e<f.length;e++){(function(i){var h='<option value="'+i.accidentTypeID+'">'+i.accidentTypeName+"</option>";$("#accidentTypeID").append(h)})(f[e])}c&&c()}})}else{$("#accidentTypeID").html("");var d='<option value="">全部</option>';$("#accidentTypeID").append(d);c&&c()}},cate_type:function(c){if(c.row.accidentTypeName){return c.row.accidentTypeName.join(",")}else{return"空"}},cate_method:function(f){var d="无";if(f.row.accidentCategoryID){for(var c=0;c<b.data.cate_dt.length;c++){(function(e){if(e.accidentCategoryID==f.row.accidentCategoryID){d=e.accidentCategoryName}})(b.data.cate_dt[c])}}return d},search:function(c){b.data.param={};b.data.param=ECS.form.getData("searchForm");if(c){b.data.param.sortType=1}if(mini.get("orgID").getSelectedNode()){b.data.param.orgID=mini.get("orgID").getSelectedNode().orgId}else{b.data.param.orgID=orgId}b.data.param.planDefinition=planDefinition;grid.load(b.data.param)},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)}}};b.init();window.page=b});