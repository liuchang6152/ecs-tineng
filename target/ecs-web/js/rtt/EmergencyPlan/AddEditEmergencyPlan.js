var addUrl=ECS.api.rttUrl+"/emergencyPlan";var getSingleUrl=ECS.api.rttUrl+"/emergencyPlan/oneEmergencyPlan";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var PlanDefinition_url=ECS.api.rttUrl+"/emergencyPlan/enum?enumName=PlanDefinition";var PlanLevel_url=ECS.api.rttUrl+"/emergencyPlan/enum?enumName=PlanLevel";var Category_url=ECS.api.bcUrl+"/accidentCategory/list";var Category_url2=ECS.api.rttUrl+"/emergencyPlan/accidentType";var getOrgIdUrl=ECS.api.bcUrl+"/org/getOrgIdByCode";var FileDownLoadUrl=ECS.api.rttUrl+"/structuredplanfile/downloadFile";var orgId="";var save_once=false;var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var grid=null;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();grid=mini.get("grid1");grid.on("drawcell",function(j){var i=j.field;var f=j.record;var g=f._uid;var h=j.value;if(i=="status"){if(f.status=="等待上传"){}else{if(f.status=="已完成"){}else{if(f.status=="上传成功"){}else{j.cellHtml='<div class="progressbar"><div class="progressbar-percent" style="width:'+h+'%;"></div><div class="progressbar-label">'+h+"%</div></div>"}}}}if(i=="action"){if(f.action=="ok"){j.cellHtml='<a class="upicon-remove" name="'+g+'"><a>'}}});var d=WebUploader.create({swf:"../../../lib/webuploader/swfupload.swf",server:ECS.api.rttUrl+"/emergencyPlan/upLoad",pick:"#uploadPlaceholder",resize:false,auto:true,formData:{owner:"webuploader.webuploader"},fileVal:"file",fileSingleSizeLimit:50*1024*1024});d.on("fileQueued",function(f){var e=c(f.size);var g={fileId:f.id,atchName:f.name,type:f.ext,size:e,status:"等待上传"};grid.addRow(g)});d.on("uploadProgress",function(f,e){var g=grid.findRow(function(h){if(h.fileId==f.id){return true}});grid.updateRow(g,{status:e})});d.on("uploadSuccess",function(f,e){var g=grid.findRow(function(h){if(h.fileId==f.id){return true}});grid.updateRow(g,{status:"上传成功",action:"ok",atchID:e})});d.on("uploadError",function(e,f){var g=grid.findRow(function(h){if(h.fileId==e.id){return true}});grid.updateRow(g,{status:"上传出错"})});d.on("uploadComplete",function(e){d.removeFile(e,true)});d.on("startUpload",function(){mini.get("beginBtn").setEnabled(false)});d.on("uploadFinished",function(){mini.get("beginBtn").setEnabled(true)});d.on("error",function(g,e,f){if(g=="Q_TYPE_DENIED"){mini.alert("请上传正确格式文件")}else{if(g=="Q_EXCEED_SIZE_LIMIT"){mini.alert("文件["+f.name+"]大小超出限制值")}else{if(g=="F_EXCEED_SIZE"){mini.alert("上传的该文件大小超过了最大限制50M,无法上传")}}}});function c(e){if(e==="空"){return"空"}if(e===0){return"0 B"}var f=1024,h=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],g=Math.floor(Math.log(e)/Math.log(f));return(e/Math.pow(f,g)).toPrecision(3)+" "+h[g]}$(document.body).on("click",".upicon-remove",function(g){if(pageMode==PageModelEnum.View){return false}var f=$(this).attr("name");var h=grid.getRowByUID(f);grid.removeRow(h)})},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#accidentCategoryID").on("change",function(){b.logic.category_menu2()})},data:{plandefinition_dt:{"0":"综合预案","1":"专项预案","2":"现场处置预案"},planlevel_dt:{"0":"中国石化级","1":"直属企业级","2":"二级单位级","3":"基层单位级"}},logic:{save:function(){if(save_once){layer.msg("正在保存！")}var c=/^[0-9a-zA-Z\u4e00-\u9fa5]+(_?\s?[0-9a-zA-Z\u4e00-\u9fa5]{0,})+$/;if(!c.test($("#emergencyPlanName").val())){layer.msg('"预案名称"只能输入中英文以及下划线或者空格！');return}var j=ECS.form.getData("AddOrEditModal");j.orgID=orgId;if($("#accidentCategoryID").val()==-1){layer.msg("请选择预案分类");return}else{j.accidentCategoryID=$("#accidentCategoryID").val()}var i="";if($.trim(mini.get("accidentTypeID").getValue())==""||$.trim(mini.get("accidentTypeID").getValue())=="请选择"){layer.msg("请选择预案类型");return}else{var k=mini.get("accidentTypeID").getSelecteds();var f=[];for(var l=0;l<k.length;l++){f.push(k[l].accidentTypeID)}if(f.length>0){i=f.join(",")}else{i=""}}var e=grid.getData();var d="";if(e.length>0){var h=[];for(var m=0;m<e.length;m++){if(e[m]["atchID"]){h.push(e[m]["atchID"])}}if(h.length>0){d=h.join(",")}else{d=""}if(d==""){layer.msg("您正在上传文件，请稍后进行保存！");return}}else{layer.msg("请至少选择一个文件上传，您目前没有选择文件，无法进行保存！");return}delete j.enterpriseCode;delete j.file;delete j.crtDate;delete j.crtUserName;delete j.atchID;delete j.accidentTypeID;var g="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){g="PUT";window.pageLoadMode=PageLoadMode.Refresh}}ECS.showLoading();save_once=true;$.ajax({url:addUrl+"?accidentTypeID="+i+"&atchID="+d,async:false,type:g,data:JSON.stringify(j),dataType:"text",contentType:"application/json;charset=utf-8",success:function(o){ECS.hideLoading();var n=JSON.parse(o);console.log("返回的信息：",n.message);if(n.isSuccess){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(n.message)}},error:function(n){ECS.hideLoading();var o=$.parseJSON(n.responseText);console.log("返回的错误信息：",o);layer.msg(o.collection.error.message)}})},GetOrgId:function(c){$.ajax({url:getOrgIdUrl+"?orgCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE,type:"GET",timeout:5000,success:function(d){orgId=d.orgId;c&&c()}})},file_download:function(c){return'<a href="'+FileDownLoadUrl+"?atchPath="+c.record.atchPath+"&atchName="+c.record.atchName+'" class="ml__5">'+c.record.atchName+"</a>"},setData:function(g){$("#title-main").text(g.title);pageMode=g.pageMode;$("#enterpriseCode input").css("color","#555555");if(pageMode==PageModelEnum.NewAdd){b.logic.select_option(riskAreaTypeNameUrl,"enterpriseCode",function(){});b.logic.planDefinition_menu();b.logic.planLevel_menu();b.logic.category_menu(function(){mini.get("accidentTypeID").setValue("请选择")});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);var e=new Date,f=e.getFullYear(),c=e.getMonth()+1,d=e.getDate();$("#crtDate").val(f+"-"+c+"-"+d);return}if(pageMode==PageModelEnum.Edit){$("#enterpriseCode").attr("disabled","disabled")}if(pageMode==PageModelEnum.View){b.logic.disable_all()}$.ajax({url:getSingleUrl+"?emergencyPlanID="+g.emergencyPlanID+"&now="+Math.random(),type:"get",async:true,dataType:"json",success:function(i){ECS.form.setData("AddOrEditModal",i);b.logic.select_option(riskAreaTypeNameUrl,"enterpriseCode",function(){orgId=i.orgID;mini.get("enterpriseCode").setValue(i.orgSname)});b.logic.planDefinition_menu(function(){$("#planDefinition").val(i.planDefinition)});b.logic.planLevel_menu(function(){$("#planLevel").val(i.planLevel)});b.logic.category_menu(function(){$("#accidentCategoryID").val(i.accidentCategoryID);b.logic.category_menu2(function(){var l="";if(i.accidentTypeEntity){for(var k=0;k<i.accidentTypeEntity.length;k++){(function(m){if(k==i.accidentTypeEntity.length-1){l+=m.accidentTypeID}else{l+=m.accidentTypeID+","}})(i.accidentTypeEntity[k])}}mini.get("accidentTypeID").setValue(l)})});if(i.attachmentEntities){var h=[];for(var j=0;j<i.attachmentEntities.length;j++){(function(m){var l={};l.atchName=m.atchName;l.atchID=m.atchID;l.type=m.atchName.split(".")[1];l.atchPath=m.atchPath;if((m.atchSize/1024).toFixed(1)>1024){var k=(m.atchSize/1024).toFixed(1);l.size=(k/1024).toFixed(1)+"Mb"}else{l.size=(m.atchSize/1024).toFixed(1)+"Kb"}l.action="ok";l.status="上传成功";h.push(l)})(i.attachmentEntities[j])}grid.addRows(h)}$("#crtDate").val(ECS.util.timestampToTime(i.crtDate))},error:function(h){var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},disable_all:function(){$("#emergencyPlanName").attr("disabled","disabled");mini.get("enterpriseCode").disable();$("#planDefinition").attr("disabled","disabled");$("#planLevel").attr("disabled","disabled");$("#accidentCategoryID").attr("disabled","disabled");mini.get("accidentTypeID").disable();$("#remark").attr("disabled","disabled");$("#uploadPlaceholder").remove();$("#beginBtn").css({background:"#ccc",color:"white"});$("#btnSave").hide()},onCloseClick:function(d){var c=d.sender;c.setText("");c.setValue("")},planDefinition_menu:function(c){$.ajax({url:PlanDefinition_url,type:"get",success:function(f){$("#planDefinition").html("");var e='<option value="">请选择</option>';$("#planDefinition").append(e);for(var d=0;d<f.length;d++){(function(h){var g='<option value="'+(h.key==null?"":h.key)+'">'+h.value+"</option>";$("#planDefinition").append(g)})(f[d])}c&&c()}})},planLevel_menu:function(c){$.ajax({url:PlanLevel_url,type:"get",success:function(f){$("#planLevel").html("");var e='<option value="">请选择</option>';$("#planLevel").append(e);for(var d=0;d<f.length;d++){(function(h){var g='<option value="'+(h.key==null?"":h.key)+'">'+h.value+"</option>";$("#planLevel").append(g)})(f[d])}c&&c()}})},category_menu:function(c){$.ajax({url:Category_url,type:"get",success:function(e){$("#accidentCategoryID").html("");for(var d=0;d<e.length;d++){(function(g){var f='<option value="'+g.accidentCategoryID+'">'+g.accidentCategoryName+"</option>";$("#accidentCategoryID").append(f)})(e[d])}c&&c()}})},category_menu2:function(c){if($("#accidentCategoryID").val()){$.ajax({url:Category_url2+"?accidentCategoryID="+$("#accidentCategoryID").val(),type:"get",success:function(d){mini.get("accidentTypeID").load(d);c&&c()}})}},select_option:function(d,e,c){$.ajax({url:d,type:"get",success:function(g){mini.get("enterpriseCode").loadList(g,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname);orgId=mini.get("enterpriseCode").data[0].orgId}else{mini.get("enterpriseCode").disable();for(var f=0;f<g.length;f++){(function(h){if(h.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(h.orgSname);orgId=h.orgId}})(g[f])}}c&&c()}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{name:{required:true,rangelength:[0,100]},sname:{required:true,rangelength:[0,100]},stdCode:{required:true,rangelength:[0,100]}}})}}};b.init();window.page=b});