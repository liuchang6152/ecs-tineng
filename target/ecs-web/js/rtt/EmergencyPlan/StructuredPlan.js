var leftMenuUrl=ECS.api.rttUrl+"/structuredplancategory";var leftDelUrl=ECS.api.rttUrl+"/structuredplancategory";var aPositionList=[];var stateUrl=ECS.api.rttUrl+"/disposalsteps/satelist";var sendOrdersUrl=ECS.api.apUrl+"/relatedplanexecuted";var addRootUrl=ECS.api.rttUrl+"/structuredplancategory";var dutyInintUrl=ECS.api.rttUrl+"/emergencyduties";var dutyaddUrl=ECS.api.rttUrl+"/emergencyduties";var dutydelUrl=ECS.api.rttUrl+"/emergencyduties";var DisposalInitUrl=ECS.api.rttUrl+"/disposalsteps";var DisposaladdUrl=ECS.api.rttUrl+"/disposalsteps";var DisposaldelUrl=ECS.api.rttUrl+"/disposalsteps";var ResponseListUrl=ECS.api.rttUrl+"/disposalsteps/feedbackMethodList";var FileInitUrl=ECS.api.rttUrl+"/structuredplanfile";var FileUploadUrl=ECS.api.rttUrl+"/structuredplanfile/uploadFile";var FileDelUrl=ECS.api.rttUrl+"/structuredplanfile";var FileAddUrl=ECS.api.rttUrl+"/structuredplanfile";var FileDownLoadUrl=ECS.api.rttUrl+"/structuredplanfile/downloadFile";var emergencyPlanID="";var emergencyPlanName="";var grid1=null;var grid2=null;var grid3=null;var grid4=null;var grid5=null;var grid6=null;var structuredPlanCategoryId="";var CurRow=null;var IsOnlyRead=false;var IsCanClick=true;window.ownDetail;var eventId;var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();grid1=mini.get("datagrid1");grid2=mini.get("datagrid2");grid3=mini.get("datagrid3");grid4=mini.get("datagrid4");grid5=mini.get("datagrid5");grid6=mini.get("datagrid6");this.bindUI();b.logic.statelist();b.logic.statelists()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.Reload;b.logic.closeLayer(false)});$("#btnSend").click(function(){b.logic.sendOrders()});$("#btnQuerys").click(function(){grid4.load({state:$("#states").val()})});$("#btnQuery").click(function(){grid5.load({state:$("#state").val()})});$("#call_btn").hover(function(){$(this).css("background","#0b93d9")},function(){$(this).css("background","#45c8dc")});$("#call_btn").click(function(){b.logic.ShowEmergencyPlan()});$("#btnDel,#btnDel2,#btnDel3").click(function(){b.logic.delAll()});$("#btnAdd,#btnAdd2,#btnAdd3").click(function(){b.logic.newRow()});$("#add_one_node").on("click",function(){if(!IsOnlyRead){b.logic.AddOneNode()}});mini.get("tree1").on("nodeclick",function(c){structuredPlanCategoryId=c.node.structuredPlanCategoryId;b.logic.reload_table()});$("#datagrid3").on("click",function(f){var d=$(f.target);if(d.hasClass("uploadPlaceholder")&&!d.attr("id")){layer.msg("当前行不处于编辑状态，您无法进行操作！")}if(d.hasClass("upicon-remove")){var c=grid3.getRowByUID(d.attr("uid"));if(grid3.isEditingRow(c)){d.parent().find("a").attr("href","javascript:;");d.parent().find("a").html("");d.hide();grid3.updateRow(c,{atchName:"",atchPath:"",atchSize:""});b.logic.editRow(d.attr("uid"))}else{layer.msg("当前行不处于编辑状态，您无法进行操作！")}}})},data:{param:{},aResponseList:[],FileType:[{id:17,text:"流程图"},{id:18,text:"消防部署图"}]},logic:{save:function(){var c="PUT";window.pageLoadMode=PageLoadMode.Reload},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;emergencyPlanID=c.emergencyPlanID;emergencyPlanName=c.emergencyPlanName;IsOnlyRead=c.IsOnlyRead?c.IsOnlyRead:false;eventId=c.eventID?c.eventID:"";$(".bread_title").html(emergencyPlanName);ECS.sys.RefreshContextFromSYS();b.logic.page_set_model();b.logic.load_sidebar(function(){if(!structuredPlanCategoryId){return false}if(IsOnlyRead){b.logic.onlyRead_load()}else{b.logic.canAction_load()}})},onlyRead_load:function(){grid4.set({ajaxType:"get",url:dutyInintUrl+"/executelist?eventId="+eventId+"&emergencyPlanId="+emergencyPlanID+"&structuredPlanCategoryId="+structuredPlanCategoryId});grid4.load({state:$("#states").val()});grid5.set({ajaxType:"get",url:DisposalInitUrl+"/executelist?structuredPlanCategoryId="+structuredPlanCategoryId+"&emergencyPlanId="+emergencyPlanID+"&eventId="+eventId});grid5.load({state:$("#state").val()});grid5.on("beforeselect",function(c){if(c.record.state==1){c.cancel=true}});grid6.set({ajaxType:"get",url:FileInitUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});grid6.load()},canAction_load:function(){grid1.set({ajaxType:"get",url:dutyInintUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});grid1.load();grid2.set({ajaxType:"get",url:DisposalInitUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});b.logic.load_responese_dt(function(){grid2.load()});grid3.set({ajaxType:"get",url:FileInitUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});grid3.load()},page_set_model:function(){if(IsOnlyRead){$(".box-tools,#datagrid1,#datagrid2,#datagrid3").hide();$("#datagrid4,#datagrid5,#datagrid6").show();$("#upload_ts").hide();$(".search-tools").show();$("#nav_tabs li").removeClass("active");$("#nav_tabs li").eq(1).addClass("active");$(".tab-content .tab-pane").removeClass("active");$(".tab-content .tab-pane").eq(1).addClass("active")}else{$(".box-tools,#datagrid1,#datagrid2,#datagrid3").show();$("#datagrid4,#datagrid5,#datagrid6").hide();$("#upload_ts").show();$(".search-tools").hide()}},reload_table:function(){if(IsOnlyRead){grid4.set({ajaxType:"get",url:dutyInintUrl+"/executelist?eventId="+eventId+"&emergencyPlanId="+emergencyPlanID+"&structuredPlanCategoryId="+structuredPlanCategoryId});grid4.load({state:$("#states").val()});grid5.set({ajaxType:"get",url:DisposalInitUrl+"/executelist?structuredPlanCategoryId="+structuredPlanCategoryId+"&emergencyPlanId="+emergencyPlanID+"&eventId="+eventId});grid5.load({state:$("#state").val()});grid5.on("beforeselect",function(c){if(c.record.state==1){c.cancel=true}});grid6.set({ajaxType:"get",url:FileInitUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});grid6.load()}else{grid1.set({ajaxType:"get",url:dutyInintUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});grid1.load();grid2.set({ajaxType:"get",url:DisposalInitUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});b.logic.load_responese_dt(function(){grid2.load()});grid3.set({ajaxType:"get",url:FileInitUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});grid3.load()}},statelist:function(){ECS.ui.getCombobox("state",stateUrl,{selectValue:"",async:false},null)},statelists:function(){ECS.ui.getCombobox("states",stateUrl,{selectValue:"",async:false},null)},sendOrders:function(){if($("[name=sendType]:checked").length==0){layer.msg("请选择下达命令类型!");return}var e="";if($("[name=sendType]:checked").length==2){e="1,2"}else{if($("#msg").is(":checked")){e="1"}else{if($("#voice").is(":checked")){e="2"}}}var c=[];var d=grid5.getSelecteds();$.each(d,function(f,g){c.push({relatedPlanExecutedId:"",exectutedId:g.disposalStepsId,emergencyPlanId:emergencyPlanID,emergencyPlanName:"",eventId:eventId,executedType:1,crtDate:"",sortNum:"1",isDelete:"0",sendStateParam:e})});if(c.length==0){layer.msg("请选择要下达命令的数据!");return}$.ajax({url:sendOrdersUrl,async:false,type:"POST",data:JSON.stringify(c),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(f){ECS.hideLoading();if(f.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){grid5.reload()})}else{layer.msg(f.collection.error.message)}},error:function(f){$("#btnSave").attr("disabled",false);ECS.hideLoading();var g=$.parseJSON(f.responseText);layer.msg(g.collection.error.message)}})},send:function(d,e,c){layer.open({type:2,closeBtn:0,area:["800px","500px"],skin:"new-class",shadeClose:false,title:false,content:"../../em/MsgTrack/detail.html?r="+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var j=window[g.find("iframe")[0]["name"]];var i={msgID:d,msgContent:e,businessModelId:"35",systemId:c,title:"通知反馈记录"};j.page.logic.setData(i)},end:function(f){if(f){grid.record()}}})},onAddBefore:function(f){var c=mini.get("tree1");var d=c.getSelectedNode();b.logic.add(d.structuredPlanCategoryPid,c.getParentNode(d).emergencyPlanName)},onAddNode:function(f){var c=mini.get("tree1");var d=c.getSelectedNode();b.logic.add(d.structuredPlanCategoryId,d.emergencyPlanName,function(e,g){b.logic.load_sidebar()})},onEditNode:function(f){var c=mini.get("tree1");var d=c.getSelectedNode();b.logic.edit(d.structuredPlanCategoryId,d.structuredPlanCategoryPid)},onRemoveNode:function(f){var c=mini.get("tree1");var d=c.getSelectedNode();b.logic.delSingle(d.structuredPlanCategoryId)},delSingle:function(c){if(confirm("确定删除此节点？")){layer.msg("删除中……");$.ajax({url:leftDelUrl,async:true,dataType:"text",timeout:1000,data:JSON.stringify([c]),contentType:"application/json;charset=utf-8",type:"DELETE",success:function(e){var d=JSON.parse(e);layer.msg(d.message);if(d.isSuccess){b.logic.load_sidebar()}},error:function(){}})}},onBeforeOpen:function(h){var j=h.sender;var c=mini.get("tree1");var g=c.getSelectedNode();if(!g){h.cancel=true;return}if(IsOnlyRead){h.cancel=true;return}switch(mini.get("tree1").getLevel(g)){case 0:$("#mini-16").show();$("#add_list").find(".mini-menuitem").eq(0).show();if(g.emergencyPlanName==emergencyPlanName){$("#del_node").hide()}else{$("#del_node").show()}break;case 1:$("#mini-16").show();$("#add_list").find(".mini-menuitem").eq(0).show();$("#del_node").show();break;case 2:$("#mini-16").hide();$("#del_node").show();break}var f=mini.getbyName("edit",j);var i=mini.getbyName("remove",j);f.show();i.enable();if(g.structuredPlanCategoryId=="-1"){f.enable();i.enable()}var d=h||window.event;if(d.stopPropagation){d.stopPropagation()}else{d.cancelBubble=true}},add:function(g,d,c){var e=PageModelEnum.NewAdd;var f="新增处置类别";if(g){b.logic.detail(f,"",e,g,d,"",c)}else{b.logic.detail(f,"",e)}},edit:function(d,g,c){var e=PageModelEnum.Edit;var f="编辑处置类别";if(g){b.logic.detail(f,d,e,g,"","",c)}else{b.logic.detail(f,d,e)}},detail:function(h,d,f,i,e,g,c){layer.open({type:2,closeBtn:0,area:["550px","250px"],skin:"new-class",shadeClose:false,title:false,content:"AddEditLevel.html?"+Math.random(),success:function(k,l){var j=layer.getChildFrame("body",l);var n=window[k.find("iframe")[0]["name"]];var m={pageMode:f,Id:d,Name:g?g:"",PID:i,emergencyPlanID:emergencyPlanID,ParentName:e,title:h};n.page.logic.setData(m)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){$("#add_one_node").hide();b.logic.load_sidebar();c&&c();window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){$("#add_one_node").hide();b.logic.load_sidebar();c&&c();window.pageLoadMode=PageLoadMode.None}}}})},ShowEmergencyPlan:function(){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"./../../ap/AutoHandlingCommon/ShowEmergencyPlan.html?"+Math.random(),success:function(d,e){var c=layer.getChildFrame("body",e);var g=window[d.find("iframe")[0]["name"]];var f={emergencyPlanID:emergencyPlanID,checkMode:false,title:"查看应急预案",isToggle:!IsOnlyRead};g.page.logic.setData(f)}})},onActionRenderer:function(h){var d=h.sender;var c=h.record;var f=c._uid;var i=h.rowIndex;var g='<a class="New_Button" href="javascript:page.logic.newRow()">新增</a> <a class="Edit_Button" href="javascript:page.logic.editRow(\''+f+'\')" >编辑</a> <a class="Delete_Button" href="javascript:page.logic.delRow(\''+f+"')\">删除</a>";if(d.isEditingRow(c)){g='<a class="Update_Button" style="margin-right:10px;" href="javascript:page.logic.updateRow(\''+f+'\')">更新</a><a class="Cancel_Button" href="javascript:page.logic.cancelRow(\''+f+"')\">取消</a>"}return g},newRow:function(){if(!structuredPlanCategoryId){layer.msg("请先添加根节点！");return false}var c={};if($("#nav_tabs").find("li.active").index()==0){grid1.addRow(c,0);grid1.cancelEdit();grid1.beginEditRow(c)}else{if($("#nav_tabs").find("li.active").index()==1){grid2.addRow(c,0);grid2.cancelEdit();grid2.beginEditRow(c)}else{if($("#nav_tabs").find("li.active").index()==2){grid3.addRow(c,0);grid3.cancelEdit();grid3.beginEditRow(c);$("#datagrid3 tr").each(function(){if($(this).hasClass("mini-grid-rowEdit")){$(this).find(".uploadPlaceholder").attr("id","uploadPlaceholder")}else{$(this).find(".uploadPlaceholder").removeAttr("id")}});b.logic.fileUpload_init()}}}},editRow:function(c){if($("#nav_tabs").find("li.active").index()==0){var d=grid1.getRowByUID(c);if(d){grid1.cancelEdit();grid1.beginEditRow(d)}}else{if($("#nav_tabs").find("li.active").index()==1){var d=grid2.getRowByUID(c);if(d){grid2.cancelEdit();grid2.beginEditRow(d)}}else{if($("#nav_tabs").find("li.active").index()==2){var d=grid3.getRowByUID(c);if(d){grid3.cancelEdit();grid3.beginEditRow(d);$("#datagrid3 tr").each(function(){if($(this).hasClass("mini-grid-rowEdit")){$(this).find(".uploadPlaceholder").attr("id","uploadPlaceholder")}else{$(this).find(".uploadPlaceholder").removeAttr("id")}});b.logic.fileUpload_init()}}}}},cancelRow:function(c){if($("#nav_tabs").find("li.active").index()==0){grid1.set({ajaxType:"get",url:dutyInintUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});grid1.load()}else{if($("#nav_tabs").find("li.active").index()==1){grid2.set({ajaxType:"get",url:DisposalInitUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});b.logic.load_responese_dt(function(){grid2.load()})}else{if($("#nav_tabs").find("li.active").index()==2){grid3.set({ajaxType:"get",url:FileInitUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});grid3.load()}}}},delRow:function(f){var d=null;var c=null;var g=null;var e="";if($("#nav_tabs").find("li.active").index()==0){d=grid1;c=dutydelUrl;g=grid1.getRowByUID(f);e=g.emergencyDutiesId}else{if($("#nav_tabs").find("li.active").index()==1){d=grid2;c=DisposaldelUrl;g=grid2.getRowByUID(f);e=g.disposalStepsId}else{if($("#nav_tabs").find("li.active").index()==2){d=grid3;c=FileDelUrl;g=grid3.getRowByUID(f);e=g.atchID}}}if(g){layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:c,async:true,dataType:"text",timeout:1000,data:JSON.stringify([e]),contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){ECS.showLoading()},success:function(i){ECS.hideLoading();var h=JSON.parse(i);if(h.isSuccess){layer.msg(h.message,{time:1000},function(){d.reload()})}else{layer.msg(h.message)}},error:function(h){ECS.hideLoading();var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},function(h){layer.close(h)})}},duty_list:function(c){if(c.row.dutyNames){return c.row.dutyNames.replace(/\)\,/g,")<br/>")}else{return""}},updateRow:function(g){var l=null;var m=grid1.getRowByUID(g);var c="";var f="";if($("#nav_tabs").find("li.active").index()==0){l=grid1;m=grid1.getRowByUID(g);f=m.emergencyDutiesId;c=dutyaddUrl}else{if($("#nav_tabs").find("li.active").index()==1){l=grid2;m=grid2.getRowByUID(g);f=m.disposalStepsId;c=DisposaladdUrl}else{if($("#nav_tabs").find("li.active").index()==2){l=grid3;m=grid3.getRowByUID(g);f=m.atchID;c=FileAddUrl}}}if(l==grid1){var d=new mini.Form("#datagrid1")}if(l==grid2){var d=new mini.Form("#datagrid2")}if(l==grid3){var d=new mini.Form("#datagrid3")}d.validate();if(d.isValid()==false){return}if(l==grid3){if(!m.atchName){layer.msg("请选择附件!");return}}else{if(!m.dutyIds){layer.msg("请选择责任人!");return}}l.commitEdit();var h=l.getChanges();l.loading("保存中，请稍后......");var k={};console.log("责任人的数据：",m.dutyNames);if(l==grid1){k.structuredPlanCategoryId=m.structuredPlanCategoryId?m.structuredPlanCategoryId:"";k.dutiesContent=m.dutiesContent?m.dutiesContent:"";k.dutyIds=m.dutyIds?m.dutyIds:"";k.dutyNames=m.dutyNames?m.dutyNames:"";k.inUse=m.inUse?m.inUse:1;k.sortNum=m.sortNum?m.sortNum:""}else{if(l==grid2){k.structuredPlanCategoryId=m.structuredPlanCategoryId?m.structuredPlanCategoryId:"";k.stepsOutline=m.stepsOutline?m.stepsOutline:"";k.stepsContent=m.stepsContent?m.stepsContent:"";k.feedbackMethod=m.feedbackMethod?m.feedbackMethod:"";k.dutyIds=m.dutyIds?m.dutyIds:"";k.dutyNames=m.dutyNames?m.dutyNames:"";k.inUse=m.inUse?m.inUse:1;k.sortNum=m.sortNum?m.sortNum:""}}var j="POST";if(f){j="PUT";if(l==grid1){k.emergencyDutiesId=m.emergencyDutiesId}else{if(l==grid2){k.disposalStepsId=m.disposalStepsId}}}if(l==grid3){j="POST";var e=new FormData();e.append("srcType",m.srcType);e.append("srcRef",structuredPlanCategoryId);e.append("atchName",m.atchName);e.append("atchPath",m.atchPath);e.append("atchSize",m.atchSize);if(f){e.append("atchID",m.atchID)}else{e.append("atchID","")}var i=new XMLHttpRequest();i.open(j,c);i.send(e);i.onload=function(){grid3.set({ajaxType:"get",url:FileInitUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});grid3.load()}}else{$.ajax({url:c,type:j,data:JSON.stringify(k),dataType:"text",contentType:"application/json;charset=utf-8",success:function(n){if($("#nav_tabs").find("li.active").index()==0){grid1.set({ajaxType:"get",url:dutyInintUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});grid1.load()}else{if($("#nav_tabs").find("li.active").index()==1){grid2.set({ajaxType:"get",url:DisposalInitUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId});b.logic.load_responese_dt(function(){grid2.load()})}}},error:function(n,p,o){}})}},dutyselect_btn:function(f){var c=f.record;var d=c._uid;return'<a style="width:30px;height:20px;line-height:20px;" class="btn btn-primary btn-sm" onclick="page.logic.GotoPage(\''+d+"')\">选择</a>"},OnCellBeginEdit:function(f){var c=f.record,d=f.field;if(d=="dutyNames"){f.cancel=true}},GotoPage:function(d){var c="";if($("#nav_tabs").find("li.active").index()==0){var e=grid1.getRowByUID(d);c=grid1}else{if($("#nav_tabs").find("li.active").index()==1){var e=grid2.getRowByUID(d);c=grid2}}if(!c.isEditingRow(e)){layer.msg("当前行处于非编辑状态，不可操作！");return false}layer.open({type:2,closeBtn:0,area:["80%","100%"],skin:"new-class",shadeClose:false,title:false,content:"SelectOrg.html?"+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var j=window[g.find("iframe")[0]["name"]];var i={title:"职位选择"};j.page.logic.setData(i)},end:function(){if(aPositionList.length>0){var l=[];var k=[];for(var f=0;f<aPositionList.length;f++){(function(m){l.push(m.dutyName);k.push(m.dutyID)})(aPositionList[f])}var j=false;var i="";var h="";var g=null;if($("#nav_tabs").find("li.active").index()==0){g=grid1}else{if($("#nav_tabs").find("li.active").index()==1){g=grid2}}if(g.isEditingRow(e)){j=true}g.commitEdit();if(g==grid1){g.updateRow(e,{dutyNames:l.join("<br/>"),dutyIds:k.join(","),structuredPlanCategoryId:structuredPlanCategoryId})}else{if(g==grid2){g.updateRow(e,{dutyNames:l.join("<br/>"),dutyIds:k.join(","),structuredPlanCategoryId:structuredPlanCategoryId})}}if(j){b.logic.editRow(d)}}if(window.pageLoadMode==PageLoadMode.Refresh){window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){window.pageLoadMode=PageLoadMode.None}}}})},delAll:function(){var e=null;var d="";var c=[];if($("#nav_tabs").find("li.active").index()==0){e=grid1;d=dutydelUrl}else{if($("#nav_tabs").find("li.active").index()==1){e=grid2;d=DisposaldelUrl}else{if($("#nav_tabs").find("li.active").index()==2){e=grid3;d=FileDelUrl}}}var f=e.getSelecteds();$.each(f,function(g,h){if(e==grid1){c.push(h.emergencyDutiesId)}if(e==grid2){c.push(h.disposalStepsId)}if(e==grid3){c.push(h.atchID)}});if(c.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:d,async:true,data:JSON.stringify(c),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){ECS.showLoading()},success:function(h){ECS.hideLoading();var g=JSON.parse(h);if(g.isSuccess){layer.msg(g.message,{time:1000},function(){e.reload()})}else{layer.msg(g.message)}},error:function(g){ECS.hideLoading();var h=$.parseJSON(g.responseText);layer.msg(h.collection.error.message)}})},function(g){layer.close(g)})},load_responese_dt:function(c){$.ajax({url:ResponseListUrl,type:"GET",success:function(f){b.data.aResponseList=[];for(var d=0;d<f.length;d++){var e={};e.id=f[d]["key"];e.text=f[d]["value"];b.data.aResponseList.push(e)}c&&c()}})},show_state:function(c){if(c.row.state==1){return'<a title="'+c.row.stateName+'" href="javascript:window.page.logic.send(\''+c.row.msgId+"','"+c.row.content+"','"+c.row.disposalStepsId+"')\">"+c.row.stateName+"</a>"}else{return c.row.stateName}},show_states:function(c){if(c.row.state==1){return'<a title="'+c.row.stateName+'" href="javascript:window.page.logic.send(\''+c.row.msgId+"','"+c.row.content+"','"+c.row.emergencyDutiesId+"')\">"+c.row.stateName+"</a>"}else{return c.row.stateName}},response_name:function(d){var f="";for(var c=0;c<b.data.aResponseList.length;c++){if(b.data.aResponseList[c]["id"]==d.row.feedbackMethod){f=b.data.aResponseList[c]["text"];break}}return f},file_upload:function(f){var c=f.record;var d=c._uid;if(IsOnlyRead){return'<div style="float:left;" class="img_box"><a href="'+FileDownLoadUrl+"?atchPath="+f.record.atchPath+"&atchName="+f.record.atchName+'" class="ml__5">'+f.record.atchName+"</a></div>"}else{if(f.record.atchName){return'<div style="float:left;" class="img_box"><a href="'+FileDownLoadUrl+"?atchPath="+f.record.atchPath+"&atchName="+f.record.atchName+'" class="ml__5">'+f.record.atchName+'</a><span class="upicon-remove mt__5" uid="'+d+'" style="float:right;"></span></div><div onclick="page.logic.findCurRow('+d+')" style="float:right;padding:0px;position:relative;heidght:25px;line-height:25px;overflow:hidden;" class="img_btn_box" row_id="'+d+'"><div class="btn-primary" style="height:auto;width:60px;">上传附件</div><div class="uploadPlaceholder"></div></div>'}else{return'<div style="float:left;" class="img_box"></div><div onclick="page.logic.findCurRow('+d+')" style="float:right;padding:0px;position:relative;heidght:25px;line-height:25px;overflow:hidden;" class="img_btn_box" row_id="'+d+'"><div class="btn-primary" style="height:auto;width:60px;">上传附件</div><div class="uploadPlaceholder"></div></div>'}}},findCurRow:function(c){CurRow=null;CurRow=grid3.getRowByUID(c)},FileTypeName:function(f){var d="";for(var c=0;c<b.data.FileType.length;c++){if(b.data.FileType[c]["id"]==f.row.srcType){d=b.data.FileType[c]["text"];break}}return d},fileUpload_init:function(){var c=WebUploader.create({swf:"../../../lib/webuploader/swfupload.swf",server:FileUploadUrl,pick:{id:"#uploadPlaceholder",multiple:false},accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/*"},fileNumLimit:1,compress:false,auto:true,formData:{owner:"webuploader.webuploader"},fileVal:"file",fileSingleSizeLimit:50*1024*1024});c.on("fileQueued",function(d){});c.on("uploadProgress",function(e,d){var f=grid3.findRow(function(g){if(g.fileId==e.id){return true}})});c.on("uploadSuccess",function(f,e){var h=grid3.findRow(function(i){if(i.fileId==f.id){return true}});var g={};for(var d=0;d<e.length;d++){switch(e[d]["key"]){case"atchName":case"atchPath":case"atchSize":g[e[d]["key"]]=e[d]["value"];break}}grid3.updateRow(CurRow,g);b.logic.editRow(CurRow._uid)});c.on("uploadError",function(d,e){var f=grid3.findRow(function(g){if(g.fileId==d.id){return true}});grid3.updateRow(CurRow,{status:"上传出错"})});c.on("uploadComplete",function(d){c.removeFile(d,true)});c.on("error",function(f,d,e){if(f=="Q_TYPE_DENIED"){mini.alert("请上传正确格式文件")}else{if(f=="Q_EXCEED_SIZE_LIMIT"){mini.alert("文件["+e.name+"]大小超出限制值")}else{if(f=="Q_EXCEED_NUM_LIMIT"){mini.alert("抱歉，超过每次上传数量图片限制")}}}})},onDeptChanged:function(f){var d=$(f.sender.el).parents("tr").find(".img_btn_box").attr("row_id");var c=grid3.getRowByUID(d);var g={};g.srcType=f.selected.id;g.srcTypeName=f.selected.text;grid3.updateRow(c,g);b.logic.editRow(c._uid)},bytesToSize:function(c){if(c==="空"){return"空"}if(c===0){return"0 B"}var d=1024,f=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],e=Math.floor(Math.log(c)/Math.log(d));return(c/Math.pow(d,e)).toPrecision(3)+" "+f[e]},AddOneNode:function(){if(!IsCanClick){layer.msg("正在添加根节点中，请稍后……");return false}IsCanClick=false;b.data.param={};b.data.param.emergencyPlanId=emergencyPlanID;b.data.param.emergencyPlanName=emergencyPlanName;b.data.param.inUse=1;b.data.param.sortNum=1;b.data.param.structuredPlanCategoryId=null;b.data.param.structuredPlanCategoryPid=null;$.ajax({url:addRootUrl,async:false,type:"POST",data:JSON.stringify(b.data.param),dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(){ECS.showLoading()},success:function(c){ECS.hideLoading();if(c.isSuccess){layer.msg("保存成功！",{time:1000},function(){$("#add_one_node").hide();b.logic.load_sidebar()})}else{layer.msg(c.message);IsCanClick=true}},error:function(c){ECS.hideLoading();IsCanClick=true;var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},load_sidebar:function(c){ECS.showLoading();$.ajax({url:leftMenuUrl+"?emergencyPlanId="+emergencyPlanID,type:"GET",timeout:5000,success:function(d){ECS.hideLoading();if(d.length>0){mini.get("tree1").loadList(d,"structuredPlanCategoryId","structuredPlanCategoryPid");mini.get("tree1").selectNode(mini.get("tree1").getRootNode().children[0]);structuredPlanCategoryId=mini.get("tree1").getRootNode().children[0].structuredPlanCategoryId}else{if(IsOnlyRead){$("#add_one_node").hide()}else{$("#add_one_node").show()}}c&&c()},error:function(d){ECS.hideLoading();if(d){layer.msg(d,{time:1000})}}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)}}};b.init();window.page=b});