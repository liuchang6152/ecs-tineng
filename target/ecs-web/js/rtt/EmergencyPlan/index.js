var searchUrl=ECS.api.rttUrl+"/emergencyPlan";var delUrl=ECS.api.rttUrl+"/emergencyPlan";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var PlanDefinition_url=ECS.api.rttUrl+"/emergencyPlan/enum?enumName=PlanDefinition&isAll=true";var PlanLevel_url=ECS.api.rttUrl+"/emergencyPlan/enum?enumName=PlanLevel&isAll=true";var Category_url=ECS.api.bcUrl+"/accidentCategory/list";var Category_url2=ECS.api.bcUrl+"/accidentCategory/accidentType";var getOrgIdUrl=ECS.api.bcUrl+"/org/getOrgIdByCode";var exportUrl=ECS.api.rttUrl+"/emergencyPlan/ExportToExcel";var orgId=null;var grid=null;pageflag=true;redisKey="";window.pageLoadMode=PageLoadMode.None;$(function(){var a={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();this.bindUI();a.logic.GetOrgId(function(){a.logic.initTable()})},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()});$("#btnReset").click(function(){a.logic.clear_val()});$("#accidentCategoryID").on("change",function(){a.logic.category_menu2()});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){a.data.param={};a.data.param=ECS.form.getData("searchForm");if(mini.get("orgID").getSelectedNode()){a.data.param.orgID=mini.get("orgID").getSelectedNode().orgId}else{a.data.param.orgID=orgId}a.data.param.accidentCategoryID=$("#accidentCategoryID").val();var f="";if($.trim(mini.get("accidentTypeID").getValue())==""||$.trim(mini.get("accidentTypeID").getValue())=="全部"){a.data.param.accidentTypeID=""}else{var e=mini.get("accidentTypeID").getSelecteds();var d=[];for(var c=0;c<e.length;c++){d.push(e[c].accidentTypeID)}if(d.length>0){a.data.param.accidentTypeID=d.join(",")}else{a.data.param.accidentTypeID=""}}var b=a.logic.setUrlK(a.data.param);window.open(exportUrl+"?"+b)})},data:{param:{}},logic:{setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];if(c){d+="&"+b+"="+encodeURIComponent(c)}}return d.substring(1,d.length)},initTable:function(){grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"});a.logic.select_option(riskAreaTypeNameUrl,"orgID",function(){a.logic.search(true)});a.logic.planDefinition_menu();a.logic.planLevel_menu();a.logic.category_menu(function(){a.logic.category_menu2()})},GetOrgId:function(b){$.ajax({url:getOrgIdUrl+"?orgCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE,type:"GET",timeout:5000,success:function(c){orgId=c.orgId;b&&b()}})},clear_val:function(){$("#emergencyPlanName").val("");$("#planDefinition").val("");$("#planLevel").val("");$("#accidentCategoryID").val("");mini.get("accidentTypeID").setValue("全部");a.logic.search(true)},show_edit:function(b){return ECS.util.editRender(b.row.emergencyPlanID)},select_option:function(c,d,b){$.ajax({url:c,type:"get",success:function(f){mini.get("orgID").loadList(f,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){mini.get("orgID").setValue(mini.get("orgID").data[0].orgCode);orgId=mini.get("orgID").data[0].orgId}else{mini.get("orgID").disable();for(var e=0;e<f.length;e++){(function(g){if(g.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("orgID").setValue(g.orgSname);orgId=g.orgId}})(f[e])}}b&&b()}})},planDefinition_menu:function(){$.ajax({url:PlanDefinition_url,type:"get",success:function(c){$("#planDefinition").html("");for(var b=0;b<c.length;b++){(function(e){var d='<option value="'+(e.key==null?"":e.key)+'">'+e.value+"</option>";$("#planDefinition").append(d)})(c[b])}$("#planDefinition").val("")}})},planLevel_menu:function(){$.ajax({url:PlanLevel_url,type:"get",success:function(c){$("#planLevel").html("");for(var b=0;b<c.length;b++){(function(e){var d='<option value="'+(e.key==null?"":e.key)+'">'+e.value+"</option>";$("#planLevel").append(d)})(c[b])}$("#planLevel").val("")}})},category_menu:function(b){$.ajax({url:Category_url,type:"get",success:function(d){$("#accidentCategoryID").html("");for(var c=0;c<d.length;c++){(function(f){if(f.accidentCategoryID<0){var e='<option value="">全部</option>'}else{var e='<option value="'+f.accidentCategoryID+'">'+f.accidentCategoryName+"</option>"}$("#accidentCategoryID").append(e)})(d[c])}b&&b()}})},category_menu2:function(b){if($("#accidentCategoryID").val()>0){$.ajax({url:Category_url2+"?accidentCategoryID="+$("#accidentCategoryID").val(),type:"get",success:function(e){var d=[];for(var c=0;c<e.length;c++){if(e[c]["accidentTypeID"]>0){d.push(e[c])}}mini.get("accidentTypeID").load(d);b&&b()}})}else{mini.get("accidentTypeID").setValue("全部");b&&b()}},set_level:function(b){if(b.row.applicationLevel==null){return"<a href=\"javascript:page.logic.gotosetpage('"+b.row.emergencyPlanID+"','"+b.row.planDefinition+'\')" style="text-decoration:underline;">未配置</a>'}else{return"<a href=\"javascript:page.logic.gotosetpage('"+b.row.emergencyPlanID+"','"+b.row.planDefinition+'\')" style="color:red;text-decoration:underline;">已配置</a>'}},cate_type:function(b){if(b.row.accidentTypeName){return b.row.accidentTypeName.join(",")}else{return"空"}},is_true:function(b){switch(b.row.isStructure){case 1:return'<span style="color:green;cursor:pointer;" onclick="page.logic.gotoStructurePlan(\''+b.row.emergencyPlanID+"','"+b.row.emergencyPlanName+"')\">是</span>";break;case 0:return'<span style="color:red;cursor:pointer;" onclick="page.logic.gotoStructurePlan(\''+b.row.emergencyPlanID+"','"+b.row.emergencyPlanName+"')\">否</span>";break}},gotoStructurePlan:function(c,d){var b=PageModelEnum.View;layer.open({type:2,closeBtn:0,area:["90%","90%"],skin:"new-class",shadeClose:false,title:false,content:"StructuredPlan.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:b,emergencyPlanID:c,emergencyPlanName:d,title:"结构化预案"};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}})},gotosetpage:function(c,d){var b=PageModelEnum.View;layer.open({type:2,closeBtn:0,area:["780px","450px"],skin:"new-class",shadeClose:false,title:false,content:"ApplicationLevelDeploy.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:b,emergencyPlanID:c,planDefinition:d,title:"应用级别配置"};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}})},delAll:function(){var b=new Array();var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.emergencyPlanID)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:false,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",success:function(d){d=JSON.parse(d);if(d.isSuccess){layer.msg(d.message);a.logic.search(true)}else{layer.msg(d.message)}},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},add:function(){var b=PageModelEnum.NewAdd;var c="应急预案新增";a.logic.detail(c,"",b)},edit:function(c){var b=PageModelEnum.Edit,d="应急预案编辑";a.logic.detail(d,c,b)},detail:function(d,c,b){layer.open({type:2,closeBtn:0,area:["900px","450px"],skin:"new-class",shadeClose:false,title:false,content:"AddEditEmergencyPlan.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:b,emergencyPlanID:c,title:d};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},search:function(e){a.data.param={};a.data.param=ECS.form.getData("searchForm");if(e){a.data.param.sortType=1}if(mini.get("orgID").getSelectedNode()){a.data.param.orgID=mini.get("orgID").getSelectedNode().orgId}else{a.data.param.orgID=orgId}a.data.param.accidentCategoryID=$("#accidentCategoryID").val();var f="";if($.trim(mini.get("accidentTypeID").getValue())==""||$.trim(mini.get("accidentTypeID").getValue())=="全部"){a.data.param.accidentTypeID=""}else{var d=mini.get("accidentTypeID").getSelecteds();var c=[];for(var b=0;b<d.length;b++){c.push(d[b].accidentTypeID)}if(c.length>0){a.data.param.accidentTypeID=c.join(",")}else{a.data.param.accidentTypeID=""}}grid.load(a.data.param)},imp:function(){var c=ECS.api.rttUrl+"/emergencyPlan/importExcel";var b=ECS.api.rttUrl+"/emergencyPlan/ExportExcel";var e=ECS.api.rttUrl+"/emergencyPlan/importAddAll";var d="../../bc/UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d)}}};a.init();window.page=a});