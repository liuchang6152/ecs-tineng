var addUrl=ECS.api.rttUrl+"/emergencyPlan/set";var leftMenuUrl=ECS.api.rttUrl+"/emergencyPlan/tree";var checkListUrl=ECS.api.rttUrl+"/emergencyPlan/getPlan";var resetUrl=ECS.api.rttUrl+"/emergencyPlan/reset";var levelUrl=ECS.api.rttUrl+"/emergencyPlan/appLvl";var getOrgIdUrl=ECS.api.bcUrl+"/org/getOrgIdByCode";var orgId="";var emergencyPlanID="";window.ownDetail;var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});mini.get("applicationLevel").on("valuechanged",function(){b.logic.load_sidebar(function(){mini.get("acheck_list").setValue("")})});$("#btnReset").on("click",function(){b.logic.reset_menu()});mini.get("tree1").on("nodeselect",function(c){b.logic.onenode_load_dt(c.node.id)})},logic:{onDrawNode:function(f){var c=f.sender;var d=f.node.number;if(d){f.cellCls="flag"}else{}},save:function(){var d="PUT";window.pageLoadMode=PageLoadMode.Reload;if(!mini.get("applicationLevel").getValue()){layer.msg("请选择应用级别下拉菜单！");return false}if(!mini.get("tree1").getSelectedNode()){layer.msg("请选择左侧tree菜单！");return false}if(!mini.get("acheck_list").getValue()){layer.msg("请选择某个节点关联的配置项！");return false}var c={};c.applicationLevel=mini.get("applicationLevel").getValue();c.emergencyPlanID=emergencyPlanID;c.reID=mini.get("acheck_list").getValue();c.treeId=mini.get("tree1").getSelectedNode().id;$.ajax({url:addUrl,async:false,type:d,timeout:5000,data:$.param(c),dataType:"text",contentType:"application/x-www-form-urlencoded",success:function(e){if(e.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(e.collection.error.message)}},error:function(e){if(e){var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}}})},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;emergencyPlanID=c.emergencyPlanID;planDefinition=c.planDefinition;b.logic.GetOrgId(function(){b.logic.load_level_menu(function(){b.logic.load_sidebar()})})},GetOrgId:function(c){$.ajax({url:getOrgIdUrl+"?orgCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE,type:"GET",timeout:5000,success:function(d){orgId=d.orgId;c&&c()}})},reset_menu:function(){layer.confirm("重置之后不可恢复，还确定要重置吗？",{btn:["确定","取消"]},function(){$.ajax({url:resetUrl+"?emergencyPlanID="+emergencyPlanID+"&now="+Math.random(),type:"DELETE",timeout:5000,beforeSend:function(){ECS.showLoading()},success:function(c){ECS.hideLoading();layer.msg("重置成功",{time:1000},function(){mini.get("applicationLevel").enable()})},error:function(d){ECS.hideLoading();var c=$.parseJSON(result.responseText);layer.msg(c.collection.error.message)}})},function(c){layer.close(c)})},onenode_load_dt:function(d,c){ECS.showLoading();$.ajax({url:checkListUrl+"?applicationLevel="+mini.get("applicationLevel").getValue()+"&treeID="+d+"&emergencyPlanID="+emergencyPlanID+"&now="+Math.random(),type:"GET",timeout:5000,success:function(f){ECS.hideLoading();mini.get("acheck_list").load(f);var g=[];for(var e=0;e<f.length;e++){(function(h){if(h.obj&&h.obj==h.id){g.push(h.id)}})(f[e])}mini.get("acheck_list").setValue(g.join(","));$("#acheck_list").parent().css("overflow-y","auto");c&&c()},error:function(e){ECS.hideLoading();if(e){layer.msg(e,{time:1000})}}})},load_level_menu:function(c){$.ajax({url:levelUrl+"?emergencyPlanID="+emergencyPlanID+"&planDefinition="+planDefinition+"&now="+Math.random(),type:"GET",timeout:5000,success:function(e){mini.get("applicationLevel").load(e);for(var d=0;d<e.length;d++){if(e[d]["obj"]){mini.get("applicationLevel").setValue(e[d]["id"]);mini.get("applicationLevel").disable()}}c&&c()},error:function(d){if(d){layer.msg(d,{time:1000})}}})},load_sidebar:function(c){if(mini.get("applicationLevel").getValue()==""){return false}ECS.showLoading();$.ajax({url:leftMenuUrl+"?applicationLevel="+mini.get("applicationLevel").getValue()+"&emergencyPlanID="+emergencyPlanID+"&orgID="+orgId+"&now="+Math.random(),type:"GET",timeout:5000,success:function(d){ECS.hideLoading();mini.get("tree1").loadList(d,"id","pid");$(".mini-splitter-pane1").css("overflow-y","auto");mini.get("acheck_list").load([]);c&&c()},error:function(d){ECS.hideLoading();if(d){layer.msg(d,{time:1000})}}})},select_option:function(d,e,c){$.ajax({url:d,type:"get",timeout:5000,success:function(f){mini.get(e).loadList(f,"orgId","orgPID");if(c!=undefined){mini.get(e).setValue(c,false)}},error:function(f){if(f){layer.msg(f,{time:1000})}}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)}}};b.init();window.page=b});