var addUrl=ECS.api.rttUrl+"/expert";var getSingleUrl=ECS.api.rttUrl+"/expert";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var expertTypeUrl=ECS.api.rttUrl+"/expert/getExpertTypeEnumList";var sexUrl=ECS.api.rttUrl+"/expert/getExpertSexEnumList";var titleNameUrl=ECS.api.rttUrl+"/expert/getExpertTitleEnumList";var educationUrl=ECS.api.rttUrl+"/expert/getExpertEducationEnumList";var guardUrl=ECS.api.rttUrl+"/expert/getExpertGuardEnumList";var hireUrl=ECS.api.rttUrl+"/expert/getExpertHireEnumList";var industryNameUrl=ECS.api.rttUrl+"/expert/expertIndustry";var professionNameUrl=ECS.api.rttUrl+"/expert/expertProfession";var enjoyWorksUrl=ECS.api.rttUrl+"/expert/expertEnjoyWorks";var pageMode=PageModelEnum.NewAdd;var expertCode;var industryIDs,professionIDs,enjoyWorksIDs;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();ECS.sys.RefreshContextFromSYS();b.logic.initExpertType();b.logic.cbxDrtDept();b.logic.initSex();b.logic.initTitleName();b.logic.initEducation();b.logic.initGuard();b.logic.initHire()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#classList").click(function(){b.logic.selectOwner("专业分类(多选)",PageModelEnum.Details,1)});$("#classField").click(function(){b.logic.selectOwner("行业领域(多选)",PageModelEnum.Details,2)});$("#goodList").click(function(){b.logic.selectOwner("擅长工作类型(多选)",PageModelEnum.Details,3)})},logic:{many:function(f,c){for(var e=0,d=c.length;e<d;e++){$(f).append('<p class="nstext">'+c[e]+"</p>")}},selectOwner:function(e,c,d){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"SelectOwner.html?"+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var j=window[g.find("iframe")[0]["name"]];var i={pageMode:c,title:e,isList:d};j.page.logic.setData(i)},end:function(){editUserName=[];usernameList=[];userIDList=[];for(var g in window.ownDetail){usernameList+=window.ownDetail[g]+"<br/>"}for(var f in window.ownDetail){editUserName.push(window.ownDetail[f])}for(var f in window.ownDetail){userIDList.push(f)}if(d=="1"){$("#expertProfession").html(usernameList);$("#expertProfessionID").val(userIDList)}if(d=="2"){$("#expertIndustry").html(usernameList);$("#expertIndustryID").val(userIDList)}if(d=="3"){$("#expertEnjoyWorks").html(usernameList);$("#expertEnjoyWorksID").val(userIDList)}}})},setData:function(d){$("#title-main").text(d.title);pageMode=d.pageMode;if(pageMode==PageModelEnum.NewAdd){$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#crtUserDept").val(ECS.sys.Context.SYS_ORG_UNIT_NAME);var c=new Date;$("#crtDate").val(ECS.util.DateTimeRender(c));return}else{if(pageMode==PageModelEnum.Edit){$("#orgCode").attr("disabled",true);$("#expertMobile").after('<input name="sortNum" type="hidden" id="sortNum" />')}}$.ajax({url:getSingleUrl+"/"+d.expertID+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(g){ECS.hideLoading();console.log(g);ECS.form.setData("AddOrEditModal",g);$("#crtDate").val(ECS.util.timestampToTime(g.crtDate));$("#inUse").iCheck("update");var e=g.expertProfessionName.split(",");var f=g.expertIndustryName.split(",");var h=g.expertEnjoyWorksName.split(",");expertCode=g.expertCode;industryIDs=g.industryIDs;professionIDs=g.professionIDs;enjoyWorksIDs=g.enjoyWorksIDs;if(g.expertProfessionName){b.logic.many("#expertProfession",e)}if(g.expertIndustryName){b.logic.many("#expertIndustry",f)}if(g.expertProfessionName){b.logic.many("#expertEnjoyWorks",h)}},error:function(e){ECS.hideLoading();var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},cbxDrtDept:function(){if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){$("#orgCode").attr("disabled",false);ECS.ui.getCombobox("orgCode",riskAreaTypeNameUrl,{selectFirstRecord:true,keyField:"orgCode",codeField:"orgId",valueField:"orgSname",async:false})}else{$("#orgCode").attr("disabled",true);ECS.ui.getCombobox("orgCode",riskAreaTypeNameUrl,{selectValue:ECS.sys.Context.SYS_ENTERPRISE_CODE,keyField:"orgCode",codeField:"orgId",valueField:"orgSname",async:false})}},initExpertType:function(){ECS.ui.getCombobox("expertType",expertTypeUrl,{selectValue:0},null)},initSex:function(){ECS.ui.getCombobox("expertSex",sexUrl,{selectValue:1},null)},initTitleName:function(){ECS.ui.getCombobox("expertTitle",titleNameUrl,{selectValue:0},null)},initEducation:function(){ECS.ui.getCombobox("expertEducation",educationUrl,{selectValue:0},null)},initGuard:function(){ECS.ui.getCombobox("expertMountGuard",guardUrl,{selectValue:1},null)},initHire:function(){ECS.ui.getCombobox("isEmploy",hireUrl,{selectValue:1},null)},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var c=ECS.form.getData("AddOrEditModal");c.expertCode=expertCode;console.log(c);c.orgIds=$("#orgCode").find("option:selected").attr("code");delete c.crtDate;var d="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){d="PUT";window.pageLoadMode=PageLoadMode.Refresh;if(c.expertIndustryID==""){c.expertIndustryID=industryIDs}if(c.expertProfessionID==""){c.expertProfessionID=professionIDs}console.log(enjoyWorksIDs);if(c.expertEnjoyWorksID==""){c.expertEnjoyWorksID=enjoyWorksIDs}}}$.ajax({url:addUrl,async:false,type:d,data:$.param(c),dataType:"text",contentType:"application/x-www-form-urlencoded;charset=UTF-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(e){ECS.hideLoading();if(e.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(e.collection.error.message)}},error:function(e){$("#btnSave").attr("disabled",false);ECS.hideLoading();var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{orgCode:{required:true},expertType:{required:true},expertName:{required:true,maxlength:200},expertAge:{required:true,maxlength:200,digits:true},expertSex:{required:true},expertJob:{maxlength:200},expertTitle:{required:true},expertEducation:{required:true},expertMountGuard:{required:true},isEmploy:{required:true},expertMobile:{required:true,mobile:true,maxlength:200}}})}}};b.init();window.page=b});