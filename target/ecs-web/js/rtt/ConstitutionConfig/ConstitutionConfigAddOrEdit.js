var addUrl=ECS.api.rttUrl+"/constitutionType";var deleteSubUrl=ECS.api.rttUrl+"/constitutionType/constitution";var getSingleUrl=ECS.api.rttUrl+"/constitutionType/getSingleConstitutionType";var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var constitutionTypeUrl=ECS.api.rttUrl+"/constitutionType/constitutionType";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var listLength=$("#nameList .form-group").length;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$("input").blur(function(){$(this).val($.trim($(this).val()))});this.bindUI();ECS.sys.RefreshContextFromSYS();b.logic.initOrgCode(enterpriseCodeUrl,$("#enterpriseCode"));b.logic.initConstitutionType()},bindUI:function(){$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#addNewName").click(function(){if(listLength<4){$("#nameList").append('<div class="form-group"><div class="col-xs-7 col-xs-offset-3"><input type="text" name="list'+listLength+'" class="form-control required" onblur="$(this).val($.trim($(this).val()))" maxlength="200" /></div><span class="span-required">*</span><button class="btn btn-danger delName" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div>');listLength++}else{layer.msg("最多只能添加四个!")}});$("#nameList").on("click",".delName",function(){$(this).closest(".form-group").remove();listLength--;return false})},logic:{setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;if(pageMode==PageModelEnum.NewAdd){return}if(pageMode==PageModelEnum.Edit){$("#enterpriseCode-text").html('<input name="orgName" type="text" class="form-control" id="orgName" /><input name="orgID" type="hidden" id="orgID" />');$("#orgName").attr("disabled","disabled");$("#constitutionTypeID").attr("disabled","disabled")}$.ajax({url:getSingleUrl+"?constitutionTypeId="+c.constitutionTypeID+"&orgID="+c.orgID,type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(e){ECS.hideLoading();ECS.form.setData("AddOrEditModal",e);$("#firstName").val(e.nameEntitys[0].constitutionName);$("#firstName").attr("nameid",e.nameEntitys[0].constitutionNameID);$("#firstName").attr("pid",e.nameEntitys[0].constitutionNamePID);for(var d=1;d<e.nameEntitys.length;d++){var f='<div class="form-group"><div class="col-xs-7 col-xs-offset-3"><input type="text" pid="'+e.nameEntitys[d].constitutionNamePID+'" nameid="'+e.nameEntitys[d].constitutionNameID+'" name="list'+d+'" class="form-control required" maxlength="200" value="'+e.nameEntitys[d].constitutionName+'" onblur="this.value=this.value.replace(/\\s+/g,\'\')" /></div><span class="span-required">*</span>';if(d==e.nameEntitys.length-1){f+='<button class="btn btn-danger delName2" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div>'}f+="</div>";$("#nameList").append(f)}$("#nameList").on("click",".delName2",function(){if(listLength>2){$(this).parent().prev().html($(this).parent().prev().html()+'<button class="btn btn-danger delName2" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div>')}$(this).closest(".form-group").remove();$.ajax({url:deleteSubUrl+"?id="+$(this).prev().prev().find("input").attr("nameid"),async:false,type:"DELETE",data:{},dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){ECS.showLoading()},success:function(g){ECS.hideLoading();if(g.indexOf("collection")<0){layer.msg("删除成功！",{time:1000})}else{layer.msg(g.collection.error.message)}},error:function(g){$("#btnSave").attr("disabled",false);ECS.hideLoading();var h=$.parseJSON(g.responseText);layer.msg(h.collection.error.message)}});listLength--;return false});listLength=$("#nameList .form-group").length},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},initOrgCode:function(c){$.ajax({url:c,type:"get",async:false,success:function(e){mini.get("orgID").loadList(e,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){mini.get("orgID").setValue(mini.get("orgID").data[0].orgId)}else{mini.get("orgID").disable();for(var d=0;d<e.length;d++){(function(f){if(f.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("orgID").setValue(f.orgId)}})(e[d])}}}})},initConstitutionType:function(){ECS.ui.getCombobox("constitutionTypeID",constitutionTypeUrl,{async:false,keyField:"constitutionTypeID",valueField:"constitutionType",},null)},save:function(){b.logic.formValidate();var f=[];$("#nameList").find(".form-control").each(function(g){$(this).val($.trim($(this).val()));if($(this).val()!=""){f.push({orgID:$("input[name=orgID]").val(),constitutionNamePID:$(this).attr("pid"),constitutionNameID:$(this).attr("nameid"),constitutionName:$(this).val(),constitutionTypeID:$("#constitutionTypeID").val(),inUse:"1",sortNum:g})}});if(!$("#AddOrEditModal").valid()){return}$("#nameEntitys").val(JSON.stringify(f));var d=ECS.form.getData("AddOrEditModal");var c=JSON.parse(d.nameEntitys);d.nameEntitys=c;delete d.list1;delete d.list2;delete d.list3;var e="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){e="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:e,data:JSON.stringify(d),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(g){ECS.hideLoading();if(g.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(g.collection.error.message)}},error:function(g){$("#btnSave").attr("disabled",false);ECS.hideLoading();var h=$.parseJSON(g.responseText);layer.msg(h.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{orgID:{required:true},constitutionTypeID:{required:true}}})}}};b.init();window.page=b});