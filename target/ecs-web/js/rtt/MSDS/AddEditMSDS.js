var addUrl=ECS.api.rttUrl+"/msds";var riskTypeUrl=ECS.api.rttUrl+"/riskType/getList";var addChildUrl=ECS.api.rttUrl+"/msdsFrimAtb/getForAdd";var delFileUrl=ECS.api.rttUrl+"/msds/deleteFile";var getSingleUrl=ECS.api.rttUrl+"/msds/findOne";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var FileDownLoadUrl=ECS.api.rttUrl+"/structuredplanfile/downloadFile";var orgId="";var msdsId="";var save_once=false;var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var grid=null;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();grid=mini.get("grid1");grid.on("drawcell",function(j){var i=j.field;var f=j.record;var g=f._uid;var h=j.value;if(i=="status"){if(f.status=="等待上传"){}else{if(f.status=="已完成"){}else{if(f.status=="上传成功"){}else{j.cellHtml='<div class="progressbar"><div class="progressbar-percent" style="width:'+h+'%;"></div><div class="progressbar-label">'+h+"%</div></div>"}}}}if(i=="action"){if(f.action=="ok"){j.cellHtml='<a class="upicon-remove" name="'+g+'"><a>'}}});var d=WebUploader.create({swf:"../../../lib/webuploader/swfupload.swf",server:ECS.api.rttUrl+"/msds/uploadFile",pick:"#uploadPlaceholder",resize:true,auto:true,formData:{owner:"webuploader.webuploader"},fileVal:"file",fileSingleSizeLimit:50*1024*1024});d.on("fileQueued",function(h){var l=true,k=grid.getData(),e=null;if(k.length>0){for(var g=0;g<k.length;g++){if(h.name==k[g].atchName){e=k[g];l=false;break}}}var f=c(h.size);if(l){var m={fileId:h.id,atchName:h.name,type:h.ext,size:f,status:"等待上传"};grid.addRow(m)}else{var j={fileId:h.id,atchName:h.name,type:h.ext,size:f,status:"等待上传"};grid.updateRow(e,j)}});d.on("uploadProgress",function(f,e){var g=grid.findRow(function(h){if(h.fileId==f.id){return true}});grid.updateRow(g,{status:e})});d.on("uploadSuccess",function(f,e){var g=grid.findRow(function(h){if(h.fileId==f.id){return true}});console.log("服务端返回的数据:",e);grid.updateRow(g,{status:"上传成功",action:"ok",atchID:e})});d.on("uploadError",function(e,f){var g=grid.findRow(function(h){if(h.fileId==e.id){return true}});grid.updateRow(g,{status:"上传出错"})});d.on("uploadComplete",function(e){d.removeFile(e,true)});d.on("startUpload",function(){mini.get("beginBtn").setEnabled(false)});d.on("uploadFinished",function(){mini.get("beginBtn").setEnabled(true)});d.on("error",function(g,e,f){if(g=="Q_TYPE_DENIED"){mini.alert("请上传正确格式文件")}else{if(g=="Q_EXCEED_SIZE_LIMIT"){mini.alert("文件["+f.name+"]大小超出限制值")}else{if(g=="F_EXCEED_SIZE"){mini.alert("上传的该文件大小超过了最大限制50M,无法上传")}}}});function c(e){if(e==="空"){return"空"}if(e===0){return"0 B"}var f=1024,h=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],g=Math.floor(Math.log(e)/Math.log(f));return(e/Math.pow(f,g)).toPrecision(3)+" "+h[g]}$(document.body).on("click",".upicon-remove",function(g){if(pageMode==PageModelEnum.View){return false}var f=$(this).attr("name");var h=grid.getRowByUID(f);grid.removeRow(h)})},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)})},data:{},logic:{save:function(){if(save_once){layer.msg("正在保存！")}b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var i=/^([\u4e00-\u9fa5]?[0-9]?)+(_?\s?[\u4e00-\u9fa50-9]{0,})+$/;if(!i.test($("#msdsChineseName").val())){layer.msg('"危化品中文名"只能输入汉字以及下划线和空格！');return}var c=/^[a-zA-Z]+(_?\s?[a-zA-Z]{0,})+$/;if(!c.test($("#msdsEnglishName").val())){layer.msg('"危化品英文名"只能输入字母以及下划线和空格！');return}if(mini.get("riskType").getValue()==""||mini.get("riskType").getValue()=="请选择"){layer.msg('"危险性类别"不可为空！');return}var h={};h.msdsId=$("#msdsId").val();h.orgId=orgId;h.msdsChineseName=$("#msdsChineseName").val();h.msdsEnglishName=$("#msdsEnglishName").val();h.msdsAliasName=$("#msdsAliasName").val();h.casno=$("#casno").val();h.materialCode=$("#materialCode").val();h.riskType=mini.get("riskType").getValue();h.attachIds="";var d=grid.getData();if(d.length>0){var g=[];for(var l=0;l<d.length;l++){if(d[l]["atchID"]){g.push(d[l]["atchID"])}}if(g.length>0){h.attachIds=g.join(",")}}h.msdsTotalTypeValue="[";var n=$("#ChildAttr_list").find(".model_box");for(var l=0;l<n.length;l++){var o={};var j=$(n[l]).find(".row").eq(0).text();o.mainParam=j.substring(0,j.length-1);o.subparams="[";var k=$(n[l]).find("textarea");for(var e=0;e<k.length;e++){(function(p,q){var m={};var r=$(p).parents(".form-group").find("div").eq(0).html();m.k=r.substring(0,r.length-1);m.v=$(p).val();if(q==k.length-1){o.subparams+=JSON.stringify(m)}else{o.subparams+=JSON.stringify(m)+","}})(k[e],e)}o.subparams+="]";if(l==n.length-1){h.msdsTotalTypeValue+=JSON.stringify(o)}else{h.msdsTotalTypeValue+=JSON.stringify(o)+","}}h.msdsTotalTypeValue+="]";delete h.enterpriseCode;var f="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){f="PUT";window.pageLoadMode=PageLoadMode.Refresh}}save_once=true;$.ajax({url:addUrl,async:false,type:f,data:JSON.stringify(h),dataType:"text",contentType:"application/json;charset=utf-8",success:function(p){var m=JSON.parse(p);if(m.isSuccess){layer.msg(m.message,{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(m.message)}},error:function(m){console.log("错误返回的信息：",m);var p=$.parseJSON(m.responseText);layer.msg(p.collection.error.message)}})},file_download:function(c){if(c.record.atchPath){return'<a href="'+FileDownLoadUrl+"?atchPath="+c.record.atchPath+"&atchName="+c.record.atchName+'" class="ml__5">'+c.record.atchName+"</a>"}else{return'<a href="javascript:;" class="ml__5">'+c.record.atchName+"</a>"}},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;msdsId=c.msdsId;if(pageMode==PageModelEnum.NewAdd){b.logic.select_option(riskAreaTypeNameUrl,"#enterpriseCode");b.logic.danger_menu(function(){mini.get("riskType").setValue("请选择")});b.logic.add_get_structure();return}$.ajax({url:getSingleUrl+"?msdsId="+c.msdsId+"&now="+Math.random(),type:"get",async:true,dataType:"json",success:function(e){ECS.form.setData("AddOrEditModal",e);b.logic.select_option(riskAreaTypeNameUrl,"enterpriseCode",function(){orgId=e.orgId;mini.get("enterpriseCode").setValue(e.orgSname)});b.logic.danger_menu(function(){var h="";for(var g=0;g<e.riskTypeEntityList.length;g++){(function(i){if(g==e.riskTypeEntityList.length-1){h+=i.riskTypeId}else{h+=i.riskTypeId+","}})(e.riskTypeEntityList[g])}mini.get("riskType").setValue(h)});b.logic.render_childAttr_list(e.msdsTotalTypeValueForEdit);if(e.attachmentEntities){var d=[];for(var f=0;f<e.attachmentEntities.length;f++){(function(i){var h={};h.atchName=i.atchName;h.atchPath=i.atchPath;h.atchID=i.atchID;h.type=i.atchName.split(".")[1];if((i.atchSize/1024).toFixed(1)>1024){var g=(i.atchSize/1024).toFixed(1);h.size=(g/1024).toFixed(1)+"Mb"}else{h.size=(i.atchSize/1024).toFixed(1)+"Kb"}h.action="ok";h.status="上传成功";d.push(h)})(e.attachmentEntities[f])}grid.addRows(d);if(pageMode==PageModelEnum.View){b.logic.disable_all()}}},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},disable_all:function(){mini.get("enterpriseCode").disable();$("#msdsChineseName").attr("disabled","disabled");$("#msdsEnglishName").attr("disabled","disabled");$("#msdsAliasName").attr("disabled","disabled");$("#casno").attr("disabled","disabled");$("#materialCode").attr("disabled","disabled");mini.get("riskType").disable();$("#ChildAttr_list").find("textarea").attr("disabled","disabled");$("#btnSave").hide();$("#uploadPlaceholder").remove();$("#beginBtn").css({background:"#ccc",color:"white"})},DeleteFile:function(f,d){var c=[];for(var e=0;e<f.length;e++){c.push(f[e].atchID)}ECS.showLoading();$.ajax({url:delFileUrl,async:false,data:JSON.stringify(c),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",success:function(g){ECS.hideLoading();if(g.indexOf("collection")<0){layer.msg("删除成功！");d&&d()}else{g=JSON.parse(g);layer.msg(g.collection.error.message)}},error:function(g){ECS.hideLoading();var h=$.parseJSON(g.responseText);layer.msg(h.collection.error.message)}})},add_get_structure:function(c){$.ajax({url:addChildUrl,type:"get",success:function(d){b.logic.render_childAttr_list(d,c)}})},render_childAttr_list:function(e,c){$("#ChildAttr_list").html("");for(var d=0;d<e.length;d++){if(e[d]["subparams"].length==0){continue}(function(m){var l=$('<div class="model_box"></div>');$("#ChildAttr_list").append(l);var h=$('<div class="row"><div class="col-xs-2 control-label" style="padding-right:0px;">'+m.mainParam+'：</div></div><div class="row"><div class="col-xs-1"></div><div class="col-xs-11" style="height: 1px; background: #CCCCCC; margin:10px 0px;"></div></div>');$(l).append(h);var j=m.subparams;var k=null;for(var f=0;f<j.length;f++){if(f%2==0){k=$('<div class="row"></div>');l.append(k);var g=$('<div class="col-xs-6"><div class="form-group"><div class="col-xs-4 control-label">'+j[f]["k"]+'：</div><div class="col-xs-8"><textarea style="width:100%;height:100px;" cols="30" rows="10">'+j[f]["v"]+"</textarea></div></div></div>");k.append(g)}else{var i=$('<div class="col-xs-6"><div class="form-group"><div class="col-xs-4 control-label">'+j[f]["k"]+'：</div><div class="col-xs-8"><textarea style="width:100%;height:100px;" cols="30" rows="10">'+j[f]["v"]+"</textarea></div></div></div>");k.append(i);k=null}}})(e[d])}c&&c()},danger_menu:function(c){$.ajax({url:riskTypeUrl,type:"get",success:function(d){mini.get("riskType").load(d);c&&c()}})},onCloseClick:function(d){var c=d.sender;c.setText("");c.setValue("")},select_option:function(d,e,c){$.ajax({url:d,type:"get",success:function(g){mini.get("enterpriseCode").loadList(g,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname);orgId=mini.get("enterpriseCode").data[0].orgId}else{mini.get("enterpriseCode").disable();for(var f=0;f<g.length;f++){(function(h){if(h.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(h.orgSname);orgId=h.orgId}})(g[f])}}c&&c()}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{msdsChineseName:{required:true,rangelength:[0,100]},msdsEnglishName:{required:true,rangelength:[0,100]},msdsAliasName:{required:true,rangelength:[0,100]},casno:{required:true,rangelength:[0,100]},materialCode:{required:true,rangelength:[0,100]}}})}}};b.init();window.page=b});