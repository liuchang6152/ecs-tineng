var searchUrl=ECS.api.rttUrl+"/msds";var riskTypeUrl=ECS.api.rttUrl+"/riskType/getList";var saveUrl=ECS.api.rttUrl+"/msds/set";var WarnSaveUrl=ECS.api.apUrl+"/DisposeWarning/RelatedMSDS";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var applicationLevel=null;var treeId=null;var eventId=null;var grid=null;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();this.bindUI()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnQuery").click(function(){b.data.aSelected_dt=[];b.logic.search()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#btnSave").click(function(){b.logic.save()})},data:{param:{},selected_list:[],aSelected_dt:[]},logic:{setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;applicationLevel=c.applicationLevel?c.applicationLevel:"";treeId=c.treeId?c.treeId:"";eventId=c.eventId?c.eventId:"";b.data.selected_list=c.IdList?c.IdList:[];b.logic.danger_menu(function(){});b.logic.initTable()},initTable:function(){grid=mini.get("datagrid");grid.on("load",b.logic.search(true));grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"});b.logic.select_option(riskAreaTypeNameUrl,"orgId",function(){b.logic.search(true)});grid.on("load",function(){grid.selects(b.data.aSelected_dt)});grid.on("selectionchanged",function(d){if(d.records.length==0){return false}for(var c=0;c<d.records.length;c++){if(grid.isSelected(d.records[c])){b.logic.save_selected(d.records[c],true)}else{b.logic.save_selected(d.records[c],false)}}})},save_selected:function(g,e){var f=false;var c=null;for(var d=0;d<b.data.aSelected_dt.length;d++){(function(i,h){if(i.msdsId==g.msdsId){f=true;c=h}})(b.data.aSelected_dt[d],d)}if(e){if(!f){b.data.aSelected_dt.push(g)}}else{if(f){b.data.aSelected_dt.splice(c,1)}}},save:function(){if(b.data.aSelected_dt.length==0){layer.msg("请选择要保存的数据!");return}if(applicationLevel){var f=new Array();for(var d=0;d<b.data.aSelected_dt.length;d++){f.push(b.data.aSelected_dt[d]["msdsId"])}for(var e=0;e<b.data.selected_list.length;e++){f.push(b.data.selected_list[e])}var c=[];for(var e=0;e<f.length;e++){if(c.indexOf(f[e])==-1){c.push(f[e])}}f=c;$.ajax({url:saveUrl+"?applicationLevel="+applicationLevel+"&treeId="+treeId,async:false,data:JSON.stringify(f),dataType:"text",contentType:"application/json;charset=utf-8",type:"POST",success:function(g){g=JSON.parse(g);if(g.isSuccess){layer.msg(g.message);b.logic.closeLayer(true)}else{layer.msg(g.message)}},error:function(g){var h=$.parseJSON(g.responseText);layer.msg(h.collection.error.message)}})}else{var f=new Array();for(var d=0;d<b.data.aSelected_dt.length;d++){(function(h){var g={};g.relatedMsdsId=null;g.eventId=eventId;g.msdsId=h.msdsId;g.isUsed=1;f.push(g)})(b.data.aSelected_dt[d])}$.ajax({url:WarnSaveUrl,async:false,data:JSON.stringify(f),dataType:"text",contentType:"application/json;charset=utf-8",type:"POST",success:function(g){g=JSON.parse(g);if(g.isSuccess){layer.msg(g.message);b.logic.closeLayer(true)}else{layer.msg(g.message)}},error:function(g){var h=$.parseJSON(g.responseText);layer.msg(h.collection.error.message)}})}},select_option:function(d,e,c){$.ajax({url:d,type:"get",success:function(g){mini.get("orgId").load(g);if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){mini.get("orgId").setValue(g[0].orgId)}else{mini.get("orgId").disable();for(var f=0;f<g.length;f++){(function(h){if(h.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("orgId").setValue(h.orgId)}})(g[f])}}c&&c()}})},show_risktype:function(c){if($.trim(c.row.riskType)==""){return"空"}else{return c.row.riskType}},param_danger:function(c){switch(c.row.risk){case 1:return'<span style="color:cornflowerblue;">有</span>';break;case 0:return"无";break}},param_firstAidMeasure:function(c){switch(c.row.firstAidMeasure){case 1:return'<span style="color:cornflowerblue;">有</span>';break;case 0:return"无";break}},param_fireMeasure:function(c){switch(c.row.fireMeasure){case 1:return'<span style="color:cornflowerblue;">有</span>';break;case 0:return"无";break}},param_revealHandle:function(c){switch(c.row.revealHandle){case 1:return'<span style="color:cornflowerblue;">有</span>';break;case 0:return"无";break}},danger_menu:function(c){$.ajax({url:riskTypeUrl,type:"get",success:function(d){mini.get("riskType").load(d);c&&c()}})},onCloseClick:function(d){var c=d.sender;c.setText("");c.setValue("")},danger_menu:function(c){$.ajax({url:riskTypeUrl,type:"get",success:function(d){mini.get("riskType").load(d);c&&c()}})},onCloseClick:function(d){var c=d.sender;c.setText("");c.setValue("")},search:function(c){b.data.param={};b.data.param=ECS.form.getData("searchForm");if(c){b.data.param.sortType=1}if(mini.get("orgId").getSelected()){b.data.param.orgId=mini.get("orgId").getSelected().orgId}else{b.data.param.orgId=""}b.data.param.riskType=mini.get("riskType").getValue();grid.load(b.data.param,function(){grid.deselectAll()})},store_dt:function(f,e){var d=false;for(var c=0;c<b.data.aSelected_dt.length;c++){if(b.data.aSelected_dt[c].msdsId==f){d=true;break}}if(!d){b.data.aSelected_dt.push(e)}},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)}}};b.init();window.page=b});