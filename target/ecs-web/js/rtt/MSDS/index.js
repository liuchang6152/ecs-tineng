var searchUrl=ECS.api.rttUrl+"/msds";var delUrl=ECS.api.rttUrl+"/msds";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var riskTypeUrl=ECS.api.rttUrl+"/riskType/getList";var exportUrl=ECS.api.rttUrl+"/msds/ExportToExcel";var enterpriseCode=null;var grid=null;var orgId=null;pageflag=true;redisKey="";window.pageLoadMode=PageLoadMode.None;$(function(){var a={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();this.bindUI();a.logic.danger_menu(function(){a.logic.initTable()})},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});mini.get("orgId").on("nodeclick",function(b){if(b.node.orgCode=="-1"){orgId=""}else{orgId=b.node.orgId}});$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()});$("#btnReset").click(function(){a.logic.clear_val()});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){a.data.param={};a.data.param=ECS.form.getData("searchForm");if(mini.get("orgId").getSelectedNode()){a.data.param.orgId=mini.get("orgId").getSelectedNode().orgId}else{a.data.param.orgId=orgId}a.data.param.riskType=mini.get("riskType").getValue();var b=a.logic.setUrlK(a.data.param);window.open(exportUrl+"?"+b)})},data:{param:{}},logic:{setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},initTable:function(){grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"});a.logic.select_option(riskAreaTypeNameUrl,"#orgId",function(){a.logic.search(true)})},clear_val:function(){$("#msdsChineseName").val("");$("#casno").val("");mini.get("riskType").setValue("");a.logic.search(true)},show_edit:function(b){return'<a title="编辑" href="javascript:window.page.logic.edit('+b.row.msdsId+')" class="mr__10"><i class="icon-edit edit"></i></a><a title="详情" href="javascript:window.page.logic.detailPage('+b.row.msdsId+')" class="mr__10"><i class="icon-details edit"></i></a>'},show_risktype:function(b){if($.trim(b.row.riskType)==""){return"空"}else{return b.row.riskType}},select_option:function(c,d,b){$.ajax({url:c,type:"get",success:function(f){mini.get("orgId").loadList(f,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){mini.get("orgId").setValue(mini.get("orgId").data[0].orgCode);orgId=mini.get("orgId").data[0].orgId}else{mini.get("orgId").disable();for(var e=0;e<f.length;e++){(function(g){if(g.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("orgId").setValue(g.orgSname);orgId=g.orgId}})(f[e])}}b&&b()}})},param_firstAidMeasure:function(b){switch(b.row.firstAidMeasure){case 1:return"有";break;case 0:return"无";break}},param_fireMeasure:function(b){switch(b.row.fireMeasure){case 1:return"有";break;case 0:return"无";break}},param_revealHandle:function(b){switch(b.row.revealHandle){case 1:return"有";break;case 0:return"无";break}},param_danger:function(b){switch(b.row.risk){case 1:return"有";break;case 0:return"无";break}},danger_menu:function(b){$.ajax({url:riskTypeUrl,type:"get",success:function(c){mini.get("riskType").load(c);b&&b()}})},onCloseClick:function(c){var b=c.sender;b.setText("");b.setValue("")},delAll:function(){var b=new Array();var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.msdsId)});if(b.length==0){layer.msg("请选择需要删除的危化品数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:false,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",success:function(d){d=JSON.parse(d);if(d.isSuccess){layer.msg(d.message);a.logic.search(true)}else{layer.msg(d.message)}},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},add:function(){var b=PageModelEnum.NewAdd;var c="危化品新增";a.logic.detail(c,"",b)},edit:function(b){var c=PageModelEnum.Edit,d="危化品编辑";a.logic.detail(d,b,c)},detailPage:function(b){var c=PageModelEnum.View,d="危化品详情";a.logic.detail(d,b,c)},detail:function(d,b,c){layer.open({type:2,closeBtn:0,area:["1100px","550px"],skin:"new-class",shadeClose:false,title:false,content:"AddEditMSDS.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,msdsId:b,title:d};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},search:function(b){a.data.param={};a.data.param=ECS.form.getData("searchForm");if(b){a.data.param.sortType=1}if(mini.get("orgId").getSelectedNode()){a.data.param.orgId=mini.get("orgId").getSelectedNode().orgId}else{a.data.param.orgId=orgId}a.data.param.riskType=mini.get("riskType").getValue();grid.load(a.data.param)},imp:function(){var c=ECS.api.rttUrl+"/msds/importExcel";var b=ECS.api.rttUrl+"/msds/ExportExcel";var e=ECS.api.rttUrl+"/msds/importAddAll";var d="../../bc/UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d)}}};a.init();window.page=a});