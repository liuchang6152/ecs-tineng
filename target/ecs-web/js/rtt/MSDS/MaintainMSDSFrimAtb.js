var addUrl=ECS.api.rttUrl+"/msds";var delUrl=ECS.api.rttUrl+"/msdsFrimAtb";var saveUrl=ECS.api.rttUrl+"/msdsFrimAtb";var childdelUrl=ECS.api.rttUrl+"/msdsSubAtb";var childsaveUrl=ECS.api.rttUrl+"/msdsSubAtb";var getListUrl=ECS.api.rttUrl+"/msdsFrimAtb/getForOrg";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName";var orgId="";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var grid=null;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#main_attrlist_box").click(function(c){if(c.target.tagName=="LI"){b.logic.cur_option_checked($(c.target).index());b.logic.load_child_list($(c.target).index())}else{if(($(c.target).hasClass("btn-danger")&&c.target.tagName=="BUTTON")||(c.target.tagName=="SPAN"&&$(c.target).parent().hasClass("btn-danger"))){b.logic.cur_option_delete($(c.target).parents("li").index())}else{if(($(c.target).hasClass("btn-info")&&c.target.tagName=="BUTTON")||(c.target.tagName=="SPAN"&&$(c.target).parent().hasClass("btn-info"))){b.logic.cur_option_save($(c.target).parents("li").index())}else{b.logic.load_child_list($(c.target).parents("li").index())}b.logic.cur_option_checked($(c.target).parents("li").index())}}});$("#child_attrlist_box").click(function(c){if(($(c.target).hasClass("btn-danger")&&c.target.tagName=="BUTTON")||(c.target.tagName=="SPAN"&&$(c.target).parent().hasClass("btn-danger"))){b.logic.child_option_delete($(c.target).parents("li").index())}if(($(c.target).hasClass("btn-info")&&c.target.tagName=="BUTTON")||(c.target.tagName=="SPAN"&&$(c.target).parent().hasClass("btn-info"))){b.logic.child_option_save($(c.target).parents("li").index())}})},data:{},logic:{cur_option_checked:function(d,c){$("#main_attrlist_box").find("input:radio").each(function(){this.checked=false});$("#main_attrlist_box").find("li").eq(d).find("input:radio")[0].checked=true;c&&c(d)},cur_option_delete:function(c){var d=$("#main_attrlist_box").find("li").eq(c);layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){if(d.attr("orgId")&&d.attr("msdsfirmatbId")){$.ajax({url:delUrl+"?id="+d.attr("msdsfirmatbId"),async:false,dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",success:function(e){e=JSON.parse(e);if(e.isSuccess){layer.msg(e.message);d.remove()}else{layer.msg("请优先选择子属性删除！")}},error:function(e){var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})}else{d.remove()}},function(e){layer.close(e)})},cur_option_save:function(c){var e=$("#main_attrlist_box").find("li").eq(c);if($.trim(e.find("input:text").eq(0).val())==""){layer.msg("主属性名称不可为空");return false}if(e.find(".input_number").val()==""){layer.msg("排序不可为空");return false}var f=e.attr("msdsFirmAtbId")?e.attr("msdsFirmAtbId"):"";var d={};d.msdsFirmAtbId=f;d.msdsFrimAtbName=$.trim(e.find("input:text").eq(0).val());d.orgId=orgId;d.sortNum=$.trim(e.find(".input_number").val());$.ajax({url:saveUrl,async:false,type:"POST",data:JSON.stringify(d),dataType:"text",contentType:"application/json;charset=utf-8",success:function(g){g=JSON.parse(g);layer.msg(g.message);if(g.isSuccess){if(f==""){e.attr("msdsfirmatbId",g.result)}if(c==$("#main_attrlist_box").find("li").length-1){var h=$("#main_attrlist_box").find("li").eq(c).clone();h.find("input:text").val("");h.find(".input_number").val("");h.removeAttr("msdsfirmatbId");h.find(".delete_button2").hide();$("#main_attrlist_box").find("li").eq(c).find(".delete_button2").show();$("#main_attrlist_box").append(h)}}}})},load_child_list:function(d){var c=$("#main_attrlist_box").find("li").eq(d).attr("msdsFirmAtbId");if(c){$.ajax({url:getListUrl+"?orgId="+orgId+"&msdsFirmAtbId="+c+"&now="+Math.random(),type:"get",async:true,dataType:"json",success:function(f){$("#child_attrlist_box").html("");if(f[0]["subparams"].length==0){b.logic.append_child_option($("#child_attrlist_box"),true)}else{for(var e=0;e<f[0]["subparams"].length;e++){(function(h,g){b.logic.append_child_option($("#child_attrlist_box"),false,function(){b.logic.set_child_attr($("#child_attrlist_box").find("li").eq(g),h)})})(f[0]["subparams"][e],e)}b.logic.append_child_option($("#child_attrlist_box"),true)}c=null}})}else{$("#child_attrlist_box").html("");b.logic.append_child_option($("#child_attrlist_box"),true)}},child_option_save:function(c){var f=$("#child_attrlist_box").find("li").eq(c);if($.trim(f.find("input:text").eq(0).val())==""){layer.msg("子属性名称不可为空");return false}if(f.find(".input_number").val()==""){layer.msg("排序不可为空");return false}var d=$("input:checked").parents("li").attr("msdsFirmAtbId")?$("input:checked").parents("li").attr("msdsFirmAtbId"):"";var e={};e.msdsSubAtbId=(f.attr("msdssubatbId")?f.attr("msdssubatbId"):"");e.msdsSubAtbName=$.trim(f.find("input:text").eq(0).val());e.sortNum=$.trim(f.find(".input_number").val());e.msdsFirmAtbId=d;$.ajax({url:childsaveUrl,async:false,type:"POST",data:JSON.stringify(e),dataType:"text",contentType:"application/json;charset=utf-8",success:function(g){g=JSON.parse(g);layer.msg(g.message);if(g.isSuccess){if(c==$("#child_attrlist_box").find("li").length-1){var h=$("#child_attrlist_box").find("li").eq(c).clone();h.find("input:text").val("");h.find(".input_number").val("");h.removeAttr("msdsfirmatbId");h.removeAttr("msdssubatbId");h.find(".delete_button2").hide();$("#child_attrlist_box").find("li").eq(c).find(".delete_button2").show();$("#child_attrlist_box").append(h)}}}})},child_option_delete:function(c){var d=$("#child_attrlist_box").find("li").eq(c);layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){if(d.attr("msdsfirmatbId")&&d.attr("msdssubatbId")){$.ajax({url:childdelUrl+"?id="+d.attr("msdssubatbId"),async:false,data:JSON.stringify(b.data.param),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",success:function(e){e=JSON.parse(e);if(e.isSuccess){layer.msg(e.message);d.remove()}else{layer.msg(e.message)}},error:function(e){var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})}else{d.remove()}},function(e){layer.close(e)})},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;b.logic.select_option(riskAreaTypeNameUrl,function(){$.ajax({url:getListUrl+"?orgId="+orgId+"&msdsFirmAtbId=&now="+Math.random(),type:"get",async:true,dataType:"json",success:function(e){for(var d=0;d<e.length;d++){(function(g,f){switch(g.msdsFrimAtbName){case"危险性":b.logic.set_attr_list($("#main_attrlist_box").find("li").eq(0),g);break;case"急救措施":b.logic.set_attr_list($("#main_attrlist_box").find("li").eq(1),g);break;case"消防措施":b.logic.set_attr_list($("#main_attrlist_box").find("li").eq(2),g);break;case"泄漏应急处理":b.logic.set_attr_list($("#main_attrlist_box").find("li").eq(3),g);break;default:b.logic.append_option($("#main_attrlist_box"),false,function(){b.logic.set_attr_list($("#main_attrlist_box").find("li").eq(f),g)})}})(e[d],d)}b.logic.append_option($("#main_attrlist_box"),true,function(){b.logic.set_attr_list($("#main_attrlist_box").find("li").eq(a),{orgId:$("#main_attrlist_box").find("li").eq(0).attr("orgId")})});b.logic.cur_option_checked(0,function(){b.logic.load_child_list(0)})},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})})},set_attr_list:function(c,d){c.attr({msdsFirmAtbId:(d.msdsFirmAtbId?d.msdsFirmAtbId:""),orgId:(d.orgId?d.orgId:"")});if($(c).index()>3){if(d.msdsFrimAtbName){$(c).find("input:text").eq(0).val(d.msdsFrimAtbName)}if(d.sortNum){$(c).find(".input_number").val(d.sortNum)}}},append_option:function(f,e,d){var c=$('<li class="mb__5"><input type="radio" style="float:left;" /><input type="text" class="width__150 ml__5 form-control" style="float:left;" /><label class="ml__10">排序：</label><input type="number" class="mr__10 width__50 input_number" min="1" max="999999" oninput="if(value.length>5)value=value.slice(0,5)" value="" /><button class="btn btn-danger delName width__50" style="width: 40px !important;" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button><button class="btn btn-info ml__10 width__50" style="width: 40px !important;" type="button" title="保存"><span class="glyphicon glyphicon-plus"></span></button></li>');if(e){c.find(".delete_button2").hide();c.find(".input_number").val("")}$(f).append(c);d&&d()},append_child_option:function(f,e,d){var c=$('<li class="mb__5"><input type="text" class="width__150 form-control" maxlength="200" style="float:left;"><label class="ml__10">排序：</label><input type="number" class="mr__10 width__50 input_number" min="1" max="999999" value="" oninput="if(value.length>5)value=value.slice(0,5)" /><button class="btn btn-danger delName width__50" style="width: 40px !important;" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button><button class="btn btn-info ml__10 width__50" style="width: 40px !important;" type="button" title="保存"><span class="glyphicon glyphicon-plus"></span></button></li>');if(e){c.find(".delete_button2").hide();c.find(".input_number").val("")}$(f).append(c);d&&d()},set_child_attr:function(c,d){$(c).attr({msdsFirmAtbId:d.msdsFirmAtbId,msdsSubAtbId:d.msdsSubAtbId});$(c).find("input:text").eq(0).val(d.msdsSubAtbName);$(c).find(".input_number").val(d.sortNum)},select_option:function(d,c){$.ajax({url:d,type:"get",success:function(f){if(ECS.sys.Context.SYS_IS_HQ){orgId=f[0].orgId}else{for(var e=0;e<f.length;e++){(function(g){if(g.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){orgId=g.orgId}})(f[e])}}c&&c()}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)}}};b.init();window.page=b});