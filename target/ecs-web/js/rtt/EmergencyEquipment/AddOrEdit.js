var addUrl=ECS.api.rttUrl+"/emergencyEquipment";var detailUrl=ECS.api.rttUrl+"/emergencyEquipment/getEmrgequipById";var riskorg_url=ECS.api.bcUrl+"/org/porgName";var getUserUrl=ECS.api.bcUrl+"/user";var stockpilePointTypeUrl=ECS.api.rttUrl+"/mtrlStorage/getStoreTypeEnumList";var stockpileTypeUrl=ECS.api.rttUrl+"/mtrlStorage/getRepoTypeEnumList";var stockpilePointUrl=ECS.api.rttUrl+"/emergencyEquipment/getEmeStoPoint";var Enterprise_url=ECS.api.rttUrl+"/expert/getExpertTypeEnumList";var unit_url=ECS.api.rttUrl+"/emergencyEquipment/getParammesunit";var mesUnitUrl=ECS.api.rttUrl+"/emrgMtrl/mesUnit";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var enterpriseCode="";var enterpriseName="";var orgList=[];var storageID="";var drtDeptCode="";$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();b.logic.initTable();b.logic.loadType()},table:{},bindUI:function(){$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$("#selectMedia").click(function(){b.logic.selectMedia()});$("#selectUser").click(function(){b.logic.selectUser()});$("#drtDeptCode").change(function(){b.logic.loadstockpilePoint()});$("#storeType").change(function(){b.logic.loadstockpilePoint()});$("#repoType").change(function(){b.logic.loadstockpilePoint()});$("#enterpriseCode").change(function(){b.logic.enterprisechanged()})},data:{param:{}},logic:{getEnterpriseType:function(){$("#equipOwner").html('<option value="" selected="selected">可输入</option>');var c=[{text:"队伍",id:1},{text:"企业",id:2}];$("#equipOwner").select2({tags:false,data:c,language:{noResults:function(d){return"没有匹配项"}},})},enterprisechanged:function(){var e=$("#enterpriseCode").val();if(orgList.length>0){var c=JSLINQ(orgList).Where(function(f){return f.id==e}).ToArray();var d=riskorg_url+"?isAll=false&orgPID="+c[0].orgId+"&orgLvl=3";b.logic.getsecordEnterPriseSelects(d,"drtDeptCode","orgCode","orgSname",false)}},getsecordEnterPriseSelects:function(e,c,f,g,d){console.log(e);$("#"+c).html('<option value="" selected="selected">可输入</option>');$.ajax({url:e,async:false,dataType:"json",success:function(i){var h=[];$.each(i,function(j,k){h.push({id:k[f],text:k[g]})});$("#"+c).select2({tags:d,data:h,language:{noResults:function(j){return"没有匹配项"}},});if(drtDeptCode){$("#drtDeptCode").val(drtDeptCode)}console.log(12)},})},loadType:function(c){ECS.ui.getComboSelects(stockpilePointTypeUrl,"storeType","key","value",false);ECS.ui.getComboSelects(stockpileTypeUrl,"repoType","key","value",false);ECS.ui.getComboSelects(Enterprise_url,"equipType","key","value",false);ECS.ui.getComboSelect(mesUnitUrl,"mesUnit","value","value",true,name)},loadstockpilePoint:function(){var d=$("#drtDeptCode").val()==null?"":$("#drtDeptCode").val();var c=$("#repoType").val()==null?"":$("#repoType").val();var e=$("#storeType").val()==null?"":$("#storeType").val();b.logic.getComboSelects(stockpilePointUrl+"?orgCode="+d+"&repoType="+c+"&mtrlType="+e,"storageID","id","name",false)},getComboSelects:function(e,c,f,g,d){$("#"+c).html('<option value="" selected="selected">可输入</option>');$.ajax({url:e,async:true,dataType:"json",success:function(i){var h=[];$.each(i,function(j,k){h.push({id:k[f],text:k[g]})});$("#"+c).select2({tags:d,data:h,language:{noResults:function(j){return"没有匹配项"}},});if(storageID){$("#storageID").val(storageID)}},})},initTable:function(){b.logic.getEnterpriseType();ECS.sys.RefreshContextFromSYS();b.logic.enterprise(riskorg_url,"enterpriseCode");$("#crtUserDept").val(ECS.sys.Context.SYS_ENTERPRISE_NAME)},enterprise:function(c,d){$.ajax({url:c+"?orgLvl=1",type:"get",success:function(g){var f=[];if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){$.each(g,function(j,k){f.push({id:k.orgCode,text:k.orgSname,orgId:k.orgId})})}else{var e=JSLINQ(g).Where(function(i){return i.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE}).ToArray();$.each(e,function(j,k){f.push({id:k.orgCode,text:k.orgSname,orgId:k.orgId})});var h=c+"?isAll=false&orgPID="+e[0].orgId+"&orgLvl=3";b.logic.getsecordEnterPriseSelects(h,"drtDeptCode","orgCode","orgSname",false);$("#"+d).attr("disabled","disabled")}orgList=f;$("#"+d).select2({tags:false,data:f,language:{noResults:function(i){return"没有匹配项"}},})},error:function(f){layer.msg("系统繁忙")}})},setData:function(c,e){$("#title-main").text(c.title);pageMode=c.pageMode;var d=setInterval(function(){if(window.document.readyState!="loading"){try{clearTimeout(d);if(pageMode==PageModelEnum.NewAdd){return}else{$.ajax({url:detailUrl+"?emrgequipId="+e.emrgEquipID,type:"get",async:true,success:function(i){b.logic.Convert(i);for(var g in i){e[g]=i[g]}drtDeptCode=i.drtDeptCode;storageID=i.storageID;ECS.form.setData("AddOrEditModal",e);var h=new mini.Form("AddOrEditModal");h.setData(e,false)},error:function(g){}})}}catch(f){}}},3000)},selectUser:function(){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"../Personnel/SelectOwner.html?"+Math.random(),success:function(d,e){var c=layer.getChildFrame("body",e);var g=window[d.find("iframe")[0]["name"]];var f={pageMode:pageMode,title:"人员选择(单选)",orgCode:$("#enterpriseCode").val(),userInfo:{userID:$("#userID").val(),userName:$("#userName").val()}};g.page.logic.setData(f)},end:function(){$("#userId").val(window.ownDetail);$.ajax({url:getUserUrl+"/"+window.ownDetail+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(d){ECS.hideLoading();var c=d.userPhone||d.userMobile;$("#userName").val(d.userName);$("#userID").val(d.userID);$("#phone").val(c)},error:function(c){ECS.hideLoading();var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})}})},selectMedia:function(){layer.open({type:2,closeBtn:1,area:["80%","90%"],skin:"new-class",shadeClose:false,title:"储存库分类选择",content:"SelectType.html?r="+Math.random(),success:function(c,d){},end:function(){var d=window.ownDetail;var c=[];if(d.allName){c=d.allName.split("-")}else{c.push(d.bgCategName)}$("#businessBgCategName").val(d.bgCategName);$("#businessBgCategCode").val(d.bgCategCode);$("#businessMdCategName").val(c[1]);$("#businessMdCategCode").val(d.mdCategCode);$("#businessSmCategName").val(c[2]);$("#businessSmCategCode").val(d.code)}})},save:function(){b.logic.formValidate();var d=ECS.form.getData("AddOrEditModal");d.userID=$("#userID").val();if(!$("#AddOrEditModal").valid()){return}var c="";if(!d.businessBgCategCode){c+="装备大类不能为空"}if(!d.equipAmount){c+="库存量不能为空"}if(!d.userID){c+="负责人不能为空"}if(!d.productionDate){c+="出厂日期不能为空"}if(c){layer.msg(c);return false}var e="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){e="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:e,data:JSON.stringify(d),dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(f){ECS.hideLoading();$("#btnSave").attr("disabled",false);if(f.isSuccess){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(f.message)}},error:function(f){$("#btnSave").attr("disabled",false);ECS.hideLoading();var g=$.parseJSON(f.responseText);layer.msg(g.collection.error.message)}})},Convert:function(c){c.expireDate=moment(c.expireDate).format("YYYY-MM-DD ");c.productionDate=moment(c.productionDate).format("YYYY-MM-DD ");return c},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{equipOwner:{required:true},drtDeptCode:{required:true},storageID:{required:true},businessBgCategName:{required:true},emrgEquipName:{required:true},equipAmount:{required:true},userID:{required:true},productionDate:{required:true},equipType:{required:true}}})}}};b.init();window.page=b});