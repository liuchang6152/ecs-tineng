var delUrl=ECS.api.rttUrl+"/emrgMtrl";var searchUrl=ECS.api.rttUrl+"/emrgMtrl";var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var drtDeptCodeUrl=ECS.api.bcUrl+"/org/porgName?isAll=true&orgLvl=3";var bgCatgUrl=ECS.api.bcUrl+"/busiBgCateg/getListByModelID1?businessModelId=31&isAll=true";var mdCatgUrl=ECS.api.bcUrl+"/busiBgCateg/getListByBgCode1?isAll=true";var smCatgUrl=ECS.api.bcUrl+"/busiBgCateg/getListByMdCode1?isAll=true";var storeTypeUrl=ECS.api.rttUrl+"/mtrlStorage/getStoreTypeEnumList";var repoTypeUrl=ECS.api.rttUrl+"/mtrlStorage/getRepoTypeEnumList";var mtrlTypeUrl=ECS.api.rttUrl+"/emrgMtrl/mtrlType";var mtrlAmountUrl=ECS.api.rttUrl+"/emrgMtrl/mesUnitCount";var mtrlAmountSearchUrl=ECS.api.rttUrl+"/emrgMtrl/getAlarmExpertList";var inUseUrl=ECS.api.commonUrl+"/getInUse";var exportUrl=ECS.api.rttUrl+"/emrgMtrl/ExportToExcel";pageflag=true;redisKey="";var flag=false;var pidcode;window.pageLoadMode=PageLoadMode.None;$(function(){var a={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();$("#searchForm").find("input").val("");a.logic.initInUse();a.logic.initTable();a.logic.initOrgCode(enterpriseCodeUrl,"#enterpriseCode");a.logic.cbxBgCatg();a.logic.cbxMdCatg();a.logic.cbxSmCatg();a.logic.cbxMtrlType();a.logic.cbxStoreType();a.logic.cbxRepoType()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){a.logic.add()});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()});mini.get("enterpriseCode").on("nodeclick",function(b){pidcode=b.node.orgCode;a.logic.cbxDrtDeptCode(drtDeptCodeUrl,$("#drtDeptCode"),b.node.orgId);a.logic.getMtrlAmount()});$("#btnToggle").click(function(){if(flag){flag=!flag;$(this).html('<i class="icon-showMore"></i>');$(".search-unfixed").hide()}else{flag=!flag;$(this).html('<i class="icon-hideMore"></i>');$(".search-unfixed").show()}});mini.get("drtDeptCode").on("nodeclick",function(b){a.logic.getMtrlAmount()});$("#btnMtrlAmount").click(function(){var b=$("input[name=drtDeptCode]").val();a.logic.searchMtrlAmount(pidcode,b)});$("#btnReset").click(function(){$("#searchForm")[0].reset();mini.get("drtDeptCode").setValue("全部");$("#mdCatgName").attr("disabled",true);$("#smCatgName").attr("disabled",true);mini.get("enterpriseCode").setValue(ECS.sys.Context.SYS_ENTERPRISE_CODE);a.logic.getMtrlAmount()});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){a.data.param=ECS.form.getData("searchForm");a.data.param.enterpriseCode=pidcode;for(var c in a.data.param){if(a.data.param[c]=="-1"||a.data.param[c]=="全部"){a.data.param[c]=""}}var b=a.logic.setUrlK(a.data.param);window.open(exportUrl+"?"+b)})},data:{param:{}},logic:{setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},initTable:function(){mini.parse();grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"})},show_edit:function(b){return ECS.util.editRender(b.row.emrgMtrlID)},initOrgCode:function(b,c){$.ajax({url:b,type:"get",async:false,success:function(e){mini.get(c).loadList(e,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){mini.get(c).setValue(mini.get(c).data[0].orgCode);pidcode=mini.get(c).data[0].orgCode;a.logic.cbxDrtDeptCode(drtDeptCodeUrl,$("#drtDeptCode"),mini.get("enterpriseCode").data[0].orgId)}else{pidcode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get(c).disable();for(var d=0;d<e.length;d++){(function(f){if(f.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get(c).setValue(f.orgSname);a.logic.cbxDrtDeptCode(drtDeptCodeUrl,$("#drtDeptCode"),f.orgId)}})(e[d])}}a.logic.getMtrlAmount()}});a.logic.search()},cbxDrtDeptCode:function(c,d,b){$.ajax({url:c+"&orgPID="+b,type:"get",success:function(e){mini.get("drtDeptCode").loadList(e,"orgId","orgPID");mini.get("drtDeptCode").setValue("全部")}})},getMtrlAmount:function(){var b=$("input[name=drtDeptCode]").val();if(b=="-1"||b=="全部"){b=""}$.ajax({url:mtrlAmountUrl+"?enterpriseCode="+pidcode+"&drtDeptCode="+b,dataType:"json",success:function(c){$("#sum").text(c)},error:function(c){var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},cbxBgCatg:function(){ECS.ui.getCombobox("bgCatgName",bgCatgUrl,{selectValue:"全部",keyField:"businessBgCategName",valueField:"businessBgCategName",codeField:"businessBgCategCode"},null,a.logic.cbxMdCatg)},cbxMdCatg:function(){var b=$("#bgCatgName").find("option:selected").attr("code");if(b&&b!="null"){$("#mdCatgName").attr("disabled",false);$("#smCatgName").html("<option value='全部'>全部</option>").attr("disabled",true);ECS.ui.getCombobox("mdCatgName",mdCatgUrl,{selectValue:"全部",keyField:"businessMdCategName",valueField:"businessMdCategName",codeField:"businessMdCategCode",data:{businessBgCategCode:b}},null,a.logic.cbxSmCatg)}else{$("#mdCatgName").html("<option value='全部'>全部</option>").attr("disabled",true);$("#smCatgName").html("<option value='全部'>全部</option>").attr("disabled",true)}},cbxSmCatg:function(){var b=$("#mdCatgName").find("option:selected").attr("code");if(b&&b!="null"){$("#smCatgName").attr("disabled",false);ECS.ui.getCombobox("smCatgName",smCatgUrl,{selectValue:"全部",keyField:"businessSmCategName",valueField:"businessSmCategName",data:{businessMdCategCode:b}},null)}else{$("#smCatgName").html("<option value='全部'>全部</option>").attr("disabled",true)}},cbxMtrlType:function(){ECS.ui.getCombobox("mtrlType",mtrlTypeUrl,{selectValue:"",data:{isAll:true}},null)},cbxStoreType:function(){ECS.ui.getCombobox("storeType",storeTypeUrl,{selectValue:-1,data:{isAll:true}},null)},cbxRepoType:function(){ECS.ui.getCombobox("repoType",repoTypeUrl,{selectValue:-1,data:{isAll:true}},null)},initInUse:function(){ECS.ui.getCombobox("inUse",inUseUrl,{selectValue:-1,data:{isAll:true}},null)},delAll:function(){var b=[];var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.emrgMtrlID)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:true,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(d){ECS.hideLoading();if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){grid.reload();a.logic.getMtrlAmount()})}else{d=JSON.parse(d);layer.msg(d.collection.error.message)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},add:function(){var b=PageModelEnum.NewAdd;var c="应急物资新增";a.logic.detail(c,"",b)},edit:function(b){var c=PageModelEnum.Edit;var d="应急物资编辑";a.logic.detail(d,b,c)},detail:function(d,b,c){layer.open({type:2,closeBtn:0,area:["80%","80%"],skin:"new-class",shadeClose:false,title:false,content:"EmrgMtrlAddOrEdit.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,emrgMtrlID:b,title:d};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);a.logic.getMtrlAmount();window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);a.logic.getMtrlAmount();window.pageLoadMode=PageLoadMode.None}}}})},searchMtrlAmount:function(c,b){if(b=="全部"){b=""}grid.set({url:mtrlAmountSearchUrl});grid.load({enterpriseCode:c,drtDeptCode:b})},search:function(c){a.data.param=ECS.form.getData("searchForm");a.data.param.enterpriseCode=pidcode;if(c){a.data.param.sortType=1}for(var b in a.data.param){if(a.data.param[b]=="-1"||a.data.param[b]=="全部"){a.data.param[b]=""}}grid.set({url:searchUrl});grid.load(a.data.param)},imp:function(){var c=ECS.api.rttUrl+"/emrgMtrl/importExcel";var b=ECS.api.rttUrl+"/emrgMtrl/ExportExcel";var e=ECS.api.rttUrl+"/emrgMtrl/importAddAll";var d="../../bc/UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d)}}};a.init();window.page=a});