var addUrl=ECS.api.rttUrl+"/emrgMtrl";var getSingleUrl=ECS.api.rttUrl+"/emrgMtrl";var riskorg_url=ECS.api.bcUrl+"/org/porgName";var storeTypeUrl=ECS.api.rttUrl+"/mtrlStorage/getStoreTypeEnumList";var storageNameUrl=ECS.api.rttUrl+"/mtrlStorage/mtrlStorageName";var repoTypeUrl=ECS.api.rttUrl+"/mtrlStorage/getRepoTypeEnumList";var mesUnitUrl=ECS.api.rttUrl+"/emrgMtrl/mesUnit";var mtrlTypeUrl=ECS.api.rttUrl+"/emrgMtrl/mtrlType";var enterpriseCode="";var drtDeptCode="";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;window.ownDetail="";$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();ECS.sys.RefreshContextFromSYS()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});mini.get("drtDeptCode").on("nodeclick",function(c){$("#ownerName").val("");window.ownDetail="";$("#ownerContact").val("");$("#userID").val("");b.logic.cbxStorage()});mini.get("enterpriseCode").on("nodeclick",function(c){b.logic.get_list(riskorg_url,$("#drtDeptCode"),c.node.orgId)});$("#selectOwner").click(function(){b.logic.selectOwner("人员选择(单选)",PageModelEnum.Details)});$("#selectMedia").click(function(){b.logic.selectMedia()})},logic:{setData:function(d){$("#title-main").text(d.title);pageMode=d.pageMode;if(pageMode==PageModelEnum.NewAdd){b.logic.initMesUnit("");$("#storageName").hide();$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#crtUserDept").val(ECS.sys.Context.SYS_ORG_UNIT_NAME);var c=new Date;$("#crtDate").val(ECS.util.DateTimeRender(c));b.logic.get_list(riskorg_url,$("#enterpriseCode"),"",function(){b.logic.cbxStorage()});b.logic.cbxStoreType();b.logic.cbxRepoType();b.logic.initExpertType();return}if(pageMode==PageModelEnum.Edit){$("#storageID").attr("disabled","disabled");$("#storeType").attr("disabled","disabled");$("#repoType").attr("disabled","disabled");mini.get("enterpriseCode").disable();mini.get("drtDeptCode").disable();mini.get("expireDate").disable()}$.ajax({url:getSingleUrl+"/"+d.emrgMtrlID+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(i){if(i.mtrlMdCategID==null){i.mtrlMdCategID="-1"}if(i.mtrlSmCategID==null){i.mtrlSmCategID="-1"}ECS.form.setData("AddOrEditModal",i);mini.get("sortNum").setValue(i.sortNum);$("#crtDate").val(ECS.util.timestampToHour(i.crtDate));b.logic.initMesUnit(i.mesUnit);$("input[name=drtDeptCode]").val(i.drtDeptCode);var f=$('<option value="'+i.storeType+'">'+i.storeTypeName+"</option>");$("#storeType").append(f);var e=$('<option value="'+i.repoType+'">'+i.repoTypeName+"</option>");$("#repoType").append(e);var h=$('<option value="'+i.storageID+'">'+i.storageName+"</option>");$("#storageID").append(h);b.logic.get_list(riskorg_url,$("#enterpriseCode"),"",function(){mini.get("enterpriseCode").setValue(i.orgName);enterpriseCode=i.enterpriseCode;mini.get("drtDeptCode").setValue(i.drtDeptName);drtDeptCode=i.drtDeptCode;$("#storageID").val(i.storageID);$("#storageName").val(i.storageName)});$("#bgCategName").val(i.bgCatgName);$("#bgCatgCode").val(i.bgCatgCode);$("#mdCategName").val(i.mdCatgName);$("#mdCatgCode").val(i.mdCatgCode);$("#smCategName").val(i.smCatgName);$("#smCategCode").val(i.smCatgCode);var g=$('<option value="'+i.mtrlType+'">'+i.mtrlTypeName+"</option>");$("#mtrlType").append(g);mini.get("expireDate").setValue(ECS.util.strToDate(i.expireDate));window.ownDetail={ownerContact:i.ownerContact,userID:i.userID,userName:i.ownerName};$("#inUse").iCheck("update");ECS.hideLoading()},error:function(e){ECS.hideLoading();var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},selectOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"SelectOwner.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];if(mini.get("enterpriseCode").getSelectedNode()){enterpriseCode=mini.get("enterpriseCode").getSelectedNode().orgCode}var h={pageMode:c,title:d,orgCode:enterpriseCode,userInfo:window.ownDetail};i.page.logic.setData(h)},end:function(){$("#ownerContact").val(window.ownDetail.ownerContact);$("#ownerName").val(window.ownDetail.userName);$("#userID").val(window.ownDetail.userID)}})},get_list:function(d,g,f,c){if(f){var e=d+"?orgPID="+f+"&orgLvl=3"}else{var e=d+"?orgLvl=2"}$.ajax({url:e,type:"GET",async:false,success:function(i){if(f){mini.get("drtDeptCode").loadList(i,"orgId","orgPID");if(i.length>0){if(i[0].orgPID){for(var h=0;h<i.length;h++){if(i[h].orgId==i[0].orgPID){mini.get("drtDeptCode").setValue(i[h].orgSname);drtDeptCode=i[h].orgCode}}}else{mini.get("drtDeptCode").setValue(i[0].orgSname);drtDeptCode=i[0].orgCode}}c&&c()}else{mini.get("enterpriseCode").loadList(i,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname);b.logic.get_list(riskorg_url,$("#drtDeptCode"),mini.get("enterpriseCode").data[0].orgId,function(){c&&c()})}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var h=0;h<i.length;h++){(function(j){if(j.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(j.orgSname);b.logic.get_list(riskorg_url,$("#drtDeptCode"),j.orgId,function(){c&&c()})}})(i[h])}}}}})},selectMedia:function(){layer.open({type:2,closeBtn:1,area:["80%","90%"],skin:"new-class",shadeClose:false,title:"物资分类选择",content:"./SelectType.html?r="+Math.random(),success:function(c,d){},end:function(){var d=window.ownDetail;var c=[];if(d.allName){c=d.allName.split("-")}else{c.push(d.bgCategName)}$("#bgCatgName").val(d.bgCategName);$("#bgCatgCode").val(d.bgCategCode);$("#mdCatgName").val(c[1]);$("#mdCatgCode").val(d.mdCategCode);$("#smCatgName").val(c[2]);$("#smCatgCode").val(d.code)}})},cbxStoreType:function(){ECS.ui.getCombobox("storeType",storeTypeUrl,{async:false},null,b.logic.cbxStorage)},cbxRepoType:function(){ECS.ui.getCombobox("repoType",repoTypeUrl,{async:false},null,b.logic.cbxStorage)},cbxStorage:function(){var c=$("#storeType").find("option:selected").attr("value");var d=$("#repoType").find("option:selected").attr("value");if(mini.get("drtDeptCode").getSelectedNode()){ECS.ui.getCombobox("storageID",storageNameUrl,{async:false,data:{drtDeptCode:mini.get("drtDeptCode").getSelectedNode().orgCode,storeType:c,repoType:d}})}},getSmCatgCode:function(){$("#smCatgCode").val($("#mtrlSmCategID").find("option:selected").attr("code"))},initMesUnit:function(c){ECS.ui.getComboSelect(mesUnitUrl,"mesUnit","value","value",true,c)},initExpertType:function(){ECS.ui.getCombobox("mtrlType",mtrlTypeUrl,{selectValue:0},null)},onDrawDate:function(f){var c=f.date;var g=new Date();if(c.getTime()<g.getTime()){f.allowSelect=false}},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var d=ECS.form.getData("AddOrEditModal");if(mini.get("enterpriseCode").getSelectedNode()){d.enterpriseCode=mini.get("enterpriseCode").getSelectedNode().orgCode}else{d.enterpriseCode=enterpriseCode}if(mini.get("drtDeptCode").getSelectedNode()){d.drtDeptCode=mini.get("drtDeptCode").getSelectedNode().orgCode}else{d.drtDeptCode=drtDeptCode}d.bgCatgName=$("#bgCatgName").val();d.bgCatgCode=$("#bgCatgCode").val();d.mdCatgName=$("#mdCatgName").val();d.mdCatgCode=$("#mdCatgCode").val();d.smCatgName=$("#smCatgName").val();d.smCatgCode=$("#smCatgCode").val();d.mtrlAmount=$("#mtrlAmount").val();d.lowLimit=$("#lowLimit").val();for(var c in d){if(d[c]=="null"||d[c]=="-1"){d[c]=""}}if(pageMode==PageModelEnum.NewAdd){var e="POST";window.pageLoadMode=PageLoadMode.Reload}if(pageMode==PageModelEnum.Edit){var e="PUT";window.pageLoadMode=PageLoadMode.Refresh}$.ajax({url:addUrl,async:false,type:e,data:$.param(d),dataType:"text",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(f){ECS.hideLoading();if(f=="保存成功！"){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(f)}},error:function(f){$("#btnSave").attr("disabled",false);ECS.hideLoading();var g=$.parseJSON(f.responseText);layer.msg(g.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{drtDeptCode:{required:true},storeType:{required:true},repoType:{required:true},storageID:{required:true},sourceType:{required:true},mtrlBgCategID:{required:true},emrgMtrlName:{required:true},mtrlAmount:{required:true},mesUnit:{required:true},ownerName:{required:true},mtrlType:{required:true},sortNum:{required:true,digits:true,min:0}}});if($("#mtrlBgCategID").val()=="-1"){$("#mtrlBgCategID").val("")}}}};b.init();window.page=b});