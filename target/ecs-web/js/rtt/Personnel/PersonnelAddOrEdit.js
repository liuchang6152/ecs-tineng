var addUrl=ECS.api.rttUrl+"/personnel";var getSingleUrl=ECS.api.rttUrl+"/personnel";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var teamIDUrl=ECS.api.rttUrl+"/team/getListByParam?param=teamName";var teamTypeUrl=ECS.api.rttUrl+"/personnel/getTeamTypeEnumList";var workStatusUrl=ECS.api.rttUrl+"/personnel/getWorkStatusEnumList";var getUserUrl=ECS.api.bcUrl+"/user";var uploadAttrUrl=ECS.api.rttUrl+"/personnel/uploadFile";var updateUrl=ECS.api.rttUrl+"/personnel/downloadFile";var pageMode=PageModelEnum.NewAdd;window.ownDetail;window.pageLoadMode=PageLoadMode.None;var uploader;var fileType;var validate;var fileTypes=new Array();var attaArray=new Array();var status=0;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();ECS.sys.RefreshContextFromSYS();b.logic.initWorkStatus();b.logic.initTeamType();b.logic.upload()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#selectOwner").click(function(){b.logic.selectOwner("人员选择(单选)",PageModelEnum.Details)});$(".close").click(function(){b.logic.delAtt(this)});$(".viewImg").bind("click",function(){var c=$(this);c.viewer({inline:false,viewed:function(){c.viewer("zoomTo",1)},hidden:function(){$(".viewImg").viewer("destroy")}})});$("#idCardBtn").click(function(){fileType=1})},logic:{setData:function(g){$("#title-main").text(g.title);pageMode=g.pageMode;if(pageMode==PageModelEnum.NewAdd){if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){ECS.ui.getCombobox("orgIds",riskAreaTypeNameUrl,{selectFirstRecord:true,keyField:"orgCode",codeField:"orgId",valueField:"orgSname",async:false},null,b.logic.initTeamName);$("#orgIds").attr("disabled",false)}else{b.logic.cbxDrtDept(ECS.sys.Context.SYS_ENTERPRISE_CODE)}b.logic.initTeamName();$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#crtUserDept").val(ECS.sys.Context.SYS_ORG_UNIT_NAME);var e=new Date;var f=e.getFullYear();var c=e.getMonth()+1;var d=e.getDate();$("#crtDate").val(f+"-"+c+"-"+d);return}else{$("#orgIds").attr("disabled",true)}$.ajax({url:getSingleUrl+"/"+g.personnelID+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(k){ECS.hideLoading();if(k.personnelPhotoPath){$("#idCardBtn").hide();$("#view1").show();$(".close").show();$("#view1").html('<img id="img1" src="'+updateUrl+"?fileId="+k.personnelPhotoPath+'">')}ECS.form.setData("AddOrEditModal",k);b.logic.cbxDrtDept(k.orgEntitySet[0].orgEntity.orgCode);ECS.ui.getCombobox("teamID",teamIDUrl+"&oid="+k.orgEntitySet[0].orgID,{selectValue:k.teamID,keyField:"ID",valueField:"NAME",async:false});var j="";for(var h=0;h<k.personnelJobList.length;h++){if(h==0){j+=k.personnelJobList[h]}else{j+=","+k.personnelJobList[h]}}$("#personnelJob").val(j);$("#crtDate").val(ECS.util.DateRender(k.crtDate));$("#inUse").iCheck("update")},error:function(h){ECS.hideLoading();var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},cbxDrtDept:function(c){$("#orgIds").attr("disabled",true);ECS.ui.getCombobox("orgIds",riskAreaTypeNameUrl,{selectValue:c,keyField:"orgCode",codeField:"orgId",valueField:"orgSname",async:false},null,b.logic.initTeamName)},initTeamName:function(){window.ownDetail="";$("#personnelName").val("");$("#personnelSexName").val("");$("#personnelBirthday").val("");$("#personnelMobile").val("");$("#personnelPhone").val("");$("#personnelJob").val("");$("#teamTypeName").val("");$("#userLvlName").val("");$("#userId").val("");var c="";if($("#orgIds").find("option:selected").attr("code")){c=$("#orgIds").find("option:selected").attr("code")}else{c=""}ECS.ui.getCombobox("teamID",teamIDUrl+"&oid="+c,{keyField:"ID",valueField:"NAME",async:false})},upload:function(){uploader=new plupload.Uploader({browse_button:["idCardBtn"],url:uploadAttrUrl,multi_selection:false,multipart_params:{collectionStr:""},filters:{mime_types:[{title:"Image files",extensions:"jpg,jpeg,png,JPG,JPEG,PNG"}],max_file_size:"50mb",prevent_duplicates:false}});uploader.init();uploader.bind("FilesAdded",function(e,c){if(c[0].name.length>100){e.removeFile(c[0]);layer.msg("文件名称不能超过100字符！");return}if(e.files.length>0){var d=false;for(x in e.files){if(e.files[x].fileType==fileType){fileTypes.push(fileType);c[0].fileType=fileType;fileTypes.splice(x,1);e.removeFile(e.files[x]);d=true}}if(!d){fileTypes.push(fileType);c[0].fileType=fileType}}else{fileTypes.push(fileType);c[0].fileType=fileType}ECS.showLoading();e.start()});uploader.bind("FileUploaded",function(g,d,c){if(pageMode==PageModelEnum.NewAdd){var f={};f.fileId=c.response;f.fileName=d.name;f.fileType=d.fileType;attaArray.push(f)}if(pageMode==PageModelEnum.Edit){var e=false;for(x in attaArray){if(attaArray[x].fileType==d.fileType){attaArray[x].fileId=c.response;attaArray[x].fileName=d.name;e=true}}if(!e){var f={};f.fileId=c.response;f.fileName=d.name;f.fileType=d.fileType;f.careVehId=$("#careVehId").val();attaArray.push(f)}}});uploader.bind("UploadComplete",function(d,c){b.logic.previewImage(c[0],function(e){$("#idCardBtn").hide();$("#view1").show();$(".close").show();$("#view1").empty();$("#view1").append('<img id="img1" src="'+e+'" />')});if(attaArray.length>0){$("#personnelPhotoPath").val(attaArray[0].fileId);$("#personnelPhotoPath").closest(".form-group").removeClass("has-error");$("#personnelPhotoPath").next("#personnelPhotoPath-error").remove()}else{$("#personnelPhotoPath").val("")}ECS.hideLoading()});uploader.bind("Error",function(d,c){if(c.code==-600){layer.msg("上传文件不能大于50MB！");return}c.file.status=2;layer.msg(JSON.parse(c.response).collection.error.message)})},delAtt:function(c){$("#view1 img").remove();$("#view1").hide();$(".close").hide();$("#idCardBtn").show();for(x in uploader.files){if(uploader.files[x].fileType==1){fileTypes.splice(x,1);uploader.files.splice(x,1);break}}$("#personnelPhotoPath").val("");b.logic.formValidates();if(!$("#AddOrEditModal").valid()){return}},previewImage:function(e,f){if(!e||!/image\//.test(e.type)){return}if(e.type=="image/gif"){var d=new mOxie.FileReader();d.onload=function(){f(d.result);d.destroy();d=null};d.readAsDataURL(e.getSource())}else{var c=new mOxie.Image();c.onload=function(){c.downsize(300,300);var g=c.type=="image/jpeg"?c.getAsDataURL("image/jpeg",80):c.getAsDataURL();f&&f(g);c.destroy();c=null};c.load(e.getSource())}},initWorkStatus:function(){ECS.ui.getCombobox("personnelWorkStatus",workStatusUrl,{selectValue:0})},initTeamType:function(){ECS.ui.getCombobox("teamType",teamTypeUrl,{selectValue:0})},selectOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"SelectOwner.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,orgCode:$("#orgIds").val(),userInfo:{userID:$("#userId").val(),userName:$("#personnelName").val()}};i.page.logic.setData(h)},end:function(){$("#userId").val(window.ownDetail);if(window.ownDetail){$.ajax({url:getUserUrl+"/"+window.ownDetail+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(e){ECS.hideLoading();$("#personnelName").val(e.userName);$("#personnelSexName").val(e.userSexName);$("#personnelBirthday").val(ECS.util.DateRender(e.userBirthday));$("#personnelMobile").val(e.userMobile);$("#personnelPhone").val(e.userPhone);$("#personnelJob").val(e.dutys);$("#teamTypeName").val(e.userNature);$("#userLvlName").val(e.userLvl)},error:function(e){ECS.hideLoading();var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})}}})},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var d=ECS.form.getData("AddOrEditModal");var c={};var f=[];var e="POST";if(pageMode==PageModelEnum.NewAdd){f.push({orgID:$("#orgIds").find("option:selected").attr("code")});window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){f.push({personnelID:$("#personnelID").val(),orgID:$("#orgIds").find("option:selected").attr("code")});e="PUT";window.pageLoadMode=PageLoadMode.Refresh}}c.orgEntitySet=f;c.teamID=d.teamID;c.teamType=d.teamType;c.personnelWorkStatus=d.personnelWorkStatus;c.userId=d.userId;c.personnelID=d.personnelID;c.crtUserName=d.crtUserName;c.crtUserDept=d.crtUserDept;c.crtDate=d.crtDate;c.personnelPhotoPath=d.personnelPhotoPath;c.inUse=d.inUse;$.ajax({url:addUrl,async:false,type:e,data:JSON.stringify(c),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(g){ECS.hideLoading();if(g.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(g.collection.error.message)}},error:function(g){$("#btnSave").attr("disabled",false);ECS.hideLoading();var h=$.parseJSON(g.responseText);layer.msg(h.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{orgIds:{required:true},personnelName:{required:true},teamID:{required:true},teamType:{required:true},personnelPhotoPath:{required:true},personnelWorkStatus:{required:true}}})},formValidates:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{personnelPhotoPath:{required:true}}})}}};b.init();window.page=b});