var addUrl=ECS.api.rttUrl+"/vehicleMaintain";var getSmailUrl=ECS.api.rttUrl+"/vehicleMaintain";var getSingleUrl=ECS.api.rttUrl+"/constitutionType/getSingleConstitutionType";var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2&isAll=true";var enterpriseCode;var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var listLength=$("#nameList .form-group").length;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();$("input").blur(function(){$(this).val($.trim($(this).val()))});this.bindUI();b.logic.initOrgCode(enterpriseCodeUrl,"enterpriseCode")},bindUI:function(){$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#addNewName").click(function(){$("#nameList").append('<div class="form-group"><div class="col-xs-7 col-xs-offset-3"><input type="text" name="list'+listLength+'" class="form-control required" maxlength="200" /></div><span class="span-required">* &nbsp;&nbsp;&nbsp;</span><button class="btn btn-danger delName" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div>');listLength++});$("#nameList").on("click",".delName",function(){$(this).closest(".form-group").remove();listLength--;return false})},logic:{setData:function(c,d){$("#title-main").text(c.title);pageMode=c.pageMode;if(pageMode==PageModelEnum.NewAdd){return}if(pageMode==PageModelEnum.Edit){ECS.form.setData("AddOrEditModal",d);enterpriseCode=d.orgCode;mini.get("enterpriseCode").setValue(d.orgCode);mini.get("enterpriseCode").setEnabled(false);$.ajax({type:"GET",url:getSmailUrl+"/"+d.vehicleBigID,data:{},dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(e){ECS.showLoading();console.log(e)},success:function(e){ECS.hideLoading();if(e.isSuccess){console.log(e);var g=e.result;$("#firstName").val(g[0].vehicleSmallName);$("#firstName").attr("nameid",g[0].vehicleSmallId);$("#firstName").attr("pid",d.vehicleBigID);for(var f=1;f<g.length;f++){$("#nameList").append('<div class="form-group"><div class="col-xs-7 col-xs-offset-3"><input type="text" pid="'+d.vehicleBigID+'" nameid="'+g[f].vehicleSmallId+'" name="list'+f+'" class="form-control required" maxlength="200" value="'+g[f].vehicleSmallName+'" onblur="this.value=this.value.replace(/\\s+/g,\'\')" /></div><span class="span-required">*&nbsp;&nbsp;&nbsp;</span><button class="btn btn-danger delName" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div></div>')}listLength=$("#nameList .form-group").length}else{}},error:function(e){$("#btnSave").attr("disabled",false);ECS.hideLoading();layer.msg(e.message)}})}},initOrgCode:function(c,d){$.ajax({url:c,type:"get",success:function(f){mini.get("enterpriseCode").loadList(f,"orgCode","porgCode");if(ECS.sys.Context.SYS_IS_HQ){mini.get(d).setValue(f[0].orgCode)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get(d).disable();for(var e=0;e<f.length;e++){(function(g){if(g.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get(d).setValue(g.orgCode)}})(f[e])}}}})},save:function(){b.logic.formValidate();var e=[];$("#nameList").find(".form-control").each(function(f){$(this).val($.trim($(this).val()));if($(this).val()!=""){if(pageMode==PageModelEnum.NewAdd){e.push($(this).val())}if(pageMode==PageModelEnum.Edit){e.push({vehicleSmallId:$(this).attr("nameid"),vehicleSmallName:$(this).val(),})}}});var c={orgCode:$("input[name=enterpriseCode]").val(),vehicleBigName:$("#vehicleBigName").val(),vehicleBigID:$("#vehicleBigID").val(),};if(!$("#AddOrEditModal").valid()){return}var d="POST";if(pageMode==PageModelEnum.NewAdd){c.vehicleSmalls=e;window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){d="PUT";c.vehicleSmallEntities=e;window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:d,data:JSON.stringify(c),dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(f){ECS.hideLoading();$("#btnSave").attr("disabled",false);if(f.isSuccess){layer.msg(f.message,{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(f.message)}},error:function(f){$("#btnSave").attr("disabled",false);ECS.hideLoading();layer.msg("系统繁忙")}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{enterpriseCode:{required:true},vehicleBigName:{required:true},firstName:{required:true}}})}}};b.init();window.page=b});