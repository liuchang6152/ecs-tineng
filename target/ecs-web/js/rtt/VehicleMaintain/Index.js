var enterpriseUrl=ECS.api.bcUrl+"/org/porgName";var dutyUrl=ECS.api.eddUrl+"/eddSchedul/dutyNames";var searchUrl=ECS.api.rttUrl+"/vehicleMaintain/getVehicleBigInfoByOrgId";var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=1";var addUrl=ECS.api.rttUrl+"/vehicleMaintain";var delUrl=ECS.api.rttUrl+"/vehicleMaintain";var delAttrUrl=ECS.api.rttUrl+"/vehicleMaintain/deleteSmall";var delSmailUrl=ECS.api.rttUrl+"/vehicleMaintain";var searchDetailUrl=ECS.api.rttUrl+"/vehicleMaintain";var exportUrl=ECS.api.eddUrl+"/eddSchedul/ExportToExcel";window.pageLoadMode=PageLoadMode.None;var enterpriseCode="";var detailGrid_Form;var grid;$(function(){var a={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();a.logic.get_list(enterpriseUrl,$("#orgCode"));a.logic.initTable();a.logic.search()},table:{},bindUI:function(){$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;a.logic.closeLayer(false)});$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){a.logic.add()});$("#btnQuery").click(function(){a.logic.search()});$("#btnDel").click(function(){a.logic.delAll()})},data:{param:{}},logic:{get_list:function(c,f,e,b){if(e){var d=c+"?isAll=true&orgPID="+e+"&orgLvl=3"}else{var d=c+"?orgLvl=2"}$.ajax({async:false,url:d,type:"GET",success:function(h){if(e){mini.get("drtDeptCode").loadList(h,"orgId","orgPID");mini.get("drtDeptCode").setValue("全部");a.logic.load_risk_menu();b&&b()}else{mini.get("orgCode").loadList(h,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("orgCode").data[0].orgCode;mini.get("orgCode").setValue(mini.get("orgCode").data[0].orgCode)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("orgCode").disable();for(var g=0;g<h.length;g++){(function(i){if(i.orgCode==enterpriseCode){mini.get("orgCode").setValue(i.orgCode)}})(h[g])}}mini.get("orgCode").doValueChanged();b&&b()}}})},initTable:function(){mini.parse();grid=mini.get("datagrid");detailGrid_Form=document.getElementById("detailGrid_Form")},show_edit:function(b){return ECS.util.editRender("","")},show_edit2:function(b){return ECS.util.editRender("","")},show_editeditAttr:function(){return'<a title="编辑" href="javascript:window.page.logic.editAttr()"><i class="icon-edit edit"></i>编辑</a>&nbsp&nbsp<a title="删除" href="javascript:window.page.logic.delAttr()"><i class="icon-delete delete"></i>删除</a>'},search:function(){a.data.param=ECS.form.getData("searchForm");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"});grid.load(a.data.param)},delAll:function(){var b=[];var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.vehicleBigID)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:true,data:JSON.stringify(b),dataType:"json",timeout:1000,contentType:"application/json;charset=utf-8",type:"DELETE",success:function(d){if(d.isSuccess){layer.msg(d.message,{time:1000},function(){grid.reload()})}else{layer.msg(d.message)}},error:function(d){layer.msg(d.responseText)}})},function(d){layer.close(d)})},add:function(){var b=PageModelEnum.NewAdd;var c="新增车辆分类";a.logic.detail(c,b)},edit:function(){var b=PageModelEnum.Edit;var c="修改车辆分类";a.logic.detail(c,b)},detail:function(d,b){var c;if(b==PageModelEnum.Edit){c=mini.get("datagrid").getSelected()}layer.open({type:2,closeBtn:0,area:["500px","450px"],skin:"new-class",shadeClose:false,title:false,content:"Edit.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:b,title:d};i.page.logic.setData(h,c)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},onShowRowDetail:function(c){var b=c.sender;var d=c.record;var f=b.getRowDetailCellEl(d);f.appendChild(detailGrid_Form);detailGrid_Form.style.display="block";mini.get("gridDetail").set({url:searchDetailUrl+"/"+d.vehicleBigID,ajaxType:"get",dataField:"result"});mini.get("gridDetail").load()},closeLayer:function(b){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(index)},editAttr:function(){var b=mini.get("gridDetail").getSelected();layer.open({type:2,closeBtn:0,area:["700px","60%"],skin:"new-class",shadeClose:false,title:false,content:"Attribute.html?"+Math.random(),success:function(d,e){var c=layer.getChildFrame("body",e);var g=window[d.find("iframe")[0]["name"]];var f={pageMode:PageModelEnum.NewAdd,title:"属性管理"};g.page.logic.setData(f,b)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},delAttr:function(){var c=mini.get("gridDetail").getSelected();var b=[];b.push(c.vehicleSmallId);layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delAttrUrl,async:true,data:JSON.stringify(b),dataType:"json",timeout:1000,contentType:"application/json;charset=utf-8",type:"DELETE",success:function(d){if(d.isSuccess){layer.msg(d.message,{time:1000},function(){mini.get("gridDetail").reload()})}else{layer.msg(d.message)}},error:function(d){layer.msg(d.responseText)}})},function(d){layer.close(d)})}}};a.init();window.page=a});