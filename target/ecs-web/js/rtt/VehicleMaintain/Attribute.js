var addUrl=ECS.api.rttUrl+"/vehicleMaintain";var getSmailUrl=ECS.api.rttUrl+"/vehicleMaintain/getVehicleSmallInfo";var getSingleUrl=ECS.api.rttUrl+"/constitutionType/getSingleConstitutionType";var updateUrl=ECS.api.rttUrl+"/vehicleMaintain/updateVehicleSmall";var uploadAttrUrl=ECS.api.rttUrl+"/vehicle/uploadFile";var downloadUrl=ECS.api.rttUrl+"/vehicle/downloadFile";var uploader;var fileType;var validate;var fileTypes=new Array();var attaArray=new Array();var status=0;var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var listLength=$("#nameList .form-group").length;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$("input").blur(function(){$(this).val($.trim($(this).val()))});b.logic.upload();this.bindUI()},bindUI:function(){$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$(".close").click(function(){b.logic.delAtt(this)});$(".viewImg").bind("click",function(){var c=$(this);c.viewer({inline:false,viewed:function(){c.viewer("zoomTo",1)},hidden:function(){$(".viewImg").viewer("destroy")}})});$("#idCardBtn").click(function(){fileType=1});$("#addNewName").click(function(){var c="";$("#nameList").find(".form-control").each(function(d){$(this).val($(this).val());if($(this).val()!=""){c+=$(this).val()}});if(c.length>=200){return false}$("#nameList").append('<div class="form-group"><div class="col-xs-7 col-xs-offset-3"><input type="text" name="list'+listLength+'" class="form-control required" maxlength="200" /></div><span class="span-required">* &nbsp;&nbsp;</span><button class="btn btn-danger delName" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div>');listLength++});$("#nameList").on("click",".delName",function(){$(this).closest(".form-group").remove();listLength--;return false})},logic:{setData:function(c,d){$("#title-main").text(c.title);$("#vehicleSmallName").attr("disabled","disabled");ECS.form.setData("AddOrEditModal",d);$.ajax({type:"GET",url:getSmailUrl+"/"+d.vehicleSmallId,data:{},dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(e){ECS.showLoading();console.log(e)},success:function(e){ECS.hideLoading();if(e.vehicleBigPicture){$("#idCardBtn").hide();$("#view1").show();$(".close").show();$("#view1").html('<img id="img1" src="'+downloadUrl+"?fileId="+e.vehicleBigPicture+'">')}if(e.vehicleSmallAttributes.length>0){console.log(e);var g=e.vehicleSmallAttributes;$("#firstName").val(g[0]);$("#firstName").attr("nameid",g[0]);for(var f=1;f<g.length;f++){$("#nameList").append('<div class="form-group"><div class="col-xs-7 col-xs-offset-3"><input type="text" pid="" nameid="" name="list'+f+'" class="form-control required" maxlength="200" value="'+g[f]+'" onblur="this.value=this.value.replace(/\\s+/g,\'\')" /></div><span class="span-required">*&nbsp;&nbsp;&nbsp;</span><button class="btn btn-danger delName" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div></div>')}listLength=$("#nameList .form-group").length}else{}},error:function(e){$("#btnSave").attr("disabled",false);ECS.hideLoading();layer.msg("系统繁忙")}})},save:function(){b.logic.formValidate();var f=[];var c=ECS.form.getData("AddOrEditModal");$("#nameList").find(".form-control").each(function(g){$(this).val($.trim($(this).val()));if($(this).val()!=""){f.push($(this).val())}});var d={vehicleSmallName:$("#vehicleSmallName").val(),vehicleSmallId:$("#vehicleSmallId").val(),vehicleSmallAttribute:f.toString(","),vehicleBigPicture:c.personnelPhotoPath,vehicleSmallPicture:c.personnelPhotoPath};if(d.vehicleSmallAttribute.length>200){layer.msg("技术属性超长");return}if(!$("#AddOrEditModal").valid()){return}var e="PUT";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){e="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:updateUrl,async:false,type:"PUT",data:JSON.stringify(d),dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(g){ECS.hideLoading();$("#btnSave").attr("disabled",false);if(g.isSuccess){layer.msg(g.message,{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(g.message)}},error:function(g){$("#btnSave").attr("disabled",false);ECS.hideLoading();layer.msg("系统繁忙")}})},upload:function(){uploader=new plupload.Uploader({browse_button:["idCardBtn"],url:uploadAttrUrl,multi_selection:false,multipart_params:{collectionStr:""},filters:{mime_types:[{title:"Image files",extensions:"jpg,jpeg,png,JPG,JPEG,PNG"}],max_file_size:"50mb",prevent_duplicates:false}});uploader.init();uploader.bind("FilesAdded",function(e,c){if(c[0].name.length>100){e.removeFile(c[0]);layer.msg("文件名称不能超过100字符！");return}if(e.files.length>0){var d=false;for(x in e.files){if(e.files[x].fileType==fileType){fileTypes.push(fileType);c[0].fileType=fileType;fileTypes.splice(x,1);e.removeFile(e.files[x]);d=true}}if(!d){fileTypes.push(fileType);c[0].fileType=fileType}}else{fileTypes.push(fileType);c[0].fileType=fileType}ECS.showLoading();e.start()});uploader.bind("FileUploaded",function(g,d,c){if(pageMode==PageModelEnum.NewAdd){var f={};f.fileId=c.response;f.fileName=d.name;f.fileType=d.fileType;attaArray.push(f)}if(pageMode==PageModelEnum.Edit){var e=false;for(x in attaArray){if(attaArray[x].fileType==d.fileType){attaArray[x].fileId=c.response;attaArray[x].fileName=d.name;e=true}}if(!e){var f={};f.fileId=c.response;f.fileName=d.name;f.fileType=d.fileType;f.careVehId=$("#careVehId").val();attaArray.push(f)}}});uploader.bind("UploadComplete",function(d,c){b.logic.previewImage(c[0],function(e){$("#idCardBtn").hide();$("#view1").show();$(".close").show();$("#view1").empty();$("#view1").append('<img id="img1" src="'+e+'" />')});if(attaArray.length>0){$("#personnelPhotoPath").val(attaArray[0].fileId);$("#personnelPhotoPath").closest(".form-group").removeClass("has-error");$("#personnelPhotoPath").next("#personnelPhotoPath-error").remove()}else{$("#personnelPhotoPath").val("")}ECS.hideLoading()});uploader.bind("Error",function(d,c){if(c.code==-600){layer.msg("上传文件不能大于50MB！");return}c.file.status=2;layer.msg(JSON.parse(c.response).collection.error.message)})},delAtt:function(c){$("#view1 img").remove();$("#view1").hide();$(".close").hide();$("#idCardBtn").show();for(x in uploader.files){if(uploader.files[x].fileType==1){fileTypes.splice(x,1);uploader.files.splice(x,1);break}}$("#personnelPhotoPath").val("");b.logic.formValidates();if(!$("#AddOrEditModal").valid()){return}},previewImage:function(e,f){if(!e||!/image\//.test(e.type)){return}if(e.type=="image/gif"){var d=new mOxie.FileReader();d.onload=function(){f(d.result);d.destroy();d=null};d.readAsDataURL(e.getSource())}else{var c=new mOxie.Image();c.onload=function(){c.downsize(300,300);var g=c.type=="image/jpeg"?c.getAsDataURL("image/jpeg",80):c.getAsDataURL();f&&f(g);c.destroy();c=null};c.load(e.getSource())}},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{enterpriseCode:{required:true},vehicleBigName:{required:true},firstName:{required:true}}})}}};b.init();window.page=b});