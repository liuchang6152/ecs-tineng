var searchUrl=ECS.api.emUrl+"/meetingUser/getUnconnectedUser";var deleteUrl=ECS.api.emUrl+"/meetingUser";var saveUrl=ECS.api.emUrl+"/meetingRecord";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var oid="";var meetingRecordId="";var userList=null;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();var c=document.body.clientHeight-150+"px";$("#datagrid").css("height",c)},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#selectOwner").click(function(){b.logic.selectOwner("人员选择",PageModelEnum.Details)});$("#btnDel").click(function(){b.logic.delAll()})},logic:{setData:function(c,d){meetingRecordId=c;userList=d;b.logic.search()},setWay:function(f){if(!f.row.mobile){return"<label>座机</label>"}var c=f.value!=1?"checked='checked'":"";var d='<label><input type="checkbox" '+c+"/> 手机</label>";return d},setStatus:function(){return"未接通"},search:function(){var c=mini.get("datagrid");c.set({url:searchUrl+"?meetingRecordId="+meetingRecordId,ajaxType:"get",dataField:"pageList"});c.load()},delAll:function(){var d=mini.get("datagrid");var e=d.getSelecteds();if(e.length>0){d.removeRows(e,true)}return false;var c=[];var f=d.getSelecteds();$.each(f,function(g,h){if(!h.meetingUserId){return}c.push({meetingUserId:h.meetingUserId})});if(c.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:deleteUrl,async:true,data:JSON.stringify(c),dataType:"json",timeout:1000,contentType:"application/json;charset=utf-8",type:"DELETE",success:function(g){if(g.isSuccess){layer.msg("删除成功！",{time:1000},function(){d.reload()})}else{layer.msg(g.message)}},error:function(g){var h=$.parseJSON(g.responseText);layer.msg("系统繁忙")}})},function(g){layer.close(g)})},selectOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","100%"],skin:"new-class",shadeClose:false,title:false,content:"../../em/CommGroup/SelectPersons.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d+"(单选)",multiSelect:false,orgCode:ECS.sys.Context.SYS_ENTERPRISE_CODE};i.page.logic.setData(h)},end:function(){var k=mini.get("datagrid").getData();var j=window.ownDetail;var e=[];for(var g=0;g<j.length;g++){var i=j[g];if(!b.logic.isExists(k,window.ownDetail[g].userId)){var f={name:"New Row",userId:i.userId,nameCode:i.userName+"("+i.userId+")",mobile:i.userMobile,phone:i.userPhone,isHandSet:0};e.push(f);var h=mini.get("datagrid");h.addRow(f)}else{layer.msg(window.ownDetail[g].userName+"已存在")}}}})},isExists:function(e,f){if(!e){return false}var c=e.length;while(c-->0){if(e[c].userId==f){return true}}var d=userList.length;while(d-->0){if(userList[d].userId==f){return true}}return false},save:function(){var c={meetingRecordId:meetingRecordId,meetingUserEntityList:[]};var d=mini.get("datagrid").getSelecteds();if(d.length==0){d=mini.get("datagrid").getData()}if(d.length>20){layer.msg("参会人员最多为20人");return}var e=[];$(d).each(function(g){var f={meetingUserId:d[g].meetingUserId,userId:d[g].userId,isHandset:d[g].isHandSet,connectionNumber:d[g].isHandSet==0?d[g].phone:d[g].mobile};c.meetingUserEntityList.push(f);e.push(d[g].isHandSet==0?d[g].phone:d[g].mobile)});window.pageLoadMode=PageLoadMode.Reload;$.ajax({url:saveUrl,async:false,type:"POST",data:JSON.stringify(c),dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(f){ECS.hideLoading();if(f.isSuccess){parent.parent.meetAdd(e);layer.msg("呼叫成功",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg("呼叫失败")}},error:function(f){$("#btnSave").attr("disabled",false);ECS.hideLoading();layer.msg("系统繁忙")}})},onCellbeginedit:function(c){if(c.field=="isHandSet"&&(c.record.phone==""||c.record.mobile=="")){c.cancel=true}},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)}}};b.init();window.page=b});