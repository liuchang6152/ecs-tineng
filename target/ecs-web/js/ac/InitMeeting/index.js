var initMeetingUrl=ECS.api.emUrl+"/initiateMeeting";var eventUrl=ECS.api.apUrl+"/fileAlarmChild/getTransferPoliceInfoNoPage";$(function(){var a={init:function(){mini.parse();a.bindUI();a.logic.initMeetingType();ECS.sys.RefreshContextFromSYS()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){a.logic.add()});$("#btnDel").click(function(){a.logic.del()});$("#btnInit").click(function(){a.logic.initMeeting()});mini.get("meetingType").on("valuechanged",function(b){a.logic.getEvents(b)})},data:{param:{}},logic:{initMeetingType:function(){var b=[{id:0,text:"普通会议"},{id:1,text:"接警事件"},];mini.get("meetingType").setData(b);mini.get("meetingType").select(0)},getEvents:function(b){if(b.value==1){mini.get("eventId").setEnabled(true);ECS.util.bindCmb({url:eventUrl,ctrId:"eventId",idField:"eventId",textField:"eventAddressr"},function(c){mini.get("eventId").setData(c.result);mini.get("eventId").select(0)})}else{mini.get("eventId").setEnabled(false);mini.get("eventId").setData([])}},add:function(){ECS.util.detail({height:480,url:"../../em/CommGroup/SelectPersons.html",data:{title:"人员选择",pageMode:PageModelEnum.NewAdd,orgCode:ECS.sys.Context.SYS_ENTERPRISE_CODE}},function(){var d=mini.get("datagrid").data;for(var c=0,b=window.ownDetail.length;c<b;c++){if(!a.logic.isExists(d,window.ownDetail[c].userId)){var e={userId:window.ownDetail[c].userId,userName:window.ownDetail[c].userName+"("+window.ownDetail[c].userId+")",userMobile:window.ownDetail[c].userMobile,userPhone:window.ownDetail[c].userPhone,mark:window.ownDetail[c].userMobile==""?0:1};d.push(e)}}mini.get("datagrid").setData(d)})},isExists:function(c,d){if(!c){return false}var b=c.length;while(b-->0){if(c[b].userId==d){return true}}return false},del:function(){var b=mini.get("datagrid");var c=b.getSelecteds();if(c.length==0){layer.msg("请选择要删除的数据");return}b.removeRows(c)},initMeeting:function(){var d=ECS.form.getData("AddOrEditModal");if(d.meetingTheme==""){layer.msg("请输入会议主题");return}d.person=[];var g=mini.get("datagrid").getSelecteds();if(g.length==0){g=mini.get("datagrid").getData()}if(g.length==0){layer.msg("请选择参会人员");return}if(g.length>20){layer.msg("参会人员最多为20人");return}var f=[];for(var c=0,b=g.length;c<b;c++){if(g[c].mark==1&&g[c].userMobile==""){layer.msg(g[c].userName+"手机号为空，请选择座机或是删除该人员");return}var e={personId:g[c].userId,mark:g[c].mark,phone:g[c].mark==1?g[c].userMobile:g[c].userPhone};d.person.push(e);f.push(g[c].mark==1?g[c].userMobile:g[c].userPhone)}console.log(JSON.stringify(d));ECS.util.addOrEdit({url:initMeetingUrl,data:d,pageMode:PageModelEnum.NewAdd},function(h){var j=h=$.parseJSON(h);var i="../../html/ac/InitMeeting/MeetingDetail.html?"+Math.random();window.parent.open(i,j.result,function(){parent.closeMeeting()},{height:"95%",width:"95%",closeBtn:0},function(){parent.meeting(f)})})},onCellbeginedit:function(b){if(b.field=="mark"&&(b.record.userPhone==""||b.record.userMobile=="")){b.cancel=true}}}};a.init();window.page=a});