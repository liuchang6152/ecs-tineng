var getSingleUrl=ECS.api.apUrl+"/AutomaticMonitoring";var addUrl=ECS.api.apUrl+"/AutomaticMonitoring";var riskRankUrl=ECS.api.bcUrl+"/riskRank/getListRiskRank?inUse=1";var eventLvlIdUrl=ECS.api.apUrl+"/DirectAlarm/eventLvl";var orgNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var accCategoryUrl=ECS.api.bcUrl+"/accidentCategory/list";var accTypeUrl=ECS.api.bcUrl+"/accidentCategory/accidentType";var keyWordUrl=ECS.api.apUrl+"/AutomaticMonitoring/getKeywordReList?keyWordreCode=AP_AC_FAE_R";var getGisUrl=ECS.api.gisSurfaceUrl;var getStatuUrl=ECS.api.apIpVerify+"/status";var acceptance=ECS.api.apIpVerify;var acceptanceUrl=ECS.api.apUrl+"/AutomaticMonitoring/alarmTelStatus";var eventId="";var uuid="";var curIP="";var gisenterpriseId="";var gisdrtDeptId="";var gisoptlRiskZoneId="";var gisriskAreaId="";var gisriskAnlsObjId="";var gispointId="";var cancelReason="";var flag=false;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){this.bindUI();mini.parse();setInterval("page.logic.initTable()",5000);b.logic.cbxKeyWord();b.logic.getGisValue()},table:{},bindUI:function(){$("#infoList").hover(function(){$("#nav_submenu").css("display","table").stop()},function(){$("#nav_submenu").stop().hide()});$("#nav_submenu").on("click","li",function(){var c=$("#information").val();$("#information").val(c+$(this).attr("title")+"  ")});$("#btnAccept").click(function(){$("#btnAccept").attr("disabled",true);$("#btnCancle").attr("disabled",false);$("#btnAlarm").attr("disabled",false);$.ajax({url:acceptanceUrl+"?eventId="+eventId+"&now="+Math.random(),type:"put",dataType:"text",success:function(){$.ajax({url:acceptance+"/"+uuid+"?ip="+curIP+"&eventId="+eventId+"&now="+Math.random(),type:"get",dataType:"json",success:function(c){layer.msg(c.message)},error:function(c){var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},error:function(c){var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})});$(document).on("change","select#eventLvlId",function(){var c=$("#eventLvlId").find("option:selected").attr("code");if(c!=undefined){layer.confirm("你确认事故等级是"+c+"吗？",{btn:["确定","取消"]},function(d){layer.close(d)},function(){$("#eventLvlId").val("7")})}else{$("#eventLvlId").val("7")}});$("#casualtyCount").blur(function(){this.value=this.value.replace(/\D/g,"");if(this.value){layer.confirm("你确认人员受伤是"+this.value+"人吗？",{btn:["确定","取消"]},function(c){layer.close(c)},function(){$("#casualtyCount").val("")})}});$("#dieCount").blur(function(){this.value=this.value.replace(/\D/g,"");if(this.value){layer.confirm("你确认人员死亡是"+this.value+"人吗？",{btn:["确定","取消"]},function(c){layer.close(c)},function(){$("#dieCount").val("")})}});$("#propertyLossCount").blur(function(){this.value=this.value.replace(/\D/g,"");if(this.value){layer.confirm("您确定财产损失是"+this.value+"万元吗？",{btn:["确定","取消"]},function(c){layer.close(c)},function(){$("#propertyLossCount").val("")})}});$("#btnAlarm").click(function(){if(flag){b.logic.save("2")}else{layer.msg("此报警信息已无效，请取消！")}});$("#btnCancle").click(function(){layer.open({type:2,closeBtn:0,area:["500px","300px"],skin:"new-class",title:false,shadeClose:false,content:"ReasonCancellation.html?"+Math.random(),success:function(d,e){var c=layer.getChildFrame("body",e);var g=window[d.find("iframe")[0]["name"]];var f={title:"取消原因"};g.page.logic.setData(f)},end:function(){if(cancelReason){b.logic.save("1")}}})})},data:{param:{}},logic:{setData:function(c){ECS.sys.RefreshContextFromSYS();$("#iframe_map").attr("src",ECS.api.gisserver_url+"/all_zjdxgis/index_ptquery.html?iframe=true&show_info=false&code="+window.btoa(ECS.sys.Context.SYS_ENTERPRISE_CODE));b.logic.cbxRiskRank();b.logic.cbxEventLvl();b.logic.cbxDrtDept();b.logic.cbxAccidentCategory();if(c.mode){eventId=c.eventId;curIP=c.curIP}else{uuid=c.uuid;curIP=c.curIP;eventId=c.event.eventId}$.ajax({url:getSingleUrl+"?eventId="+eventId+"&now="+Math.random(),type:"get",async:false,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(f){if(c.alertRule=="2"){$("#btnAccept").remove();$("#btnCancle").attr("disabled",false);$("#btnAlarm").attr("disabled",false)}else{if(f.alarmTelStatus=="0"){$("#btnAccept").attr("disabled",false);$("#btnCancle").attr("disabled",true);$("#btnAlarm").attr("disabled",true)}else{$("#btnAccept").attr("disabled",true);$("#btnCancle").attr("disabled",false);$("#btnAlarm").attr("disabled",false)}}gisenterpriseId=f.enterpriseId;gisdrtDeptId=f.drtDeptId;gisriskAreaId=f.riskAreaId;gisoptlRiskZoneId=f.optlRiskSoneId;gisriskAnlsObjId=f.riskAnlsObjId;gispointId=f.pointId;if(f.eventAddress){$("#eventAddress").attr("readonly",false)}else{$("#eventAddress").attr("readonly",true)}ECS.form.setData("AddOrEditModal",f);$(".eventSummary").html(f.eventSummary);var g=[];for(var h in f.alertsLogEntityMap){g=g.concat(f.alertsLogEntityMap[h])}if(g.length>0){flag=true}else{flag=false}mini.get("alarm").setData(g);var d=[];for(var e=0;e<g.length;e++){d=d.concat(g[e].sendMap)}mini.get("feedback").setData(d);if(f.optlRiskSoneId){b.logic.getList("5",f.optlRiskSoneId,"作业风险区")}else{if(f.riskAreaId){b.logic.getList("4",f.riskAreaId,"安全风险区")}else{if(f.drtDeptId){b.logic.getList("3",f.drtDeptId,"二级单位")}else{if(f.enterpriseId){b.logic.getList("2",f.enterpriseId,"企业")}}}}ECS.hideLoading()},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},initTable:function(){$.ajax({url:getSingleUrl+"?eventId="+eventId+"&now="+Math.random(),type:"get",async:true,dataType:"json",success:function(f){var c=[];for(var g in f.alertsLogEntityMap){c=c.concat(f.alertsLogEntityMap[g])}if(c.length>0){flag=true}else{flag=false}mini.get("alarm").setData(c);var d=[];for(var e=0;e<c.length;e++){d=d.concat(c[e].sendMap)}mini.get("feedback").setData(d)},error:function(c){var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},adressDetail:function(c){return c.row.riskAreaName+"->"+c.row.optlRiskZoneName+"->"+c.row.riskAnlsobjName},siteName:function(c){return c.row.rapName+"->"+c.row.siteName},cbxKeyWord:function(){$.ajax({url:keyWordUrl,type:"get",dataType:"json",success:function(c){if(c.length>0){for(var d=0;d<c.length;d++){$("#nav_submenu").append("<li title='"+c[d].keyWordreExplain+"'>"+c[d].keyWord+"</li>")}}},error:function(c){var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},cbxRiskRank:function(){ECS.ui.getCombobox("riskRankId",riskRankUrl+"&enterpriseCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE,{selectValue:"-1",keyField:"riskRankID",valueField:"rankDisplay",async:false},null)},cbxEventLvl:function(){ECS.ui.getCombobox("eventLvlId",eventLvlIdUrl+"?orgCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE,{selectValue:"7",keyField:"eventLvlId",valueField:"eventLvlName",codeField:"eventLvlName",async:false},null)},cbxAccidentCategory:function(){ECS.ui.getCombobox("accidentCategoryId",accCategoryUrl,{selectValue:"-1",keyField:"accidentCategoryID",valueField:"accidentCategoryName",async:false},null,b.logic.cbxAccidentType)},cbxAccidentType:function(c){ECS.ui.getCombobox("accidentTypeId",accTypeUrl,{selectValue:"-1",keyField:"accidentTypeID",valueField:"accidentTypeName",async:false,data:{accidentCategoryID:c}})},cbxDrtDept:function(){ECS.ui.getCombobox("enterpriseId",orgNameUrl,{keyField:"orgId",valueField:"orgSname",async:false})},getList:function(d,e,c){if(e){$.ajax({url:getGisUrl+"/surface/type/"+d+"/alarm/"+e+"?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE,async:false,type:"get",dataType:"json",success:function(f){if(f.length>0){var g={layerName:c,id:f[0].gisSurfaceId}}else{var g={layerName:"",id:""}}setTimeout(function(){var i=document.getElementById("iframe_map");var h=i.document;if(h==undefined){i.contentWindow.postMessage(g,"*")}else{i.postMessage(g,"*")}},5000)},error:function(f){ECS.hideLoading();var g=$.parseJSON(f.responseText);layer.msg(g.collection.error.message)}})}},getGisValue:function(){if(window.addEventListener){window.addEventListener("message",b.logic.handleMessage,false)}else{window.attachEvent("onmessage",b.logic.handleMessage)}},handleMessage:function(d){d=d||window.event;var c="";switch(d.data[0].layerName){case"企业":c=2;break;case"二级单位":c=3;break;case"安全风险区":c=4;break;case"作业风险区":c=5;break;default:c=""}$.ajax({url:getGisUrl+"/surface/type/"+c+"/id/"+d.data[0].id+"?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE,async:true,type:"get",dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(f){var e="";if(f.enterpriseName){e+=f.enterpriseName}if(f.unitName){e+=f.unitName}if(f.riskAreaName){e+=f.riskAreaName}if(f.optlRiskZoneName){e+=f.optlRiskZoneName}gisenterpriseId=f.enterpriseId;gisdrtDeptId=f.unitId;gisriskAreaId=f.riskAreaId;gisoptlRiskZoneId=f.optlRiskZoneId;gisriskAnlsObjId="";gispointId="";$("#eventAddress").val(e);if(e){$("#eventAddress").attr("readonly",false)}else{$("#eventAddress").attr("readonly",true)}ECS.hideLoading()},error:function(e){ECS.hideLoading();var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},save:function(c){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}if($("#riskRankId").val()=="-1"){$("#riskRankId").val("")}if($("#accidentCategoryId").val()=="-1"){$("#accidentCategoryId").val("")}if($("#accidentTypeId").val()=="-1"){$("#accidentTypeId").val("")}var f=ECS.form.getData("AddOrEditModal");var d={alarmTelStatus:c,eventAddress:f.eventAddress,eventId:eventId,riskRankId:f.riskRankId,accidentCategoryId:f.accidentCategoryId,accidentTypeId:f.accidentTypeId,enterpriseId:gisenterpriseId,drtDeptId:gisdrtDeptId,riskAreaId:gisriskAreaId,optlRiskSoneId:gisoptlRiskZoneId,riskAnlsObjId:gisriskAnlsObjId,pointId:gispointId,eventLvlId:f.eventLvlId};var g=[];var e=[];if($("#casualtyCount").val()){g.push({eventId:eventId,casualtyTypeCode:"AP_AC_WOUNDED",casualtyCount:$("#casualtyCount").val(),sortNum:"1",casualtyDiscription:"受伤",isDelete:"0"})}if($("#dieCount").val()){g.push({eventId:eventId,casualtyTypeCode:"AP_AC_DEATH",casualtyCount:$("#dieCount").val(),sortNum:"1",casualtyDiscription:"死亡",isDelete:"0"})}d.casualtyEntityList=g;if($("#propertyLossCount").val()){e.push({eventId:eventId,propertyLossTypeCode:"AP_AC_OTHER",propertyLossMoney:$("#propertyLossCount").val(),sortNum:"1",propertyLossDiscription:"财产损失",isDelete:"0"})}d.propertyLossEntityList=e;if(c=="1"){f.eventSummary+=cancelReason;d.cancelReason=cancelReason}$.ajax({url:addUrl,async:false,type:"PUT",data:JSON.stringify(d),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnAlarm").attr("disabled",true);$("#btnCancle").attr("disabled",true);ECS.showLoading()},success:function(h){if(c=="1"){$.ajax({url:getStatuUrl+"?orgId="+gisenterpriseId+"&ip="+curIP+"&status=close&now="+Math.random(),type:"get",dataType:"json",success:function(){parent.hasArlamId={eventId:eventId,ip:curIP,isAlram:false};parent.layer.close(a);ECS.hideLoading()},error:function(i){$("#btnAlarm").attr("disabled",false);$("#btnCancle").attr("disabled",false);ECS.hideLoading();var j=$.parseJSON(i.responseText);layer.msg(j.collection.error.message)}})}else{parent.hasArlamId={eventId:eventId,ip:curIP,isAlram:true};parent.layer.close(a);ECS.hideLoading()}},error:function(h){$("#btnAlarm").attr("disabled",false);$("#btnCancle").attr("disabled",false);ECS.hideLoading();var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{eventAddress:{required:true}}})}}};b.init();window.page=b});