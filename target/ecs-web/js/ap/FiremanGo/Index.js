var teamUrl=ECS.api.apUrl+"/policeProcess";var carUrl=ECS.api.apUrl+"/policeProcess/getTeamByTeamId";var orderSender=ECS.api.apWebSocket+"/policeProcess";var closePageUrl=ECS.api.apUrl+"/policeProcess/vehicleReturn";var sendUrl=ECS.api.apUrl+"/policeProcess/policeEnd";var detailUrl=ECS.api.apUrl+"/fileAlarmChild/singlePoliceRecord";var previewUrl=ECS.api.apUrl+"/event/getPreviewPreview";var downloadUrl=ECS.api.rttUrl+"/vehicle/downloadFile";var videoUrl=ECS.api.apUrl+"/policeProcess/getVideoSurveillance";var noFeedbackUrl=ECS.api.apUrl+"/firemanGo/noFeedback";var teamIPUrl=ECS.api.apUrl+"/fileAlarmChild/findByIp?teamId=";window.pageLoadMode=PageLoadMode.None;var tabindex1=0;var tabindex2=0;var tabindex3=0;var tabindex4=0;var vm=new Vue({el:"#main",data:{items:[],selectedItem:[],eventId:"",detail:{},selectedTree:[],attrUrl:"",heigth:"",heigth3:"",width:"",video:[],src:"",tips:null},mounted:function(){this.heigth=document.body.clientHeight-120+"px";this.heigth3=document.body.clientHeight-200+"px";this.width=document.body.clientWidth-100+"px"},methods:{returnJson:function(a){return JSON.stringify(a)},getImgUrl:function(a){return downloadUrl+"?fileId="+a},windowOpen:function(a){window.open(a.url)},getElementId:function(a,b){return a+b},setAttr:function(a){if(a.poactionStatusName=="待命"){return"TRUE"}else{return"FALSE"}},getError:function(a){if(a.systemName){return"系统分类："+a.systemName+"   相关部件： "+a.relevantModuleCh}},mouseout:function(){layer.close(vm.tips)},mouseover:function(a,f){if(a.length==0){return}var e="";for(var b=0;b<a.length;b++){var d=a[b];e=e+"<div class='col-xs-4'>";e=e+" <label class='control-label'>"+d.systemName+"</label>";e=e+"  </div>";e=e+"<div class='col-xs-4'>";e=e+" <label class='control-label'>"+d.relevantModuleCh+"</label>";e=e+"  </div>";e=e+"<div class='col-xs-4'>";e=e+" <label class='control-label'>"+d.priority+"</label>";e=e+"  </div>"}var c="<div style='text-align: center;  class='form-horizontal'> <div class='row' > <div class='col-xs-12'> <div class='form-group'> <div class='col-xs-4'> <label class='control-label'>系统分类</label>  </div>  <div class='col-xs-4' > <label class='control-label'>相关部件</label>  </div>  <div class='col-xs-4' > <label class='control-label'>故障等级</label>  </div>"+e+"  </div>  </div>  </div>";vm.tips=layer.tips(c,"#div"+f,{area:["400px","auto"],time:0,tips:[1,"#c00"]})}},});$(function(){var a={init:function(){mini.parse();a.bindUI();mini.get("tree1").on("drawnode",function(f){var d=f.field,b=f.record,c=f.rowIndex;if(f.record._level!=0){f.showCheckBox=false}})},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btndispatch").click(function(){a.logic.dispatch()});$("#btndispatchAll").click(function(){a.logic.dispatchAll()});$("#btnclearCaar").click(function(){a.logic.clearCaar()});$("#btnOrderSend").click(function(){a.logic.OrderSend()});$("#btnAlarmSend").click(function(){a.logic.AlarmSend()});$("#btnHangup").click(function(){parent.hangup()});$("#btnClose").click(function(){parent.hangup();parent.setFree();try{document.getElementById("iframe").contentWindow.DoStopPlay()}catch(c){}var b=parent.layer.getFrameIndex(window.name);parent.layer.close(b)});$("#btnOther").click(function(){a.logic.otherPlan()});mini.get("tree1").on("nodecheck",function(b){if(b.checked){}a.logic.drawCar(b)});$("#btnSendTask").click(function(){a.logic.sendTask()})},data:{param:{sendSuccessArr:[],sendFailArr:[]}},logic:{setData:function(c,b){vm.eventId=c;console.log(c);a.logic.init();if(b){$("#btndispatch").hide();$("#btndispatchAll").hide();$("#btnclearCaar").hide();$("#btnOrderSend").hide();$("#btnAlarmSend").hide();$("#btnHangup").hide();$("#btnoff").hide();parent.setFree()}else{parent.setBusy()}},isExist:function(d){for(var b=0;b<vm.selectedTree.length;b++){var c=vm.selectedTree[b];if(c.teamId==d.teamId){d.checked=true}}},defaultSelect:function(d){for(var b=0;b<d.length;b++){var c=d[b];if(c.show){c.checked=true}}},init:function(){a.logic.initTab1();a.logic.initTab2();$('a[data-toggle="tab"]').on("shown.bs.tab",function(d){var c=d.target;var b=d.relatedTarget;switch(c.hash){case"#tab1":a.logic.initTab1();break;case"#tab2":a.logic.initTab2();break;case"#tab3":a.logic.initTab3();break;case"#tab4":a.logic.initTab4();break}})},initTab1:function(){$.ajax({async:false,url:teamUrl+"?eventId="+vm.eventId,type:"get",success:function(d){for(var b=0;b<d.result.length;b++){var c=d.result[b];a.logic.defaultSelect(d.result);a.logic.isExist(c)}mini.get("tree1").loadData(d.result);a.logic.drawCar();tabindex1=1},error:function(b){}})},initTab2:function(){$.ajax({url:detailUrl+"?eventId="+vm.eventId,type:"get",success:function(b){vm.detail=a.logic.Convert(b);tabindex2=1},error:function(b){}})},initTab3:function(){$.ajax({url:previewUrl+"?eventId="+vm.eventId,type:"get",success:function(d){if(d.isSuccess){if(!d.result){layer.msg("未匹配到预案");return false}tabindex3=1;$("#previewName").text(d.message);var b=d.result.atchName;var c=b.lastIndexOf(".");var e=b.substr(c+1);if(e=="doc"||e=="docx"||e=="xls"||e=="xlsx"||e=="rar"){layer.msg("该文件不支持在线预览")}vm.attrUrl=downloadUrl+"?fileId="+d.result.atchPath+"#toolbar=0"}},error:function(b){}})},initTab4:function(){if(tabindex4==0){$.ajax({url:videoUrl+"?eventId=24362",type:"get",success:function(b){tabindex4=1;vm.video=b;vm.src="video.html"},error:function(b){}})}},Convert:function(b){if(b.alarmTime){b.alarmTime=moment(b.alarmTime).format("YYYY-MM-DD HH:mm:ss")}if(b.initTime){b.initTime=moment(b.initTime).format("YYYY-MM-DD HH:mm:ss")}if(b.commandTime){b.commandTime=moment(b.commandTime).format("YYYY-MM-DD HH:mm:ss")}if(b.completeTime){b.completeTime=moment(b.completeTime).format("YYYY-MM-DD HH:mm:ss")}if(b.registerTime){b.registerTime=moment(b.registerTime).format("YYYY-MM-DD HH:mm:ss")}b.teamEntities.forEach(function(c){if(c.printingTime){c.printingTime=moment(c.printingTime).format("YYYY-MM-DD HH:mm:ss")}if(c.handleTime){c.handleTime=moment(c.handleTime).format("YYYY-MM-DD HH:mm:ss")}});return b},check:function(c){var b=$("#"+c).prop("checked");if(b){$("#div"+c).css("border","3px solid red")}else{$("#div"+c).css("border","1px solid #dddddd")}a.logic.dispatch()},drawCar:function(d){var c=mini.get("tree1").getCheckedNodes();if(c.length==0){vm.items=[];return false}vm.selectedTree=c;var b=[];$(c).each(function(f){b.push(c[f].teamId)});a.logic.Car(b.toString(","))},Car:function(b){var c={teamId:b};$.ajax({url:carUrl+"?teamIds="+b,type:"get",contentType:"application/json;charset=utf-8",success:function(d){vm.items=d},error:function(d){}})},dispatchAll:function(){var c=[];var b=$("#selectCar input[type='checkbox']");$(b).each(function(d){c.push(JSON.parse(b[d].value))});vm.selectedItem=c;$("#selectCar input[type='checkbox']").prop("checked","true");$("#selectCar [data='TRUE']").css("border","3px solid red")},dispatch:function(){var c=[];var b=$("#selectCar input:checked");$(b).each(function(d){c.push(JSON.parse(b[d].value))});vm.selectedItem=c},clearCaar:function(){vm.selectedItem=[];$("#selectCar input[type='checkbox']").attr("checked",false);$("#selectCar .thumbnail").css("border","1px solid #dddddd")},canel:function(c){var d=vm.selectedItem;var b=$.grep(vm.selectedItem,function(f,e){return c.vehicleId==f.vehicleId},c);vm.selectedItem=b;$("#"+c.vehicleId).attr("checked",false);$("#div"+c.vehicleId).css("border","1px solid #dddddd")},OrderSend:function(e){var f=[];var d=[];var b=vm.selectedItem;$(b).each(function(h){var g=b[h];f.push(g.teamId);d.push(g.vehicleId)});if(d.length==0){layer.msg("请选择车辆");return}var c={tramIds:f,vehicleIds:d,eventId:vm.eventId,teamIdGUID:parent.webSocketId};$.ajax({url:orderSender,type:"post",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnOrderSend").attr("disabled","disabled");ECS.showLoading()},success:function(l){if(l.isSuccess){vm.selectedItem=[];a.logic.clearCaar();a.logic.init();a.logic.drawCar();var h=[];for(var j=0,g=c.tramIds.length;j<g;j++){if(h.indexOf(c.tramIds[j])==-1){h.push(c.tramIds[j])}}for(var j=0,g=h.length;j<g;j++){var k=h[j];$.ajax({url:teamIPUrl+k,type:"GET",contentType:"application/json;charset=utf-8",success:function(i){if(i.isSuccess){parent.sendOrder(i.result,c.eventId+"|"+parent.netIP+"|"+l.result+"|"+k);layer.msg("下达成功")}else{alert(i.message)}}})}}else{layer.msg(l.message)}$("#btnOrderSend").attr("disabled",false);ECS.hideLoading()},error:function(g){$("#btnOrderSend").attr("disabled",false);ECS.hideLoading()}})},AlarmSend:function(){var c=parent.getStatus();var b=c.split("|");if(b[0]!=1){layer.msg("正在通话中");return}$.ajax({url:noFeedbackUrl+"?eventID="+vm.eventId,type:"GET",success:function(d){if(d.result.length>0){layer.open({type:2,area:["30%","40%"],offset:"auto",id:"layerDemoauto",content:"Feedback.html?"+Math.random(),btnAlign:"c",shade:0,yes:function(){layer.closeAll()},title:"更改队伍反馈状态",success:function(f,g){var e=layer.getChildFrame("body",g);var h=window[f.find("iframe")[0]["name"]];h.page.logic.setData(d,vm.eventId)},end:function(){parent.parent.closeTeamcall()}})}else{layer.msg("无未反馈记录")}},error:function(d){console.log(d)}})},otherPlan:function(){layer.open({type:2,area:["90%","90%"],offset:"auto",id:"layerDemoauto",content:"More.html?"+Math.random(),btnAlign:"c",shade:0,yes:function(){layer.closeAll()},title:"更多预案",success:function(c,d){var b=layer.getChildFrame("body",d);var f=window[c.find("iframe")[0]["name"]];var e={eventId:vm.eventId};f.page.logic.setData(e)},end:function(){tabindex3=0;a.logic.initTab3()}})},closePage:function(){$.ajax({url:closePageUrl+"?eventId="+vm.eventId,type:"get",contentType:"application/json;charset=utf-8",success:function(b){var g="";var h=b.result;var i="<div style='text-align: center'>";for(var e=0;e<h.length;e++){var f=h[e];i+=f.teamName+"          "+f.vehicleName+"        出警 <br/>";g+=f.teamName+"          "+f.vehicleName+"        出警  \n"}i+="<span style='color:red'>确定结束事件吗？</span> </div>";g+="确定结束事件吗？";var c=confirm(g);if(c){var d={eventId:vm.eventId};$.ajax({url:sendUrl,async:false,type:"POST",data:JSON.stringify(d),dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(j){ECS.hideLoading();if(j.isSuccess){parent.hangup();parent.setFree();layer.closeAll();var k="auto";layer.open({type:2,area:["30%","30%"],offset:k,id:"layerDemo"+k,content:"End.html?"+Math.random(),btnAlign:"c",shade:0,yes:function(){layer.closeAll()},title:"处警总结",success:function(m,n){var l=layer.getChildFrame("body",n);var p=window[m.find("iframe")[0]["name"]];var o={eventId:vm.eventId};p.page.logic.setData(o)},end:function(){var l=parent.layer.getFrameIndex(window.name)}})}else{layer.msg("系统繁忙")}},error:function(j){$("#btnSave").attr("disabled",false);ECS.hideLoading();layer.msg("系统繁忙")}})}},error:function(b){}})},rendererSendSuccess:function(b){a.data.param.sendSuccessArr.push(b);a.logic.renderer()},rendererSendFail:function(b){a.data.param.sendFailArr.push(b);a.logic.renderer()},renderer:function(){var o=mini.get("tree1");for(var f=0,b=a.data.param.sendFailArr.length;f<b;f++){var h=a.data.param.sendFailArr[f].split("|");var n=h[3];var g=h[2];for(var e=0,k=o.getNode(n+"").children.length;e<k;e++){var d=o.getNode(n).children[e];if(d.firemanGoBatch=="第"+g+"批次"&&d.name.indexOf("未反馈")!=-1){var c=d.teamId;var l=d.name.replace("未反馈","发送失败");var m=o.getNode(c+"");o.setNodeText(m,l)}}}for(var f=0,b=a.data.param.sendSuccessArr.length;f<b;f++){var h=a.data.param.sendSuccessArr[f].split("|");var n=h[3];var g=h[2];for(var e=0,k=o.getNode(n+"").children.length;e<k;e++){var d=o.getNode(n).children[e];if(d.firemanGoBatch=="第"+g+"批次"&&d.name.indexOf("未反馈")!=-1){var c=d.teamId;var l=d.name.replace("未反馈","发送成功");var m=o.getNode(c+"");o.setNodeText(m,l)}}}},sendTask:function(){var c=mini.get("tree1");var e=c.getSelectedNode();if(!e){layer.msg("请选择未反馈或发送失败的批次");return}if(!c.isLeaf(e)){layer.msg("请选择未反馈或发送失败的批次");return}if(e.confirmStateName!="未反馈"){layer.msg("请选择未反馈或发送失败的批次");return}var b=c.getParentNode(e);var d=e.firemanGoBatch.match(/\d+/g);$.ajax({url:teamIPUrl+b.teamId,type:"GET",contentType:"application/json;charset=utf-8",success:function(f){if(f.isSuccess){parent.sendOrder(f.result,vm.eventId+"|"+parent.netIP+"|"+d+"|"+b.teamId);layer.msg("发送成功")}else{alert(f.message)}}})}}};a.init();window.page=a});