var delUrl=ECS.api.emUrl+"/CommonGroupOrg";var treeurl=ECS.api.apUrl+"/event/getRiskTree";var searchUrl=ECS.api.apUrl+"/event/getEmergencyPlanByCondition";var searchTypeUrl=ECS.api.apUrl+"/event/getconfimPlanDefinition";var submitUrl=ECS.api.apUrl+"/event/planDetermination";window.pageLoadMode=PageLoadMode.None;var eventId="";$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();b.logic.initTable();ECS.sys.RefreshContextFromSYS();b.logic.loadType()},table:{},bindUI:function(){mini.get("tree1").on("nodeclick",function(c){b.logic.search()});$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){b.logic.submit()});$("#btnQuery").click(function(){b.logic.search()})},data:{param:{}},logic:{setData:function(c){eventId=c.eventId;b.logic.load_sidebar(treeurl,"tree1")},initTable:function(){mini.parse();grid=mini.get("datagrid")},show_edit:function(c){return ECS.util.editRender(c.row.constitutionTypeID,c.row.orgCode)},load_sidebar:function(c,d){$.ajax({url:c+"?eventId="+eventId,type:"get",success:function(e){mini.get(d).loadList(e.result,"orgRiskId","pOrgRiskId")},error:function(f){}})},loadType:function(c){ECS.ui.getComboSelects(searchTypeUrl,"Type","id","name",false)},search:function(){var c=mini.get("tree1");var d=c.getSelectedNode();b.data.param=ECS.form.getData("searchForm");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"});grid.load({enterpriseId:d.orgRiskId,emergencyPlanName:b.data.param.key_words,planDefinition:b.data.param.Type})},submit:function(){var d=grid.getSelected();var c={eventId:eventId,planId:d.emergencyPlanID};$.ajax({url:submitUrl,async:false,type:"post",data:JSON.stringify(c),dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnAdd").attr("disabled","disabled");ECS.showLoading()},success:function(e){ECS.hideLoading();$("#btnAdd").attr("disabled",false);if(e.isSuccess){layer.msg("确认成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(e.message)}},error:function(e){$("#btnAdd").attr("disabled",false);ECS.hideLoading();layer.msg("系统繁忙")}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},}};b.init();window.page=b});