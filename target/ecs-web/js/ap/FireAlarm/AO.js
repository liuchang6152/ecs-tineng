var getGisUrl=ECS.api.gisSurfaceUrl;var invalidAlarmUrl=ECS.api.apUrl+"/fileAlarmChild/invalidAlarm/";var keyWordUrl=ECS.api.apUrl+"/fileAlarmChild/keywordre";var mobileOrPhoneUrl=ECS.api.apUrl+"/fileAlarmChild/mobileOrPhone";var startUrl=ECS.api.apUrl+"/fileAlarmChild/addEvent";var saveUrl=ECS.api.apUrl+"/fileAlarmChild/updateEvent";var saveHOUrl=ECS.api.apUrl+"/fileAlarmChild/manualEvent";var type_url=ECS.api.apUrl+"/fileAlarmChild/getAccidentTypePojo";var detailUrl=ECS.api.apUrl+"/fileAlarmChild/singlePoliceRecord";var saveEventUrl=ECS.api.apUrl+"/fileAlarmChild/saveEvent";var fIndex;var treatStatus=false;var eventId;var readyState;var currentTime;var timeFlag=false;window.pageLoadMode=PageLoadMode.None;var vm=new Vue({el:"#content",data:{items:[],second:0,masterCallNum:"",eventId:""}});$(function(){var a={init:function(){ECS.sys.RefreshContextFromSYS();mini.parse();this.bindUI();a.logic.initTable();a.logic.initPage();a.logic.getKeyWords();document.oncontextmenu=function(){return false}},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#selectGIS").click(function(){a.logic.GIS()});$("#btnStart").click(function(){a.logic.Start(true)});$("#btnRepeat").click(function(){a.logic.Repeat()});$("#btnTransfer").click(function(){a.logic.Transfer()});$("#btnInvalid").click(function(){a.logic.Invalid()});$("#btnHangup").click(function(){a.logic.hangup()});$("#selectMedia").click(function(){a.logic.selectMedia()});$("#btnSave").click(function(){a.logic.Save()});$("#btnSave_HO").click(function(){a.logic.SaveHO()});$("#btnSaveData").click(function(){a.logic.SaveData()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;a.logic.closeLayer(false)})},data:{param:{}},logic:{setData:function(b){parent.setBusy();if(b){$("#btnStart").attr("disabled","disabled");readyState=1}vm.eventId=b;if(b){$.ajax({url:detailUrl+"?eventId="+vm.eventId,type:"get",success:function(c){eventId=vm.eventId;var d=a.logic.Convert(c);$("#startTime").val(d.alarmTime);$("#mobileOrPhone").val(d.mobileOrPhone);$("#mobileOrPhone").text(d.mobileOrPhone);$("#userName").val(d.userName);$("#userName").text(d.userName);$("#ringInstallAddress").val(d.ringInstallAddress);$("#ringInstallAddress").text(d.ringInstallAddress);$("#accidentType").val(d.accidentTypeId);$("#eventSummary").val(d.eventSummary);$("#answerInstallAddress").val(d.eventAddress);$("#isExplode").attr("checked",d.isExplode==1?true:false);$("#isPersonIn").attr("checked",d.isPersonIn==1?true:false);$("#fireLvl").val(d.fireLvl);$("#fireSubstanceTypeIds").val(d.fireSubstanceTypeIds);$("#fireSubstanceTypeNames").val(d.fireSubstanceName);$("#fireSubstanceTypeNames").text(d.fireSubstanceName);var e="摘机时长："+d.receptionTime+"秒，受理时长："+d.processingTime+"秒";$("#btnHangup").attr("disabled","disabled");$("#htitle").text(e);$("#iTile").text("警情电话"+d.mobileOrPhone);a.data.param.enterpriseId=c.enterpriseId;a.data.param.unitId=c.unitId;a.data.param.riskAreaId=c.riskAreaId;a.data.param.optlRiskZoneId=c.optlRiskZoneId},error:function(c){}})}},setData2:function(b){a.data.param.masterCallNum=b.masterCallNum;a.data.param.ip=b.ip;vm.masterCallNum=b.masterCallNum;a.logic.getMobileOrPhone()},GIS:function(){var c=ECS.sys.Context.SYS_ENTERPRISE_CODE;var b=PageModelEnum.View;fIndex=layer.open({type:2,closeBtn:1,area:["96%","96%"],skin:"new-class",shadeClose:false,title:"选择报警位置",shade:[0.8,"#393D49"],content:"SelectMap.html?"+Math.random(),success:function(e,f){var d=layer.getChildFrame("body",f);var h=window[e.find("iframe")[0]["name"]];var g={pageMode:b,enterpriseId:a.data.param.enterpriseId,drtDeptId:a.data.param.unitId,riskAreaId:a.data.param.riskAreaId,optlRiskSoneId:a.data.param.optlRiskZoneId,title:"选择报警位置"};h.page.logic.setData(g)},end:function(){if(a.data.param.res){$("#answerInstallAddress").val(a.data.param.res);$("#eventSummary").val(a.data.param.res)}}})},initPage:function(){if(window.addEventListener){window.addEventListener("message",a.logic.handleMessage,false)}else{window.attachEvent("onmessage",a.logic.handleMessage)}},handleMessage:function(c){c=c||window.event;var b="";switch(c.data[0].layerName){case"企业":b=2;break;case"二级单位":b=3;break;case"安全风险区":b=4;break;case"作业风险区":b=5;break;default:b=""}$.ajax({url:getGisUrl+"/surface/type/"+b+"/id/"+c.data[0].id,async:true,type:"get",dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(d){var e="";if(d.enterpriseName){e+=d.enterpriseName}if(d.unitName){e+="-"+d.unitName}if(d.riskAreaName){e+="-"+d.riskAreaName}if(d.optlRiskZoneName){e+="-"+d.optlRiskZoneName}a.data.param.enterpriseId=d.enterpriseId;a.data.param.unitId=d.unitId;a.data.param.riskAreaId=d.riskAreaId;a.data.param.optlRiskZoneId=d.optlRiskZoneId;$("#answerInstallAddress").val(e);$("#eventSummary").val(e);layer.close(fIndex);ECS.hideLoading()},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},Start:function(b){if(!timeFlag){return}treatStatus=true;if(b){window.parent.answer()}$("#btnStart").css({color:"#fff","background-color":"#2A72B5","border-color":"#2A72B5"})},AnswerSuccess:function(){parent.setBusy();var b={alarmTime:currentTime,seatIp:a.data.param.ip,callPhone:a.data.param.masterCallNum,enterpriseId:a.data.param.enterpriseId,riskAreaId:a.data.param.riskAreaId,optlRiskSoneId:a.data.param.optlRiskSoneId,riskAnlsObjId:a.data.param.riskAnlsObjId,accidentTypeId:$("#accidentType").val(),fireLvl:$("#fireLvl").val(),userName:$("#userName").text(),mobileOrPhone:$("#mobileOrPhone").text(),ringInstallAddress:$("#ringInstallAddress").text(),answerInstallAddress:$("#answerInstallAddress").val(),eventAddress:$("#answerInstallAddress").val()};$.ajax({url:startUrl,async:true,type:"POST",dataType:"json",contentType:"application/json;charset=utf-8",data:JSON.stringify(b),beforeSend:function(){$("#btnStart").attr("disabled","disabled");ECS.showLoading()},success:function(c){ECS.hideLoading();if(c.isSuccess){eventId=c.result;$("#btnStart").text("正在受理");$("#telTile").text("警情电话"+a.data.param.masterCallNum+"，接听中...");vm.second=0;$("#btnRepeat").attr("disabled",false);$("#btnTransfer").attr("disabled",false);$("#btnInvalid").attr("disabled",false);layer.msg("受理成功！",{time:1000},function(){});parent.startRecord("",eventId,true)}else{$("#btnStart").attr("disabled",false);layer.msg(c.message)}},error:function(c){$("#btnStart").attr("disabled",false);ECS.hideLoading();var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},Repeat:function(){layer.open({type:2,closeBtn:0,area:["80%","80%"],skin:"new-class",shadeClose:false,title:false,content:"repeatAlarm.html",success:function(b,c){var e=window[b.find("iframe")[0]["name"]];var d={eventId:eventId};e.page.logic.setData(d)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){$("#btnRepeat").attr("disabled","disabled");$("#btnTransfer").attr("disabled","disabled");$("#btnInvalid").attr("disabled","disabled");$("#btnSaveData").attr("disabled","disabled");$("#btnSave").attr("disabled","disabled")}}})},Transfer:function(){layer.open({type:2,closeBtn:0,area:["80%","80%"],skin:"new-class",shadeClose:false,title:false,content:"transferAlarm.html",success:function(b,c){var e=window[b.find("iframe")[0]["name"]];var d={eventId:eventId};e.page.logic.setData(d)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){$("#btnRepeat").attr("disabled","disabled");$("#btnTransfer").attr("disabled","disabled");$("#btnInvalid").attr("disabled","disabled");$("#btnSaveData").attr("disabled","disabled");$("#btnSave").attr("disabled","disabled")}}})},Invalid:function(){parent.hangup();ECS.util.addOrEdit({url:invalidAlarmUrl+eventId},function(b){b=$.parseJSON(b);if(b.isSuccess){layer.msg("操作成功");$("#btnRepeat").attr("disabled","disabled");$("#btnTransfer").attr("disabled","disabled");$("#btnInvalid").attr("disabled","disabled");$("#btnSaveData").attr("disabled","disabled");$("#btnSave").attr("disabled","disabled");readyState=true}else{layer.msg("操作失败")}})},selectMedia:function(){layer.open({type:2,closeBtn:0,area:["80%","80%"],skin:"new-class",shadeClose:false,title:false,content:"fireSubstance.html",success:function(b,c){},end:function(){}})},KeyWord:function(c){var b=$("#eventSummary").val();$("#eventSummary").val(b+c.keyWordreExplain)},getMobileOrPhone:function(){$.ajax({url:mobileOrPhoneUrl+"?mobileOrPhone="+a.data.param.masterCallNum,type:"get",dataType:"json",success:function(b){currentTime=b.currentTime;$("#startTime").text(b.currentTime);$("#userName").text(b.userName);$("#ringInstallAddress").text(b.caseAddress);$("#answerInstallAddress").text(b.caseAddress);$("#answerInstallAddress").val(b.caseAddress);$("#eventSummary").text(b.caseAddress);a.data.param.enterpriseId=b.orgId;a.data.param.riskAreaId=b.riskAreaID;a.data.param.optlRiskSoneId=b.optlRiskZoneID;a.data.param.riskAnlsObjId=b.riskAnlsObjID;timeFlag=true;var c=b.caseAddreses;var d=a.logic.ConvertList(c);$("#answerInstallAddress").autocomplete({scroll:true,minLength:0,focus:function(e,f){$("#answerInstallAddress").val(f.item.label);return false},select:function(e,f){a.data.param.enterpriseId=f.item.orgId;a.data.param.riskAreaId=f.item.riskAreaId;a.data.param.optlRiskSoneId=f.item.optlRiskZoneID;a.data.param.riskAnlsObjId=f.item.riskAnlsObjID;$("#answerInstallAddress").val(f.item.label);$("#eventSummary").val(f.item.label);$this=$(this);setTimeout(function(){$this.blur()},1)},change:function(e,f){},autoFocus:false,source:d}).focus(function(){$(this).autocomplete("search")})},error:function(b){var c=$.parseJSON(b.responseText);layer.msg(c.collection.error.message)}})},getKeyWords:function(){$.ajax({url:keyWordUrl,type:"get",dataType:"json",success:function(b){vm.items=b},error:function(b){var c=$.parseJSON(b.responseText);layer.msg(c.collection.error.message)}})},getSecond:function(){var b=setInterval(function(){if(readyState){clearTimeout(b)}vm.second++},1000)},initTable:function(){a.logic.getComboSelect(type_url,"accidentType","accidentTypeID","accidentTypeName",false);a.logic.getSecond();if(!$("#startTime").text()){var b=new Date();$("#startTime").text(moment(b).format("YYYY-MM-DD HH:mm:ss"))}},getComboSelect:function(d,b,e,f,c){$.ajax({url:d,async:true,dataType:"json",success:function(h){var g=[];$.each(h,function(j,k){g.push({id:k[e],text:k[f]})});$("#"+b).select2({tags:c,data:g,language:{noResults:function(i){return"没有匹配项"}},})},})},Save:function(){if(!$("#answerInstallAddress").val()){layer.msg("请在地图上选择案发位置");return}if(!$("#accidentType").val()){layer.msg("请选择案件类型");return}if(!$("#fireLvl").val()){layer.msg("请选择火势大小");return}if(!eventId){layer.msg("事件未受理");return}var b={eventId:eventId,accidentTypeId:$("#accidentType").val(),enterpriseId:a.data.param.enterpriseId,drtDeptId:a.data.param.unitId,riskAreaId:a.data.param.riskAreaId,optlRiskSoneId:a.data.param.optlRiskZoneId,alertsPersonInfo:a.data.param.masterCallNum,eventSummary:$("#eventSummary").val(),eventAddress:$("#answerInstallAddress").val(),isExplode:Number($("#isExplode").is(":checked")),isPersonIn:Number($("#isPersonIn").is(":checked")),fireLvl:$("#fireLvl").val(),fireSubstanceTypeIds:($("#fireSubstanceTypeIds").val()).split(",")};$.ajax({url:saveUrl,async:true,type:"PUT",dataType:"json",data:JSON.stringify(b),contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(c){ECS.hideLoading();if(c.isSuccess){layer.msg("立案成功！",{time:1000},function(){a.logic.Redirection(eventId)})}else{layer.msg(c.message)}},error:function(c){$("#btnSave").attr("disabled",false);ECS.hideLoading();var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},SaveHO:function(){if(!$("#answerInstallAddress").val()){layer.msg("请在地图上选择案发位置");return}if(!$("#accidentType").val()){layer.msg("请选择案件类型");return}if(!$("#fireLvl").val()){layer.msg("请选择火势大小");return}var b={alarmTime:$("#startTime").text(),accidentTypeId:$("#accidentType").val(),enterpriseId:a.data.param.enterpriseId,drtDeptId:a.data.param.unitId,riskAreaId:a.data.param.riskAreaId,optlRiskSoneId:a.data.param.optlRiskZoneId,eventSummary:$("#eventSummary").val(),eventAddress:$("#answerInstallAddress").val(),isExplode:Number($("#isExplode").is(":checked")),isPersonIn:Number($("#isPersonIn").is(":checked")),fireLvl:$("#fireLvl").val(),fireSubstanceTypeIds:($("#fireSubstanceTypeIds").val()).split(",")};$.ajax({url:saveHOUrl,async:true,type:"POST",dataType:"json",data:JSON.stringify(b),contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave_HO").attr("disabled","disabled");ECS.showLoading()},success:function(c){ECS.hideLoading();if(c.isSuccess){layer.msg("立案成功！");$("#btnSave_HO").attr("disabled",true);a.logic.Redirection(c.result)}else{layer.msg(c.message)}},error:function(c){$("#btnSave_HO").attr("disabled",false);ECS.hideLoading();var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},SaveData:function(){if(!$("#answerInstallAddress").val()){layer.msg("请在地图上选择案发位置");return}if(!$("#accidentType").val()){layer.msg("请选择案件类型");return}if(!$("#fireLvl").val()){layer.msg("请选择火势大小");return}if(!eventId){layer.msg("警情未受理");return}var b={eventId:eventId,accidentTypeId:$("#accidentType").val(),enterpriseId:a.data.param.enterpriseId,drtDeptId:a.data.param.unitId,riskAreaId:a.data.param.riskAreaId,optlRiskSoneId:a.data.param.optlRiskZoneId,alertsPersonInfo:a.data.param.masterCallNum,eventSummary:$("#eventSummary").val(),eventAddress:$("#answerInstallAddress").val(),isExplode:Number($("#isExplode").is(":checked")),isPersonIn:Number($("#isPersonIn").is(":checked")),fireLvl:$("#fireLvl").val(),fireSubstanceTypeIds:($("#fireSubstanceTypeIds").val()).split(",")};$.ajax({url:saveEventUrl,async:true,type:"PUT",dataType:"json",data:JSON.stringify(b),contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSaveData").attr("disabled","disabled");ECS.showLoading()},success:function(c){ECS.hideLoading();if(c.isSuccess){layer.msg("保存成功！",{time:1000},function(){})}else{layer.msg(c.message)}$("#btnSaveData").attr("disabled",false)},error:function(c){$("#btnSaveData").attr("disabled",false);ECS.hideLoading();layer.msg("系统繁忙")}})},Redirection:function(b){layer.confirm("是否跳转处警页面？",{btn:["确定","取消"]},function(){var c="../../html/ap/FiremanGo/Index.html";window.parent.layerOpen(c,b,function(){var d=parent.layer.getFrameIndex(window.name);parent.layer.close(d)},{closeBtn:0})},function(c){parent.hangup();parent.setFree();var c=parent.layer.getFrameIndex(window.name);parent.layer.close(c)})},hangup:function(){layer.confirm("确定要挂断电话？",{btn:["确定","取消"]},function(){$("#telTile").text("警情电话"+a.data.param.masterCallNum+"，已挂断");readyState=1;parent.hangup();parent.setBusy();if(!treatStatus){$("#btnStart").attr("disabled","disabled");$("#btnSave").attr("disabled","disabled");parent.setFree();a.logic.closeLayer(true)}layer.closeAll()})},afterTransfer:function(){$("#telTile").text("警情电话"+a.data.param.masterCallNum+"，已挂断");readyState=1},Convert:function(b){b.alarmTime=moment(b.alarmTime).format("YYYY-MM-DD ");return b},closeLayer:function(b){if(b){var c=parent.layer.getFrameIndex(window.name);parent.layer.close(c)}else{layer.confirm("确定要关闭窗口吗？",{btn:["确定","取消"]},function(){parent.hangup();parent.setFree();var d=parent.layer.getFrameIndex(window.name);parent.layer.close(d)})}},ConvertList:function(b){var c=[];b.forEach(function(d){var e=new Object();for(key in d){e[key]=d[key]}e.value=d.address;e.label=d.address;c.push(e)});return c}}};a.init();window.page=a});