var addUrl=ECS.api.apUrl+"/AcceptWarningConfig";var getSingleUrl=ECS.api.apUrl+"/AcceptWarningConfig/getConfigAccept";var baseDataID=null;var baseModelCategory=null;var enterpriseID="";var leng=1;var editUserName=[];var usernameList=[];var editCheckName=[];var userCheckList=[];var orgCode="";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#manageItem .btn").click(function(){var c=$(this).index();$(this).addClass("btn-danger").siblings().removeClass("btn-danger");$("#tabMain .tabItem").eq(c).show().siblings().hide()});$("#addNewName").click(function(){b.logic.addNewIP("firstCompanyIP","ipList")});$("#addNewVideo").click(function(){b.logic.addNewVideo("firstCompanyVideo","videoList")});$("#btnSave").click(function(){b.logic.save()});$("#btnClose,.btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#tabMain").on("click",".delName",function(){leng--;$(this).closest(".row").remove()});$("#selectOwner").click(function(){b.logic.selectOwner("人员选择(多选)",PageModelEnum.Details)});$("#checkOwner").click(function(){b.logic.checkOwner("人员选择(多选)",PageModelEnum.Details)})},logic:{setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;orgCode=c.orgCode;enterpriseID=c.enterpriseID;baseModelCategory=c.baseModelCategory;baseDataID=c.baseDataID;$("#roleName").append('<option value="'+c.baseDataID+'">'+c.name+"</option>");$.ajax({url:getSingleUrl+"?baseModelCategory="+baseModelCategory+"&baseDataID="+baseDataID+"&now="+Math.random(),type:"get",async:true,dataType:"json",success:function(e){if(e.seatIPEntityList){$("#firstCompanyIP").attr("seatIPID",e.seatIPEntityList[0].seatIPID);$("#firstCompanyIP").val(e.seatIPEntityList[0].seatIP);$("#callPhone").val(e.seatIPEntityList[0].callPhone);$("#callPhone2").val(e.seatIPEntityList[0].callPhone2);$("#phoneExchangeAccount").val(e.seatIPEntityList[0].phoneExchangeAccount);$("#phoneExchangePWD").val(e.seatIPEntityList[0].phoneExchangePWD);if(e.seatIPEntityList[0].seatType=="1"){$("#isFire").attr("checked",true)}else{$("#isFire").removeAttr("checked")}for(var d=1;d<e.seatIPEntityList.length;d++){$(".ipList").append('<div class="row newItem"><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="name'+d+'" class="form-control required ipv4" onblur="$(this).val($.trim($(this).val()))" seatIPID="'+e.seatIPEntityList[d].seatIPID+'" value="'+e.seatIPEntityList[d].seatIP+'"/></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="tel'+d+'" class="form-control required" onblur="$(this).val($.trim($(this).val()))" value="'+e.seatIPEntityList[d].callPhone+'" /></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="telt'+d+'" class="form-control required" onblur="$(this).val($.trim($(this).val()))" value="'+e.seatIPEntityList[d].callPhone2+'" /></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="account'+d+'" class="form-control required" onblur="$(this).val($.trim($(this).val()))" value="'+e.seatIPEntityList[d].phoneExchangeAccount+'" /></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="pwd'+d+'" class="form-control required" onblur="$(this).val($.trim($(this).val()))" value="'+e.seatIPEntityList[d].phoneExchangePWD+'" /></div></div></div><div class="col-xs-2"><input type="checkbox" class="isFire" /><button class="btn btn-danger delName ml__35" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div></div>');if(e.seatIPEntityList[d].seatType=="1"){$(".isFire").eq(d).attr("checked",true)}}leng=e.seatIPEntityList.length;editUserName=[];usernameList=[];editCheckName=[];userCheckList=[];if(e.seatAccountEntityList){for(var d=0;d<e.seatAccountEntityList.length;d++){if(e.seatAccountEntityList[d].seatAccountType=="0"){usernameList+=e.seatAccountEntityList[d].userName+"\n";editUserName.push({seatAccountID:e.seatAccountEntityList[d].seatAccountID,userName:e.seatAccountEntityList[d].userName,userUID:e.seatAccountEntityList[d].userUID})}if(e.seatAccountEntityList[d].seatAccountType=="1"){userCheckList+=e.seatAccountEntityList[d].userName+"\n";editCheckName.push({seatAccountID:e.seatAccountEntityList[d].seatAccountID,userName:e.seatAccountEntityList[d].userName,userUID:e.seatAccountEntityList[d].userUID})}}$("#userName").val(usernameList);$("#checker").val(userCheckList)}}if(e.videoList){$("#firstCompanyVideo").attr("videoConfigId",e.videoList[0].videoConfigId);$("#firstCompanyVideo").val(e.videoList[0].videoEndpoint);$("#VideoNumber").val(e.videoList[0].maxCount);for(var d=1;d<e.videoList.length;d++){$(".videoList").append('<div class="row newItem"><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="name'+d+'" class="form-control required " onblur="$(this).val($.trim($(this).val()))" videoConfigId="'+e.videoList[d].videoConfigId+'" value="'+e.videoList[d].videoEndpoint+'"/></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="tel'+d+'" class="form-control required" onblur="$(this).val($.trim($(this).val()))" value="'+e.videoList[d].maxCount+'" /></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><button class="btn btn-danger delName ml__35" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div></div>')}}},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},addNewIP:function(d,c){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}if($("#"+d).val()!=""){$("."+c).append('<div class="row newItem"><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="name'+leng+'" class="form-control required ipv4" onblur="$(this).val($.trim($(this).val()))" seatIPID="" value=""/></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="tel'+leng+'" class="form-control number required" onblur="$(this).val($.trim($(this).val()))" value="" /></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="telt'+leng+'" class="form-control number required" onblur="$(this).val($.trim($(this).val()))" value="" /></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="account'+leng+'" class="form-control required" onblur="$(this).val($.trim($(this).val()))" value="" /></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="pwd'+leng+'" class="form-control required" onblur="$(this).val($.trim($(this).val()))" value="" /></div></div></div><div class="col-xs-2"><input type="checkbox" class="isFire" /><button class="btn btn-danger delName ml__35" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div></div>');leng++}},addNewVideo:function(d,c){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}if($("#"+d).val()!=""){$("."+c).append('<div class="row newItem"><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="name'+leng+'" class="form-control required " onblur="$(this).val($.trim($(this).val()))" seatIPID="" value=""/></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><input type="text" name="tel'+leng+'" class="form-control number required" onblur="$(this).val($.trim($(this).val()))" value="" /></div></div></div><div class="col-xs-2"><div class="form-group"><div class="col-xs-12"><button class="btn btn-danger delName ml__35" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div></div>');leng++}},selectOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"SelectOwner.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,userName:editUserName,orgCode:orgCode};i.page.logic.setData(h)},end:function(){editUserName=[];usernameList=[];for(var e=0;e<window.ownDetail.length;e++){usernameList+=window.ownDetail[e].userName+"\n";editUserName=window.ownDetail}$("#userName").val(usernameList)}})},checkOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"SelectOwner.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,userName:editCheckName,orgCode:orgCode};i.page.logic.setData(h)},end:function(){editCheckName=[];userCheckList=[];for(var e=0;e<window.ownDetail.length;e++){userCheckList+=window.ownDetail[e].userName+"\n";editCheckName=window.ownDetail}$("#checker").val(userCheckList)}})},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}if($("#userName").val()==""){layer.msg("请选择接警人员！");$("#userName").parents(".form-group").addClass("has-error");return}else{$("#userName").parents(".form-group").removeClass("has-error")}var d=[];$(".ipList").find(".row").each(function(){if($(this).find("input").eq(0).val()){var i=0;if($(this).find("input").eq(5).is(":checked")){i=1}else{i=0}d.push({seatIPID:$(this).find("input").eq(0).attr("seatIPID"),seatIP:$(this).find("input").eq(0).val(),baseModelCategory:baseModelCategory,callPhone:$(this).find("input").eq(1).val(),callPhone2:$(this).find("input").eq(2).val(),phoneExchangeAccount:$(this).find("input").eq(3).val(),phoneExchangePWD:$(this).find("input").eq(4).val(),seatType:i,baseDataID:baseDataID,enterpriseID:enterpriseID,sortNum:0,isDelete:0})}});var c=[];for(var f=0;f<editUserName.length;f++){c.push({seatAccountID:editUserName[f].seatAccountID,userName:editUserName[f].userName,baseDataID:baseDataID,userUID:editUserName[f].userUID,seatAccountType:"0",baseModelCategory:baseModelCategory,enterpriseID:enterpriseID,sortNum:0,isDelete:0})}for(var e=0;e<editCheckName.length;e++){c.push({seatAccountID:editCheckName[e].seatAccountID,userName:editCheckName[e].userName,baseDataID:baseDataID,userUID:editCheckName[e].userUID,seatAccountType:"1",baseModelCategory:baseModelCategory,enterpriseID:enterpriseID,sortNum:0,isDelete:0})}var h=[];$(".videoList").find(".row").each(function(){if($(this).find("input").eq(0).val()){h.push({videoConfigId:$(this).find("input").eq(0).attr("videoConfigId"),videoEndpoint:$(this).find("input").eq(0).val(),maxCount:$(this).find("input").eq(1).val(),baseModelCategory:baseModelCategory,baseDataId:baseDataID,enterpriseId:enterpriseID})}});var g={};g.seatIPEntityList=d;g.seatAccountEntityList=c;g.videoList=h;$.ajax({url:addUrl,async:false,type:"POST",data:JSON.stringify(g),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(i){ECS.hideLoading();if(i.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(i.collection.error.message)}},error:function(i){$("#btnSave").attr("disabled",false);ECS.hideLoading();var j=$.parseJSON(i.responseText);layer.msg(j.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{firstCompanyIP:{required:true,ipv4:true},callPhone:{required:true,number:true},callPhone2:{required:true,number:true},phoneExchangeAccount:{required:true},phoneExchangePWD:{required:true},firstCompanyVideo:{required:true,},VideoNumber:{required:true,number:true},},})}}};b.init();window.page=b});