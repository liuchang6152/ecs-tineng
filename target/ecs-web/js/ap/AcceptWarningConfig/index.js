var delUrl=ECS.api.apUrl+"/RuleConfig";var searchUrl=ECS.api.apUrl+"/RuleConfig";var orgNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var grid=null;window.pageLoadMode=PageLoadMode.None;$(function(){var a={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();this.bindUI();a.logic.initTable();a.logic.cbxOrgName();a.logic.search()},table:{},bindUI:function(){$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()})},data:{param:{}},logic:{initTable:function(){grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"})},show_edit:function(b){return'<a title="编辑" href="javascript:window.page.logic.edit('+b.row.ruleConfigID+')">编辑</a> | <a title="配置接警单元" href="javascript:window.page.logic.deploy('+b.row.enterpriseID+","+b.row.equalLvl+",'"+b.row.enterpriseName+"')\">配置接警单元</a>"},baseName:function(b){return"总数[ "+b.row.jjCount+" ]"},cbxOrgName:function(){if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){ECS.ui.getCombobox("orgId",orgNameUrl,{selectFirstRecord:true,keyField:"orgId",valueField:"orgSname",codeField:"orgId",valueSField:"orgSname",async:false,},null);$("#orgId").attr("disabled",false)}else{ECS.ui.getCombobox("orgId",orgNameUrl,{selectValue:ECS.sys.Context.SYS_ENTERPRISE_CODE,async:false,keyField:"orgCode",valueField:"orgSname",codeField:"orgId",valueSField:"orgSname"},null);$("#orgId").attr("disabled",true)}},delAll:function(){var b=[];var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.ruleConfigID)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:true,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(d){ECS.hideLoading();if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){grid.reload({pageIndex:0})})}else{d=JSON.parse(d);layer.msg(d.collection.error.message)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},add:function(){var b=PageModelEnum.NewAdd;var c="基础配置新增";a.logic.detail(c,"",b)},edit:function(c){var b=PageModelEnum.Edit;var d="基础配置编辑";a.logic.detail(d,c,b)},detail:function(d,c,b){layer.open({type:2,closeBtn:0,area:["400px","300px"],skin:"new-class",shadeClose:false,title:false,content:"AcceptWarningConfigAddOrEdit.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:b,ruleConfigID:c,title:d};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search();window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search();window.pageLoadMode=PageLoadMode.None}}}})},deploy:function(b,d,c){layer.open({type:2,closeBtn:0,area:["900px","580px"],skin:"new-class",shadeClose:false,title:false,content:"deployIndex.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={orgID:b,equalLvl:d,orgName:c,orgCode:$("#orgId").val()};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search();window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search();window.pageLoadMode=PageLoadMode.None}}}})},search:function(){grid.load({orgId:$("#orgId").find("option:selected").attr("code")})}}};a.init();window.page=a});