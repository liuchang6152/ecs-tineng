var addUrl=ECS.api.apUrl+"/DirectAlarm/handEvent";var riskRankUrl=ECS.api.bcUrl+"/riskRank/getListRiskRank?inUse=1";var eventLvlIdUrl=ECS.api.apUrl+"/DirectAlarm/eventLvl";var accCategoryUrl=ECS.api.bcUrl+"/accidentCategory/list";var accTypeUrl=ECS.api.bcUrl+"/accidentCategory/accidentType";var keyWordUrl=ECS.api.apUrl+"/AutomaticMonitoring/getKeywordReList?keyWordreCode=AP_AC_FAE_R";var getGisUrl=ECS.api.gisSurfaceUrl;var gisenterpriseId="";var gisdrtDeptId="";var gisoptlRiskZoneId="";var gisriskAreaId="";var gisriskAnlsObjId="";var gispointId="";var addSum="";var curIP="";window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){this.bindUI();mini.parse();b.logic.cbxAccidentCategory();b.logic.cbxKeyWord();b.logic.getGisValue()},table:{},bindUI:function(){$("#infoList").hover(function(){$("#nav_submenu").css("display","table").stop()},function(){$("#nav_submenu").stop().hide()});$("#nav_submenu").on("click","li",function(){var c=$("#information").val();$("#information").val(c+$(this).attr("title")+"  ")});$(document).on("change","select#eventLvlId",function(){var c=$("#eventLvlId").find("option:selected").attr("code");layer.confirm("你确认事故等级是"+c+"吗？",{btn:["确定","取消"]},function(d){layer.close(d);b.logic.cbxInfo()},function(){$("#eventLvlId").val("7")})});$("#casualtyCount").blur(function(){this.value=this.value.replace(/\D/g,"");if(this.value){layer.confirm("你确认人员受伤是"+this.value+"人吗？",{btn:["确定","取消"]},function(c){layer.close(c)},function(){$("#casualtyCount").val("")})}});$("#dieCount").blur(function(){this.value=this.value.replace(/\D/g,"");if(this.value){layer.confirm("你确认人员死亡是"+this.value+"人吗？",{btn:["确定","取消"]},function(c){layer.close(c)},function(){$("#dieCount").val("")})}});$("#propertyLossCount").blur(function(){this.value=this.value.replace(/\D/g,"");if(this.value){layer.confirm("您确定财产损失是"+this.value+"万元吗？",{btn:["确定","取消"]},function(c){layer.close(c)},function(){$("#propertyLossCount").val("")})}});$("#btnAlarm").click(function(){b.logic.save()});$("#btnCancle").click(function(){parent.hasArlamId={isAlram:false};parent.layer.close(a)});$("#eventAddress").blur(function(){addSum=$("#eventAddress").val();b.logic.cbxInfo()})},data:{param:{}},logic:{setData:function(c){if(c.curIP.length>0){curIP=c.curIP}else{curIP="10.163.243.37"}ECS.sys.RefreshContextFromSYS();$("#iframe_map").attr("src",ECS.api.gisserver_url+"/all_zjdxgis/index_ptquery.html?iframe=true&show_info=false&code="+window.btoa(ECS.sys.Context.SYS_ENTERPRISE_CODE));b.logic.cbxRiskRank();b.logic.cbxEventLvl()},cbxInfo:function(){var i=new Date;var j=i.getFullYear();var e=i.getMonth()+1;var f=i.getDate()<10?"0"+i.getDate():i.getDate();var k=i.getHours()<10?"0"+i.getHours():i.getHours();var g=i.getMinutes()<10?"0"+i.getMinutes():i.getMinutes();var d=i.getSeconds()<10?"0"+i.getSeconds():i.getSeconds();if(e<10){e="0"+e}var c="";var h="";var l=$("#eventLvlId option:selected").text();if($("#accidentCategoryId").val()=="-1"){c=""}else{c=$("#accidentCategoryId option:selected").text()}if($("#accidentTypeId").val()=="-1"){h=""}else{h=$("#accidentTypeId option:selected").text()}if(addSum==null){addSum=""}$("#eventSummary").val("接警信息："+j+"年"+e+"月"+f+"日 "+k+":"+g+":"+d+"  "+addSum+l+c+h)},cbxEventLvl:function(){ECS.ui.getCombobox("eventLvlId",eventLvlIdUrl+"?orgCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE,{selectValue:"7",keyField:"eventLvlId",valueField:"eventLvlName",codeField:"eventLvlName",async:false},null)},cbxRiskRank:function(){ECS.ui.getCombobox("riskRankId",riskRankUrl+"&enterpriseCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE,{selectValue:"-1",keyField:"riskRankID",valueField:"rankDisplay",async:false},null)},cbxKeyWord:function(){$.ajax({url:keyWordUrl,type:"get",dataType:"json",success:function(c){if(c.length>0){for(var d=0;d<c.length;d++){$("#nav_submenu").append("<li title='"+c[d].keyWordreExplain+"'>"+c[d].keyWord+"</li>")}}},error:function(c){var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},cbxAccidentCategory:function(){ECS.ui.getCombobox("accidentCategoryId",accCategoryUrl,{selectValue:"-1",keyField:"accidentCategoryID",valueField:"accidentCategoryName",async:false},null,b.logic.cbxAccidentType)},cbxAccidentType:function(c){ECS.ui.getCombobox("accidentTypeId",accTypeUrl,{selectValue:"-1",keyField:"accidentTypeID",valueField:"accidentTypeName",async:false,data:{accidentCategoryID:c}},null,b.logic.cbxInfo);b.logic.cbxInfo()},getGisValue:function(){if(window.addEventListener){window.addEventListener("message",b.logic.handleMessage,false)}else{window.attachEvent("onmessage",b.logic.handleMessage)}},handleMessage:function(d){d=d||window.event;var c="";switch(d.data[0].layerName){case"企业":c=2;break;case"二级单位":c=3;break;case"安全风险区":c=4;break;case"作业风险区":c=5;break;default:c=""}$.ajax({url:getGisUrl+"/surface/type/"+c+"/id/"+d.data[0].id+"?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE,async:true,type:"get",dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(f){var e="";addSum="";if(f.enterpriseName){e+=f.enterpriseName}if(f.unitName){e+=f.unitName;addSum+=f.unitName}if(f.riskAreaName){e+=f.riskAreaName;addSum+=f.riskAreaName}if(f.optlRiskZoneName){e+=f.optlRiskZoneName;addSum+=f.optlRiskZoneName}gisenterpriseId=f.enterpriseId;gisdrtDeptId=f.unitId;gisriskAreaId=f.riskAreaId;gisoptlRiskZoneId=f.optlRiskZoneId;gisriskAnlsObjId="";gispointId="";$("#eventAddress").val(e);if(e){$("#eventAddress").attr("readonly",false)}else{$("#eventAddress").attr("readonly",true)}b.logic.cbxInfo(addSum);ECS.hideLoading()},error:function(e){ECS.hideLoading();var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var d=ECS.form.getData("AddOrEditModal");d.enterpriseId=gisenterpriseId;d.drtDeptId=gisdrtDeptId;d.riskAreaId=gisriskAreaId;d.optlRiskSoneId=gisoptlRiskZoneId;d.riskAnlsObjId=gisriskAnlsObjId;d.pointId=gispointId;d.alarmTelStatus="2";d.eventType="0";d.eventSource="0";d.isDelete="0";d.sortNum="1";d.pushStatus="1";d.seatIp=curIP;d.eventSummary+=d.information;var e=[];var c=[];if($("#casualtyCount").val()){e.push({casualtyTypeCode:"AP_AC_WOUNDED",casualtyCount:$("#casualtyCount").val(),sortNum:"1",casualtyDiscription:"受伤",isDelete:"0"})}if($("#dieCount").val()){e.push({casualtyTypeCode:"AP_AC_DEATH",casualtyCount:$("#dieCount").val(),sortNum:"1",casualtyDiscription:"死亡",isDelete:"0"})}d.casualtyEntityList=e;if($("#propertyLossCount").val()){c.push({propertyLossTypeCode:"AP_AC_OTHER",propertyLossMoney:$("#propertyLossCount").val(),sortNum:"1",propertyLossDiscription:"财产损失",isDelete:"0"})}d.propertyLossEntityList=c;delete d.casualtyCount;delete d.dieCount;delete d.propertyLossCount;delete d.information;$.ajax({url:addUrl,async:false,type:"POST",data:JSON.stringify(d),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){ECS.showLoading()},success:function(f){f=JSON.parse(f);parent.hasArlamId={eventId:f.result.eventId,ip:curIP,isAlram:true};parent.layer.close(a);ECS.hideLoading()},error:function(f){ECS.hideLoading();var g=$.parseJSON(f.responseText);layer.msg(g.collection.error.message)}})},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{riskRankId:{required:true},accidentCategoryId:{required:true},accidentTypeId:{required:true},eventAddress:{required:true}}});if($("#riskRankId").val()=="-1"){$("#riskRankId").val("")}if($("#accidentCategoryId").val()=="-1"){$("#accidentCategoryId").val("")}if($("#accidentTypeId").val()=="-1"){$("#accidentTypeId").val("")}}}};b.init();window.page=b});