var loginInfoUrl=ECS.api.apUrl+"/event/getIPInfo";var EventListUrl=ECS.api.apUrl+"/selectEvents?isFinished=0&eventType=0";var CheckEventListUrl=ECS.api.apUrl+"/selectEvents?eventType=0";var map={};var strIp=[];var ipReader=null;var hasArlamId={};var callStatus=0;var firelayer;var number=parseInt(Math.random()*1000000000);var lockReconnect=false;var time=null;$(function(){var a={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();$("#userUid").val(ECS.sys.Context.SYS_USER_CODE);ECS.showLoading();a.logic.tryGetIP(0);a.logic.initPage();a.logic.search();a.logic.search2()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#nav_tabs li").click(function(d){var c=false;var b=0;setTimeout(function(){if(d.target.tagName=="A"){if($(d.target).parent().hasClass("active")){c=true;b=$(d.target).parent().index()}}if(d.target.tagName=="LI"){if($(d.target).hasClass("active")){c=true;b=$(d.target).index()}}if(c){if(b==0){a.logic.search()}if(b==1){a.logic.search2()}}},100)});$("#call_btn").hover(function(){$(this).css("background","#0b93d9")},function(){$(this).css("background","#45c8dc")});$("#btnQuery").click(function(){a.logic.search()});$("#btnQuery2").click(function(){a.logic.search2()});$("#loginOut").click(function(){ipReader.pbx_Logout();ipReader.pbx_cleanup()});$("#call_btn").click(function(){layer.open({type:2,closeBtn:0,area:["100%","100%"],skin:"new-class",title:"<i class='title-vertical'></i><span class='box-title text-color'>手动接警</span>",move:".layui-layer-title",offset:[y=0],shadeClose:false,content:"../DirectAlarm/ManualAlarm.html?"+Math.random(),zIndex:layer.zIndex,success:function(c,d){var b=layer.getChildFrame("body",d);var f=window[c.find("iframe")[0]["name"]];var e={curIP:strIp};f.page.logic.setData(e)},end:function(){if(hasArlamId.isAlram){hasArlamId.isAlram={};layer.open({type:2,closeBtn:1,area:["100%","100%"],skin:"new-class",shadeClose:false,title:false,content:"../AutoHandlingCommon/index.html?eventId="+hasArlamId.eventId+"&ip="+strIp+"&n="+Math.random(),success:function(c,d){var b=layer.getChildFrame("body",d);var e=window[c.find("iframe")[0]["name"]];hasArlamId.title="手动处警";e.page.logic.setData(hasArlamId)},end:function(){a.logic.search();a.logic.search2()}})}}})})},data:{param:{}},logic:{tryGetIP:function(b){try{ipReader=document.getElementById("ipReader");if(!ipReader){console.log("没有找到ip reader ocx")}var d=ipReader.readLocalIp();strIp=d.split("|");if(strIp[b]!=null&&strIp[b]!=undefined){strIp=strIp[b];a.logic.register(strIp)}else{$("#showInfo").text("本机IP地址："+strIp+"，未配置接警单元，无法执行接警操作");alert("接警单元未注册本机IP，请联系管理员注册");ECS.hideLoading()}}catch(c){alert("ocx插件获取本机IP失败，请检查：\n1、浏览器是否为IE11；\n2、浏览器安全设置中是否信任本站点；\n3、浏览器安全设置中是否允许未经签名的ActiveX插件执行。\n如仍有问题请联系管理员。");$("#showInfo").text("抓取本机IP地址失败，请联系管理员");ECS.hideLoading()}},getLoginInfo:function(c){var b;$.ajax({url:loginInfoUrl,type:"GET",async:false,data:{seatIp:c},success:function(d){if(d==null||d==undefined||!d.isSuccess){layer.msg("获取坐席信息失败，请联系系统管理员!");return}var f=ipReader.pbx_init();ipReader.pbx_setNumber(d.result.callPhone);ipReader.pbx_setLocalNumber(d.result.callPhone2);var e=ipReader.pbx_login(d.result.phoneExchangeAccount,d.result.phoneExchangePWD,"192.168.20.10","9800");if(e=="200"){layer.msg("ocx登录成功",{time:5000})}else{layer.msg("ocx登录失败"+e,{time:5000})}},error:function(d){layer.msg("登陆失败，请联系系统管理员！")}})},register:function(b){$.ajax({type:"GET",url:ECS.api.apIpVerify+"/"+ECS.sys.Context.SYS_USER_CODE+"/"+number,data:{ip:b},dataType:"json",async:false,error:function(c){alert(c.message);console.info(c.message);ECS.hideLoading();return -1},success:function(c){alert(c.message);if(c.isSuccess){ECS.hideLoading();$("#showInfo").text(c.message.substring(5));a.logic.ws_conn(c)}else{ECS.hideLoading();a.logic.tryGetIP(++i)}return 0}})},ws_conn:function(c){var b=new WebSocket(ECS.api.webSocket+"/websocket/"+number);b.onopen=function(){clearTimeout(time);b.send("注册完毕")};b.onmessage=function(d){var e=JSON.parse(d.data);if(e.alertStatus==4){console.log(e.time);b.send(new Date())}else{if(e.alertStatus===1){layer.open({type:2,closeBtn:0,offset:[y=0],title:"<i class='title-vertical'></i><span class='box-title text-color'>自动接警</span>",move:".layui-layer-title",area:["100%","100%"],skin:"new-class",shadeClose:false,content:"../AutomaticMonitoring/index.html?"+Math.random(),success:function(g,h){map[e.uuid]=h;var f=layer.getChildFrame("body",h);var k=window[g.find("iframe")[0]["name"]];var j=JSON.parse(d.data);j.curIP=strIp;k.page.logic.setData(j)},end:function(){if(hasArlamId.isAlram){hasArlamId.isAlram={};layer.open({type:2,closeBtn:1,area:["100%","100%"],skin:"new-class",shadeClose:false,title:false,content:"../AutoHandlingCommon/index.html?eventId="+hasArlamId.eventId+"&ip="+strIp+"&n="+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var j=window[g.find("iframe")[0]["name"]];hasArlamId.title="自动处警";j.page.logic.setData(hasArlamId)},end:function(){a.logic.search();a.logic.search2()}})}}})}else{if(e.alertStatus===2){layer.close(map[e.uuid])}}}};b.onclose=function(d){console.log(d);if(lockReconnect){return}lockReconnect=true;time=setTimeout(function(){b=new WebSocket(ECS.api.webSocket+"/websocket/"+number);lockReconnect=false},2000)};b.onerror=function(d){console.log(d)}},phoneAlarmEven:function(c,b){if(callStatus==0){firelayer=layer.open({type:2,closeBtn:0,area:["100%","100%"],skin:"new-class",shadeClose:false,offset:[y=0],title:"<i class='title-vertical'></i><span class='box-title text-color'>电话接警</span>",move:".layui-layer-title",content:"../DirectAlarm/PhoneAlarm.html?"+Math.random(),zIndex:layer.zIndex,success:function(e,f){var d=layer.getChildFrame("body",f);var h=window[e.find("iframe")[0]["name"]];var g={curIP:strIp,mode:false,alarmNum:c,answerNum:b};h.page.logic.setData(g)},end:function(){if(hasArlamId.isAlram){hasArlamId.isAlram={};layer.open({type:2,closeBtn:1,area:["100%","100%"],skin:"new-class",shadeClose:false,title:false,content:"../AutoHandlingCommon/index.html?eventId="+hasArlamId.eventId+"&ip="+strIp+"&n="+Math.random(),success:function(e,f){var d=layer.getChildFrame("body",f);var g=window[e.find("iframe")[0]["name"]];hasArlamId.title="电话处警";g.page.logic.setData(hasArlamId)},end:function(){callStatus=0;a.logic.search();a.logic.search2()}})}}})}},answer:function(){callStatus=1;ipReader.sp_answer()},initPage:function(){var c;if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){c=""}else{c=ECS.sys.Context.SYS_ENTERPRISE_CODE}var b=mini.get("eventDatagrid");b.set({url:EventListUrl+"&orgCode="+c+"&ip="+strIp,ajaxType:"GET",dataField:"result.pageList",totalField:"result.total"});var d=mini.get("historyDatagrid");d.set({url:CheckEventListUrl+"&orgCode="+c+"&ip="+strIp,ajaxType:"GET",dataField:"result.pageList",totalField:"result.total"})},search:function(){a.data.param={};a.data.param=ECS.form.getData("searchForm");var b=mini.get("eventDatagrid");b.load(a.data.param,function(c){if(c.result.isSuccess){$("#total_num").html(c.result.result.total)}else{layer.msg(c.result.message);$("#total_num").html(0);ECS.hideLoading()}})},search2:function(){a.data.param={};a.data.param=ECS.form.getData("searchForm2");var b=mini.get("historyDatagrid");b.load(a.data.param,function(c){if(!c.result.isSuccess){layer.msg(c.result.message)}})},lookdetail:function(b){if(b.row.eventCode=="结束"||b.row.eventCode=="取消"){return'<a href="javascript:window.page.logic.gotodetail('+b.row.eventId+');">查看</a>'}else{return"<a href=\"javascript:window.page.logic.detail('"+b.row.eventSource+"','"+b.row.eventId+"','"+b.row.eventCode+"')\">查看</a>"}},show_Detail:function(b){return"<a href=\"javascript:window.page.logic.detail('"+b.row.eventSource+"','"+b.row.eventId+"','"+b.row.eventCode+"')\">"+b.value+"</a>"},gotodetail:function(b){layer.open({type:2,closeBtn:0,area:["80%","80%"],skin:"new-class",shadeClose:false,title:false,content:"./EventFlow.html?"+Math.random(),success:function(d,e){var c=layer.getChildFrame("body",e);var g=window[d.find("iframe")[0]["name"]];var f={EventId:b};g.page.logic.setData(f)}})},detail:function(d,c,b){var e="";if(b=="接警"){switch(d){case"自动":e="../AutomaticMonitoring/index.html";break;case"手动":e="./../DirectAlarm/ManualAlarm.html";break;case"电话":e="../DirectAlarm/PhoneAlarm.html";break}layer.open({type:2,closeBtn:0,area:["100%","100%"],shadeClose:false,skin:"new-class",title:"<i class='title-vertical'></i><span class='box-title text-color'>"+d+b+"</span>",content:e+"?r="+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var k=window[g.find("iframe")[0]["name"]];var j={eventId:c,mode:true,curIP:strIp};k.page.logic.setData(j)},end:function(){a.logic.search();a.logic.search2();if(hasArlamId.isAlram){hasArlamId.isAlram={};layer.open({type:2,closeBtn:1,area:["100%","100%"],skin:"new-class",shadeClose:false,title:false,content:"../AutoHandlingCommon/index.html?eventId="+hasArlamId.eventId+"&ip="+strIp+"&n="+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var j=window[g.find("iframe")[0]["name"]];hasArlamId.title="自动处警";j.page.logic.setData(hasArlamId)},end:function(){a.logic.search();a.logic.search2()}})}}})}else{if(b=="处警"){e="./../AutoHandlingCommon/index.html?eventId="+c+"&ip="+strIp;layer.open({type:2,closeBtn:0,area:["100%","100%"],shadeClose:false,skin:"new-class",title:false,content:e+"&n="+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var k=window[g.find("iframe")[0]["name"]];var j={eventId:c,ip:hasArlamId.curIP,title:d+b};k.page.logic.setData(j)},end:function(){a.logic.search();a.logic.search2()}})}}}}};a.init();window.page=a});