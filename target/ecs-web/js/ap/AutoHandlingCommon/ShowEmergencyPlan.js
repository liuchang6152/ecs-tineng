var getSingleUrl=ECS.api.rttUrl+"/emergencyPlan/oneEmergencyPlan";var leftMenuUrl=ECS.api.rttUrl+"/structuredplancategory";var searchUrl=ECS.api.rttUrl+"/emergencyduties";var FileDownLoadUrl=ECS.api.rttUrl+"/structuredplanfile/downloadFile";var isToggle=true;var emergencyPlanID;var structuredPlanCategoryId;var Trigger_btn=true;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI()},bindUI:function(){$("#btnSave").click(function(){if(Trigger_btn){b.logic.closeLayer(PageLoadMode.Refresh);$(this).addClass("btn-close");$(this).removeClass("btn-delete")}else{$(this).addClass("btn-close");$(this).removeClass("btn-delete")}});$("#btnClose").click(function(){b.logic.closeLayer(PageLoadMode.None)});$("#nav_tabs li").click(function(){var c=$(this).index();$(".tab-content").find(".tab-pane").hide();$(".tab-content").find(".tab-pane").eq(c).show();$(this).addClass("active").siblings().removeClass("active")});mini.get("tree1").on("nodeselect",function(c){structuredPlanCategoryId=c.node.structuredPlanCategoryId;b.logic.initTable()})},logic:{setData:function(c){$("#title-main").text(c.title);if(c.checkMode){$("#btnSave").show()}else{$("#btnSave").hide();$(".check-zz").hide()}emergencyPlanID=c.emergencyPlanID;isToggle=c.isToggle?c.isToggle:false;if(isToggle){$("#nav_tabs").hide()}else{$("#nav_tabs").show()}$.ajax({url:getSingleUrl+"?emergencyPlanID="+emergencyPlanID+"&now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(f){$("#emergencyPlanName").text(f.emergencyPlanName);$("#orgSname").text(f.orgSname);$("#planDefinitionName").text(f.planDefinitionName);$("#planLevelName").text(f.planLevelName);$("#accidentCategoryName").text(f.accidentCategoryName);$("#remark").text(f.remark);$("#crtUserName").text(f.crtUserName);if(f.accidentTypeEntity){var d=f.accidentTypeEntity[0].accidentTypeName;if(f.accidentTypeEntity.length>0){for(var e=1;e<f.accidentTypeEntity.length;e++){d+=","+f.accidentTypeEntity[e].accidentTypeName}}$("#accidentTypeName").text(d)}if(f.attachmentEntities){for(var g=0;g<f.attachmentEntities.length;g++){$("#fileList").append('<a class="col-xs-6" title="'+f.attachmentEntities[g].atchName+'" href="'+FileDownLoadUrl+"?atchPath="+f.attachmentEntities[g].atchPath+"&atchName="+f.attachmentEntities[g].atchName+'">'+f.attachmentEntities[g].atchName+"</a>")}}$("#crtDate").text(ECS.util.timestampToTime(f.crtDate));b.logic.load_sidebar();ECS.hideLoading()},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},load_sidebar:function(){$.ajax({url:leftMenuUrl+"?emergencyPlanId="+emergencyPlanID,type:"GET",async:false,timeout:5000,beforeSend:function(){ECS.showLoading()},success:function(c){ECS.hideLoading();if(c.length>0){mini.get("tree1").loadList(c,"structuredPlanCategoryId","structuredPlanCategoryPid");structuredPlanCategoryId=mini.get("tree1").data[0].structuredPlanCategoryId;b.logic.initTable()}},error:function(c){ECS.hideLoading();if(c){layer.msg(c,{time:1000})}}})},initTable:function(){grid=mini.get("datagrid");grid.set({url:searchUrl+"?structuredPlanCategoryId="+structuredPlanCategoryId,ajaxType:"get",dataField:"pageList"});grid.load()},duty_list:function(c){if(c.row.dutyNames){return c.row.dutyNames.replace(/\)\,/g,")<br/>")}else{return""}},closeLayer:function(c){Trigger_btn=false;window.parent.pageLoadMode=c;parent.layer.close(a)}}};b.init();window.page=b});