var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2&isAll=true";var commGroupsType_url=ECS.api.emUrl+"/CommGroupsType";var saveUrl=ECS.api.emUrl+"/CommonGroupOrg";window.pageLoadMode=PageLoadMode.None;var riskAreaCode,enterpriseCode,enterpriseName,isLeaf;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={};var c={init:function(){mini.parse();this.bindUI();mini.get("commGroupsType").on("drawnode",function(h){var g=h.field,d=h.record,f=h.rowIndex;if(h.record._level==0){h.showCheckBox=false}})},table:{},bindUI:function(){$("#btnSave").click(function(){c.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;c.logic.closeLayer(false)});mini.get("enterpriseCode").on("nodeclick",function(d){c.logic.load_sidebar(commGroupsType_url,"commGroupsType",d.node.orgId)});mini.get("commGroupsType").on("nodeclick",function(g){var d=mini.get("commGroupsType");var f=d.getSelectedNode();if(f.children){return}})},data:{param:{}},logic:{setData:function(d){riskAreaCode=d.riskAreaCode;enterpriseCode=d.enterpriseCode;enterpriseName=d.enterpriseName;isLeaf=d.isLeaf;$("#title-main").text(d.title);mini.get("enterpriseCode").setEnabled(false);c.logic.select_option(enterpriseCodeUrl,"#enterpriseCode",d.keys);pageMode=d.pageMode;if(pageMode==PageModelEnum.NewAdd){return}},select_option:function(e,f,d){$.ajax({url:e,type:"get",success:function(h){mini.get(f).loadList(h,"orgCode","porgCode");mini.get(f).setValue(enterpriseCode);var g=mini.get("enterpriseCode");c.logic.load_sidebar(commGroupsType_url,"commGroupsType",g.value,d)},error:function(g){}})},load_sidebar:function(d,g,e,f){$.ajax({url:d+"?enterpriseCode="+e+"&commGroupIds="+f,type:"get",success:function(h){if(h.length==0){h.push({id:0,name:"无",children:[]})}mini.get(g).loadData(h)},error:function(h){}})},closeLayer:function(d){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},save:function(){var e=[];var d=mini.get("commGroupsType");var h=d.getCheckedNodes(false);if(h.length==0){layer.msg("请选择通讯组");return false}for(var f=0;f<h.length;f++){var k=h[f];var g={commGroupId:k.id};if(isLeaf){g.riskAreaCode=riskAreaCode}else{g.drtDeptCode=riskAreaCode}e.push(g)}var j="POST";window.pageLoadMode=PageLoadMode.Refresh;console.log(JSON.stringify(g));$.ajax({url:saveUrl,async:false,type:j,data:JSON.stringify(e),dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(i){ECS.hideLoading();$("#btnSave").attr("disabled",false);if(i.isSuccess){layer.msg("保存成功！",{time:1000},function(){c.logic.closeLayer(true)})}else{layer.msg(i.message)}},error:function(i){$("#btnSave").attr("disabled",false);ECS.hideLoading();layer.msg(i.message)}})},beforenodeselect:function(d){if(d.isLeaf==false){d.cancel=true}}}};c.init();window.page=c});