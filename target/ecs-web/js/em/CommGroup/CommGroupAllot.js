var delUrl=ECS.api.emUrl+"/CommonGroupOrg";var commGroupsType_url=ECS.api.emUrl+"/CommonGroupOrg/allRiskTree";var searchUrl=ECS.api.emUrl+"/CommonGroupOrg";var searchGroupTypeUrl=ECS.api.emUrl+"/CommGroupsType";var searchPersonUrl=ECS.api.emUrl+"/PersonInCommGroup";var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName";window.pageLoadMode=PageLoadMode.None;var detailGrid_Form;$(function(){var a={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();a.logic.get_list(enterpriseCodeUrl,$("#enterpriseCode"));var b=mini.get("enterpriseCode").getSelectedNode().orgCode;a.logic.load_sidebar(commGroupsType_url,"tree1",b);a.logic.loadGroupType(b);a.logic.initTable()},table:{},bindUI:function(){mini.get("enterpriseCode").on("nodeclick",function(b){a.logic.load_sidebar(commGroupsType_url,"tree1",b.node.orgCode);a.logic.loadGroupType(b.node.orgCode)});mini.get("tree1").on("nodeclick",function(b){a.logic.search();mini.get("employee_grid").setData([])});$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnQuery").click(function(){a.logic.search()});$("#btnDel").click(function(){a.logic.delAll()})},data:{param:{}},logic:{initTable:function(){mini.parse();grid=mini.get("datagrid");detailGrid_Form=document.getElementById("detailGrid_Form")},show_edit:function(b){return ECS.util.editRender(b.row.constitutionTypeID,b.row.orgCode)},get_list:function(c,f,e,b){if(e){var d=c+"?isAll=true&orgPID="+e+"&orgLvl=3"}else{var d=c+"?orgLvl=2"}$.ajax({async:false,url:d,type:"GET",success:function(h){if(e){mini.get("drtDeptCode").loadList(h,"orgId","orgPID");mini.get("drtDeptCode").setValue("全部");a.logic.load_risk_menu();b&&b()}else{mini.get("enterpriseCode").loadList(h,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgCode)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var g=0;g<h.length;g++){(function(i){if(i.orgCode==enterpriseCode){mini.get("enterpriseCode").setValue(i.orgCode)}})(h[g])}}mini.get("enterpriseCode").doValueChanged();b&&b()}}})},load_sidebar:function(b,d,c){$.ajax({url:b+"?code="+c,type:"get",success:function(e){if(e.length==0){e.push({id:0,name:"无",children:[]})}mini.get(d).loadList(e,"orgCode","pOrgCode")},error:function(f){}})},onSelectionChanged:function(d){var c=d.sender;var b=c.getSelected();if(b){var f=mini.get("employee_grid");f.set({url:searchPersonUrl+"?commGroupId="+b.commGroupid,ajaxType:"get",dataField:"pageList"});f.load({},function(){})}},loadGroupType:function(c){var b=searchGroupTypeUrl+"/query?enterpriseCode="+c;ECS.ui.getComboSelects(b,"commGroupType","commGroupTypeId","commGroupTypeName",false)},search:function(){var b=mini.get("tree1");var c=b.getSelectedNode();a.data.param=ECS.form.getData("searchForm");grid.set({url:searchUrl,ajaxType:"get",dataField:"result"});console.log(b.isLeaf(c));if(b.isLeaf(c)){grid.load({riskAreaCode:c.orgCode,groupName:a.data.param.key_words,commGroupTypeId:a.data.param.commGroupType})}else{grid.load({drtDeptCode:c.orgCode,groupName:a.data.param.key_words,commGroupTypeId:a.data.param.commGroupType})}},add:function(){var e=PageModelEnum.NewAdd;var g="选择通讯组";var b=mini.get("tree1");var d=b.getSelectedNode();if(!d){layer.msg("请选择风险区!");return}var c=b.isLeaf(d);var f=mini.get("enterpriseCode");a.logic.detail(g,d.orgCode,f.value,f.text,e,c)},delAll:function(){var b=[];var c=grid.getSelecteds();$.each(c,function(d,e){b.push({riskAreaCode:e.riskAreaCode,commGroupId:e.commGroupid})});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:true,data:JSON.stringify(b),dataType:"json",timeout:1000,contentType:"application/json;charset=utf-8",type:"DELETE",success:function(d){if(d.isSuccess){layer.msg("删除成功！",{time:1000},function(){grid.reload()})}else{layer.msg(d.message)}},error:function(d){var e=$.parseJSON(d.responseText);layer.msg("系统繁忙")}})},function(d){layer.close(d)})},detail:function(i,b,h,f,d,c){var j=grid.getList();var l=[];var k="";for(var g=0;g<j.length;g++){var e=j[g];l.push(e.commGroupid);k+=e.commGroupid+";"}layer.open({type:2,closeBtn:0,area:["400px","400px"],skin:"new-class",shadeClose:false,title:false,content:"SelectGroup.html?"+Math.random(),success:function(n,o){var m=layer.getChildFrame("body",o);var q=window[n.find("iframe")[0]["name"]];var p={pageMode:d,riskAreaCode:b,enterpriseCode:h,enterpriseName:f,title:i,keys:k,isLeaf:c};q.page.logic.setData(p)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search();window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search();window.pageLoadMode=PageLoadMode.None}}}})},onShowRowDetail:function(c){var b=c.sender;var d=c.record;var f=b.getRowDetailCellEl(d);f.appendChild(detailGrid_Form);detailGrid_Form.style.display="block";a.logic.onSelectionChanged(c)},}};a.init();window.page=a});