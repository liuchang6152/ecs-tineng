var delUrl=ECS.api.emUrl+"/Device";var useUrl=ECS.api.emUrl+"/Device/updateDeviceInuse";var searchUrl=ECS.api.emUrl+"/Device";var enterpriseUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var deviceCategUrl=ECS.api.emUrl+"/Device/deviceByDeviceCatg";var deviceTypeUrl=ECS.api.emUrl+"/Device/deviceByDeviceType";window.pageLoadMode=PageLoadMode.None;var exportUrl=ECS.api.emUrl+"/Device/ExportToExcel";$(function(){var a={init:function(){ECS.sys.RefreshContextFromSYS();this.bindUI();$("#searchForm").find("input").val("");a.logic.cbxEnterprise();a.logic.cbxDeviceCateg();a.logic.cbxDeviceType();a.logic.initTable();a.logic.search()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){a.data.param={};a.data.param=ECS.form.getData("searchForm");for(var c in a.data.param){a.data.param[c]=$.trim(a.data.param[c])}var b=a.logic.setUrlK(a.data.param);window.open(exportUrl+"?"+b)})},data:{param:{}},logic:{setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},initTable:function(){mini.parse();grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"})},show_edit:function(b){if(b.row.inUse==1){return'<a title="启用" href="javascript:window.page.logic.inUse(\''+b.row.deviceId+"','"+b.row.inUse+'\')"><i class="icon-enable"></i></a>　|　<a title="编辑" href="javascript:window.page.logic.edit(\''+b.row.deviceId+'\')"><i class="icon-edit edit"></i></a>　|　<a title="状态列表配置" href="javascript:window.page.logic.deploy(\''+b.row.deviceId+"','"+b.row.deviceName+'\')"><i class="icon-deploy history"></i></a>'}else{return'<a title="禁用" href="javascript:window.page.logic.inUse(\''+b.row.deviceId+"','"+b.row.inUse+'\')"><i class="icon-disable del"></i></a>　|　<a title="编辑" href="javascript:window.page.logic.edit(\''+b.row.deviceId+'\')"><i class="icon-edit edit"></i></a>　|　<a title="状态列表配置" href="javascript:window.page.logic.deploy(\''+b.row.deviceId+"','"+b.row.deviceName+'\')"><i class="icon-deploy history"></i></a>'}},show_status:function(b){return b.row.deviceOperationPattern+"(激活)"},inUse:function(d,b){var c=new Array();if(b=="0"){c.inUse="1"}else{c.inUse="0"}$.ajax({url:useUrl+"/"+d+"/"+c.inUse,async:false,type:"PUT",data:$.param(c),dataType:"text",success:function(e){if(e.indexOf("collection")<0){layer.msg("修改成功！",{time:1000},function(){grid.reload()})}else{e=JSON.parse(e);layer.msg(e.collection.error.message)}},error:function(e){var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},cbxEnterprise:function(){if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){ECS.ui.getCombobox("enterpriseCode",enterpriseUrl,{selectFirstRecord:true,async:false,keyField:"orgCode",valueField:"orgSname"},null)}else{ECS.ui.getCombobox("enterpriseCode",enterpriseUrl,{selectValue:ECS.sys.Context.SYS_ENTERPRISE_CODE,async:false,keyField:"orgCode",valueField:"orgSname"},null);$("#enterpriseCode").attr("disabled",true)}},cbxDeviceCateg:function(){ECS.ui.getCombobox("deviceCatgId",deviceCategUrl,{selectValue:"",data:{isAll:true}},null,a.logic.cbxDeviceType)},cbxDeviceType:function(b){ECS.ui.getCombobox("deviceTypeId",deviceTypeUrl,{selectValue:"",data:{isAll:true,deviceCatgId:b}},null)},delAll:function(){var b=[];var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.deviceId)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:false,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",success:function(d){if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){grid.reload()})}else{d=JSON.parse(d);layer.msg(d.collection.error.message)}},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},add:function(){var b=PageModelEnum.NewAdd;var c="应急设备维护新增";a.logic.detail(c,"",b)},edit:function(c){var b=PageModelEnum.Edit;var d="应急设备维护编辑";a.logic.detail(d,c,b)},detail:function(d,c,b){layer.open({type:2,closeBtn:0,area:["800px","450px"],skin:"new-class",shadeClose:false,title:false,content:"DeviceAddOrEdit.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:b,deviceId:c,title:d};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},deploy:function(c,b){layer.open({type:2,closeBtn:0,area:["600px","450px"],skin:"new-class",shadeClose:false,title:false,content:"deploy.html?"+Math.random(),success:function(e,f){var d=layer.getChildFrame("body",f);var h=window[e.find("iframe")[0]["name"]];var g={deviceId:c,deviceName:b};h.page.logic.setData(g)},end:function(){a.logic.search(true)}})},search:function(c){a.data.param={};a.data.param=ECS.form.getData("searchForm");if(c){a.data.param.sortType=1}for(var b in a.data.param){a.data.param[b]=$.trim(a.data.param[b])}grid.load(a.data.param)},imp:function(){var c=ECS.api.emUrl+"/Device/importExcel";var b=ECS.api.emUrl+"/Device/ExportExcel";var e=ECS.api.emUrl+"/Device/importAddAll";var d="../../bc/UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d)}}};a.init();window.page=a});