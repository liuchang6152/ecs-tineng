var searchAddUrl=ECS.api.emUrl+"/DispatchDeviceConfig/getDevice";var addUrl=ECS.api.emUrl+"/DispatchDeviceConfig";var enterpriseUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var deviceCategUrl=ECS.api.emUrl+"/Device/deviceByDeviceCatg";var deviceTypeUrl=ECS.api.emUrl+"/Device/deviceByDeviceType";var addObj;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();b.logic.cbxDeviceCateg();b.logic.cbxDeviceType()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnQuery").click(function(){b.logic.search()});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)})},data:{param:{}},logic:{setData:function(c){addObj=c;grid=mini.get("datagrid");grid.set({url:searchAddUrl,ajaxType:"get",dataField:"pageList"});if(c.teamID){grid.load({baseModelCategory:c.baseModelCategory,baseDataId:c.baseDataId,teamID:c.teamID,enterpriseID:c.enterpriseID,deviceMode:c.deviceMode})}else{grid.load({baseModelCategory:c.baseModelCategory,baseDataId:c.baseDataId,enterpriseID:c.enterpriseID,deviceMode:c.deviceMode})}b.logic.cbxEnterprise(c.enterpriseID)},show_status:function(c){return c.row.activationPattern+"(激活)"},cbxEnterprise:function(c){ECS.ui.getCombobox("enterpriseID",enterpriseUrl,{selectValue:addObj.enterpriseID,keyField:"orgId",valueField:"orgSname"},null);$("#enterpriseID").attr("disabled",true)},cbxDeviceCateg:function(){ECS.ui.getCombobox("deviceCatgId",deviceCategUrl,{selectValue:"",data:{isAll:true}},null,b.logic.cbxDeviceType)},cbxDeviceType:function(c){ECS.ui.getCombobox("deviceTypeId",deviceTypeUrl,{selectValue:"",data:{isAll:true,deviceCatgId:c}},null)},save:function(){var c=[];var e=grid.getSelecteds();$.each(e,function(f,g){c.push(g.deviceId)});if(c.length==0){layer.msg("请选择要新增的数据!");return}if(addObj.teamID){var d={deviceIDList:c,enterpriseID:addObj.enterpriseID,deviceMode:"2",baseModelCategory:"2",baseDataId:addObj.enterpriseID,teamID:addObj.teamID}}else{var d={deviceIDList:c,enterpriseID:addObj.enterpriseID,deviceMode:addObj.deviceMode,baseModelCategory:addObj.baseModelCategory,baseDataId:addObj.baseDataId}}$.ajax({url:addUrl,async:false,type:"POST",data:JSON.stringify(d),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(f){ECS.hideLoading();if(f.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(f.collection.error.message)}},error:function(f){$("#btnSave").attr("disabled",false);ECS.hideLoading();var g=$.parseJSON(f.responseText);layer.msg(g.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},search:function(){var e={};var c={};if(addObj.teamID){c={baseModelCategory:addObj.baseModelCategory,baseDataId:addObj.baseDataId,teamID:addObj.teamID,enterpriseID:addObj.enterpriseID,deviceMode:addObj.deviceMode}}else{c={baseModelCategory:addObj.baseModelCategory,baseDataId:addObj.baseDataId,enterpriseID:addObj.enterpriseID,deviceMode:addObj.deviceMode}}b.data.param={};b.data.param=ECS.form.getData("searchForm");for(var d in b.data.param){b.data.param[d]=$.trim(b.data.param[d])}e=$.extend(b.data.param,c);grid.load(e)}}};b.init();window.page=b});