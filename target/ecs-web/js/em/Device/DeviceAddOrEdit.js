var addUrl=ECS.api.emUrl+"/Device";var getSingleUrl=ECS.api.emUrl+"/Device";var enterpriseUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var deviceCategUrl=ECS.api.emUrl+"/Device/deviceByDeviceCatg";var deviceTypeUrl=ECS.api.emUrl+"/Device/deviceByDeviceType";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){ECS.sys.RefreshContextFromSYS();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();b.logic.cbxDeviceCateg();b.logic.cbxDeviceType()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)})},logic:{setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;if(pageMode==PageModelEnum.NewAdd){b.logic.cbxEnterprise(ECS.sys.Context.SYS_ENTERPRISE_CODE);$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});return}$.ajax({url:getSingleUrl+"/"+c.deviceId+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(d){b.logic.cbxEnterprise(d.enterpriseCode);$("#enterpriseID").attr("disabled","disabled");ECS.form.setData("AddOrEditModal",d);$("#inUse").iCheck("update");ECS.hideLoading()},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},cbxEnterprise:function(c){if(ECS.sys.isHQ(c)){ECS.ui.getCombobox("enterpriseID",enterpriseUrl,{selectFirstRecord:true,keyField:"orgCode",codeField:"orgId",valueField:"orgSname",async:true},null)}else{ECS.ui.getCombobox("enterpriseID",enterpriseUrl,{selectValue:c,keyField:"orgCode",codeField:"orgId",valueField:"orgSname",async:true},null);$("#enterpriseID").attr("disabled","disabled")}},cbxDeviceCateg:function(){ECS.ui.getCombobox("deviceCatgId",deviceCategUrl,{selectFirstRecord:true,async:false},null,b.logic.cbxDeviceType)},cbxDeviceType:function(){var c=$("#deviceCatgId").val();ECS.ui.getCombobox("deviceTypeId",deviceTypeUrl,{async:false,data:{deviceCatgId:c}},null)},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var d=ECS.form.getData("AddOrEditModal");d.enterpriseID=$("#enterpriseID").find("option:selected").attr("code");for(var c in d){d[c]=$.trim(d[c])}var e="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){e="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:e,data:JSON.stringify(d),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(f){ECS.hideLoading();if(f.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(f.collection.error.message)}},error:function(f){$("#btnSave").attr("disabled",false);ECS.hideLoading();var g=$.parseJSON(f.responseText);layer.msg(g.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{enterpriseID:{required:true},deviceName:{required:true},deviceCatgId:{required:true},deviceTypeId:{required:true},activationPattern:{required:true},deviceNumber:{required:true},ipAddress:{ipv4:true},sortNum:{required:true}}})}}};b.init();window.page=b});