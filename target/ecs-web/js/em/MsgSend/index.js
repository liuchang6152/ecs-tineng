var tempPersonUrl=ECS.api.emUrl+"/msg/getTemporaryStaff";var delTempPersonUrl=ECS.api.emUrl+"/msg/deleteTemporaryStaff";var weatherUrl=ECS.api.emUrl+"/msg/getWeatherForecast";var dataSource=null;$(function(){var a={orgUrl:ECS.api.bcUrl+"/org/porgName",commGroupsTypeUrl:ECS.api.emUrl+"/CommGroupsType",personGroupsUrl:ECS.api.emUrl+"/CommonGroupOwer",searchUrl:ECS.api.emUrl+"/PersonInCommGroup",emEventUrl:ECS.api.emUrl+"/msg/event",groupPerson:ECS.api.emUrl+"/PersonInCommGroup/search",sendMsg:ECS.api.emUrl+"/msg",feedbackTypeUrl:ECS.api.emUrl+"/msg/feedbackTypeList",init:function(){mini.parse();$('[tabindex="2"],[tabindex="3"],[tabindex="4"]').hide();ECS.sys.RefreshContextFromSYS();a.logic.get_list(a.orgUrl,$("#enterpriseCode"));a.logic.initData();this.bindUI();a.logic.initPage()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnNewMsg").click(function(){window.location.reload()});$("#btnMsgTrack").click(function(){window.location="../MsgTrack/index.html"+location.search});$("#voice").change(function(){var b=mini.get("feedbackType");if($(this).is(":checked")){b.setEnabled(true)}else{b.select(0);b.setEnabled(false)}});$("#btnDel").click(function(){var b=mini.get("datagrid");var c=b.getSelecteds();if(c.length==0){layer.msg("请选择要删除的数据")}b.removeRows(c)});$("#btnQuery").click(function(){a.logic.searchPerson()});$("#btnTempQuery").click(function(){a.logic.searchTempPerson()});$("#btnSave").click(function(){a.logic.savePersonGroup()});$("#btnAdd").click(function(){a.logic.addPerson()});$("#btnSend").click(function(){a.logic.sendMsg()});$("#btnTempAdd").click(function(){a.logic.tempAdd()});mini.get("enterpriseCode").on("nodeclick",function(b){a.logic.load_sidebar(a.commGroupsTypeUrl,"commGroupsType",b.node.orgCode)});mini.get("commGroupsType").on("nodedblclick",function(b){a.logic.addPersonToTable(b.row[this.idField])});mini.get("userGroups").on("nodedblclick",function(b){a.logic.initTable(b.row[this.idField])});$('[tabindex="1"]').click(function(){$.ajax({url:weatherUrl,type:"GET",dataType:"text",success:function(b){$("#autoMsg").val($("#autoMsg").val()+b)},error:function(b){console.log(b)}})})},data:{param:{}},logic:{initPage:function(){var b=a.logic.getQueryString("PageModel");if(b==1){$("#em").attr("checked","checked");$('[tabindex="2"],[tabindex="3"],[tabindex="4"]').show();$.ajax({url:a.emEventUrl+"?eventId="+a.logic.getQueryString("eventId"),type:"get",success:function(c){$("#event").text(c.eventSummary)},error:function(c){console.log(c)}})}else{$("#day").attr("checked","checked")}a.logic.initTempTable()},get_list:function(c,f,e,b){if(e){var d=c+"?isAll=true&orgPID="+e+"&orgLvl=3"}else{var d=c+"?orgLvl=2"}$.ajax({url:d,type:"GET",success:function(h){if(e){mini.get("drtDeptCode").loadList(h,"orgId","orgPID");mini.get("drtDeptCode").setValue("全部");a.logic.load_risk_menu();b&&b()}else{mini.get("enterpriseCode").loadList(h,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgCode)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var g=0;g<h.length;g++){(function(i){if(i.orgCode==enterpriseCode){mini.get("enterpriseCode").setValue(i.orgCode)}})(h[g])}}a.logic.load_sidebar(a.commGroupsTypeUrl,"commGroupsType",enterpriseCode);b&&b()}}})},load_sidebar:function(b,d,c){$.ajax({url:b+"?enterpriseCode="+c,type:"get",success:function(e){mini.get(d).loadData(e)},error:function(f){console.log(f)}})},initData:function(){$.ajax({url:a.personGroupsUrl,type:"get",success:function(b){if(b==null||b==undefined||b.length==0){return}mini.get("userGroups").loadData(b);mini.get("userGroups").select(0);a.logic.initTable(mini.get("userGroups").getValue())},error:function(b){console.log(b)}});ECS.util.bindCmb({ctrId:"feedbackType",url:a.feedbackTypeUrl},function(){mini.get("feedbackType").select(0)})},searchPerson:function(){var f=$.trim($("#userName").val());var e=mini.get("datagrid");if(dataSource==null){dataSource=e.data}var c=[];for(var d=0,b=dataSource.length;d<b;d++){if(dataSource[d].userName.indexOf(f)>-1){c.push(dataSource[d])}}e.setData(c)},searchTempPerson:function(){var b=$.trim($("#tempUserName").val());$.ajax({url:tempPersonUrl,type:"GET",success:function(d){var f=mini.get("tempDatagrid");var g=[];for(var e=0,c=d.length;e<c;e++){if(d[e].privatePersonName.indexOf(b)>-1){g.push(d[e])}}f.setData(g)}})},savePersonGroup:function(){var b=mini.get("datagrid").getSelecteds();if(b.length==0){layer.msg("请先选择人员");return}layer.open({type:2,closeBtn:0,area:["400px;","300px"],skin:"new-class",shadeClose:false,title:false,content:"addPersonGroup.html?r="+Math.random(),success:function(l,j){var g=layer.getChildFrame("body",j);var d=window[l.find("iframe")[0]["name"]];var h=mini.get("datagrid").getSelecteds();var c="";for(var f=0,k=h.length;f<k;f++){c+=h[f].userID+","}c=c.substring(0,c.length-1);personGroupArr=mini.get("userGroups").data;var e={title:"添加个人通讯组",personIds:c,personGroupArr:personGroupArr};d.page.logic.setData(e)},end:function(){}})},addPerson:function(){var b=mini.get("userGroups").getSelectedNode();if(!b){layer.confirm("请先选择个人通讯组",{btn:["关闭"]},function(c){layer.close(c)});return}layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"../../bc/RiskAnalysisPoint/SelectOwner.html?"+Math.random(),success:function(d,e){var c=layer.getChildFrame("body",e);var g=window[d.find("iframe")[0]["name"]];var f={title:"选择人员",userName:"",orgCode:mini.get("enterpriseCode").getValue()};g.page.logic.setData(f)},end:function(){var d=[];for(var c in window.ownDetail){var e={userId:c,commGroupId:b.commGroupid};d.push(e)}if(d.length==0){return}$.ajax({url:a.searchUrl,async:false,type:"POST",data:JSON.stringify(d),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){ECS.showLoading()},success:function(f){ECS.hideLoading();f=$.parseJSON(f);if(f.isSuccess){layer.msg(f.message,{time:1000},function(){a.logic.initTable(b.commGroupid)})}else{layer.msg(f.message)}},error:function(f){ECS.hideLoading();layer.msg(f.message)}})}})},tempAdd:function(){ECS.util.detail({url:"addTempPerson.html",width:500,height:300,data:{title:"新增临时人员"}})},initTable:function(b){mini.mask({cls:"mini-mask-loading",html:"努力加载中..."});$.ajax({async:true,url:a.searchUrl+"?commGroupId="+b,type:"GET",success:function(c){var d=mini.get("datagrid");d.setData(c.pageList);mini.unmask();$(".mini-grid-checkbox").removeClass("mini-grid-checkbox-checked")},error:function(c){mini.unmask();console.log(c)}})},initTempTable:function(){$.ajax({url:tempPersonUrl,type:"GET",success:function(b){var c=mini.get("tempDatagrid");c.setData(b)}})},addPersonToTable:function(d){mini.mask({cls:"mini-mask-loading",html:"努力加载中..."});var b=mini.get("datagrid");var c=b.getData();$.ajax({url:a.searchUrl+"?commGroupId="+d,type:"GET",success:function(f){var e=f.pageList.length;while(e>0){var h=f.pageList[e-1];var i=h.userID;var j=c.length;var g=true;while(j>0){if(i==c[j-1].userID){g=false}j--}if(g){b.addRow(h)}e--}mini.unmask()},error:function(e){mini.unmask();console.log(e)}})},getQueryString:function(b){var c=new RegExp("(^|&)"+b+"=([^&]*)(&|$)","i");var d=window.location.search.substr(1).match(c);if(d!=null){return decodeURI(d[2])}return null},onBeforeOpen:function(f){var g=f.sender;var b=mini.get("userGroups");var d=b.getSelectedNode();if(!d){f.cancel=true;return}if(d&&d.text=="Base"){f.cancel=true;f.htmlEvent.preventDefault();return}var c=f||window.event;if(c.stopPropagation){c.stopPropagation()}else{c.cancelBubble=true}},onRemoveNode:function(b){var c=mini.get("userGroups").getSelectedNode().personGroupId;layer.confirm("确定删除选中的通讯组？",{btn:["确定","取消"]},function(){$.ajax({url:a.personGroupsUrl,async:false,data:JSON.stringify({personGroupId:c}),contentType:"application/json;charset=utf-8",type:"DELETE",success:function(d){if(d.isSuccess){layer.msg("删除成功！",{time:1000},function(){a.logic.initData()})}else{layer.msg(d.message)}},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},sendMsg:function(){if($("[name=sendType]:checked").length==0){alert("请选择发送类型");return}var j=mini.get("datagrid").data;var l=mini.get("tempDatagrid").getSelecteds();var k=j.length+l.length;if(k==0){alert("请添加接收人");return}if($.trim($("#autoMsg").val())==""){alert("请填写发送内容");return}var d=-1;if($("[name=sendType]:checked").length==2){d=3}else{if($("#msg").is(":checked")){d=1}else{if($("#voice").is(":checked")){d=2}}}var f={businessID:a.logic.getQueryString("eventId"),commuType:d,feedbackTypeId:mini.get("feedbackType").getValue(),infoRecordEntity:[]};var b=[];for(var g=0,h=j.length;g<h;g++){var e={answerName:j[g].userName,answerPhoneNumber:j[g].userMobile,remarks:$.trim($("#autoMsg").val())};f.infoRecordEntity.push(e);if(j[g].mark==1){b.push(j[g].userPhone)}else{b.push(j[g].userMobile)}}var c=mini.get("tempDatagrid").getSelecteds();for(var g=0,h=c.length;g<h;g++){var e={answerName:c[g].privatePersonName,answerPhoneNumber:c[g].privatePersonMobile,remarks:$.trim($("#autoMsg").val())};f.infoRecordEntity.push(e);if(c[g].mark==1){b.push(c[g].privatePersonPhone)}else{b.push(c[g].privatePersonMobile)}}if(d==2||d==3){if(a.logic.isExists(b)){return}}$.ajax({url:a.sendMsg,async:false,type:"POST",data:JSON.stringify(f),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSend").attr("disabled","disabled");ECS.showLoading()},success:function(i){ECS.hideLoading();layer.msg(i,{time:1000},function(){location.reload()});if(d==2||d==3){var m=parent.sendvox(b,$.trim($("#autoMsg").val()))}},error:function(i){$("#btnSend").attr("disabled",false);ECS.hideLoading();layer.msg(i)}})},rendererOperate:function(b){var c=b.record.privatePersonId;return'<a href="javascript:page.logic.del('+c+')">删除</a>'},del:function(b){layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delTempPersonUrl,data:JSON.stringify(b),dataType:"text",timeout:1000,contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){ECS.showLoading()},success:function(c){c=$.parseJSON(c);if(c.isSuccess){layer.msg("删除成功",{time:1000},function(){a.logic.initTempTable()})}else{layer.msg(c.message,{time:1000})}ECS.hideLoading()}})},function(c){layer.close(c)})},onDrawcell:function(b){if(b.field=="mark"&&b.record.userPhone==""){b.cellHtml=""}else{if(b.field=="mark"&&b.record.privatePersonPhone==""){b.cellHtml=""}}},isExists:function(c){var e={};for(var d=0,b=c.length;d<b;d++){if(e[c[d]]){layer.msg(c[d]+"存在重复");return true}e[c[d]]=true}return false}}};a.init();window.page=a});