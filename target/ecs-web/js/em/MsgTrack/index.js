$(function(){var a={searchUrl:ECS.api.emUrl+"/msg/record",orgUrl:ECS.api.bcUrl+"/org/porgName",emEventUrl:ECS.api.emUrl+"/msg/event",init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();a.logic.get_list(a.orgUrl,$("#enterpriseCode"));a.logic.initTable();if(a.logic.getQueryString("PageModel")==1){a.logic.initEventTable()}this.bindUI();a.logic.search()},table:{},bindUI:function(){$("#btnQuery").click(function(){a.logic.search()});$("#btnNewMsg").click(function(){window.location="../MsgSend/index.html"+location.search});$("#btnMsgTrack").click(function(){window.location.reload()})},data:{param:{}},logic:{get_list:function(c,f,e,b){if(e){var d=c+"?isAll=true&orgPID="+e+"&orgLvl=3"}else{var d=c+"?orgLvl=2"}$.ajax({url:d,type:"GET",success:function(h){if(e){mini.get("drtDeptCode").loadList(h,"orgId","orgPID");mini.get("drtDeptCode").setValue("全部");a.logic.load_risk_menu();b&&b()}else{mini.get("enterpriseCode").loadList(h,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgCode)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var g=0;g<h.length;g++){(function(i){if(i.orgCode==enterpriseCode){mini.get("enterpriseCode").setValue(i.orgCode)}})(h[g])}}a.logic.search();b&&b()}}})},initTable:function(){grid=mini.get("datagrid");var c=a.logic.getQueryString("eventId");var b=c==null?a.searchUrl:a.searchUrl+"?eventId="+a.logic.getQueryString("eventId");grid.set({url:b,ajaxType:"get",dataField:"pageList"})},initEventTable:function(){$("#event").show();$.ajax({url:a.emEventUrl+"?eventId="+a.logic.getQueryString("eventId"),type:"get",success:function(b){$("#eventSummary").text(b.eventSummary);$("#enentType").text(a.logic.show_eventType(b.enentType));$("#sendTime").text(ECS.util.DateTimeRender(b.sendTime));$("#msgNumber").text(b.msgNumber);$("#groupCalls").text(b.groupCalls)},error:function(b){console.log(b)}})},show_content:function(b){return'<a href="javascript:page.logic.detail('+b.record._uid+')">'+b.value+"</a>"},show_notFBack:function(b){return'<a href="javascript:page.logic.detail('+b.record._uid+',true)">'+b.value+"</a>"},show_eventType:function(b){if(b==0){return"普通"}else{if(b==1){return"消防"}}return"未定义"},search:function(){var c=mini.formatDate(mini.get("startTime").getValue(),"yyyy-MM-dd");var b=mini.formatDate(mini.get("endTime").getValue(),"yyyy-MM-dd");if(c>b){layer.msg("开始时间不能大于结束时间");return}a.data.param={orgCode:mini.get("enterpriseCode").getValue(),userName:$.trim($("#userName").val()),startTime:c,endTime:b,msgType:$("#msgType").val()};grid.load(a.data.param)},detail:function(b,c){var d=grid.getRowByUid(b);layer.open({type:2,closeBtn:0,area:["800px","500px"],skin:"new-class",shadeClose:false,title:false,content:"detail.html?r="+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={msgID:d.msgID,msgContent:d.content,title:"通知反馈记录"};if(c){h.feedbackStatus=2}i.page.logic.setData(h)},end:function(e){if(e){grid.record()}}})},getQueryString:function(b){var c=new RegExp("(^|&)"+b+"=([^&]*)(&|$)","i");var d=window.location.search.substr(1).match(c);if(d!=null){return decodeURI(d[2])}return null}}};a.init();window.page=a});