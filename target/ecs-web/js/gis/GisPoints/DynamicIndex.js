var searchUrl=ECS.api.gisPoint;var gisId=-1;var state=0;var grid=null;var grid2=null;var grid3=null;var isTriggerEdit=false;var tabs=null;mini_debugger=false;window.pageLoadMode=PageLoadMode.None;$(function(){var page={init:function(){ECS.sys.RefreshContextFromSYS();mini.parse();grid=mini.get("datagrid");grid2=mini.get("datagrid2");grid4=mini.get("datagrid4");grid3=mini.get("datagrid3");tabs=mini.get("tabs");this.bindUI();page.logic.check_point(-1);document.oncontextmenu=new Function("return false")},table:{},bindUI:function(){$("#searchForm")[0].reset();$("input").keyup(function(){$(this).val($.trim($(this).val()))});tabs.on("activechanged",function(e){if(e.tab.title=="静态数据"){if(gisId>0){page.logic.static_list(gisId)}else{page.logic.static_list(-1)}e.cancel=true}});$("#btnQuery").click(function(){var cur_gisId=gisId?gisId:-1;page.logic.check_dymic_dt(function(){})});$("#isSelect").click(function(){var ischecked=$(this).prop("checked");if(ischecked){$("#datagrid").hide();$("#datagrid2").show();grid2.clearRows();grid2.addRows(page.data.aSelected_dt);grid2.selectAll()}else{page.logic.get_check(gisId,function(){grid.selects(page.data.aSelected_dt)})}});$("#btnQuery2").click(function(){page.logic.static_list()});grid.on("load",function(){if(isTriggerEdit){grid.selects(page.data.aSelected_dt)}});grid4.on("load",function(){grid4.selectAll()});grid.on("selectionchanged",function(e){if(e.records.length==0){return false}if(isTriggerEdit){if(e.records.length>1){for(var i=0;i<e.records.length;i++){if(e.records[i].isDisabled==1){var check_button=false;for(var a=0;a<page.data.aDymic_init_dt.length;a++){if(e.records[i].gisPointForID==page.data.aDymic_init_dt[a].gisPointForID){check_button=true;break}}if(check_button==false){grid.deselect(e.records[i]);page.logic.save_selected(e.records[i],false)}check_button=null}}}else{var oCur_tr=e.records[0];if(oCur_tr.isDisabled==1){var check_button=false;for(var a=0;a<page.data.aDymic_init_dt.length;a++){if(oCur_tr.gisPointForID==page.data.aDymic_init_dt[a].gisPointForID){check_button=true;break}}if(check_button==false){grid.deselect(oCur_tr);page.logic.save_selected(oCur_tr,false)}check_button=null}}}else{for(var w=0;w<e.records.length;w++){grid.deselect(e.records[w]);page.logic.save_selected(e.records[w],false)}}});$("#mini-4checkall").parents("td").on("click",function(){if(isTriggerEdit){setTimeout(function(){if($("#datagrid").is(":hidden")){return false}var aForm_dt=grid.getData();for(var w=0;w<aForm_dt.length;w++){if(grid.isSelected(aForm_dt[w])){page.logic.save_selected(aForm_dt[w],true)}else{page.logic.save_selected(aForm_dt[w],false)}}},100)}else{grid.deselectAll()}});$("#mini-17checkall").parents("td").on("click",function(){if(isTriggerEdit){setTimeout(function(){if($("#datagrid2").is(":hidden")){return false}var aForm_dt=grid2.getData();for(var w=0;w<aForm_dt.length;w++){if(grid2.isSelected(aForm_dt[w])){page.logic.save_selected(aForm_dt[w],true)}else{page.logic.save_selected(aForm_dt[w],false)}}},100)}});grid.on("rowclick",function(e){if(isTriggerEdit){if(grid.isSelected(e.record)){page.logic.save_selected(e.record,true)}else{page.logic.save_selected(e.record,false)}}});grid.on("drawcell",function(e){page.logic.ondrawcell(e)});grid2.on("rowclick",function(e){if(isTriggerEdit){if(grid2.isSelected(e.record)){page.logic.save_selected(e.record,true)}else{page.logic.save_selected(e.record,false)}}});grid4.on("rowclick",function(e){if(!isTriggerEdit&&gisId<0){var url="GetGisId("+e.record.gisID+")";window.parent.postMessage(url,"*")}});grid3.on("rowclick",function(e){if(!isTriggerEdit&&gisId<0){var url="GetGisId("+e.record.gisId+")";window.parent.postMessage(url,"*")}});$("#btnQuery3").click(function(){page.logic.loadMSDSGrid(gisId)}),$("#isSelectMSDS").click(function(){var ischecked=$(this).prop("checked");if(ischecked){var checkData=mini.get("datagridMSDS").getSelecteds();$("#datagridMSDS").hide();$("#datagridMSDS2").show();mini.get("datagridMSDS2").clearRows();mini.get("datagridMSDS2").addRows(checkData);mini.get("datagridMSDS2").selectAll()}else{page.logic.get_check(gisId,function(){$("#datagridMSDS").show();$("#datagridMSDS2").hide();page.logic.loadMSDSGrid(-1)})}}),mini.get("datagridMSDS").on("load",function(e){var rows=mini.get("datagridMSDS").findRows(function(row){if(row.isband){return true}});mini.get("datagridMSDS").selects(rows)})},data:{param:{},aStatic_list:[{id:1,text:"消防栓"},{id:2,text:"消防站"},{id:3,text:"消防炮"},{id:4,text:"门口/出入口"},{id:5,text:"应急队伍点"},{id:6,text:"物资存放点"}],aType_list:{"1":"消防栓","2":"消防站","3":"消防炮","4":"门口/出入口","5":"应急队伍点","6":"物资存放点"},aSelected_dt:[],aStatic_dt:[],aDymic_type:{"1":"实时监测点","2":"应急物资存放点","3":"应急队伍点","4":"应急装备存放点"},aDymic_init_dt:[]},logic:{show_name:function(e){return e.row.name},ondrawcell:function(e){var row=e.record,field=e.field,cellCls=e.cellCls,cellHtml=e.cellHtml;if(isTriggerEdit){if(row.isDisabled=="1"&&cellCls=="mini-checkcolumn"){var check_button=false;for(var w=0;w<page.data.aDymic_init_dt.length;w++){if(row.gisPointForID==page.data.aDymic_init_dt[w].gisPointForID){check_button=true;break}}if(check_button==false){e.cellHtml='<span class="mini-grid-checkbox checkbox-enabled mini-icon"></span>';if(!$("#mini-4checkall").hasClass("checkbox-enabled")){$("#mini-4checkall").addClass("checkbox-enabled");$("#mini-4checkall").parents(".mini-grid-headerCell-outer").remove()}}check_button=null}}else{if(cellCls=="mini-checkcolumn"){e.cellHtml='<span class="mini-grid-checkbox checkbox-enabled mini-icon"></span>'}}},ondrawcell_head:function(){if(isTriggerEdit){$("#mini-4checkall").removeClass("checkbox-enabled")}else{$("#mini-4checkall").addClass("checkbox-enabled")}},setGridHeight:function(){var searchHeight=document.getElementById("searchForm").offsetHeight;var winHeight=document.documentElement.clientHeight;grid4.setHeight(winHeight-searchHeight-60);grid.setHeight(winHeight-searchHeight-60);grid2.setHeight(winHeight-searchHeight-60);var searchHeight2=document.getElementById("searchForm2").offsetHeight;grid3.setHeight(winHeight-searchHeight2-60)},get_static_type:function(cb){$.ajax({url:ECS.api.gisPoint+"/static/type",type:"GET",dataType:"text",contentType:"application/json;charset=utf-8",success:function(dt1){var dt=JSON.parse(dt1);$("#type2").html("");var oPtion_first=$('<option value="">全部</option>');$("#type2").append(oPtion_first);for(var w=0;w<dt.length;w++){if(dt[w].key){var oPtion=$('<option value="'+dt[w].key+'">'+dt[w].value+"</option>");$("#type2").append(oPtion)}}page.data.aStatic_dt=dt;cb&&cb()}})},static_list:function(GisId){page.data.param={};page.data.param.type=$("#type2").val();page.data.param.name=$("#name2").val();page.data.param.enterprise=ECS.sys.Context.SYS_ENTERPRISE_CODE;if(GisId){gisId=GisId}grid3.set({ajaxType:"get",url:ECS.api.gisPoint+"/"+(gisId?gisId:"-1")+"/static"});grid3.load(page.data.param,function(){if(!isTriggerEdit){$("#add_one").css("cursor","not-allowed")}})},gispointtype:function(e){return page.data.aType_list[e.row.pointType]},onActionRenderer:function(e){var cur_grid3=e.sender;var record2=e.record;var uid=record2._uid;var rowIndex=e.rowIndex;if(isTriggerEdit){var s='<a class="New_Button" href="javascript:page.logic.newRow()">新增</a> <a class="Edit_Button" href="javascript:page.logic.editRow(\''+uid+'\')" >编辑</a> <a class="Delete_Button" href="javascript:page.logic.delRow(\''+uid+"')\">删除</a>"}else{var s='<a class="New_Button input_useless" style="cursor: not-allowed;" href="javascript:;">新增</a> <a class="Edit_Button input_useless" style="cursor: not-allowed;" href="javascript:;" >编辑</a> <a class="Delete_Button input_useless" style="cursor: not-allowed;" href="javascript:;">删除</a>'}if(cur_grid3.isEditingRow(record2)){s='<a class="Update_Button" style="margin-right:10px;" href="javascript:page.logic.updateRow(\''+uid+'\')">更新</a><a class="Cancel_Button" href="javascript:page.logic.cancelRow(\''+uid+"')\">取消</a>"}return s},newRow:function(){if(!isTriggerEdit){var event=event||window.event;if(event.preventDefault){event.preventDefault()}else{event.returnValue=false}}var row={};grid3.addRow(row,0);grid3.cancelEdit();grid3.beginEditRow(row)},editRow:function(row_uid){var row=grid3.getRowByUID(row_uid);if(row){grid3.cancelEdit();grid3.beginEditRow(row)}},cancelRow:function(row_uid){grid3.reload()},delRow:function(row_uid){var row=grid3.getRowByUID(row_uid);if(row){var GisId=row.gisId;var StaticPointId=row.staticPointId;if(confirm("确定删除此记录？")){grid3.loading("删除中，请稍后......");$.ajax({url:ECS.api.gisPoint+"/"+GisId+"/static",async:true,dataType:"text",timeout:1000,data:JSON.stringify([StaticPointId]),contentType:"application/json;charset=utf-8",type:"DELETE",success:function(text){grid3.reload()},error:function(){}})}}},updateRow:function(row_uid){var row=grid3.getRowByUID(row_uid);var GisId=row.gisId;var StaticPointId=row.staticPointId;var form=new mini.Form("#datagrid3");form.validate();if(form.isValid()==false){return}grid3.commitEdit();var rowData=grid3.getChanges();grid3.loading("保存中，请稍后......");var data={};data.pointType=row.pointType;data.location=row.location;data.info=row.info;data.name=row.name;var url="",sub_type="";if(StaticPointId){url=ECS.api.gisPoint+"/"+GisId+"/static/"+StaticPointId+"?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;sub_type="PUT";data.staticPointId=row.staticPointId;data.gisId=row.gisId}else{url=ECS.api.gisPoint+"/"+gisId+"/static?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;sub_type="POST";data.gisId=gisId}$.ajax({url:url,type:sub_type,data:JSON.stringify(data),dataType:"text",contentType:"application/json;charset=utf-8",success:function(text){grid3.reload()},error:function(jqXHR,textStatus,errorThrown){}})},isClick:function(e){var record2=e.record;var uid=record2._uid;switch(e.row.pointType){case 5:case 6:return'<button style="width:30px;height:20px;line-height:20px;" class="btn btn-primary btn-sm" onclick="javascript:page.logic.GotoPage(\''+uid+"')\">编辑</button>";break;default:return'<button style="border:#CCCCCC solid 1px;width:30px;height:20px;line-height:20px;cursor:not-allowed;" class="btn btn-primary btn-sm input_useless" onclick="javascript:;">编辑</button>'}},GotoPage:function(Row_uid){var row=grid3.getRowByUID(Row_uid),GisId=row.gisId,StaticPointId=row.staticPointId,PointType=row.pointType;switch(row.pointType){case 5:var title="应急队伍点列表";break;case 6:var title="物资存放点列表";break}page.logic.detail(title,GisId,StaticPointId,PointType)},detail:function(title,GisId,StaticPointId,PointType){if(PointType==5){var pageType="StaticTeam.html"}else{if(PointType==6){var pageType="StaticStorage.html"}}layer.open({type:2,closeBtn:0,area:["650px","450px"],skin:"new-class",shadeClose:false,title:false,content:pageType+"?"+Math.random(),success:function(layero,index){var body=layer.getChildFrame("body",index);var iframeWin=window[layero.find("iframe")[0]["name"]];var data={gisId:GisId,StaticPointId:StaticPointId,title:title,isTriggerEdit:isTriggerEdit};iframeWin.page.logic.setData(data)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){window.pageLoadMode=PageLoadMode.None}}}})},set_init_url:function(n){var url="";if(typeof n=="number"){if(n<0){url=searchUrl+"/"+n+"/pageall?type="+$("#type").val()}else{url=searchUrl+"/"+n+"/all?type="+$("#type").val()}}if(typeof n=="object"){if(n.type||n.type==""){url=searchUrl+"?type="+n.type}}return url},save_selected:function(row,isSelected){var isHave=false;var cur_index=null;for(var w=0;w<page.data.aSelected_dt.length;w++){(function(cur_key,index){if((cur_key.gisPointForID==row.gisPointForID)&&(cur_key.type==row.type)){isHave=true;cur_index=index}})(page.data.aSelected_dt[w],w)}if(isSelected){if(!isHave){page.data.aSelected_dt.push(row)}}else{if(isHave){page.data.aSelected_dt.splice(cur_index,1)}}},filter_data:function(dt){var aCur_data=[];for(var i=0;i<dt.length;i++){(function(cur_dt){var cur_one={};cur_one.gisID=gisId;cur_one.type=cur_dt.type;cur_one.gisPointForID=cur_dt.gisPointForID;cur_one.info=cur_dt.info?cur_dt.info:"";aCur_data.push(cur_one)})(dt[i])}var MSDSGridList=[];if($("#datagridMSDS").is(":visible")){MSDSGridList=mini.get("datagridMSDS").getSelecteds()}else{MSDSGridList=mini.get("datagridMSDS2").getSelecteds()}for(var i=0;i<MSDSGridList.length;i++){(function(cur_dt){var cur_one={};cur_one.gisID=gisId;cur_one.type=5;cur_one.gisPointForID=cur_dt.msdsId;cur_one.info=cur_dt.info?cur_dt.info:"";aCur_data.push(cur_one)})(MSDSGridList[i])}return aCur_data},get_type_val:function(e){return page.data.aDymic_type[e.row.type]},search:function(search_url,cb){var ischecked=$("#isSelect").prop("checked");var isSelectMSDS=$("#isSelectMSDS").prop("checked");page.data.param={};page.data.param.name=$("#name").val();page.data.param.enterprise=ECS.sys.Context.SYS_ENTERPRISE_CODE;if(ischecked){if(isTriggerEdit){grid2.set({ajaxType:"get",url:search_url});grid2.load(page.data.param,function(result){grid2.selectAll(true);page.data.aDymic_init_dt=[];page.data.aDymic_init_dt=result.data;page.data.aSelected_dt=result.data;cb&&cb()})}else{grid4.set({ajaxType:"get",url:search_url});grid4.load(page.data.param,function(result){grid4.selectAll(true);cb&&cb()});page.data.aDymic_init_dt=[]}}else{grid.set({ajaxType:"get",url:search_url});grid.load(page.data.param,function(result){grid.clearSelect(true);cb&&cb()})}page.logic.setGridHeight();if(isSelectMSDS){if(isTriggerEdit){page.logic.loadMSDSGrid(gisId)}else{page.logic.loadMSDSGrid(gisId)}}else{page.logic.loadMSDSGrid()}},IntoEdit:function(status,GisId){switch(status){case 0:$("#isSelect").prop("checked",false);$("#isSelect").prop("disabled",true);isTriggerEdit=false;$("#isSelectMSDS").prop("checked",false);$("#isSelectMSDS").prop("disabled",true);break;case 1:$("#isSelect").prop("checked",true);$("#isSelect").prop("disabled",false);$("#type").val("");isTriggerEdit=true;$("#isSelectMSDS").prop("checked",true);$("#isSelectMSDS").prop("disabled",false);break}gisId=GisId;if(isTriggerEdit){page.logic.get_check(GisId,function(){var row_list=grid2.getData();for(var w=0;w<row_list.length;w++){page.logic.save_selected(row_list[w],true)}page.logic.ondrawcell_head()});page.logic.static_list(GisId);layer.closeAll("iframe")}else{page.logic.typeClickLoad(-1,function(){page.logic.ondrawcell_head();page.data.aSelected_dt=[]})}},check_point:function(GisId){if(GisId>0){page.logic.get_check(GisId)}else{page.logic.typeClickLoad(-1,function(){page.logic.ondrawcell_head()})}if(GisId>0){page.logic.static_list(GisId)}else{page.logic.get_static_type(function(){page.logic.static_list(-1)})}layer.closeAll("iframe")},get_check:function(GisId,cb){var url="";gisId=GisId;if($("#isSelect").attr("checked")){$("#datagrid").hide();if(isTriggerEdit){$("#datagrid2").show();$("#datagrid4").hide()}else{$("#datagrid2").hide();$("#datagrid4").show()}if($("#type").val()==""){url=page.logic.set_init_url(gisId)}else{url=page.logic.set_init_url({type:$("#type").val()})}}else{$("#datagrid").show();$("#datagrid2").hide();$("#datagrid4").hide();url=page.logic.set_init_url({type:$("#type").val()})}page.logic.search(url,cb)},check_dymic_dt:function(cb){var url="";if(isTriggerEdit){if($("#isSelect").attr("checked")){url=searchUrl+"/"+gisId+"/all?type="+$("#type").val()}else{url=searchUrl+"?type="+$("#type").val()}}else{url=searchUrl+"/-1/pageall?type="+$("#type").val()}page.logic.search(url,cb)},typeClickLoad:function(n,cb){if(!isTriggerEdit){$("#datagrid").hide();$("#datagrid2").hide();$("#datagrid4").show();$("#datagridMSDS2").hide();$("#datagridMSDS").show()}else{$("#datagrid").hide();$("#datagrid4").hide();$("#datagrid2").show();$("#datagridMSDS2").hide();$("#datagridMSDS").show()}grid.clearSelect(true);grid2.clearSelect(true);grid4.clearSelect(true);$("#type").val("");$("#isSelect").prop("checked",true);$("#isSelect").prop("disabled",true);$("#isSelectMSDS").prop("checked",true);$("#isSelectMSDS").prop("disabled",true);var cur_url="";if(n){gisId=n;cur_url=page.logic.set_init_url(n)}else{cur_url=page.logic.set_init_url({type:""})}page.logic.search(cur_url,cb)},refresh_page:function(){isTriggerEdit=false;page.logic.check_point(-1)},deletes:function(GisId){if(gisId){var deleteUrl=searchUrl+"/"+gisId+"/all";$.ajax({url:deleteUrl,async:true,dataType:"text",timeout:1000,contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){ECS.showLoading()},success:function(result){ECS.hideLoading();if(result.indexOf("删除成功")>-1){layer.msg("删除成功！",{time:1000},function(){isTriggerEdit=false;page.logic.check_point(-1);var url="isDelete(1)";window.parent.postMessage(url,"*")})}else{var url="isDelete(-1)";window.parent.postMessage(url,"*")}},error:function(result){ECS.hideLoading();return false}})}else{layer.msg("请选择要删除的gis面数据!");return false}},save:function(GisId){gisId=GisId;if(gisId>0){if($("#datagrid3").is(":visible")){if(grid3.isEditing()){layer.msg("您当前的地图点的静态数据存在行编辑，请先退出行编辑",{time:1000});var url="isSave(-1)";window.parent.postMessage(url,"*");return false}if(!$("#isSelect").attr("checked")){layer.msg("您未选择“已勾选”，请先勾选！",{time:1000});var url="isSave(-1)";window.parent.postMessage(url,"*");return false}}else{if(!$("#isSelect").attr("checked")){layer.msg("您未选择“已勾选”，请先勾选！",{time:1000});var url="isSave(-1)";window.parent.postMessage(url,"*");return false}if(grid3.isEditing()){layer.msg("您当前的地图点的静态数据存在行编辑，请先退出行编辑",{time:1000});var url="isSave(-1)";window.parent.postMessage(url,"*");return false}}var ajaxType="POST";var jsonArr=page.logic.filter_data(page.data.aSelected_dt);$.ajax({url:searchUrl+"/"+gisId+"/all?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE,type:ajaxType,data:JSON.stringify(jsonArr),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){ECS.showLoading()},success:function(dt){ECS.hideLoading();var result=eval("("+dt+")");if(result.isSuccess){page.logic.save_success(result.result);page.logic.loadMSDSGrid(gisId)}},error:function(result){ECS.hideLoading();layer.msg("保存失败")}})}},give_up:function(){isTriggerEdit=false;page.logic.check_point(-1)},save_success:function(result_dt){grid3=mini.get("datagrid3");layer.msg("保存成功！",{time:1000},function(){isTriggerEdit=false;page.logic.check_point(-1)});var Point_Dynamic=result_dt;var MSDSList=[];if($("#datagridMSDS").is(":visible")){MSDSList=mini.get("datagridMSDS").getSelecteds()}else{MSDSList=mini.get("datagridMSDS2").getSelecteds()}var aReturn_dt={static_dt:{},damic_dt:Point_Dynamic,MSDS_dt:MSDSList};var Point_Static=grid3.getData();for(var i=0;i<page.data.aStatic_dt.length;i++){aReturn_dt.static_dt[""+page.data.aStatic_dt[i].key]=[]}if(Point_Static.length>0){for(var w=0;w<Point_Static.length;w++){aReturn_dt.static_dt[""+Point_Static[w].pointType].push(Point_Static[w].staticPointId)}}var url="isSave(1,"+JSON.stringify(aReturn_dt)+")";window.parent.postMessage(url,"*")},getQueryString:function(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=window.location.search.substr(1).match(reg);if(r!=null){return unescape(r[2])}return null},onCloseClick:function(e){var obj=e.sender;obj.setText("");obj.setValue("")},loadMSDSGrid:function(MSDSGISid){var param=ECS.form.getData("searchFormMSDS");var msdsGrid=mini.get("datagridMSDS");var url=ECS.api.rttUrl+"/msds/getMsdsGisInfo?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;if(MSDSGISid&&MSDSGISid!=-1){url=url+"&gisId="+MSDSGISid}msdsGrid.set({ajaxType:"get",url:url});msdsGrid.load(param,function(){})},}};page.init();window.page=page});