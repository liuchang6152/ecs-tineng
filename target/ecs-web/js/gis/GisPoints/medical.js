var searchUrl=ECS.api.rttUrl+"/medicalInstitutio/getMedicalAddressPage";var gisId=-1;var state=0;var grid=null;var grid2=null;var isTriggerEdit=false;var tabs=null;mini_debugger=false;window.pageLoadMode=PageLoadMode.None;$(function(){var a={init:function(){ECS.sys.RefreshContextFromSYS();mini.parse();grid=mini.get("datagrid");grid2=mini.get("datagrid2");grid4=mini.get("datagrid4");this.bindUI();a.logic.check_point(-1);document.oncontextmenu=new Function("return false")},table:{},bindUI:function(){$("#searchForm")[0].reset();$("input").keyup(function(){$(this).val($.trim($(this).val()))});$("#btnQuery").click(function(){var b=gisId?gisId:-1;a.logic.check_dymic_dt(function(){var c=$("#isSelect").prop("checked");if(c){if(b>0){grid2.selects(a.data.aSelected_dt)}}else{grid.selects(a.data.aSelected_dt)}})});$("#isSelect").click(function(){var b=$(this).prop("checked");if(b){$("#datagrid").hide();$("#datagrid2").show();grid2.clearRows();grid2.addRows(a.data.aSelected_dt);grid2.selectAll()}else{a.logic.get_check(gisId,function(){grid.selects(a.data.aSelected_dt)});grid.select()}});$("#btnQuery2").click(function(){a.logic.static_list()});grid.on("load",function(b){console.log(b)});grid.on("headercellmousedown",function(b){console.log("列对象：",b.column);console.log("表格对象：",b.sender)});grid4.on("load",function(){});$("#mini-4checkall").parents("td").on("click",function(){if(isTriggerEdit){setTimeout(function(){if($("#datagrid").is(":hidden")){return false}var c=grid.getData();for(var b=0;b<c.length;b++){if(grid.isSelected(c[b])){a.logic.save_selected(c[b],true)}else{a.logic.save_selected(c[b],false)}}},100)}else{}});$("#mini-17checkall").parents("td").on("click",function(){if(isTriggerEdit){setTimeout(function(){if($("#datagrid2").is(":hidden")){return false}var c=grid2.getData();for(var b=0;b<c.length;b++){if(grid2.isSelected(c[b])){a.logic.save_selected(c[b],true)}else{a.logic.save_selected(c[b],false)}}},100)}});grid.on("rowclick",function(b){console.log(b);if(isTriggerEdit){if(grid.isSelected(b.record)){a.logic.save_selected(b.record,true)}else{a.logic.save_selected(b.record,false)}}});grid.on("drawcell",function(b){a.logic.ondrawcell(b)});grid2.on("rowclick",function(b){if(isTriggerEdit){if(grid2.isSelected(b.record)){a.logic.save_selected(b.record,true)}else{a.logic.save_selected(b.record,false)}}});grid4.on("rowclick",function(c){console.log(isTriggerEdit);if(!isTriggerEdit&&gisId<0){var b="GetGisId("+c.record.gisId+")";window.parent.postMessage(b,"*")}});$("#btnSave").click(function(){a.logic.save(63)});$("#btnDelete").click(function(){a.logic.deletes(63)});$("#btnGive").click(function(){a.logic.give_up()});$("#btnEdit").click(function(){a.logic.IntoEdit(1,63)})},data:{param:{},aStatic_list:[{id:1,text:"消防栓"},{id:2,text:"消防站"},{id:3,text:"消防炮"},{id:4,text:"门口/出入口"},{id:5,text:"应急队伍点"},{id:6,text:"物资存放点"}],aType_list:{"1":"消防栓","2":"消防站","3":"消防炮","4":"门口/出入口","5":"应急队伍点","6":"物资存放点"},aSelected_dt:[],aStatic_dt:[],aDymic_type:{"1":"实时监测点","2":"应急物资存放点","3":"应急队伍点","4":"应急装备存放点"},aDymic_init_dt:[]},logic:{show_name:function(b){return b.row.name},ondrawcell:function(f){var g=f.record,d=f.field,c=f.cellCls,i=f.cellHtml;if(isTriggerEdit){if(g.isDisabled=="1"&&c=="mini-checkcolumn"){var h=false;for(var b=0;b<a.data.aDymic_init_dt.length;b++){if(g.gisPointForID==a.data.aDymic_init_dt[b].gisPointForID){h=true;break}}if(h==false){f.cellHtml='<span class="mini-grid-checkbox checkbox-enabled mini-icon"></span>';if(!$("#mini-4checkall").hasClass("checkbox-enabled")){$("#mini-4checkall").addClass("checkbox-enabled");$("#mini-4checkall").parents(".mini-grid-headerCell-outer").remove()}}h=null}}else{if(c=="mini-checkcolumn"){f.cellHtml='<span class="mini-grid-checkbox checkbox-enabled mini-icon"></span>'}}},ondrawcell_head:function(){if(isTriggerEdit){$("#mini-4checkall").removeClass("checkbox-enabled")}else{$("#mini-4checkall").addClass("checkbox-enabled")}},setGridHeight:function(){var c=document.getElementById("searchForm").offsetHeight;var b=document.documentElement.clientHeight;grid4.setHeight(b-c-60);grid.setHeight(b-c-60);grid2.setHeight(b-c-60)},get_static_type:function(b){$.ajax({url:ECS.api.gisPoint+"/static/type",type:"GET",success:function(e){$("#type2").html("");var f=$('<option value="">全部</option>');$("#type2").append(f);for(var d=0;d<e.length;d++){if(e[d].key){var c=$('<option value="'+e[d].key+'">'+e[d].value+"</option>");$("#type2").append(c)}}a.data.aStatic_dt=e;b&&b()}})},static_list:function(b){a.data.param={};a.data.param.name=$("#name2").val();a.data.param.enterprise=ECS.sys.Context.SYS_ENTERPRISE_CODE;if(b){gisId=b}},gispointtype:function(b){return a.data.aType_list[b.row.pointType]},onActionRenderer:function(g){var c=g.sender;var b=g.record;var d=b._uid;var h=g.rowIndex;if(isTriggerEdit){var f='<a class="New_Button" href="javascript:page.logic.newRow()">新增</a> <a class="Edit_Button" href="javascript:page.logic.editRow(\''+d+'\')" >编辑</a> <a class="Delete_Button" href="javascript:page.logic.delRow(\''+d+"')\">删除</a>"}else{var f='<a class="New_Button input_useless" style="cursor: not-allowed;" href="javascript:;">新增</a> <a class="Edit_Button input_useless" style="cursor: not-allowed;" href="javascript:;" >编辑</a> <a class="Delete_Button input_useless" style="cursor: not-allowed;" href="javascript:;">删除</a>'}if(c.isEditingRow(b)){f='<a class="Update_Button" style="margin-right:10px;" href="javascript:page.logic.updateRow(\''+d+'\')">更新</a><a class="Cancel_Button" href="javascript:page.logic.cancelRow(\''+d+"')\">取消</a>"}return f},newRow:function(){if(!isTriggerEdit){var b=b||window.event;if(b.preventDefault){b.preventDefault()}else{b.returnValue=false}}var c={};grid3.addRow(c,0);grid3.cancelEdit();grid3.beginEditRow(c)},editRow:function(b){var c=grid3.getRowByUID(b);if(c){grid3.cancelEdit();grid3.beginEditRow(c)}},cancelRow:function(b){grid3.reload()},delRow:function(d){var e=grid3.getRowByUID(d);if(e){var c=e.gisId;var b=e.staticPointId;if(confirm("确定删除此记录？")){grid3.loading("删除中，请稍后......");$.ajax({url:ECS.api.gisPoint+"/"+c+"/static",async:true,dataType:"text",timeout:1000,data:JSON.stringify([b]),contentType:"application/json;charset=utf-8",type:"DELETE",success:function(f){grid3.reload()},error:function(){}})}}},updateRow:function(d){var j=grid3.getRowByUID(d);var i=j.gisId;var h=j.staticPointId;var c=new mini.Form("#datagrid3");c.validate();if(c.isValid()==false){return}grid3.commitEdit();var e=grid3.getChanges();grid3.loading("保存中，请稍后......");var g={};g.pointType=j.pointType;g.location=j.location;g.info=j.info;g.name=j.name;var b="",f="";if(h){b=ECS.api.gisPoint+"/"+i+"/static/"+h+"?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;f="PUT";g.staticPointId=j.staticPointId;g.gisId=j.gisId}else{b=ECS.api.gisPoint+"/"+gisId+"/static?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;f="POST";g.gisId=gisId}$.ajax({url:b,type:f,data:JSON.stringify(g),dataType:"text",contentType:"application/json;charset=utf-8",success:function(k){grid3.reload()},error:function(k,m,l){}})},isClick:function(d){var b=d.record;var c=b._uid;switch(d.row.pointType){case 5:case 6:return'<button style="width:30px;height:20px;line-height:20px;" class="btn btn-primary btn-sm" onclick="javascript:page.logic.GotoPage(\''+c+"')\">编辑</button>";break;default:return'<button style="border:#CCCCCC solid 1px;width:30px;height:20px;line-height:20px;cursor:not-allowed;" class="btn btn-primary btn-sm input_useless" onclick="javascript:;">编辑</button>'}},GotoPage:function(d){var g=grid3.getRowByUID(d),c=g.gisId,b=g.staticPointId,f=g.pointType;switch(g.pointType){case 5:var e="应急队伍点列表";break;case 6:var e="物资存放点列表";break}a.logic.detail(e,c,b,f)},detail:function(f,d,b,e){if(e==5){var c="StaticTeam.html"}else{if(e==6){var c="StaticStorage.html"}}layer.open({type:2,closeBtn:0,area:["650px","450px"],skin:"new-class",shadeClose:false,title:false,content:c+"?"+Math.random(),success:function(h,i){var g=layer.getChildFrame("body",i);var k=window[h.find("iframe")[0]["name"]];var j={gisId:d,StaticPointId:b,title:f,isTriggerEdit:isTriggerEdit};k.page.logic.setData(j)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){window.pageLoadMode=PageLoadMode.None}}}})},set_init_url:function(c){var b="";if(typeof c=="number"){if(c<0){b=searchUrl+"/"+c+"/pageall?status="}else{b=searchUrl+"/"+c+"/all?status="}}if(typeof c=="object"){if(c.type!=undefined){console.log(gisId);if(c.type==1){b=searchUrl+"?status="+c.type}else{if(gisId>1){b=searchUrl+"?status="+c.type}}}else{console.log(isTriggerEdit);b=searchUrl}}return b},save_selected:function(e,c){var d=false;var b=null;if(c){if(!d){a.data.aSelected_dt=[];a.data.aSelected_dt.push(e)}}else{if(d){a.data.aSelected_dt.splice(b,1)}}},filter_data:function(d){var b=[];for(var c=0;c<d.length;c++){(function(f){var e={};e.gisId=gisId;e.type=f.type;e.gisPointForId=f.gisPointForId;e.info=f.info?f.info:"";b.push(e)})(d[c])}return b},get_type_val:function(b){return a.data.aDymic_type[b.row.type]},search:function(d,b){console.log(gisId);d=mini.encode(d);var c=$("#isSelect").prop("checked");a.data.param={};if(gisId>1){a.data.param.gisId=gisId||""}else{a.data.param.gisId=""}a.data.param.enterprise=ECS.sys.Context.SYS_ENTERPRISE_CODE;if(c){if(isTriggerEdit){grid2.set({ajaxType:"get",url:d});grid2.load(a.data.param,function(e){a.data.aDymic_init_dt=[];a.data.aDymic_init_dt=e.data;a.data.aSelected_dt=e.data;grid2.selectAll();b&&b()})}else{grid4.set({ajaxType:"get",url:d});grid4.load(a.data.param,function(e){b&&b()});grid4.select();a.data.aDymic_init_dt=[]}}else{grid.set({ajaxType:"get",url:d});grid.load(a.data.param,function(e){grid.clearSelect(true);b&&b()})}grid.selectAll();a.logic.setGridHeight()},IntoEdit:function(b,c){switch(b){case 0:$("#isSelect").prop("checked",false);$("#isSelect").prop("disabled",true);isTriggerEdit=false;break;case 1:$("#isSelect").prop("checked",true);$("#isSelect").prop("disabled",false);isTriggerEdit=true;break}gisId=c;if(isTriggerEdit){a.logic.get_check(c,function(){var e=grid2.getData();for(var d=0;d<e.length;d++){a.logic.save_selected(e[d],true)}a.logic.ondrawcell_head()});a.logic.static_list(c);layer.closeAll("iframe")}else{a.logic.typeClickLoad(1,function(){a.logic.ondrawcell_head();a.data.aSelected_dt=[]})}},check_point:function(b){if(b>0){a.logic.get_check(b)}else{a.logic.typeClickLoad(0,function(){a.logic.ondrawcell_head()})}layer.closeAll("iframe")},get_check:function(d,b){var c="";gisId=d;if($("#isSelect").attr("checked")){$("#datagrid").hide();if(isTriggerEdit){$("#datagrid2").show();$("#datagrid4").hide();c=a.logic.set_init_url({gisId:gisId})}else{$("#datagrid2").hide();$("#datagrid4").show();c=a.logic.set_init_url({type:1})}}else{$("#datagrid").show();$("#datagrid2").hide();$("#datagrid4").hide();c=a.logic.set_init_url({type:2})}a.logic.search(c,b)},check_dymic_dt:function(b){var c="";if(isTriggerEdit){if($("#isSelect").attr("checked")){c=searchUrl+"/"+gisId+"/all?status="+$("#name").val()}else{c=searchUrl+"?status="+$("#name").val()}}else{c=searchUrl+"?status=1&medicalName="+$("#name").val()}a.logic.search(c,b)},typeClickLoad:function(d,b){if(!isTriggerEdit){$("#datagrid").hide();$("#datagrid2").hide();$("#datagrid4").show()}else{$("#datagrid").hide();$("#datagrid4").hide();$("#datagrid2").show()}grid.clearSelect(true);grid2.clearSelect(true);grid2.deselectAll(true);$("#isSelect").prop("checked",true);$("#isSelect").prop("disabled",true);var c="";if(d){gisId=d;c=a.logic.set_init_url(d)}else{c=a.logic.set_init_url({type:1})}a.logic.search(c,b)},refresh_page:function(){isTriggerEdit=false;a.logic.check_point(-1)},deletes:function(b){if(gisId){var c=ECS.api.medicalGis+"/delmedicalGis?gisId="+b+"&systemId="+a.data.aSelected_dt[0].institutionId;$.ajax({url:c,async:false,dataType:"json",timeout:1000,contentType:"application/json;charset=utf-8",type:"Get",beforeSend:function(){},success:function(d){console.log(d);if(d.isSuccess){layer.msg(d.message,{time:1000},function(){isTriggerEdit=false;var f="isDelete(1)";window.parent.postMessage(f,"*")});a.logic.check_point(-1)}else{var e="isDelete(-1)";window.parent.postMessage(e,"*")}},error:function(d){ECS.hideLoading();return false}})}else{layer.msg("请选择要删除的gis面数据!");return false}a.logic.give_up()},save:function(d){gisId=d;if(gisId>0){if(!$("#isSelect").attr("checked")){layer.msg("您未选择“已勾选”，请先勾选！",{time:1000});var c="isSave(-1)";window.parent.postMessage(c,"*");return false}console.log(a.data.aSelected_dt);var f="POST";var b={gisId:d,systemId:a.data.aSelected_dt[0].institutionId,};var e={institutionId:a.data.aSelected_dt[0].institutionId||"",medicalName:a.data.aSelected_dt[0].survVideoName||""};$.ajax({url:ECS.api.medicalGis+"/addMedicalGis",type:f,data:JSON.stringify(b),dataType:"json",contentType:"application/json;charset=utf-8",beforeSend:function(){},success:function(g){if(g.isSuccess){layer.msg(g.message,{time:1000},function(){var h="isSave(1,"+JSON.stringify(e)+")";console.log(g);window.parent.postMessage(h,"*");a.logic.search(a.logic.set_init_url({type:1}),"",true)})}else{layer.msg(g.message,{time:1000},function(){var h="isSave(-1,"+JSON.stringify(e)+")";console.log(g);window.parent.postMessage(h,"*");a.logic.search(a.logic.set_init_url({type:1}),"",true)})}},error:function(g){}})}a.logic.give_up()},give_up:function(){isTriggerEdit=false;$("#name").val("");grid4.set({ajaxType:"get",url:a.logic.set_init_url({type:1})});var b={gisId:""};grid4.load(b,function(c){});grid.hide();grid2.hide();grid4.show();$("#isSelect").prop("checked",true);$("#isSelect").prop("disabled",true)},save_success:function(h){grid3=mini.get("datagrid3");layer.msg("保存成功！",{time:1000},function(){isTriggerEdit=false;a.logic.check_point(-1)});var g=h;var d={static_dt:{},damic_dt:g};var c=grid3.getData();for(var f=0;f<a.data.aStatic_dt.length;f++){d.static_dt[""+a.data.aStatic_dt[f].key]=[]}if(c.length>0){for(var b=0;b<c.length;b++){d.static_dt[""+c[b].pointType].push(c[b].staticPointId)}}var e="isSave(1,"+JSON.stringify(d)+")";window.parent.postMessage(e,"*")},getQueryString:function(b){var c=new RegExp("(^|&)"+b+"=([^&]*)(&|$)","i");var d=window.location.search.substr(1).match(c);if(d!=null){return unescape(d[2])}return null}}};a.init();window.page=a});