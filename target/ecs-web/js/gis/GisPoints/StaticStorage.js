var Storage_list=ECS.api.gisPoint;var storage_type_url=ECS.api.rttUrl+"/mtrlStorage/getStoreTypeEnumList";var repository_type_url=ECS.api.rttUrl+"/mtrlStorage/getRepoTypeEnumList";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var gisId="";var StaticPointId="";var isTriggerEdit=false;var grid=null;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){ECS.sys.RefreshContextFromSYS();mini.parse();grid=mini.get("datagrid");this.bindUI()},bindUI:function(){$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});document.oncontextmenu=new Function("return false")},data:{param:{},storage_type_dt:{},repository_type_dt:{}},logic:{setData:function(c){gisId=c.gisId;StaticPointId=c.StaticPointId;$("#title-main").text(c.title);isTriggerEdit=c.isTriggerEdit;b.data.param={};gisId=c.gisId;grid.set({ajaxType:"get",url:Storage_list+"/"+c.gisId+"/static/"+c.StaticPointId+"/storage"});grid.load(b.data.param,function(){if(!isTriggerEdit){$("#add_one").css("cursor","not-allowed")}});b.logic.storage_type_list();b.logic.repository_type_list()},storage_type_list:function(){$.ajax({url:storage_type_url,type:"GET",async:true,dataType:"json",success:function(c){b.data.storage_type_dt=c},error:function(c){var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},repository_type_list:function(){$.ajax({url:repository_type_url,type:"GET",async:true,dataType:"json",success:function(c){b.data.repository_type_dt=c},error:function(c){var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},storage_type_text:function(f){var d=b.data.storage_type_dt;var g="";for(var c=0;c<d.length;c++){(function(e){if(e.key==f.row.storeType){g=e.value}})(d[c])}return g},repository_type_text:function(f){var d=b.data.repository_type_dt;var g="";for(var c=0;c<d.length;c++){(function(e){if(e.key==f.row.repoType){g=e.value}})(d[c])}return g},onActionRenderer:function(h){var d=h.sender;var c=h.record;var f=c._uid;var i=h.rowIndex;if(isTriggerEdit){var g='<a class="New_Button" href="javascript:page.logic.newRow()">新增</a> <a class="Edit_Button" href="javascript:page.logic.editRow(\''+f+'\')" >编辑</a> <a class="Delete_Button" href="javascript:page.logic.delRow(\''+f+"')\">删除</a>"}else{var g='<a class="New_Button input_useless" style="cursor:not-allowed;" href="javascript:;">新增</a> <a class="Edit_Button input_useless" style="cursor:not-allowed;" href="javascript:;" >编辑</a> <a class="Delete_Button input_useless" style="cursor:not-allowed;" href="javascript:;">删除</a>'}if(d.isEditingRow(c)){g='<a class="Update_Button" style="margin-right:10px;" href="javascript:page.logic.updateRow(\''+f+'\')">更新</a><a class="Cancel_Button" href="javascript:page.logic.cancelRow(\''+f+"')\">取消</a>"}return g},newRow:function(){if(!isTriggerEdit){var c=c||window.event;if(c.preventDefault){c.preventDefault()}else{c.returnValue=false}}var d={};grid.addRow(d,0);grid.cancelEdit();grid.beginEditRow(d)},editRow:function(c){var d=grid.getRowByUID(c);if(d){grid.cancelEdit();grid.beginEditRow(d)}},cancelRow:function(c){grid.reload()},delRow:function(d){var e=grid.getRowByUID(d);if(e){var c=e.staticPointId;if(confirm("确定删除此记录？")){grid.loading("删除中，请稍后......");$.ajax({url:ECS.api.gisPoint+"/"+gisId+"/static/"+c+"/storage",async:true,dataType:"text",timeout:1000,data:JSON.stringify([e.storagePointId]),contentType:"application/json;charset=utf-8",type:"DELETE",success:function(f){grid.reload()},error:function(){}})}}},updateRow:function(e){var d=new mini.Form("#datagrid");d.validate();if(d.isValid()==false){return}var k=grid.getRowByUID(e);var j=k.gisId;var g=k.staticPointId;grid.commitEdit();var f=grid.getChanges();grid.loading("保存中，请稍后......");var c="";var i="";var h={};h.storageName=k.storageName;h.storeType=k.storeType;h.repoType=k.repoType;if(g){c=Storage_list+"/"+gisId+"/static/"+k.staticPointId+"/storage/"+k.storagePointId+"?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;i="PUT";h.staticPointId=k.staticPointId;h.storagePointId=k.storagePointId}else{c=Storage_list+"/"+gisId+"/static/"+StaticPointId+"/storage?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;i="POST";h.staticPointId=StaticPointId}$.ajax({url:c,type:i,data:JSON.stringify(h),dataType:"text",contentType:"application/json;charset=utf-8",success:function(l){grid.reload()},error:function(l,n,m){}})},isClick:function(f){var c=f.record;var d=c._uid;if(f.row.storagePointId){return'<button class="btn btn-primary btn-sm" onclick="javascript:page.logic.GotoPage(\''+d+"')\">编辑</button>"}else{return'<button class="btn btn-primary btn-sm input_useless" style="border:#CCCCCC solid 1px;cursor:not-allowed;" onclick="javascript:;">编辑</button>'}},GotoPage:function(f){var h=grid.getRowByUID(f),e=gisId,c=h.staticPointId,d=h.storagePointId,g="应急物资列表";b.logic.detail(g,e,c,d)},detail:function(f,e,c,d){layer.open({type:2,closeBtn:0,area:["500px","450px"],skin:"new-class",shadeClose:false,title:false,content:"StaticMtrl.html?"+Math.random(),success:function(h,i){var g=layer.getChildFrame("body",i);var k=window[h.find("iframe")[0]["name"]];var j={gisId:e,StaticPointId:c,title:f,StorageId:d,isTriggerEdit:isTriggerEdit};k.page.logic.setData(j)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){b.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){b.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{}})}}};b.init();window.page=b});