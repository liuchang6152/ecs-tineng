var Team_list=ECS.api.gisPoint;var Team_type=ECS.api.rttUrl+"/team/getListByParam?param=teamType&isAll=true";var Team_lv=ECS.api.rttUrl+"/team/getListByParam?param=teamLvl";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var gisId="";var StaticPointId="";var grid=null;var isTriggerEdit=false;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){ECS.sys.RefreshContextFromSYS();mini.parse();grid=mini.get("datagrid");this.bindUI()},bindUI:function(){$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});document.oncontextmenu=new Function("return false")},data:{param:{},team_type_dt:{},team_level_dt:{}},logic:{setData:function(c){gisId=c.gisId;StaticPointId=c.StaticPointId;$("#title-main").text(c.title);isTriggerEdit=c.isTriggerEdit;b.data.param={};gisId=c.gisId;grid.set({ajaxType:"get",url:Team_list+"/"+c.gisId+"/static/"+c.StaticPointId+"/team"});grid.load(b.data.param,function(){if(!isTriggerEdit){$("#add_one").css("cursor","not-allowed")}});b.logic.Team_type_list();b.logic.Team_lv_list()},mobile_test:function(d){if(d.isValid){var c=/^1(3|4|5|7|8)\d{9}$/;if(c.test(d.value)){d.isValid=true}else{d.isValid=false}}},Team_type_list:function(){$.ajax({url:Team_type,type:"GET",async:true,dataType:"json",success:function(d){var e=[];for(var c=0;c<d.length;c++){if(d[c]["ID"]!=""){e.push(d[c])}}b.data.team_type_dt=e;e=null},error:function(c){var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},Team_lv_list:function(){$.ajax({url:Team_lv,type:"GET",async:true,dataType:"json",success:function(c){b.data.team_level_dt=c},error:function(c){var d=$.parseJSON(c.responseText);layer.msg(d.collection.error.message)}})},team_type_text:function(f){var d=b.data.team_type_dt;var g="";for(var c=0;c<d.length;c++){(function(e){if(e.ID==f.row.teamTypeId){g=e.NAME}})(d[c])}return g},team_lv_text:function(f){var g="",d=b.data.team_level_dt;for(var c=0;c<d.length;c++){(function(e){if(e.ID==f.row.teamLvlId){g=e.NAME}})(d[c])}return g},onActionRenderer:function(h){var d=h.sender;var c=h.record;var f=c._uid;var i=h.rowIndex;if(isTriggerEdit){var g='<a class="New_Button" href="javascript:page.logic.newRow()">新增</a> <a class="Edit_Button" href="javascript:page.logic.editRow(\''+f+'\')" >编辑</a> <a class="Delete_Button" href="javascript:page.logic.delRow(\''+f+"')\">删除</a>"}else{var g='<a class="New_Button input_useless"  style="cursor:not-allowed;" href="javascript:;">新增</a> <a class="Edit_Button input_useless"  style="cursor:not-allowed;" href="javascript:;" >编辑</a> <a class="Delete_Button input_useless" style="cursor:not-allowed;" href="javascript:;">删除</a>'}if(d.isEditingRow(c)){g='<a class="Update_Button" style="margin-right:10px;" href="javascript:page.logic.updateRow(\''+f+'\')">更新</a><a class="Cancel_Button" href="javascript:page.logic.cancelRow(\''+f+"')\">取消</a>"}return g},newRow:function(){if(!isTriggerEdit){var c=c||window.event;if(c.preventDefault){c.preventDefault()}else{c.returnValue=false}}var d={};grid.addRow(d,0);grid.cancelEdit();grid.beginEditRow(d)},editRow:function(c){var d=grid.getRowByUID(c);if(d){grid.cancelEdit();grid.beginEditRow(d)}},cancelRow:function(c){grid.reload()},delRow:function(c){var d=grid.getRowByUID(c);if(d){if(confirm("确定删除此记录？")){grid.loading("删除中，请稍后......");$.ajax({url:ECS.api.gisPoint+"/"+gisId+"/static/"+d.staticPointId+"/team",async:true,dataType:"text",timeout:1000,data:JSON.stringify([d.teamPointId]),contentType:"application/json;charset=utf-8",type:"DELETE",success:function(e){grid.reload()},error:function(){}})}}},updateRow:function(i){var d=new mini.Form("#datagrid");d.validate();if(d.isValid()==false){return}var j=grid.getRowByUID(i);var g=j.staticPointId;grid.commitEdit();var f=grid.getChanges();grid.loading("保存中，请稍后......");var c="";var h="";var e={};e.teamName=j.teamName;e.teamTypeId=j.teamTypeId;e.teamLvlId=j.teamLvlId;e.personCount=j.personCount;e.vehicleCount=j.vehicleCount;e.boatCount=j.boatCount;e.ownerName=j.ownerName;e.ownerContact=j.ownerContact;if(g){c=ECS.api.gisPoint+"/"+gisId+"/static/"+g+"/team/"+j.teamPointId+"?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;h="PUT";e.staticPointId=j.staticPointId;e.teamPointId=j.teamPointId}else{c=Team_list+"/"+gisId+"/static/"+StaticPointId+"/team?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;h="POST";e.staticPointId=StaticPointId}$.ajax({url:c,type:h,data:JSON.stringify(e),dataType:"text",contentType:"application/json;charset=utf-8",success:function(k){grid.reload()},error:function(k,m,l){}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)}}};b.init();window.page=b});