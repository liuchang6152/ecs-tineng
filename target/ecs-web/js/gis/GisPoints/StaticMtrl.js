var Storage_list=ECS.api.gisPoint;var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var gisId="";var StaticPointId="";var StorageId="";var isTriggerEdit=false;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();grid=mini.get("datagrid");this.bindUI()},bindUI:function(){$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});document.oncontextmenu=new Function("return false")},data:{param:{},aStatic_list:[{id:1,text:"消防栓"},{id:2,text:"消防站"},{id:3,text:"消防炮"},{id:4,text:"门口/出入口"},{id:5,text:"应急队伍点"},{id:6,text:"物资存放点"}],aType_list:{"1":"消防栓","2":"消防站","3":"消防炮","4":"门口/出入口","5":"应急队伍点","6":"物资存放点"}},logic:{setData:function(c){gisId=c.gisId;StaticPointId=c.StaticPointId;StorageId=c.StorageId;$("#title-main").text(c.title);isTriggerEdit=c.isTriggerEdit;b.data.param={};grid.set({ajaxType:"get",url:Storage_list+"/"+c.gisId+"/static/"+c.StaticPointId+"/storage/"+c.StorageId+"/mtrl"});grid.load(b.data.param,function(){if(!isTriggerEdit){$("#add_one").css("cursor","not-allowed")}})},gispointtype:function(c){return b.data.aType_list[c.row.pointType]},onActionRenderer:function(h){var d=h.sender;var c=h.record;var f=c._uid;var i=h.rowIndex;if(isTriggerEdit){var g='<a class="New_Button" href="javascript:page.logic.newRow()">新增</a> <a class="Edit_Button" href="javascript:page.logic.editRow(\''+f+'\')" >编辑</a> <a class="Delete_Button" href="javascript:page.logic.delRow(\''+f+"')\">删除</a>"}else{var g='<a class="New_Button input_useless" style="cursor:not-allowed;" href="javascript:;">新增</a> <a class="Edit_Button input_useless" style="cursor:not-allowed;" href="javascript:;" >编辑</a> <a class="Delete_Button input_useless" style="cursor:not-allowed;" href="javascript:;">删除</a>'}if(d.isEditingRow(c)){g='<a class="Update_Button" style="margin-right:10px;" href="javascript:page.logic.updateRow(\''+f+'\')">更新</a><a class="Cancel_Button" href="javascript:page.logic.cancelRow(\''+f+"')\">取消</a>"}return g},newRow:function(){if(!isTriggerEdit){var c=c||window.event;if(c.preventDefault){c.preventDefault()}else{c.returnValue=false}}var d={};grid.addRow(d,0);grid.cancelEdit();grid.beginEditRow(d)},editRow:function(c){var d=grid.getRowByUID(c);if(d){grid.cancelEdit();grid.beginEditRow(d)}},cancelRow:function(c){grid.reload()},delRow:function(c){var d=grid.getRowByUID(c);if(d){if(confirm("确定删除此记录？")){grid.loading("删除中，请稍后......");$.ajax({url:Storage_list+"/"+gisId+"/static/"+StaticPointId+"/storage/"+StorageId+"/mtrl",async:true,dataType:"text",timeout:1000,data:JSON.stringify([d.staticMtrlId]),contentType:"application/json;charset=utf-8",type:"DELETE",success:function(e){grid.reload()},error:function(){}})}}},updateRow:function(i){var e=new mini.Form("#datagrid");e.validate();if(e.isValid()==false){return}var j=grid.getRowByUID(i);var c=j.staticMtrlId;grid.commitEdit();var g=grid.getChanges();grid.loading("保存中，请稍后......");var d="";var h="";var f={};f.storagePointId=StorageId;f.mtrlName=j.mtrlName;f.mtrlAmount=j.mtrlAmount;f.mesUnit=j.mesUnit;f.ownerName=j.ownerName;f.ownerContact=j.ownerContact;if(c){d=Storage_list+"/"+gisId+"/static/"+StaticPointId+"/storage/"+StorageId+"/mtrl/"+j.staticMtrlId+"?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;h="PUT";f.staticMtrlId=j.staticMtrlId}else{d=Storage_list+"/"+gisId+"/static/"+StaticPointId+"/storage/"+StorageId+"/mtrl?enterprise="+ECS.sys.Context.SYS_ENTERPRISE_CODE;h="POST"}$.ajax({url:d,type:h,data:JSON.stringify(f),dataType:"text",contentType:"application/json;charset=utf-8",success:function(k){grid.reload()},error:function(k,m,l){}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{}})}}};b.init();window.page=b});