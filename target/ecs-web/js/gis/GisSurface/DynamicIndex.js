var searchUrl=ECS.api.gisSurfaceUrl+"/surface";var gisId=-1;var typeCode=0;var state=0;window.pageLoadMode=PageLoadMode.None;var enterpriseCode="";$(function(){var page={init:function(){mini.parse();var strfun=page.logic.getQueryString("url");ECS.sys.RefreshContextFromSYS();enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;if(strfun!=null){eval(strfun)}else{document.oncontextmenu=new Function("return false")}},table:{},bindUI:function(){$("#searchForm")[0].reset();$("input").keyup(function(){$(this).val($.trim($(this).val()))});$("#btnQuery").click(function(){page.logic.search()});grid=mini.get("datagrid");grid2=mini.get("datagrid2");grid.on("select",function(e){page.logic.adds();var row=e.record;var data=grid2.getData();var querResult=JSLINQ(data).Where(function(x){return x.gisSurfaceForID!=row.gisSurfaceForID}).ToArray();if(querResult.length>0){grid2.removeRows(querResult,true)}});grid2.on("rowclick",function(e){var row=e.record;if(state==0){var arrGisSurfaceIds=row.arrGisSurfaceIds;if(arrGisSurfaceIds!=null){var strGisSurfaceIds=arrGisSurfaceIds.join(",");var url="getArrGisSurfaceIds('"+arrGisSurfaceIds+"')";window.parent.postMessage(url,"*")}}});$("#isSelect").click(function(){var ischecked=$(this).prop("checked");$("#btnQuery").off();if(ischecked){$("#datagrid").hide();$("#datagrid2").show();if(state==1){$("#btnQuery").attr("disabled",true)}else{$("#btnQuery").attr("disabled",false);$("#btnQuery").click(page.logic.search)}page.logic.setGrid2Selecteds();page.logic.setGrid2Height()}else{$("#datagrid").show();$("#datagrid2").hide();$("#btnQuery").attr("disabled",false);$("#btnQuery").click(page.logic.search);page.logic.setGridSelecteds();page.logic.setGridHeight()}})},data:{param:{}},logic:{initTable:function(){mini.parse();grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"})},initTable2:function(gisSurfaceId){mini.parse();grid2=mini.get("datagrid2");var grid2Url=page.logic.getDatagrid2RUL(gisSurfaceId);grid2.set({url:grid2Url,ajaxType:"get",dataField:"pageList"})},search:function(){grid=mini.get("datagrid");grid2=mini.get("datagrid2");page.data.param=ECS.form.getData("searchForm");page.data.param.enterprise=enterpriseCode;grid2.load(page.data.param,function(data){if(state==0){grid2.clearSelect(true)}});page.data.param.type=typeCode;grid.load(page.data.param,function(data){if(state==1){page.logic.setGridSelecteds()}})},getDatagrid2RUL:function(gisSurfaceId){var datagrid2URL;switch(typeCode){case 2:datagrid2URL=searchUrl+"/"+gisSurfaceId+"/org/"+2;break;case 3:datagrid2URL=searchUrl+"/"+gisSurfaceId+"/org/"+3;break;case 4:datagrid2URL=searchUrl+"/"+gisSurfaceId+"/riskarea";break;case 5:datagrid2URL=searchUrl+"/"+gisSurfaceId+"/optlriskarea";break;case 15:datagrid2URL=searchUrl+"/"+gisSurfaceId+"/medicalAddress";break;default:datagrid2URL=searchUrl+"/"+gisSurfaceId+"/org/"+0;break}return datagrid2URL},adds:function(){var ischecked=$("#isSelect").prop("checked");if(!ischecked){grid=mini.get("datagrid");var items=grid.getSelecteds();page.logic.doAddItems(items)}},doAddItems:function(items){items=mini.clone(items);for(var i=items.length-1;i>=0;i--){var item=items[i];var item2=grid2.findRow(function(row){if(row.gisSurfaceForID==item.gisSurfaceForID){return true}});if(item2){items.removeAt(i)}}grid2.addRows(items);grid2.selects(items)},getSave2RUL:function(gisSurfaceId,typeValueCode){var save2URL;if(typeValueCode!=0&&typeValueCode!=null){switch(typeValueCode){case 2:save2URL=searchUrl+"/"+gisSurfaceId+"/org/"+2+"?enterprise="+enterpriseCode;break;case 3:save2URL=searchUrl+"/"+gisSurfaceId+"/org/"+3+"?enterprise="+enterpriseCode;break;case 4:save2URL=searchUrl+"/"+gisSurfaceId+"/riskarea?enterprise="+enterpriseCode;break;case 5:save2URL=searchUrl+"/"+gisSurfaceId+"/optlriskarea?enterprise="+enterpriseCode;break;case 15:save2URL=searchUrl+"/"+gisSurfaceId+"/medicalAddress?enterprise="+enterpriseCode;break}}return save2URL},getDeleteRUL:function(gisSurfaceId,typeValueCode){var save2URL;if(typeValueCode!=0&&typeValueCode!=null){switch(typeValueCode){case 2:save2URL=searchUrl+"/"+gisSurfaceId+"/org";break;case 3:save2URL=searchUrl+"/"+gisSurfaceId+"/org";break;case 4:save2URL=searchUrl+"/"+gisSurfaceId+"/riskarea";break;case 5:save2URL=searchUrl+"/"+gisSurfaceId+"/optlriskarea";break;case 15:save2URL=searchUrl+"/"+gisSurfaceId+"/medicalAddress";break}}return save2URL},setGridSelecteds:function(){grid=mini.get("datagrid");grid2=mini.get("datagrid2");var data=grid2.getData();var ischecked=$("#isSelect").prop("checked");if(!ischecked){var rows=grid.findRows(function(row){var querResult=JSLINQ(data).Where(function(x){return x.gisSurfaceForID==row.gisSurfaceForID}).ToArray();if(querResult.length>0){return true}else{return false}});grid.selects(rows)}},setGrid2Selecteds:function(){grid2=mini.get("datagrid2");var data=grid2.getData();var rows=grid2.findRows(function(row){var querResult=JSLINQ(data).Where(function(x){return x.gisSurfaceForID==row.gisSurfaceForID}).ToArray();if(row.surfaceID==gisId||querResult.length>0){return true}else{return false}});grid2.selects(rows)},setGridHeight:function(){grid=mini.get("datagrid");var searchHeight=document.getElementById("searchForm").offsetHeight;var winHeight=document.documentElement.clientHeight;grid.setHeight(winHeight-searchHeight-30)},setGrid2Height:function(){grid2=mini.get("datagrid2");var searchHeight=document.getElementById("searchForm").offsetHeight;var winHeight=document.documentElement.clientHeight;grid2.setHeight(winHeight-searchHeight-30)},typeClickLoad:function(typeCodeValue,stateValue){mini.parse();typeCode=typeCodeValue;state=stateValue;gisId=-1;selectIndex=0;grid=mini.get("datagrid");grid2=mini.get("datagrid2");grid2.commitEdit();if(typeCode!=0){page.bindUI();$("#datagrid").hide();$("#datagrid2").show();page.logic.initTable();page.logic.initTable2(gisId);page.logic.search();$("#isSelect").prop("checked",true);grid.clearSelect(true);grid2.clearSelect(true);page.logic.setGrid2Height()}if(state==0){$("#isSelect").prop("disabled",true);grid2.allowCellEdit=false}else{$("#isSelect").prop("disabled",false);grid2.allowCellEdit=true}},gisSurfaceClickLoad:function(typeCodeValue,gisValueId,stateValue){typeCode=typeCodeValue;gisId=gisValueId;state=stateValue;selectIndex=0;grid=mini.get("datagrid");grid2=mini.get("datagrid2");grid2.commitEdit();if(typeCode!=0&&gisId!=0){$("#datagrid").hide();$("#datagrid2").show();$("#isSelect").attr("checked","checked");grid.clearSelect(true);grid2.selectAll(false);page.logic.initTable();page.logic.initTable2(gisId);page.logic.search();page.logic.setGrid2Height()}$("#btnQuery").off();if(state==0){$("#isSelect").prop("disabled",true);$("#btnQuery").attr("disabled",false);$("#btnQuery").click(page.logic.search);grid2.allowCellEdit=false}else{$("#isSelect").prop("disabled",false);$("#btnQuery").attr("disabled",true);grid2.allowCellEdit=true}},deletes:function(typeCodeValue,gisValueId){typeCode=typeCodeValue;gisId=gisValueId;if(typeCode!=0&&gisId!=0){var deleteUrl=page.logic.getSave2RUL(gisId,typeCode);$.ajax({url:deleteUrl,async:true,dataType:"text",timeout:1000,contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){ECS.showLoading()},success:function(result){ECS.hideLoading();if(result.indexOf("删除成功")>-1){gisId=-1;return true}else{return false}},error:function(result){ECS.hideLoading();return false}})}else{layer.msg("请选择要删除的gis面数据!");return false}},save:function(typeCodeValue,gisValueId){grid2=mini.get("datagrid2");grid2.commitEdit();typeCode=typeCodeValue;gisId=gisValueId;var data=grid2.getSelecteds();if(data.length!=0){if(!$("#isSelect").attr("checked")){layer.msg("您未选择“已勾选”，请先勾选！",{time:1000});var url="isSave(-1,'"+data[0].name+"')";console.log(url);window.parent.postMessage(url,"*");return false}else{var url="isSave(1,'"+data[0].name+"')";console.log(url);window.parent.postMessage(url,"*")}}else{layer.msg("保存失败，请选择关联数据！");return false}grid2.commitEdit();if(typeCode>0&&gisId>0){var jsonArr=[];if(typeCode=="2"){for(var i=0;i<data.length;i++){var json={};json.surfaceID=gisId;json.gisSurfaceForID=data[i].gisSurfaceForID;json.orgLvl=2;json.info=data[i].inf4o;jsonArr.push(json)}}else{if(typeCode=="3"){for(var i=0;i<data.length;i++){var json={};json.surfaceID=gisId;json.gisSurfaceForID=data[i].gisSurfaceForID;json.orgLvl=3;json.info=data[i].info;jsonArr.push(json)}}else{for(var i=0;i<data.length;i++){var json={};json.surfaceID=gisId;json.gisSurfaceForID=data[i].gisSurfaceForID;json.orgLvl=0;json.info=data[i].info;jsonArr.push(json)}}}var addUrl=page.logic.getSave2RUL(gisId,typeCode);var ajaxType="POST";$.ajax({url:addUrl,type:ajaxType,data:JSON.stringify(jsonArr),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){ECS.showLoading()},success:function(result){ECS.hideLoading();if(result.indexOf("保存成功")>-1){gisId=-1;return true}else{return false}},error:function(result){ECS.hideLoading();return false}})}else{return false}},getQueryString:function(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=window.location.search.substr(1).match(reg);if(r!=null){return unescape(r[2])}return null}}};page.init();window.page=page});