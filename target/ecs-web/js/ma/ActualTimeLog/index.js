var searchUrl=ECS.api.maUrl+"/alertsLog";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var drtDeptCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=3&isAll=true";var riskAreaName_url=ECS.api.maUrl+"/alertsLog/getListByParam?param=RISK_AREA_NAME";var optlRiskZoneName_url=ECS.api.maUrl+"/alertsLog/getListByParam?param=OPTL_RISK_ZONE_NAME";var riskAnlsobjName_url=ECS.api.maUrl+"/alertsLog/getListByParam?param=RISK_ANLS_OBJ_NAME";var rapName_url=ECS.api.maUrl+"/alertsLog/getListByParam?param=RAP_NAME";var siteName_url=ECS.api.maUrl+"/alertsLog/getListByParam?param=SITE_NAME";var direction_url=ECS.api.maUrl+"/alertsLog/getLogDirectionEnumList";var inUseUrl=ECS.api.commonUrl+"/getInUse";var exportUrl=ECS.api.maUrl+"/alertsLog/ExportToExcel";window.pageLoadMode=PageLoadMode.None;var flag=false;var enterpriseLink="";var deptLink="";var riskAreaLink="";var optlRiskZoneLink="";var riskAnlsObjLink="";var rapLink="";$(function(){var a={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();this.bindUI();$("#searchForms").find("input").val("");a.logic.initTable();a.logic.cbxDrtDept();a.logic.cbxDrtDeptCode();a.logic.cbxRiskAreaName();a.logic.cbxOptlRiskZoneName();a.logic.cbxRiskAnlsobjName();a.logic.cbxRapName();a.logic.cbxSiteName();a.logic.initLogDirection();a.logic.initInFire();a.logic.search("")},table:{},bindUI:function(){var d=new Date();var c=d.getFullYear()+"-"+((d.getMonth()+1)<10?"0":"")+(d.getMonth()+1)+"-"+(d.getDate()<10?"0":"")+d.getDate();var b=d.getFullYear()+"-"+((d.getMonth()+1)<10?"0":"")+(d.getMonth()+1)+"-"+(d.getDate()<10?"0":"")+d.getDate();mini.get("alertsLogStartTime").setValue(b);mini.get("alertsLogEndTime").setValue(c);$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnToggle").click(function(){if(flag){flag=!flag;$(this).html('<i class="icon-showMore"></i>');$(".search-unfixed").hide()}else{flag=!flag;$(this).html('<i class="icon-hideMore"></i>');$(".search-unfixed").show()}});$("#btnQuery").click(function(){a.logic.search()});mini.get("alertsLogStartTime").on("valuechanged",function(){var e=new Date($("input[name=alertsLogStartTime]").val().replace(/\-/g,"/"));var f=new Date($("input[name=alertsLogEndTime]").val().replace(/\-/g,"/"));if(e>f){mini.get("alertsLogStartTime").setValue(b);layer.msg("开始束时间需早于结束时间！");return false}});mini.get("alertsLogEndTime").on("valuechanged",function(){var e=new Date($("input[name=alertsLogStartTime]").val().replace(/\-/g,"/"));var f=new Date($("input[name=alertsLogEndTime]").val().replace(/\-/g,"/"));if(e>f){mini.get("alertsLogEndTime").setValue(c);layer.msg("结束时间需晚于开始时间！");return false}});$("#btnExport").click(function(){window.open(exportUrl)})},data:{param:{}},logic:{initTable:function(){mini.parse();grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"})},show_details:function(b){return'<a title="查看相关数据" href="javascript:window.page.logic.edit('+b.row.alertsLogID+')">查看相关数据</a>'},edit:function(b){var c=PageModelEnum.Edit;var d="报警日志相关数据";a.logic.detail(d,b,c)},detail:function(e,c,d,b){layer.open({type:2,closeBtn:0,area:["850px","500px"],skin:"new-class",shadeClose:false,title:false,content:"ActualTimeLogInfo.html?"+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var j=window[g.find("iframe")[0]["name"]];var i={pageMode:d,alertsLogID:c,title:e,orgId:b};j.page.logic.setData(i)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},onDrawDate:function(c){var b=c.date;var f=new Date();if(b>f){c.allowSelect=false}},cbxDrtDept:function(){if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){$("#orgName").attr("disabled",false);ECS.ui.getCombobox("orgName",riskAreaTypeNameUrl,{selectFirstRecord:true,keyField:"orgCode",codeField:"orgId",valueField:"orgSname",valueSField:"orgSname",async:false},null,a.logic.cbxDrtDeptCode)}else{$("#orgName").attr("disabled",true);ECS.ui.getCombobox("orgName",riskAreaTypeNameUrl,{selectValue:ECS.sys.Context.SYS_ENTERPRISE_CODE,keyField:"orgCode",codeField:"orgId",valueField:"orgSname",valueSField:"orgSname",async:false},null,a.logic.cbxDrtDeptCode)}},cbxDrtDeptCode:function(){$("#riskAreaName").attr("disabled",true);$("#riskAreaName option:first").prop("selected","selected");$("#optlRiskZoneName").attr("disabled",true);$("#optlRiskZoneName option:first").prop("selected","selected");$("#riskAnlsobjName").attr("disabled",true);$("#riskAnlsobjName option:first").prop("selected","selected");$("#rapName").attr("disabled",true);$("#rapName option:first").prop("selected","selected");$("#siteName").attr("disabled",true);$("#siteName option:first").prop("selected","selected");deptLink=$("#orgNameLvl2").find("option:selected").text();var b=$("#orgName").find("option:selected").attr("code");enterpriseLink=$("#orgName").find("option:selected").text();if(b=="-1"){b=""}ECS.ui.getCombobox("orgNameLvl2",drtDeptCodeUrl,{selectValue:"-1",keyField:"orgId",valueField:"orgSname",async:false,data:{orgPID:b}},null,a.logic.cbxRiskAreaName)},cbxRiskAreaName:function(){$("#optlRiskZoneName").attr("disabled",true);$("#optlRiskZoneName option:first").prop("selected","selected");$("#riskAnlsobjName").attr("disabled",true);$("#riskAnlsobjName option:first").prop("selected","selected");$("#rapName").attr("disabled",true);$("#rapName option:first").prop("selected","selected");$("#siteName").attr("disabled",true);$("#siteName option:first").prop("selected","selected");deptLink=$("#orgNameLvl2").find("option:selected").text();if(deptLink=="全部"){$("#riskAreaName").attr("disabled",true)}else{$("#riskAreaName").attr("disabled",false)}ECS.ui.getCombobox("riskAreaName",riskAreaName_url,{selectValue:"全部",keyField:"RISK_AREA_NAME",valueField:"RISK_AREA_NAME",async:false,data:{enterprise:enterpriseLink,dept:deptLink,isAll:true}},null,a.logic.cbxOptlRiskZoneName)},cbxOptlRiskZoneName:function(){$("#riskAnlsobjName").attr("disabled",true);$("#riskAnlsobjName option:first").prop("selected","selected");$("#rapName").attr("disabled",true);$("#rapName option:first").prop("selected","selected");$("#siteName").attr("disabled",true);$("#siteName option:first").prop("selected","selected");riskAreaLink=$("#riskAreaName").find("option:selected").text();if(riskAreaLink=="全部"){$("#optlRiskZoneName").attr("disabled",true)}else{$("#optlRiskZoneName").attr("disabled",false)}ECS.ui.getCombobox("optlRiskZoneName",optlRiskZoneName_url,{selectValue:"全部",keyField:"OPTL_RISK_ZONE_NAME",valueField:"OPTL_RISK_ZONE_NAME",async:false,data:{enterprise:enterpriseLink,dept:deptLink,riskArea:riskAreaLink,isAll:true}},null,a.logic.cbxRiskAnlsobjName)},cbxRiskAnlsobjName:function(){$("#rapName").attr("disabled",true);$("#rapName option:first").prop("selected","selected");$("#siteName").attr("disabled",true);$("#siteName option:first").prop("selected","selected");optlRiskZoneLink=$("#optlRiskZoneName").find("option:selected").text();if(optlRiskZoneLink=="全部"){$("#riskAnlsobjName").attr("disabled",true)}else{$("#riskAnlsobjName").attr("disabled",false)}ECS.ui.getCombobox("riskAnlsobjName",riskAnlsobjName_url,{selectValue:"全部",keyField:"RISK_ANLS_OBJ_NAME",valueField:"RISK_ANLS_OBJ_NAME",async:false,data:{enterprise:enterpriseLink,dept:deptLink,riskArea:riskAreaLink,optlRiskZone:optlRiskZoneLink,isAll:true}},null,a.logic.cbxRapName)},cbxRapName:function(){$("#siteName").attr("disabled",true);$("#siteName option:first").prop("selected","selected");riskAnlsObjLink=$("#riskAnlsobjName").find("option:selected").text();if(riskAnlsObjLink=="全部"){$("#rapName").attr("disabled",true)}else{$("#rapName").attr("disabled",false)}ECS.ui.getCombobox("rapName",rapName_url,{selectValue:"全部",keyField:"RAP_NAME",valueField:"RAP_NAME",async:false,data:{enterprise:enterpriseLink,dept:deptLink,riskArea:riskAreaLink,optlRiskZone:optlRiskZoneLink,riskAnlsObj:riskAnlsObjLink,isAll:true}},null,a.logic.cbxSiteName)},cbxSiteName:function(){rapLink=$("#rapName").find("option:selected").text();if(rapLink=="全部"){$("#siteName").attr("disabled",true)}else{$("#siteName").attr("disabled",false)}ECS.ui.getCombobox("siteName",siteName_url,{selectValue:"全部",keyField:"SITE_NAME",valueField:"SITE_NAME",data:{enterprise:enterpriseLink,dept:deptLink,riskArea:riskAreaLink,optlRiskZone:optlRiskZoneLink,riskAnlsObj:riskAnlsObjLink,rap:rapLink,isAll:true}})},initInFire:function(){ECS.ui.getCombobox("isFireAlarm",inUseUrl,{selectValue:-1,data:{isAll:true}},null)},initLogDirection:function(){ECS.ui.getCombobox("alertsLogDirection",direction_url,{selectValue:"",data:{isAll:true}},null)},search:function(b){a.data.param=ECS.form.getData("searchForms");if(a.data.param.isFireAlarm=="-1"){a.data.param.isFireAlarm=""}console.log(ECS.util.timestampToTimes(mini.get("alertsLogEndTime").getValue()));if(isNaN(ECS.util.timestampToTimes(mini.get("alertsLogStartTime").getValue()))){a.data.param.alertsLogStartTime=""}else{a.data.param.alertsLogStartTime=ECS.util.timestampToTimes(mini.get("alertsLogStartTime").getValue())}if(isNaN(ECS.util.timestampToTimes(mini.get("alertsLogEndTime").getValue()))){a.data.param.alertsLogEndTime=""}else{a.data.param.alertsLogEndTime=ECS.util.timestampToTimes(mini.get("alertsLogEndTime").getValue())}a.data.param.orgName=$("#orgName").find("option:selected").attr("values");a.data.param.orgNameLvl2=$("#orgNameLvl2").find("option:selected").attr("title");if(a.data.param.isFireAlarm=="全部"){a.data.param.isFireAlarm=""}if(a.data.param.alertsLogMaxLvl=="全部"){a.data.param.alertsLogMaxLvl=""}if(a.data.param.alertsLogDirection=="全部"){a.data.param.alertsLogDirection=""}if(b){a.data.param.sortType=1}grid.load(a.data.param)}}};a.init();window.page=a});