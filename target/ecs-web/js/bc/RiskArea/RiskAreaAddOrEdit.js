var addUrl=ECS.api.bcUrl+"/riskArea";var getSingleUrl=ECS.api.bcUrl+"/riskArea";var riskType_url=ECS.api.bcUrl+"/riskArea/getRiskAreaEnumList";var riskType_url2=ECS.api.bcUrl+"/riskArea/getCategObj";var riskorg_url=ECS.api.bcUrl+"/org/porgName";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var editUserName=[];var usernameList=[];var userIDList=[];var cate_dt={};var categID="";var code="";var enterpriseCode="";var drtDeptCode="";var drtDeptPID="";$(function(){var a=parent.layer.getFrameIndex(window.name);console.log(ECS.api.bcUrl+"/riskArea/getRiskAreaCode");var b={init:function(){mini.parse();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI()},bindUI:function(){$.ajax({url:ECS.api.bcUrl+"/riskArea/getRiskAreaCode",async:false,type:"GET",data:"",dataType:"text",contentType:"application/json;charset=utf-8",success:function(c){console.log(c);$("#riskAreaCode").val(c)},error:function(c){layer.msg("请联系后台管理员！")}});$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});mini.get("enterpriseCode").on("nodeclick",function(c){$("input[name=enterpriseCode]").next(".has-error").remove();b.logic.get_list(riskorg_url,$("#drtDeptCode"),c.node.orgId);enterpriseCode=c.node.orgCode;editUserName=[];$("#userName").html("");$("#userID").val("")});mini.get("drtDeptCode").on("nodeclick",function(c){$("input[name=drtDeptCode]").next(".has-error").remove()});mini.get("riskAreaCatgName").on("nodeclick",function(c){$("input[name=riskAreaCatgName]").next(".has-error").remove()});$("#selectOwner").click(function(){b.logic.selectOwner("人员选择(多选)",PageModelEnum.Details)})},logic:{save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var f=ECS.form.getData("AddOrEditModal");var e=mini.get("riskAreaCatgName").getCheckedNodes(true);if(e.length>0){for(var d=0;d<e.length;d++){(function(h){if(h.categID.indexOf("sm")!=-1){f.areaSmCatg=h.code}if(h.categID.indexOf("md")!=-1){f.areaMdCatg=h.code}if(h.categID.indexOf("bg")!=-1){f.areaBgCatg=h.code}})(e[d])}}else{if(pageMode==PageModelEnum.Edit){f.areaBgCatg=cate_dt.areaBgCatg;f.areaMdCatg=cate_dt.areaMdCatg;f.areaSmCatg=cate_dt.areaSmCatg}if(pageMode==PageModelEnum.NewAdd){if(categID.indexOf("sm")!=-1){f.areaSmCatg=code}if(categID.indexOf("md")!=-1){f.areaMdCatg=code}if(categID.indexOf("bg")!=-1){f.areaBgCatg=code}}}if(mini.get("drtDeptCode").getSelectedNode()){f.drtDeptPID=mini.get("drtDeptCode").getSelectedNode().orgPID;f.drtDeptCode=mini.get("drtDeptCode").getSelectedNode().orgCode}else{f.drtDeptPID=drtDeptPID;f.drtDeptCode=drtDeptCode}f.enterpriseCode=enterpriseCode;if(f.userID){var c=[];for(var d=0;d<f.userID.split(",").length;d++){c.push({userID:f.userID.split(",")[d]})}f.userEntity=c}delete f.userID;delete f.userName;delete f.riskAreaCatgName;var g="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){g="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:g,data:JSON.stringify(f),dataType:"text",contentType:"application/json;charset=utf-8",success:function(h){if(h.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(h.collection.error.message)}},error:function(h){var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;ECS.sys.RefreshContextFromSYS();if(pageMode==PageModelEnum.NewAdd){$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);b.logic.select_option(riskType_url,$("#riskAreaCatg"),function(){b.logic.load_riskAreaCate()});b.logic.get_list(riskorg_url,$("#enterpriseCode"),"",function(){});$("#riskAreaCatg").change(function(){b.logic.load_riskAreaCate()});return}mini.get("enterpriseCode").disable();mini.get("drtDeptCode").disable();$("#riskAreaCatg").attr("disabled","disabled");$("#riskAreaCatg").addClass("input_useless");mini.get("riskAreaCatgName").disable();$("#riskAreaCode").attr("disabled","disabled");$("#riskAreaCode").addClass("input_useless");$.ajax({url:getSingleUrl+"/"+c.riskAreaID+"?now="+Math.random(),type:"get",async:true,dataType:"json",success:function(e){ECS.form.setData("AddOrEditModal",e);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);mini.get("enterpriseCode").setValue(e.orgSname);enterpriseCode=e.enterpriseCode;mini.get("drtDeptCode").setValue(e.drtDeptSname);drtDeptCode=e.drtDeptCode;if(e.drtDeptPID){drtDeptPID=e.drtDeptPID}b.logic.select_option(riskType_url,$("#riskAreaCatg"),function(){$("#riskAreaCatg").val(e.riskAreaCatg)});if(e.bgCategName&&e.mdCategName&&e.smCategName){mini.get("riskAreaCatgName").setValue(e.bgCategName+","+e.mdCategName+","+e.smCategName)}else{if(e.bgCategName&&e.mdCategName){mini.get("riskAreaCatgName").setValue(e.bgCategName+","+e.mdCategName)}else{if(e.bgCategName){mini.get("riskAreaCatgName").setValue(e.bgCategName)}}}cate_dt.areaBgCatg=e.areaBgCatg;cate_dt.areaMdCatg=e.areaMdCatg;cate_dt.areaSmCatg=e.areaSmCatg;editUserName=[];usernameList=[];userIDList=[];if(e.userEntity){for(var d=0;d<e.userEntity.length;d++){usernameList+=e.userEntity[d].userName+"<br/>";userIDList.push(e.userEntity[d].userID);editUserName.push(e.userEntity[d].userName)}$("#userName").html(usernameList);$("#userID").val(userIDList)}mini.get("sortNum").setValue(e.sortNum);$("#inUse").iCheck("update")},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},selectOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"../RiskAnalysisPoint/SelectOwner.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,userId:$("#userID").val(),orgCode:enterpriseCode,userName:editUserName};i.page.logic.setData(h)},end:function(){editUserName=[];usernameList=[];userIDList=[];for(var f in window.ownDetail){usernameList+=window.ownDetail[f]+"<br/>"}for(var e in window.ownDetail){editUserName.push(window.ownDetail[e])}for(var e in window.ownDetail){userIDList.push(e)}$("#userName").html(usernameList);$("#userID").val(userIDList)}})},get_list:function(d,g,f,c){if(f){var e=d+"?orgPID="+f+"&orgLvl=3"}else{var e=d+"?orgLvl=2"}$.ajax({url:e,type:"GET",success:function(i){if(f){mini.get("drtDeptCode").loadList(i,"orgId","orgPID");if(i.length>0){if(i[0].orgPID){for(var h=0;h<i.length;h++){if(i[h].orgId==i[0].orgPID){mini.get("drtDeptCode").setValue(i[h].orgSname);drtDeptCode=i[h].orgCode}}drtDeptPID=i[0].orgPID}else{mini.get("drtDeptCode").setValue(i[0].orgSname);drtDeptCode=i[0].orgCode}}c&&c()}else{mini.get("enterpriseCode").loadList(i,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname);b.logic.get_list(riskorg_url,$("#drtDeptCode"),mini.get("enterpriseCode").data[0].orgId)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var h=0;h<i.length;h++){(function(j){if(j.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(j.orgSname);b.logic.get_list(riskorg_url,$("#drtDeptCode"),j.orgId)}})(i[h])}}c&&c()}}})},load_riskAreaCate:function(){b.logic.select_option(riskType_url2+"?riskAreaCatg="+$("#riskAreaCatg").val(),$("#riskAreaCatgName"),"xx")},select_option:function(d,e,c){$.ajax({url:d,type:"GET",success:function(g){if(c&&typeof c!="function"){mini.get("riskAreaCatgName").loadList(g,"categID","gcategID");if(g[0]){categID=g[0].categID;code=g[0].code}}else{for(var f=0;f<g.length;f++){(function(i){if(i.key){var h=$('<option value="'+i.key+'">'+i.value+"</option>")}$(e).append(h)})(g[f])}$("#riskAreaCatg").val("S");c&&c()}}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){jQuery.validator.addMethod("ucode",function(d,c,f){var e=new RegExp(f);return e.test(d)},"只能输入字母和数字!");ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{enterpriseCode:{required:true,rangelength:[0,200]},drtDeptCode:{required:true,rangelength:[0,200]},riskAreaCatg:{required:true,rangelength:[0,200]},riskAreaCatgName:{required:true,rangelength:[0,200]},riskAreaName:{required:true,rangelength:[0,200]},riskAreaSName:{required:true,rangelength:[0,200]},riskAreaCode:{required:true,rangelength:[0,200],ucode:/^[A-Za-z0-9]+$/},sortNum:{required:true,digits:true,min:0}}})}}};b.init();window.page=b});