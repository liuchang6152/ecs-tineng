var addUrl=ECS.api.bcUrl+"/riskAnlsObj";var getSingleUrl=ECS.api.bcUrl+"/riskAnlsObj";var riskorg_url=ECS.api.bcUrl+"/org/porgName";var orgType_url=ECS.api.bcUrl+"/org/porgName";var riskType_url=ECS.api.bcUrl+"/riskArea/getRiskAreaEnumList";var riskType_url2=ECS.api.bcUrl+"/riskArea/getCategObj?showPleaseSelect=true";var riskAreaName_url=ECS.api.bcUrl+"/riskArea/getAllList";var oprisktype_url=ECS.api.bcUrl+"/optlRiskZone/getOptlZoneCatgEnumList?showPleaseSelect=true";var oprisk_url=ECS.api.bcUrl+"/optlRiskZone/getAllList";var RiskAnlsObj_url=ECS.api.bcUrl+"/riskAnlsObj/getRiskObjCatgEnumList";var drtDeptPID="";var enterpriseCode="";var drtDeptCode="";var riskAreaID="";var optlRiskZoneID="";var editUserName=[];var usernameList=[];var userIDList=[];var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var cate_dt={};$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});mini.get("enterpriseCode").on("nodeclick",function(c){enterpriseCode=c.node.orgCode;editUserName=[];$("#userName").html("");$("#userID").val("");$("input[name=enterpriseCode]").next(".has-error").remove();b.logic.get_list(riskorg_url,$("#drtDeptCode"),c.node.orgId)});mini.get("drtDeptCode").on("nodeclick",function(c){drtDeptCode=c.node.orgCode;$("input[name=drtDeptCode]").next(".has-error").remove();b.logic.load_risk_menu("")});mini.get("riskAreaCatgName").on("valuechanged",function(){$("input[name=riskAreaCatgName]").next(".has-error").remove();b.logic.load_risk_menu("")});mini.get("riskAreaID").on("valuechanged",function(c){if(c.value==""||c.value=="-1"){mini.get("riskAreaID").setValue("-1");riskAreaID=""}else{riskAreaID=c.selected.riskAreaID}$("input[name=riskAreaID]").next(".has-error").remove();b.logic.load_optrisk_menu("")});$("#zoneCatg").change(function(){b.logic.load_optrisk_menu("")});mini.get("optlRiskName").on("valuechanged",function(c){if(c.value==""||c.value=="-1"){mini.get("optlRiskName").setValue("-1");optlRiskZoneID=""}else{optlRiskZoneID=c.selected.optlRiskZoneID}$("input[name=optlRiskName]").next(".has-error").remove()});$("#selectOwner").click(function(){b.logic.selectOwner("人员选择(多选)",PageModelEnum.Details)});mini.get("riskAreaID").disable();mini.get("optlRiskName").disable()},logic:{save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var f=ECS.form.getData("AddOrEditModal");var e=mini.get("riskAreaCatgName").getCheckedNodes(true);if(e.length>0){for(var d=0;d<e.length;d++){(function(h){if(h.categID.indexOf("sm")!=-1){f.areaSmCatg=h.code}if(h.categID.indexOf("md")!=-1){f.areaMdCatg=h.code}if(h.categID.indexOf("bg")!=-1){f.areaBgCatg=h.code}})(e[d])}}else{if(pageMode==PageModelEnum.Edit){f.areaBgCatg=cate_dt.areaBgCatg;f.areaMdCatg=cate_dt.areaMdCatg;f.areaSmCatg=cate_dt.areaSmCatg}}delete f.riskAreaCatgName;if(mini.get("drtDeptCode").getSelectedNode()){f.drtDeptPID=mini.get("drtDeptCode").getSelectedNode().orgPID;f.drtDeptCode=mini.get("drtDeptCode").getSelectedNode().orgCode}else{f.drtDeptPID=drtDeptPID;f.drtDeptCode=drtDeptCode}f.enterpriseCode=enterpriseCode;f.optlRiskZoneID=optlRiskZoneID;f.riskAreaID=riskAreaID;f.riskAnlsObjCatg=$("#riskAnlsObjCatg").find("option:selected").val();if(f.userID){var c=[];for(var d=0;d<f.userID.split(",").length;d++){c.push({userID:f.userID.split(",")[d]})}f.userEntity=c}delete f.userID;delete f.userName;var g="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){g="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:g,data:JSON.stringify(f),dataType:"text",contentType:"application/json;charset=utf-8",success:function(h){if(h.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(h.collection.error.message)}},error:function(h){var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;ECS.sys.RefreshContextFromSYS();if(pageMode==PageModelEnum.NewAdd){$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});b.logic.get_list(orgType_url,$("#enterpriseCode"));b.logic.select_option(riskType_url,$("#riskAreaCatg"));b.logic.select_option(riskType_url2+"&riskAreaCatg=S",$("#riskAreaCatgName"),"ww");b.logic.select_option(oprisktype_url,$("#zoneCatg"));b.logic.select_option(RiskAnlsObj_url,$("#riskAnlsObjCatg"));$("#riskAreaCatg").change(function(){b.logic.select_option(riskType_url2+"&riskAreaCatg="+$("#riskAreaCatg").val(),$("#riskAreaCatgName"),"xx")});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);return}else{if(pageMode==PageModelEnum.Edit){mini.get("enterpriseCode").disable();mini.get("drtDeptCode").disable();$("#riskAreaCatg").attr("disabled","disabled");mini.get("riskAreaCatgName").disable();$("#zoneCatg").attr("disabled","disabled");$("#optlRiskName").attr("disabled","disabled")}}$.ajax({url:getSingleUrl+"/"+c.riskAnlsObjID+"?now="+Math.random(),type:"get",async:true,dataType:"json",success:function(e){ECS.form.setData("AddOrEditModal",e);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);mini.get("sortNum").setValue(e.sortNum);mini.get("enterpriseCode").setValue(e.orgSname);enterpriseCode=e.enterpriseCode;mini.get("drtDeptCode").setValue(e.drtDeptSname);drtDeptCode=e.drtDeptCode;if(e.drtDeptPID){drtDeptPID=e.drtDeptPID}optlRiskZoneID=e.optlRiskZoneID;b.logic.create_option($("#riskAreaCatg"),e.riskAreaCatg,e.riskAreaCatgName);if(e.bgCategName&&e.mdCategName&&e.smCategName){mini.get("riskAreaCatgName").setValue(e.bgCategName+","+e.mdCategName+","+e.smCategName)}else{if(e.bgCategName&&e.mdCategName){mini.get("riskAreaCatgName").setValue(e.bgCategName+","+e.mdCategName)}else{if(e.bgCategName){mini.get("riskAreaCatgName").setValue(e.bgCategName)}}}cate_dt.areaBgCatg=e.areaBgCatg?e.areaBgCatg:"";cate_dt.areaMdCatg=e.areaMdCatg?e.areaMdCatg:"";cate_dt.areaSmCatg=e.areaSmCatg?e.areaSmCatg:"";b.logic.load_risk_menu(e.riskAreaCode,e.riskAreaSname);b.logic.create_option($("#zoneCatg"),e.zoneCatg,e.zoneCatgName);b.logic.load_optrisk_menu(e.optlRiskCode,e.optlRiskSname);b.logic.select_option(RiskAnlsObj_url,$("#riskAnlsObjCatg"),function(){$("#riskAnlsObjCatg").val(e.riskAnlsObjCatg)});b.logic.create_option($("#riskAnlsObjName"),e.riskAnlsObjCode,e.riskAnlsObjName);editUserName=[];usernameList=[];userIDList=[];if(e.userEntity){for(var d=0;d<e.userEntity.length;d++){usernameList+=e.userEntity[d].userName+"<br/>";userIDList.push(e.userEntity[d].userID);editUserName.push(e.userEntity[d].userName)}$("#userName").html(usernameList);$("#userID").val(userIDList)}$("#inUse").iCheck("update")},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},create_option:function(d,g,e,c){var f=null;if(c){f=$('<option value="'+g+'" att_id="'+c+'">'+e+"</option>")}else{f=$('<option value="'+g+'">'+e+"</option>")}d.append(f);d.val(g)},selectCombox:function(c,d){$.ajax({url:c,type:"get",async:false,success:function(e){mini.get(d).load(e);mini.get(d).setValue("-1")}})},load_optrisk_menu:function(f,d){if(f){mini.get("optlRiskName").load([{name:d,optlRiskZoneID:f}]);mini.get("optlRiskName").setValue(f);return}var e=$("#zoneCatg").val();if(riskAreaID){var c=oprisk_url+"?riskAreaID="+riskAreaID+"&zoneCatg="+e;b.logic.selectCombox(c,"#optlRiskName");mini.get("optlRiskName").enable()}else{mini.get("optlRiskName").disable();mini.get("optlRiskName").setValue("-1")}},load_risk_menu:function(c,k){if(c){mini.get("riskAreaID").load([{riskAreaName:k,riskAreaCode:c}]);mini.get("riskAreaID").setValue(c);return}var h=mini.get("riskAreaCatgName").getCheckedNodes(true);var e="";var d="";var j="";if(h.length>0){for(var f=0;f<h.length;f++){(function(i){if(i.categID==""){e="";d="";j=""}else{if(i.categID.indexOf("sm")!=-1){e=i.code}else{if(i.categID.indexOf("md")!=-1){d=i.code}else{if(i.categID.indexOf("bg")!=-1){j=i.code}}}}})(h[f])}}var g=$("#riskAreaCatg").val();if(drtDeptCode){var l=riskAreaName_url+"?enterpriseCode="+enterpriseCode+"&drtDeptCode="+drtDeptCode+"&areaSmCatg="+e+"&areaMdCatg="+d+"&areaBgCatg="+j+"&riskAreaCatg="+g;b.logic.selectCombox(l,"#riskAreaID");mini.get("riskAreaID").enable()}else{mini.get("riskAreaID").disable();mini.get("riskAreaID").setValue("-1")}mini.get("optlRiskName").disable();mini.get("optlRiskName").setValue("-1")},selectOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"../RiskAnalysisPoint/SelectOwner.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,userId:$("#userID").val(),orgCode:enterpriseCode,userName:editUserName};i.page.logic.setData(h)},end:function(){editUserName=[];usernameList=[];userIDList=[];for(var f in window.ownDetail){usernameList+=window.ownDetail[f]+"<br/>"}for(var e in window.ownDetail){editUserName.push(window.ownDetail[e])}for(var e in window.ownDetail){userIDList.push(e)}$("#userName").html(usernameList);$("#userID").val(userIDList)}})},get_list:function(d,g,f,c){if(f){var e=d+"?orgPID="+f+"&orgLvl=3"}else{var e=d+"?orgLvl=2"}$.ajax({url:e,type:"GET",success:function(i){if(f){mini.get("drtDeptCode").loadList(i,"orgId","orgPID");if(i.length>0){if(i[0].orgPID){for(var h=0;h<i.length;h++){if(i[h].orgId==i[0].orgPID){mini.get("drtDeptCode").setValue(i[h].orgSname);drtDeptCode=i[h].orgCode}}drtDeptPID=i[0].orgPID}else{mini.get("drtDeptCode").setValue(i[0].orgSname);drtDeptCode=i[0].orgCode}}c&&c()}else{mini.get("enterpriseCode").loadList(i,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname);b.logic.get_list(riskorg_url,$("#drtDeptCode"),mini.get("enterpriseCode").data[0].orgId)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var h=0;h<i.length;h++){(function(j){if(j.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(j.orgSname);b.logic.get_list(riskorg_url,$("#drtDeptCode"),j.orgId)}})(i[h])}}c&&c()}}})},select_option:function(d,e,c){$.ajax({url:d,type:"GET",async:false,success:function(g){if(c&&(typeof c!="function")){mini.get("riskAreaCatgName").loadList(g,"categID","gcategID");b.logic.load_risk_menu("")}else{$(e).html("");$("#riskAreaCatg").find("option[value=S]").attr("selected",true);for(var f=0;f<g.length;f++){(function(i){if(i.key||i.key==0){var h=$('<option value="'+i.key+'">'+i.value+"</option>")}$(e).append(h)})(g[f])}c&&c()}}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){jQuery.validator.addMethod("ucode",function(d,c,f){var e=new RegExp(f);return e.test(d)},"只能输入字母和数字!");ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{enterpriseCode:{required:true},drtDeptCode:{required:true},riskAreaCatg:{required:true},riskAreaID:{required:true},optlRiskName:{required:true},riskAnlsObjCatg:{required:true},name:{required:true,rangelength:[0,200]},code:{required:true,rangelength:[0,200],ucode:/^[A-Za-z0-9]+$/},sortNum:{required:true,digits:true,min:0}}})}}};b.init();window.page=b});