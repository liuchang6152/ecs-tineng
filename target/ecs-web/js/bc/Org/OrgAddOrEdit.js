var addUrl=ECS.api.bcUrl+"/org";var getSingleUrl=ECS.api.bcUrl+"/org";var porg_url=ECS.api.bcUrl+"/org/porgName";var orgType_url=ECS.api.bcUrl+"/org/orgType";var orgLvl_url=ECS.api.bcUrl+"/org/orgLvl";var orgNature_url=ECS.api.bcUrl+"/org/orgNature";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var orgPid="";var porgCode="";var editUserName=[];var usernameList=[];var userIDList=[];var selectCode="";$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});mini.get("porgCode").on("nodeclick",function(c){mini.get("isnode_root").setChecked(false)});$("#selectOwner").click(function(){b.logic.selectOwner("人员选择(多选)",PageModelEnum.Details)})},logic:{save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var e=ECS.form.getData("AddOrEditModal");var f="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload;if(mini.get("porgCode").getSelectedNode()){e.orgPID=mini.get("porgCode").getSelectedNode().orgId}else{e.orgPID=orgPid}}else{if(pageMode==PageModelEnum.Edit){f="PUT";window.pageLoadMode=PageLoadMode.Refresh;if(mini.get("porgCode").getSelectedNode()){e.orgPID=mini.get("porgCode").getSelectedNode().orgId}else{e.orgPID=orgPid}}}if(e.userID){var d=[];for(var c=0;c<e.userID.split(",").length;c++){d.push({userID:e.userID.split(",")[c]})}e.userEntity=d}delete e.userID;delete e.userName;delete e.isnode_root;$.ajax({url:addUrl,async:false,type:f,data:JSON.stringify(e),dataType:"text",contentType:"application/json;charset=utf-8",success:function(g){if(g.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(g.collection.error.message)}},error:function(g){var h=$.parseJSON(g.responseText);layer.msg(h.collection.error.message)}})},setData:function(c){console.log(c);selectCode=c.selectCode;orgPid=c.orgPID?c.orgPID:"";console.log(orgPid);$("#title-main").text(c.title);pageMode=c.pageMode;if(c.orgPID){mini.get("isnode_root").setChecked(false)}else{mini.get("isnode_root").setChecked(true)}mini.get("isnode_root").disable();if(pageMode==PageModelEnum.NewAdd){$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});ECS.form.setData("AddOrEditModal",c);b.logic.select_option(orgType_url,$("#AddOrEditModal #orgTypeID"),function(){$("#AddOrEditModal #orgTypeID").val(c.orgTypeID)});b.logic.select_option(orgNature_url,$("#AddOrEditModal #orgNatureID"),function(){$("#AddOrEditModal #orgNatureID").val(c.orgNatureID)});b.logic.select_option(orgLvl_url,$("#AddOrEditModal #orgLvlID"),function(){$("#AddOrEditModal #orgLvlID").val(c.orgLvlID)});mini.get("#porgCode").setValue(c.name)}else{if(pageMode==PageModelEnum.Edit){$.ajax({url:getSingleUrl+"/"+c.OrgId+"?"+Math.random(),type:"get",async:true,dataType:"json",success:function(e){console.log(e);ECS.form.setData("AddOrEditModal",e);b.logic.select_option(orgType_url,$("#AddOrEditModal #orgTypeID"),function(){$("#AddOrEditModal #orgTypeID").val(e.orgTypeID)});b.logic.select_option(orgNature_url,$("#AddOrEditModal #orgNatureID"),function(){$("#AddOrEditModal #orgNatureID").val(e.orgNatureID)});b.logic.select_option(orgLvl_url,$("#AddOrEditModal #orgLvlID"),function(){$("#AddOrEditModal #orgLvlID").val(e.orgLvlID)});mini.get("#porgCode").setValue(e.orgPidSname);editUserName=[];usernameList=[];userIDList=[];if(e.userEntity){for(var d=0;d<e.userEntity.length;d++){usernameList+=e.userEntity[d].userName+"<br/>";userIDList.push(e.userEntity[d].userID);editUserName.push(e.userEntity[d].userName)}$("#userName").html(usernameList);$("#userID").val(userIDList)}$("#inUse").iCheck("update");if(e.orgPID){mini.get("isnode_root").setChecked(false)}else{mini.get("isnode_root").setChecked(true)}orgPid=e.orgPID?e.orgPID:""},error:function(d){console.log(d);var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}});mini.get("porgCode").disable()}}},selectOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"../RiskAnalysisPoint/SelectOwner.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,userId:$("#userID").val(),orgCode:selectCode,userName:editUserName};i.page.logic.setData(h)},end:function(){editUserName=[];usernameList=[];userIDList=[];for(var f in window.ownDetail){usernameList+=window.ownDetail[f]+"<br/>"}for(var e in window.ownDetail){editUserName.push(window.ownDetail[e])}for(var e in window.ownDetail){userIDList.push(e)}$("#userName").html(usernameList);$("#userID").val(userIDList)}})},select_option:function(d,e,c){$.ajax({url:d,type:"GET",success:function(j){if(c&&(typeof c=="string")){mini.get("porgCode").loadList(j,"orgId","orgPID");var g="";for(var f=0;f<j.length;f++){if(j[f].orgId==orgPid){g=j[f].orgSname}}mini.get("porgCode").setValue(g);mini.get("porgCode").disable()}else{for(var h=0;h<j.length;h++){(function(k){if(k.value){var i=$('<option value="'+k.key+'">'+k.value+"</option>")}if(k.orgSname){var i=$('<option value="'+(k.orgPID?k.orgPID:"")+'">'+k.orgSname+"</option>")}$(e).append(i)})(j[h])}c&&c()}},error:function(f){console.log(f)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){jQuery.validator.addMethod("ucode",function(d,c,f){var e=new RegExp(f);return e.test(d)},"只能输入字母和数字!");ECS.form.formValidate("AddOrEditModal",{rules:{orgCode:{required:true,rangelength:[0,200],ucode:/^[A-Za-z0-9]+$/},orgName:{required:true,rangelength:[0,200]},orgSname:{required:true,rangelength:[0,200]},orgTypeID:{required:true},orgNatureID:{required:true},orgLvlID:{required:true},porgCode$text:{required:true,rangelength:[0,200]},sortNum:{required:true,digits:true,min:0}}})}}};b.init();window.page=b});