var delUrl=ECS.api.bcUrl+"/org";var searchUrl=ECS.api.bcUrl+"/org";var exportUrl=ECS.api.bcUrl+"/org/ExportToExcel";var org_url=ECS.api.bcUrl+"/org/porgName?isAll=true";var porg_url=ECS.api.bcUrl+"/org/porgNameOne";var orgType_url=ECS.api.bcUrl+"/org/orgType?isAll=true";var orgLvl_url=ECS.api.bcUrl+"/org/orgLvl?isAll=true";var orgNature_url=ECS.api.bcUrl+"/org/orgNature?isAll=true";var riskorg_url=ECS.api.bcUrl+"/org/porgName";var grid=null;var selectCode="";pageflag=true;redisKey="";var nsName;window.pageLoadMode=PageLoadMode.None;$(function(){var a={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();$("#searchForm").find("input").val("");a.logic.initTable();a.logic.load_sidebar();a.logic.clear_val()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){a.data.param={};a.data.param=ECS.form.getData("searchForm");if(mini.get("tree1").getSelectedNode()){a.data.param.orgId=mini.get("tree1").getSelectedNode().orgId}else{a.data.param.orgId=mini.get("tree1").data[0].orgId}var c=a.logic.setUrlK(a.data.param);window.open(exportUrl+"?"+c)});mini.get("tree1").on("nodeselect",function(){a.logic.typelist_dt()});$("#btnQuery2").click(function(){var c=$.trim($("#tree_val").find("input").val());if(c==""||c=="全部"){mini.get("tree1").clearFilter()}else{c=c.toLowerCase();mini.get("tree1").filter(function(d){var e=d.orgSname?d.orgSname.toLowerCase():"";if(e.indexOf(c)!=-1){return true}})}});var b=true;$(".btn-toggle").click(function(){if(b){$(".leftNav-body").hide();$(".box-body").css("margin-left","0");$(this).css({left:"0",transform:"rotate(180deg)"})}else{$(".leftNav-body").show();$(".box-body").css("margin-left","280px");$(this).css({left:"263px",transform:"rotate(0deg)"})}b=!b;a.logic.search()});$("#treeMenu2 li").click(function(){a.logic.onAddNode2()});$("#enterpriseCode").change(function(){a.logic.enterprisechanged()})},data:{param:{}},logic:{enterprisechanged:function(){a.logic.load_sidebar(porg_url)},enterprise:function(b,c){$.ajax({url:b+"?orgLvl=1",type:"get",success:function(f){var e=[];if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){$.each(f,function(g,h){e.push({id:h.orgCode,text:h.orgSname,orgId:h.orgId})})}else{var d=JSLINQ(f).Where(function(g){return g.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE}).ToArray();$.each(d,function(g,h){e.push({id:h.orgCode,text:h.orgSname,orgId:h.orgId})});$("#"+c).attr("disabled","disabled")}orgList=e;$("#"+c).select2({tags:false,data:e,language:{noResults:function(g){return"没有匹配项"}},});a.logic.enterprisechanged()},error:function(d){layer.msg("系统繁忙")}})},setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},initTable:function(){grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"});a.logic.enterprise(riskorg_url,"enterpriseCode");a.logic.select_option(orgType_url,$("#orgTypeID"));a.logic.select_option(orgLvl_url,$("#orgLvlID"));a.logic.select_option(orgNature_url,$("#orgNatureID"))},clear_val:function(){$("#orgTypeID").val("");$("#orgLvlID").val("");$("#orgNatureID").val("");$("#orgName").val("");$("#orgCode").val("")},show_upload:function(b){return"<a href=\"javascript:ECS.util.renderUploader_Page('"+b.row.orgCode+"','"+b.row.orgId+"','"+b.row.orgName+"','11','企业组织机构附件上传')\">上传附件</a>"},rightmenu:function(b,e){var d=document.getElementById(e);var c=document.getElementById(b);c.onmousedown=function(f){if(window.event){f=window.event}if(f.button==2){document.oncontextmenu=function(g){if(window.event){g=window.event;g.returnValue=false}else{g.preventDefault()}};d.style.cssText="display:block;top:"+(f.pageY-50)+"px;left:"+f.pageX+"px;"}};d.onmouseout=function(){setTimeout(function(){d.style.display="none"},400)}},load_sidebar:function(){var c=$("#enterpriseCode").val();var b=porg_url+"?orgCode="+c;$.ajax({url:b,type:"GET",success:function(d){if(d.length>0){mini.get("tree1").loadList(d,"orgId","orgPID");a.logic.search()}else{a.logic.rightmenu("left_tree","treeMenu2")}},error:function(){a.logic.rightmenu("left_tree","treeMenu2")}})},reset_all:function(b){a.logic.clear_val();a.logic.load_sidebar(porg_url,function(){a.data.param={};if(b){a.data.param.sortType=1}a.data.param.orgId="";grid.load(a.data.param)})},onAddBefore:function(g){var c=mini.get("tree1");var f=c.getSelectedNode();var b=c.getParentNode(f);console.log(b.orgName);nsName=b.orgName;if(c.getAncestors(f).length=="0"){selectCode=""}else{if(c.getAncestors(f).length=="1"){selectCode=f.orgCode}else{for(var d=0;d<c.getAncestors(f).length;d++){if(c.getAncestors(f)[d]._level=="1"){selectCode=c.getAncestors(f)[d].orgCode}}}}a.logic.add(f.orgPID)},onAddNode:function(f){var b=mini.get("tree1");var d=b.getSelectedNode();console.log(d);if(b.getAncestors(d).length=="0"){selectCode=""}else{if(b.getAncestors(d).length=="1"){selectCode=d.orgCode}else{for(var c=0;c<b.getAncestors(d).length;c++){if(b.getAncestors(d)[c]._level=="1"){selectCode=b.getAncestors(d)[c].orgCode}}}}a.logic.add(d.orgId,function(e,g){a.logic.load_sidebar(porg_url)})},onAddNode2:function(){a.logic.add("",function(){a.logic.load_sidebar(porg_url)});$("#treeMenu2").hide()},onEditNode:function(f){var b=mini.get("tree1");var d=b.getSelectedNode();if(b.getAncestors(d).length=="0"){selectCode=""}else{if(b.getAncestors(d).length=="1"){selectCode=d.orgCode}else{for(var c=0;c<b.getAncestors(d).length;c++){if(b.getAncestors(d)[c]._level=="1"){selectCode=b.getAncestors(d)[c].orgCode}}}}a.logic.edit(d.orgId,d.orgPID)},onRemoveNode:function(d){var b=mini.get("tree1");var c=b.getSelectedNode();a.logic.delSingle(c.orgId)},show_edit:function(b){return ECS.util.editRender(b.row.orgId,b.row.orgPID)},onBeforeOpen:function(h){var j=h.sender;var b=mini.get("tree1");var f=b.getSelectedNode();if(!f){h.cancel=true;return}if((f&&f.text=="Base")||(f.orgName=="全部"&&f.orgId<0)){h.cancel=true;h.htmlEvent.preventDefault();return}var d=mini.getbyName("edit",j);var i=mini.getbyName("remove",j);var g=mini.getbyName("addPnode",j);d.show();i.enable();if(f.orgId=="-1"){d.disable();i.disable()}if(f._level=="0"){g.hide()}else{g.show()}var c=h||window.event;if(c.stopPropagation){c.stopPropagation()}else{c.cancelBubble=true}},select_option:function(c,d,b){$.ajax({url:c,type:"GET",success:function(f){for(var e=0;e<f.length;e++){(function(h){if(h.value){var g=$('<option value="'+h.key+'">'+h.value+"</option>")}if(h.orgSname){var g=$('<option value="'+h.orgPID+'">'+h.orgSname+"</option>")}$(d).append(g)})(f[e])}b&&b()}})},delAll:function(){var b=new Array();var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.orgId)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:false,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(d){ECS.hideLoading();if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){a.logic.reset_all()})}else{d=JSON.parse(d);layer.msg(d.collection.error.message)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},delSingle:function(c){var b=new Array();b.push(c);layer.confirm("温馨提示：可能存在相关引用，您确认删除当前组织机构吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:false,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(d){ECS.hideLoading();if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){a.logic.reset_all()})}else{d=JSON.parse(d);layer.msg(d.collection.error.message)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},add:function(c,b){var d=PageModelEnum.NewAdd;var e="企业组织机构新增";if(c){a.logic.detail(e,"",d,c,b)}else{a.logic.detail(e,"",d)}},edit:function(e,c,b){var d=PageModelEnum.Edit;var f="企业组织机构编辑";if(c){a.logic.detail(f,e,d,c,b)}else{a.logic.detail(f,e,d)}},detail:function(g,f,e,d,c){var b;if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){b=selectCode}else{b=ECS.sys.Context.SYS_ENTERPRISE_CODE}console.log(f);layer.open({type:2,closeBtn:0,area:["780px","480px"],skin:"new-class",shadeClose:false,title:false,content:"OrgAddOrEdit.html?"+Math.random(),success:function(i,j){var h=layer.getChildFrame("body",j);var l=window[i.find("iframe")[0]["name"]];var k={pageMode:e,OrgId:f,orgPID:d,selectCode:b,title:g,name:nsName};l.page.logic.setData(k)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.reset_all(true);c&&c();window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.reset_all(true);c&&c();window.pageLoadMode=PageLoadMode.None}}}})},typelist_dt:function(){a.data.param={};var c=mini.get("tree1").getSelectedNode();if(c){if(mini.get("tree1").getAncestors(c).length=="0"){selectCode=""}else{if(mini.get("tree1").getAncestors(c).length=="1"){selectCode=c.orgCode}else{for(var b=0;b<mini.get("tree1").getAncestors(c).length;b++){if(mini.get("tree1").getAncestors(c)[b]._level=="1"){selectCode=mini.get("tree1").getAncestors(c)[b].orgCode}}}}a.data.param.orgId=mini.get("tree1").getSelectedNode().orgId}grid.load(a.data.param)},search:function(b){a.data.param={};a.data.param=ECS.form.getData("searchForm");if(b){a.data.param.sortType=1}if(mini.get("tree1").getSelectedNode()){a.data.param.orgId=mini.get("tree1").getSelectedNode().orgId}else{a.data.param.orgId=mini.get("tree1").data[0].orgId}grid.load(a.data.param)},imp:function(){var c=ECS.api.bcUrl+"/org/importExcel";var b=ECS.api.bcUrl+"/org/ExportExcel";var e=ECS.api.bcUrl+"/org/importAddAll";var d="../UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d,function(){a.logic.load_sidebar(porg_url)})},}};a.init();window.page=a});