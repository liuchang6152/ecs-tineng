var addUrl=ECS.api.bcUrl+"/monitorFactor";var getSingleUrl=ECS.api.bcUrl+"/monitorSite";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI()},bindUI:function(){$("#btnQuery").click(function(){b.logic.search()});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)})},logic:{setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;$.ajax({url:getSingleUrl+"/"+c.siteID+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(e){ECS.hideLoading();ECS.form.setData("AddOrEditModal",e);for(var d=0;d<e.factorEntitys.length;d++){if(e.factorEntitys[d].lowLimit==e.factorEntitys[d].uppLimit){e.factorEntitys[d].inUpper="3";e.factorEntitys[d].inLower="3"}else{if(e.factorEntitys[d].inUpper==1){e.factorEntitys[d].inUpper="2"}if(e.factorEntitys[d].inLower==1){e.factorEntitys[d].inLower="2"}if(e.factorEntitys[d].inUpper==0){e.factorEntitys[d].inUpper="1"}if(e.factorEntitys[d].inLower==0){e.factorEntitys[d].inLower="1"}}$(".factorList").eq(d).find(".leftInput").eq(0).val(e.factorEntitys[d].lowLimit);$(".factorList").eq(d).find(".rightInput").eq(1).val(e.factorEntitys[d].uppLimit);$(".factorList").eq(d).find(".rightInput").eq(0).find("option:eq("+parseInt(e.factorEntitys[d].inLower)+")").attr("selected",true);$(".factorList").eq(d).find(".leftInput").eq(1).find("option:eq("+parseInt(e.factorEntitys[d].inUpper)+")").attr("selected",true)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},save:function(){var m=[];var p=[];for(var l=0;l<$(".factorList").length;l++){var j=$(".factorList").eq(l).find(".leftInput").eq(0).val();var d=$(".factorList").eq(l).find(".rightInput").eq(0).find("option:selected").val();var c=$(".factorList").eq(l).find(".rightInput").eq(0).find("option:selected").attr("name");var o=$(".factorList").eq(l).find(".leftInput").eq(1).find("option:selected").val();var f=$(".factorList").eq(l).find(".leftInput").eq(1).find("option:selected").attr("name");var n=$(".factorList").eq(l).find(".rightInput").eq(1).val();if(j!=""&&n!=""&&(f==2||c==2)&&j!=n){layer.msg("指标相等时，上标和下标需一致！");return false}if(j!=""&&n!=""&&j==n&&(f!=2||c!=2)){layer.msg("上标和下标一致时，指标需选择等于号！");return false}if((j&&d)||(n&&o)){if(m.length==0){if(n&&o){m.push({sortNum:0,siteID:$("#siteID").val(),lowLimit:j,inLower:d,uppLimit:n,inUpper:o,factorID:$("#factorID").val()})}}else{if(m.length==m.length){if(j&&d){m.push({sortNum:0,siteID:$("#siteID").val(),lowLimit:j,inLower:d,uppLimit:n,inUpper:o,factorID:$("#factorID").val()})}}else{if(n&&o&&j&&d){m.push({sortNum:0,siteID:$("#siteID").val(),lowLimit:j,inLower:d,uppLimit:n,inUpper:o,factorID:$("#factorID").val()})}}}}}if(m&&m.length>0){for(var l=0;l<m.length;l++){var k=m[l];if(l==0||l==m.length-1){p.push(k)}else{if(k.lowLimit&&k.uppLimit){p.push(k)}}}}if(p&&p.length>0){if(p.length%2!=0){layer.msg("指标需要成对填写！");return false}if(p[0].lowLimit>999999.999999||p[0].lowLimit<-999999.999999||p[p.length-1].uppLimit>999999.999999||p[p.length-1].uppLimit<-999999.999999){layer.msg('指标区间范围为["-999999.999999","999999.999999"]！');return false}for(var l=0;l<p.length;l++){var k=p[l];var h=p.length/2;if(l<h){m[l].factorDirection="0"}else{m[l].factorDirection="1"}if(k.lowLimit&&k.uppLimit){if(k.uppLimit*1<k.lowLimit*1){layer.msg("指标下限不能大于指标上限！");return false}}if(l>0){var e=p[l-1];if(k.lowLimit*1<=e.uppLimit*1){layer.msg("指标下限需大于上一指标上限！");return false}}}}var g="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){g="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:g,data:JSON.stringify(p),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(i){ECS.hideLoading();if(i.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(i.collection.error.message)}},error:function(i){var q=$.parseJSON(i.responseText);$("#btnSave").attr("disabled",false);ECS.hideLoading();layer.msg(q.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)}}};b.init();window.page=b});