var addUrl=ECS.api.bcUrl+"/optlRiskZone";var getSingleUrl=ECS.api.bcUrl+"/optlRiskZone";var riskorg_url=ECS.api.bcUrl+"/org/porgName";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/riskArea/categ?showPleaseSelect=true";var riskAreaEnumListNameUrl=ECS.api.bcUrl+"/riskArea/getRiskAreaEnumList";var riskAreaNameUrl=ECS.api.bcUrl+"/riskArea/riskAreaNameAll";var zoneCatgUrl=ECS.api.bcUrl+"/optlRiskZone/getOptlZoneCatgEnumList";var cate_dt={};var categID="";var code="";var enterpriseCode="";var drtDeptCode="";var editUserName=[];var usernameList=[];var userIDList=[];var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var catgCode;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();b.logic.get_list(riskorg_url,$("#enterpriseCode"));b.logic.cbxRiskAreaEnumList();b.logic.cbxLink("S");b.logic.cbxZoneCatg();mini.get("riskAreaID").disable()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnQuery").click(function(){b.logic.search()});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});mini.get("enterpriseCode").on("nodeclick",function(c){$("input[name=enterpriseCode]").next(".has-error").remove();enterpriseCode=c.node.orgCode;editUserName=[];$("#userName").html("");$("#userID").val("");b.logic.get_list(riskorg_url,$("#drtDeptCode"),c.node.orgId)});mini.get("drtDeptCode").on("nodeclick",function(c){$("input[name=drtDeptCode]").next(".has-error").remove();drtDeptCode=c.node.orgCode;b.logic.cbxRiskAreaName("")});mini.get("riskAreaTypeName").on("nodeclick",function(c){$("input[name=riskAreaTypeName]").next(".has-error").remove();catgCode=c.node.code;b.logic.cbxRiskAreaName("")});mini.get("riskAreaID").on("valuechanged",function(c){$("input[name=riskAreaID]").next(".has-error").remove()});$("#selectOwner").click(function(){b.logic.selectOwner("人员选择(多选)",PageModelEnum.Details)})},logic:{setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;if(pageMode==PageModelEnum.NewAdd){$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);return}if(pageMode==PageModelEnum.Edit){$("#enterpriseCode-text").html('<input name="enterpriseName" type="text" class="form-control" id="enterpriseName" /><input name="enterpriseCode" type="hidden" id="enterpriseCode" />');$("#enterpriseName").attr("disabled","disabled");$("#orgName-text").html('<input name="orgName" type="text" class="form-control" id="orgName" /><input name="drtDeptCode" type="hidden" id="drtDeptCode" />');$("#orgName").attr("disabled","disabled");$("#riskAreaCatg-text").html('<input name="riskAreaCatgName" type="text" class="form-control" id="riskAreaCatgName" />');$("#riskAreaCatgName").attr("disabled","disabled");$("#riskAreaTypeName-text").html('<input name="riskAreaTypeName" type="text" class="form-control" id="riskAreaTypeName" disabled="disabled" />');$("#code").attr("disabled","disabled")}$.ajax({url:getSingleUrl+"/"+c.optlRiskZoneID+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(e){ECS.hideLoading();ECS.form.setData("AddOrEditModal",e);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);mini.get("sortNum").setValue(e.sortNum);mini.get("enterpriseCode").setValue(e.orgSname);enterpriseCode=e.enterpriseCode;mini.get("drtDeptCode").setValue(e.drtDeptSname);drtDeptCode=e.drtDeptCode;b.logic.cbxRiskAreaName(e.riskAreaID,e.riskAreaName);cate_dt.areaBgCatg=e.areaBgCatg;cate_dt.areaMdCatg=e.areaMdCatg;cate_dt.areaSmCatg=e.areaSmCatg;editUserName=[];usernameList=[];userIDList=[];if(e.userEntitySet){for(var d=0;d<e.userEntitySet.length;d++){usernameList+=e.userEntitySet[d].userName+"<br/>";userIDList.push(e.userEntitySet[d].userID);editUserName.push(e.userEntitySet[d].userName)}$("#userName").html(usernameList);$("#userID").val(userIDList)}$("#inUse").iCheck("update")},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},get_list:function(d,g,f,c){if(f){var e=d+"?orgPID="+f+"&orgLvl=3"}else{var e=d+"?orgLvl=2"}$.ajax({url:e,type:"GET",success:function(i){if(f){mini.get("drtDeptCode").loadList(i,"orgId","orgPID");if(i.length>0){if(i[0].orgPID){for(var h=0;h<i.length;h++){if(i[h].orgId==i[0].orgPID){mini.get("drtDeptCode").setValue(i[h].orgSname);drtDeptCode=i[h].orgCode}}}else{mini.get("drtDeptCode").setValue(i[0].orgSname);drtDeptCode=i[0].orgCode}}c&&c()}else{mini.get("enterpriseCode").loadList(i,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgCode);b.logic.get_list(riskorg_url,$("#drtDeptCode"),mini.get("enterpriseCode").data[0].orgId)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var h=0;h<i.length;h++){(function(j){if(j.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(j.orgSname);b.logic.get_list(riskorg_url,$("#drtDeptCode"),j.orgId)}})(i[h])}}c&&c()}}})},cbxRiskAreaEnumList:function(){ECS.ui.getCombobox("riskAreaCatg",riskAreaEnumListNameUrl,{selectValue:"S",},null,b.logic.cbxLink)},cbxLink:function(c){b.logic.select_option(riskAreaTypeNameUrl+"&riskAreaCatg="+c,"#riskAreaTypeName");catgCode="";b.logic.cbxRiskAreaName("")},select_option:function(c,d){$.ajax({url:c,type:"get",success:function(e){mini.get(d).loadList(e,"categID","gcategID");mini.get(d).setValue("请选择");if(e[0]){categID=e[0].categID;code=e[0].code}}})},selectCombox:function(c,d){$.ajax({url:c,type:"get",success:function(e){mini.get(d).load(e)}})},cbxRiskAreaName:function(f,e){if(f){mini.get("riskAreaID").load([{riskAreaName:e,riskAreaID:f}]);mini.get("riskAreaID").setValue(f);return}var c=$("#riskAreaCatg").val();if(drtDeptCode){var d=riskAreaNameUrl+"?enterpriseCode="+enterpriseCode+"&drtDeptCode="+drtDeptCode+"&riskAreaCatgCode="+catgCode+"&riskAreaCatg="+c;b.logic.selectCombox(d,"#riskAreaID");mini.get("riskAreaID").enable()}else{mini.get("riskAreaID").disable();mini.get("riskAreaID").setValue("-1")}},cbxZoneCatg:function(){ECS.ui.getCombobox("zoneCatg",zoneCatgUrl,{selectValue:""},null)},selectOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"../RiskAnalysisPoint/SelectOwner.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,userId:$("#userID").val(),orgCode:enterpriseCode,userName:editUserName};i.page.logic.setData(h)},end:function(){editUserName=[];usernameList=[];userIDList=[];for(var f in window.ownDetail){usernameList+=window.ownDetail[f]+"<br/>"}for(var e in window.ownDetail){editUserName.push(window.ownDetail[e])}for(var e in window.ownDetail){userIDList.push(e)}$("#userName").html(usernameList);$("#userID").val(userIDList)}})},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var f=ECS.form.getData("AddOrEditModal");if(mini.get("drtDeptCode").getSelectedNode()){f.drtDeptCode=mini.get("drtDeptCode").getSelectedNode().orgCode}else{f.drtDeptCode=drtDeptCode}f.enterpriseCode=enterpriseCode;var e=mini.get("riskAreaTypeName").getCheckedNodes(true);if(e.length>0){for(var d=0;d<e.length;d++){(function(h){if(h.categID.indexOf("sm")!=-1){f.areaSmCatg=h.code}if(h.categID.indexOf("md")!=-1){f.areaMdCatg=h.code}if(h.categID.indexOf("bg")!=-1){f.areaBgCatg=h.code}})(e[d])}}else{if(pageMode==PageModelEnum.Edit){f.areaBgCatg=cate_dt.areaBgCatg;f.areaMdCatg=cate_dt.areaMdCatg;f.areaSmCatg=cate_dt.areaSmCatg}if(pageMode==PageModelEnum.NewAdd){if(categID.indexOf("sm")!=-1){f.areaSmCatg=code}if(categID.indexOf("md")!=-1){f.areaMdCatg=code}if(categID.indexOf("bg")!=-1){f.areaBgCatg=code}}}if(f.userID){var c=[];for(var d=0;d<f.userID.split(",").length;d++){c.push({userID:f.userID.split(",")[d]})}f.userEntitySet=c}delete f.userID;delete f.userName;delete f.riskAreaTypeName;var g="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){g="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:g,data:JSON.stringify(f),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(h){ECS.hideLoading();if(h.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(h.collection.error.message)}},error:function(h){$("#btnSave").attr("disabled",false);ECS.hideLoading();var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){jQuery.validator.addMethod("ucode",function(d,c,f){var e=new RegExp(f);return e.test(d)},"只能输入字母和数字!");ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{enterpriseCode:{required:true},drtDeptCode:{required:true},riskAreaID:{required:true},zoneCatg:{required:true},name:{required:true,maxlength:200},sname:{required:true,maxlength:200},code:{required:true,maxlength:200,ucode:/^[A-Za-z0-9]+$/},sortNum:{required:true,digits:true,min:0}}})}}};b.init();window.page=b});