var addUrl=ECS.api.bcUrl+"/alarmLine";var getSingleUrl=ECS.api.bcUrl+"/alarmLine";var orgCodeUrl=ECS.api.bcUrl+"/org/orgCodeAndName";var riskAreaNameUrl=ECS.api.bcUrl+"/riskArea/getListByName";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;var selectValue="";var selectCode=[];var selectRight="";$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){this.bindUI();b.logic.initOrgCode()},bindUI:function(){$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#riskAreaNames").focus(function(){$(this).val("");$(".mainSelect").show();b.logic.saveRiskAreaList();b.logic.initRiskAreaList("")});$("#riskAreaNames").bind("input propertychange",function(){b.logic.initRiskAreaList($(this).val())});$("#equipmentUid,#officePhone,#ipAddress").bind("input propertychange",function(){if($("#officePhone").val()!==""||$("#ipAddress").val()!==""||$("#equipmentUid").val()!==""){$(".list").removeClass("required").next(".has-error").remove();$(".list").parents(".form-group").removeClass("has-error")}else{$("#officePhone").addClass("required");$("#ipAddress").addClass("required");$("#equipmentUid").addClass("required")}})},logic:{initOrgCode:function(){ECS.ui.getCombobox("orgCode",orgCodeUrl,{selectFirstRecord:true,keyField:"key",valueField:"value",},null)},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;$("#alarmLineTypeName").val(c.typeName);if(pageMode==PageModelEnum.NewAdd){if(c.typeName=="扩音设备"){$("#alarmLineType").val("1")}else{$("#alarmLineType").val("2")}return}$.ajax({url:getSingleUrl+"/"+c.alarmLineID+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(d){ECS.hideLoading();ECS.form.setData("AddOrEditModal",d);if(pageMode==PageModelEnum.Edit){b.logic.editRiskArea(d)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},editRiskArea:function(g){var f="";var e="";var d=[];for(var c=0;c<g.alarmLineRiskArea.length;c++){f+=g.alarmLineRiskArea[c].riskAreaEntity.riskAreaName+"、";e+="<p id='"+g.alarmLineRiskArea[c].riskAreaEntity.riskAreaID+"' areaId='"+g.alarmLineRiskArea[c].alarmLineRiskAreaID+"' code='"+g.alarmLineRiskArea[c].code+"' title='"+g.alarmLineRiskArea[c].riskAreaEntity.riskAreaName+"'><span>"+g.alarmLineRiskArea[c].riskAreaEntity.riskAreaName+"</span><i class='icon-close del fr' style='width: 12px;;'></i></p>";d.push({alarmLineID:$("#alarmLineID").val(),alarmLineRiskAreaID:g.alarmLineRiskArea[c].alarmLineRiskAreaID,code:g.alarmLineRiskArea[c].code})}f.substring(f.length-1);$("#riskAreaNames").val(f);$(".main-right").append(e);$("#alarmLineRiskArea").val(JSON.stringify(d));$(".icon-close").click(function(){$(this).parent().remove("p");$(".main-left").find("#"+$(this).parent().attr("id")).removeClass("active")});b.logic.saveRiskAreaList()},initRiskAreaList:function(d){var c="";$.ajax({url:riskAreaNameUrl+"?riskAreaName="+d,type:"get",dataType:"json",success:function(f){for(var e=0;e<f.length;e++){c+="<p id='"+f[e].riskAreaID+"' code='"+f[e].riskAreaCode+"'>"+f[e].riskAreaName+"</p>"}$(".main-left").html(c);$(".main-right p").each(function(){$(".main-left").find("#"+$(this).attr("id")).addClass("active")});b.logic.initRiskArea()},error:function(e){var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},initRiskArea:function(){$(".main-left p").click(function(d){d.stopPropagation();var f="<p id='"+$(this).attr("id")+"' title='"+$(this).text()+"' code='"+$(this).attr("code")+"'><span>"+$(this).text()+"</span><i class='icon-close del fr'></i></p>";var e=$(this).attr("id");var c=false;$(".main-right p").each(function(){var g=$(this).attr("id");if(e==g){c=true;return false}else{c=false}});if(!c){$(this).addClass("active");$(".main-right").append(f)}$(".icon-close").click(function(){$(this).parent().remove("p");$(".main-left").find("#"+$(this).parent().attr("id")).removeClass("active")})});b.logic.saveRiskAreaList()},saveRiskAreaList:function(){$(".saveSelect").click(function(){$("#alarmLineRiskArea").val("");selectValue="";selectCode=[];if($(".main-right p").length>0){selectRight=$(".main-right").html();$(".main-right p").each(function(){selectValue+=$(this).text()+"、";selectCode.push({alarmLineID:$("#alarmLineID").val(),alarmLineRiskAreaID:$(this).attr("areaId"),code:$(this).attr("code")})});$("#riskAreaNames").val(selectValue);$("#alarmLineRiskArea").val(JSON.stringify(selectCode));$("#riskAreaNames").removeClass("required").next(".has-error").remove();$("#riskAreaNames").parents(".form-group").removeClass("has-error");$(".mainSelect").hide()}else{layer.msg("请选择风险区域！")}});$(".closeSelect").click(function(){$("#riskAreaNames").val(selectValue);$("#alarmLineRiskArea").val(JSON.stringify(selectCode));$(".mainSelect").hide()})},save:function(){b.logic.formValidate();$("#AddOrEditModal").find("input[class*=form-control]").each(function(){$(this).val($.trim($(this).val()))});if(!$("#AddOrEditModal").valid()){return}var d=ECS.form.getData("AddOrEditModal");if(d.alarmLineRiskArea=="[]"||!d.alarmLineRiskArea||!d.riskAreaNames){layer.msg("请选择正确的风险区域数据!");return}var c=JSON.parse(d.alarmLineRiskArea);d.alarmLineRiskArea=c;var e="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){e="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:e,data:JSON.stringify(d),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(f){ECS.hideLoading();if(f.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(f.collection.error.message)}},error:function(f){var g=$.parseJSON(f.responseText);$("#btnSave").attr("disabled",false);ECS.hideLoading();layer.msg(g.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{alarmLineName:{required:true,rangelength:[0,200]},orgCode:{required:true},riskArea:{required:true},officePhone:{simplePhone:true},ipAddress:{ipv4:true},alarmLineDes:{rangelength:[0,200]}}});if($("#officePhone").val()!==""||$("#ipAddress").val()!==""||$("#equipmentUid").val()!==""){$(".list").removeClass("required")}else{$("#officePhone").addClass("required");$("#ipAddress").addClass("required");$("#equipmentUid").addClass("required")}}}};b.init();window.page=b});