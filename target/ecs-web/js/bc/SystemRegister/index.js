var delUrl=ECS.api.bcUrl+"/systemRegistersisPoint";var searchUrl=ECS.api.bcUrl+"/systemRegistersisPoint";var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var inUseUrl=ECS.api.commonUrl+"/getInUse";window.pageLoadMode=PageLoadMode.None;$(function(){var a={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();this.bindUI();$("#searchForm").find("input").val("");a.logic.initInUse();a.logic.initTable()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()})},data:{param:{}},logic:{initTable:function(){mini.parse();grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"});a.logic.initOrgCode(enterpriseCodeUrl,$("#enterpriseCode"))},show_edit:function(b){return ECS.util.editRender(b.row.systemID)},initOrgCode:function(c,d,b){$.ajax({url:c,type:"get",success:function(f){mini.get("enterpriseCode").loadList(f,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){grid.load({enterpriseCode:mini.get("enterpriseCode").data[0].orgCode});mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname)}else{mini.get("enterpriseCode").disable();grid.load({enterpriseCode:ECS.sys.Context.SYS_ENTERPRISE_CODE});for(var e=0;e<f.length;e++){(function(g){if(g.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(g.orgSname)}})(f[e])}}b&&b()}})},delAll:function(){var b=[];var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.systemID)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:true,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(d){ECS.hideLoading();if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){grid.reload({pageIndex:0})})}else{d=JSON.parse(d);layer.msg(d.collection.error.message)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},add:function(){var b=PageModelEnum.NewAdd;var c="外部系统注册新增";a.logic.detail(c,"",b)},edit:function(d){var b=PageModelEnum.Edit;var c="外部系统注册编辑";a.logic.detail(c,d,b)},detail:function(c,d,b){layer.open({type:2,closeBtn:0,area:["780px","360px"],skin:"new-class",shadeClose:false,title:false,content:"SystemRegisterAddOrEdit.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:b,systemID:d,title:c};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},search:function(b){ECS.sys.RefreshContextFromSYS();a.data.param={};a.data.param=ECS.form.getData("searchForm");if(b){a.data.param.sortType=1}if(mini.get("enterpriseCode").getSelectedNode()){a.data.param.enterpriseCode=mini.get("enterpriseCode").getSelectedNode().orgCode}else{a.data.param.enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE}grid.load(a.data.param)},initInUse:function(){ECS.ui.getCombobox("inUse",inUseUrl,{selectValue:"-1",data:{isAll:true}},null)}}};a.init();window.page=a});