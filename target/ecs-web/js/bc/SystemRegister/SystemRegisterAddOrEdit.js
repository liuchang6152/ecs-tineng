var addUrl=ECS.api.bcUrl+"/systemRegistersisPoint";var getSingleUrl=ECS.api.bcUrl+"/systemRegistersisPoint";var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();b.logic.initOrgCode(enterpriseCodeUrl)},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)})},logic:{initOrgCode:function(d,c){$.ajax({url:d,type:"get",async:false,success:function(f){mini.get("enterpriseCode").loadList(f,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname)}else{mini.get("enterpriseCode").disable();for(var e=0;e<f.length;e++){(function(g){if(g.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(g.orgSname)}})(f[e])}}c&&c()}})},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;ECS.sys.RefreshContextFromSYS();if(pageMode==PageModelEnum.NewAdd){$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);return}$.ajax({url:getSingleUrl+"/"+c.systemID+"?now="+Math.random(),type:"get",dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(d){ECS.hideLoading();ECS.form.setData("AddOrEditModal",d);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);mini.get("sortNum").setValue(d.sortNum);mini.get("enterpriseCode").disable();mini.get("enterpriseCode").setValue(d.enterpriseCode);$("#inUse").iCheck("update")},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var c=ECS.form.getData("AddOrEditModal");c.sortNum=mini.get("sortNum").getValue();if(mini.get("enterpriseCode").getSelectedNode()){c.enterpriseCode=mini.get("enterpriseCode").getSelectedNode().orgCode}else{c.enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE}var d="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){d="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:d,data:JSON.stringify(c),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(e){ECS.hideLoading();if(e.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(e.collection.error.message)}},error:function(e){$("#btnSave").attr("disabled",false);ECS.hideLoading();var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{systemName:{required:true,maxlength:200},systemUID:{required:true,maxlength:36},address:{required:true,maxlength:200},path:{required:true,maxlength:200}}})}}};b.init();window.page=b});