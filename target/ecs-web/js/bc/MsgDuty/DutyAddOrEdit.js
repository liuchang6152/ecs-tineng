var searchUrl=ECS.api.bcUrl+"/duty";var dutyTypeUrl=ECS.api.bcUrl+"/duty/type";var OrgNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var inUseUrl=ECS.api.commonUrl+"/getInUse";var dutyLevelUrl=ECS.api.bcUrl+"/duty/level";var getSingleUrl=ECS.api.bcUrl+"/duty/oneDuty";var addUrl=ECS.api.bcUrl+"/duty";var mtrlTypeEnumUrl=ECS.api.bcUrl+"/duty/mtrlTypeEnum";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();ECS.sys.RefreshContextFromSYS();b.logic.cbxOrgName();b.logic.cbxDutyType();b.logic.cbxDutyLevel();b.logic.cbxMtrlTypeName()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)})},logic:{setData:function(g){$("#title-main").text(g.title);pageMode=g.pageMode;if(pageMode==PageModelEnum.NewAdd){$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#crtUserDept").val(ECS.sys.Context.SYS_ORG_UNIT_NAME);var e=new Date;var f=e.getFullYear();var c=e.getMonth()+1;var d=e.getDate();$("#crtDate").val(f+"-"+c+"-"+d);return}$.ajax({url:getSingleUrl+"?dutyID="+g.dutyID+"&now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(h){ECS.form.setData("AddOrEditModal",h);$("#orgCode").attr("disabled",true);mini.get("sortNum").setValue(h.sortNum);$("#crtDate").val(ECS.util.timestampToTime(h.crtDate));$("#inUse").iCheck("update");ECS.hideLoading()},error:function(h){ECS.hideLoading();var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},cbxOrgName:function(){if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){ECS.ui.getCombobox("orgCode",OrgNameUrl,{selectFirstRecord:true,async:false,keyField:"orgCode",codeField:"orgId",valueField:"orgSname"},null);$("#orgCode").attr("disabled",false)}else{ECS.ui.getCombobox("orgCode",OrgNameUrl,{selectValue:ECS.sys.Context.SYS_ENTERPRISE_CODE,async:false,keyField:"orgCode",codeField:"orgId",valueField:"orgSname"},null);$("#orgCode").attr("disabled",true)}},cbxDutyType:function(){ECS.ui.getCombobox("dutyTypeID",dutyTypeUrl,{selectFirstRecord:true,async:false,keyField:"dutyTypeID",valueField:"dutyTypeName"})},cbxDutyLevel:function(){ECS.ui.getCombobox("dutyLevelID",dutyLevelUrl,{async:false,keyField:"dutyLevelID",valueField:"dutyLevelName"})},cbxMtrlTypeName:function(){ECS.ui.getCombobox("mtrlType",mtrlTypeEnumUrl,{selectValue:"0",async:false})},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var c=ECS.form.getData("AddOrEditModal");c.sortNum=mini.get("sortNum").getValue();c.orgID=$("#orgCode").find("option:selected").attr("code");var d="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){d="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:d,data:$.param(c),dataType:"text",contentType:"application/x-www-form-urlencoded",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(e){ECS.hideLoading();if(e.indexOf("collection")<0){layer.msg(e,{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(e.collection.error.message)}},error:function(e){$("#btnSave").attr("disabled",false);ECS.hideLoading()}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){jQuery.validator.addMethod("ucode",function(d,c,f){var e=new RegExp(f);return e.test(d)},"只能输入字母和数字!");ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{orgCode:{required:true},dutyTypeID:{required:true},dutyLevelID:{required:true},dutyName:{required:true,maxlength:200},dutyCode:{required:true,ucode:/^[A-Za-z0-9]+$/},mtrlTypeName:{required:true},sortNum:{digits:true}}})}}};b.init();window.page=b});