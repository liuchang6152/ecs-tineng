var delUrl=ECS.api.bcUrl+"/duty";var searchUrl=ECS.api.bcUrl+"/duty";var OrgNameUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var dutyTypeUrl=ECS.api.bcUrl+"/duty/type";var inUseUrl=ECS.api.commonUrl+"/getInUse";var dutyLevelUrl=ECS.api.bcUrl+"/duty/level";var exportUrl=ECS.api.bcUrl+"/duty/ExportToExcel";var importUrl=ECS.api.bcUrl+"/duty/importExcel";var uploader;window.pageLoadMode=PageLoadMode.None;pageflag=true;redisKey="";$(function(){var a={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();$("#searchForm").find("input").val("");a.logic.initTable();a.logic.cbxOrgName();a.logic.search();a.logic.initDutyType();a.logic.initDutyLevel();a.logic.initInUse();a.logic.upload()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnDel").click(function(){a.logic.delAll()});$("#btnQuery").click(function(){a.logic.search()});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){a.data.param=ECS.form.getData("searchForm");a.data.param.orgID=$("#orgID").find("option:selected").attr("code");if(a.data.param.inUse=="-1"){a.data.param.inUse=""}var b=a.logic.setUrlK(a.data.param);window.open(exportUrl+"?"+b)})},data:{param:{}},logic:{setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},initTable:function(){grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"data"})},show_edit:function(b){return ECS.util.editRender(b.row.dutyID)},cbxOrgName:function(){if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){ECS.ui.getCombobox("orgID",OrgNameUrl,{selectFirstRecord:true,async:false,keyField:"orgCode",codeField:"orgId",valueField:"orgSname"},null);$("#orgID").attr("disabled",false)}else{ECS.ui.getCombobox("orgID",OrgNameUrl,{selectValue:ECS.sys.Context.SYS_ENTERPRISE_CODE,async:false,keyField:"orgCode",codeField:"orgId",valueField:"orgSname"},null);$("#orgID").attr("disabled",true)}},initDutyType:function(){ECS.ui.getComboSelects(dutyTypeUrl,"dutyTypeID","dutyTypeID","dutyTypeName",false)},initDutyLevel:function(){ECS.ui.getComboSelects(dutyLevelUrl,"dutyLevelID","dutyLevelID","dutyLevelName",false)},initInUse:function(){ECS.ui.getCombobox("inUse",inUseUrl,{selectValue:"-1",data:{isAll:true}},null)},delAll:function(){var b=[];var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.dutyID)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:true,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(d){ECS.hideLoading();if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){grid.reload({pageIndex:0})})}else{d=JSON.parse(d);layer.msg(d.collection.error.message);layer.msg(d)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},upload:function(){uploader=new plupload.Uploader({browse_button:"btnImport",url:importUrl,filters:{mime_types:[{title:"xlsx files",extensions:"xlsx"},]}});uploader.init();uploader.bind("FilesAdded",function(c,b){if(b[0].name.length>50){c.removeFile(b[0]);layer.msg("文件名称不能超过50个字符！");return}if(c.files.length>0){c.start()}});uploader.bind("UploadProgress",function(c,b){layer.msg("正在导入文件请耐心等待！")});uploader.bind("FileUploaded",function(h,e,c){var f=JSON.parse(c.response);var g="";if(f.isSuccess){layer.msg("导入成功！");a.logic.search(true)}else{var b=f.message.split("!");for(var d=0;d<b.length-1;d++){g+="<p>"+(parseInt(d)+1)+"、"+b[d]+";</p>"}a.logic.importDetail("导入数据错误",g,PageModelEnum.Details)}})},importDetail:function(d,b,c){layer.open({type:2,closeBtn:0,area:["800px","400px"],skin:"new-class",shadeClose:false,title:false,content:"../RiskAnalysisPoint/RiskAnalysisPointDataError.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,errorTip:b};i.page.logic.setData(h)},end:function(){a.logic.search();window.pageLoadMode=PageLoadMode.Refresh}})},add:function(){var b=PageModelEnum.NewAdd;var c="企业职务新增";a.logic.detail(c,"",b)},edit:function(b){var c=PageModelEnum.Edit;var d="企业职务编辑";a.logic.detail(d,b,c)},detail:function(d,b,c){layer.open({type:2,closeBtn:0,area:["780px","400px"],skin:"new-class",shadeClose:false,title:false,content:"DutyAddOrEdit.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,dutyID:b,title:d};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.None}}}})},search:function(b){a.data.param=ECS.form.getData("searchForm");if(b){a.data.param.sortType=1}a.data.param.orgID=$("#orgID").find("option:selected").attr("code");if(a.data.param.inUse=="-1"){a.data.param.inUse=""}grid.load(a.data.param)},imp:function(){var c=ECS.api.bcUrl+"/duty/importExcel";var b=ECS.api.bcUrl+"/duty/ExportExcel";var e=ECS.api.bcUrl+"/duty/importAddAll";var d="../UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d)}}};a.init();window.page=a});