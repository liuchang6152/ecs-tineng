var addUrl=ECS.api.bcUrl+"/monitorSite";var getSingleUrl=ECS.api.bcUrl+"/monitorSite";var riskorg_url=ECS.api.bcUrl+"/org/porgName";var orgType_url=ECS.api.bcUrl+"/org/porgName";var riskType_url=ECS.api.bcUrl+"/riskArea/getRiskAreaEnumList";var riskType_url2=ECS.api.bcUrl+"/riskArea/getCategObj?showPleaseSelect=true";var riskAreaName_url=ECS.api.bcUrl+"/riskArea/getAllList";var oprisktype_url=ECS.api.bcUrl+"/optlRiskZone/getOptlZoneCatgEnumList?showPleaseSelect=true";var oprisk_url=ECS.api.bcUrl+"/optlRiskZone/getAllList?showPleaseSelect=true";var RiskAnlsObj_url=ECS.api.bcUrl+"/riskAnlsObj/getRiskObjCatgEnumList?showPleaseSelect=true";var RiskAnlsObjName_url=ECS.api.bcUrl+"/riskAnlsObj/getAllList?showPleaseSelect=true";var CheckType_url=ECS.api.bcUrl+"/monitorSite/type";var System_url=ECS.api.bcUrl+"/monitorSite/system";var mesureUnit_url=ECS.api.bcUrl+"/monitorSite/unit";var rapName_url=ECS.api.bcUrl+"/riskAnalysisPoint/rapNameList";var enterpriseCode="";var drtDeptCode="";var riskAreaID="";var optlRiskZoneID="";var optlRiskZoneCode="";var riskAnlsObjCode="";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){ECS.sys.RefreshContextFromSYS();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});$("#isFireAlarm").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)})},logic:{save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var c=ECS.form.getData("AddOrEditModal");c.pointID=$("#pointID").find("option:selected").attr("att_id");delete c.riskAreaCatgName;delete c.drtDeptCode;delete c.enterpriseCode;delete c.optlRiskZoneName;delete c.riskAnlsObjCatg;delete c.riskAnlsObjName;delete c.riskAnlsObjCatg;var d="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){d="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:d,data:$.param(c),dataType:"text",success:function(e){if(e.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(e.collection.error.message)}},error:function(e){var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},setData:function(c){mini.parse();$("#title-main").text(c.title);pageMode=c.pageMode;b.logic.select_option(System_url,$("#systemUID"));b.logic.select_option(CheckType_url,$("#monitorTypeID"));b.logic.select_option(mesureUnit_url,$("#paramMesUnitID"));if(pageMode==PageModelEnum.NewAdd){$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);b.logic.get_list(orgType_url,$("#enterpriseCode"));mini.get("enterpriseCode").on("nodeclick",function(d){enterpriseCode=d.node.orgCode;$("input[name=enterpriseCode]").next(".has-error").remove();b.logic.get_list(riskorg_url,$("#drtDeptCode"),d.node.orgId)});mini.get("drtDeptCode").on("nodeclick",function(d){drtDeptCode=d.node.orgCode;$("input[name=drtDeptCode]").next(".has-error").remove();b.logic.load_risk_menu("")});b.logic.select_option(riskType_url,$("#riskAreaCatg"));b.logic.select_option(riskType_url2+"&riskAreaCatg=S",$("#riskAreaCatgName"),"xx");$("#riskAreaCatg").change(function(){b.logic.select_option(riskType_url2+"&riskAreaCatg="+$("#riskAreaCatg").val(),$("#riskAreaCatgName"),"xx")});b.logic.select_option(oprisktype_url,$("#zoneCatg"));b.logic.select_option(RiskAnlsObj_url,$("#riskAnlsObjCatg"));mini.get("riskAreaCatgName").on("valuechanged",function(){$("input[name=riskAreaCatgName]").next(".has-error").remove();b.logic.load_risk_menu("")});mini.get("riskAreaName").on("valuechanged",function(d){if(d.value==""||d.value=="-1"){mini.get("riskAreaName").setValue("-1");riskAreaID=""}else{riskAreaID=d.selected.riskAreaID}$("input[name=riskAreaName]").next(".has-error").remove();b.logic.load_optrisk_menu("");b.logic.load_rapNameList()});$("#zoneCatg").change(function(){b.logic.load_optrisk_menu("")});mini.get("optlRiskZoneName").on("valuechanged",function(d){if(d.value==""||d.value=="-1"){mini.get("optlRiskZoneName").setValue("-1");optlRiskZoneID="";optlRiskZoneCode=""}else{optlRiskZoneID=d.selected.optlRiskZoneID;optlRiskZoneCode=d.selected.code}$("input[name=optlRiskZoneName]").next(".has-error").remove();b.logic.load_rapNameList();b.logic.load_rapTypeNameList("")});$("#riskAnlsObjCatg").change(function(){b.logic.load_rapTypeNameList("")});mini.get("riskAnlsObjName").on("valuechanged",function(d){$("input[name=riskAnlsObjName]").next(".has-error").remove();if(d.value==""||d.value=="-1"){riskAnlsObjCode=""}else{riskAnlsObjCode=d.selected.code}b.logic.load_rapNameList()});mini.get("riskAreaName").disable();mini.get("optlRiskZoneName").disable();mini.get("riskAnlsObjName").disable();return}else{if(pageMode==PageModelEnum.Edit){mini.get("enterpriseCode").disable();mini.get("drtDeptCode").disable();$("#riskAreaCatg").attr("disabled","disabled");mini.get("riskAreaCatgName").disable();mini.get("riskAreaName").disable();mini.get("optlRiskZoneName").disable();mini.get("riskAnlsObjName").disable();$("#zoneCatg").attr("disabled","disabled");$("#riskAnlsObjCatg").attr("disabled","disabled");$("#pointID").attr("disabled","disabled")}}$.ajax({url:getSingleUrl+"/"+c.siteID+"?now="+Math.random(),type:"get",async:true,dataType:"json",success:function(d){ECS.form.setData("AddOrEditModal",d);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);mini.get("sortNum").setValue(d.sortNum);mini.get("enterpriseCode").setValue(d.enterpriseSname);enterpriseCode=d.enterpriseCode;mini.get("drtDeptCode").setValue(d.drtDeptName);drtDeptCode=d.drtDeptCode;b.logic.create_option($("#riskAreaCatg"),d.riskAreaCatg,d.riskAreaCatgValue);mini.get("riskAreaCatgName").setValue(d.riskAreaCatgName);b.logic.load_risk_menu(d.areaCode,d.areaName);b.logic.create_option($("#zoneCatg"),(d.zoneCatg?d.zoneCatg:""),d.zoneCatgName);b.logic.load_optrisk_menu(d.optlRiskZoneCode,d.optlRiskZoneName);b.logic.create_option($("#riskAnlsObjCatg"),d.riskAnlsObjCatg,d.riskAnlsObjCatgName);b.logic.load_rapTypeNameList(d.riskAnlsObjCode,d.riskAnlsObjName);b.logic.create_option($("#pointID"),d.rapCode,d.rapName,d.pointID);$("#systemUID").val(d.systemUID);$("#paramMesUnitID").val(d.paramMesUnitID);$("#siteNumber").val(d.siteNumber);$("#isFireAlarm").iCheck("update");$("#inUse").iCheck("update")},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},create_option:function(d,g,e,c){var f=null;if(c){f=$('<option value="'+g+'" att_id="'+c+'">'+e+"</option>")}else{f=$('<option value="'+g+'">'+e+"</option>")}d.append(f);d.val(g)},load_rapNameList:function(){var c=rapName_url+"?riskAreaID="+riskAreaID+"&riskCode="+optlRiskZoneCode+"&anlsObjCode="+riskAnlsObjCode;if(!riskAreaID){return false}$.ajax({url:c,type:"GET",success:function(e){$("#pointID").html("");for(var d=0;d<e.length;d++){(function(f){if(f.valueName){$oPtion=$('<option title="'+f.valueName+'" value="'+f.keyCode+'" att_id="'+f.keyId+'">'+f.valueName.substring(0,20)+"</option>");$("#pointID").append($oPtion)}})(e[d])}}})},load_rapTypeNameList:function(e,f){if(e){mini.get("riskAnlsObjName").load([{name:f,code:e}]);mini.get("riskAnlsObjName").setValue(e);return}var c=$("#riskAnlsObjCatg").val(),d=RiskAnlsObjName_url+"&optlRiskZoneID="+optlRiskZoneID+"&riskAnlsObjCatg="+c;if(optlRiskZoneID){b.logic.selectCombox(d,"#riskAnlsObjName");mini.get("riskAnlsObjName").enable();if(f){mini.get("riskAnlsObjName").setValue(f);mini.get("riskAnlsObjName").disable()}}else{mini.get("riskAnlsObjName").disable();mini.get("riskAnlsObjName").setValue("-1")}},load_optrisk_menu:function(d,e){if(d){mini.get("optlRiskZoneName").load([{name:e,code:d}]);mini.get("optlRiskZoneName").setValue(d);return}var f=$("#zoneCatg").val();if(riskAreaID){var c=oprisk_url+"&riskAreaID="+riskAreaID+"&zoneCatg="+f;b.logic.selectCombox(c,"#optlRiskZoneName");mini.get("optlRiskZoneName").enable()}else{mini.get("optlRiskZoneName").disable();mini.get("optlRiskZoneName").setValue("-1")}mini.get("riskAnlsObjName").disable();mini.get("riskAnlsObjName").setValue("-1")},selectCombox:function(c,d){$.ajax({url:c,type:"get",async:false,success:function(e){mini.get(d).load(e);mini.get(d).setValue("-1")}})},load_risk_menu:function(c,k){if(c){mini.get("riskAreaName").load([{riskAreaName:k,riskAreaCode:c}]);mini.get("riskAreaName").setValue(c);return}var h=mini.get("riskAreaCatgName").getCheckedNodes(true);var e="";var d="";var j="";if(h.length>0){for(var f=0;f<h.length;f++){(function(i){if(i.categID==""){e="";d="";j=""}else{if(i.categID.indexOf("sm")!=-1){e=i.code}else{if(i.categID.indexOf("md")!=-1){d=i.code}else{if(i.categID.indexOf("bg")!=-1){j=i.code}}}}})(h[f])}}var g=$("#riskAreaCatg").val();if(drtDeptCode){var l=riskAreaName_url+"?enterpriseCode="+enterpriseCode+"&drtDeptCode="+drtDeptCode+"&areaSmCatg="+e+"&areaMdCatg="+d+"&areaBgCatg="+j+"&riskAreaCatg="+g;b.logic.selectCombox(l,"#riskAreaName");mini.get("riskAreaName").enable()}else{mini.get("riskAreaName").disable();mini.get("riskAreaName").setValue("-1")}mini.get("optlRiskZoneName").disable();mini.get("optlRiskZoneName").setValue("-1");mini.get("riskAnlsObjName").disable();mini.get("riskAnlsObjName").setValue("-1")},get_list:function(d,g,f,c){if(f){var e=d+"?orgPID="+f+"&orgLvl=3"}else{var e=d+"?orgLvl=2"}$.ajax({url:e,type:"GET",success:function(i){if(f){mini.get("drtDeptCode").loadList(i,"orgId","orgPID");if(i.length>0){if(i[0].orgPID){for(var h=0;h<i.length;h++){if(i[h].orgId==i[0].orgPID){mini.get("drtDeptCode").setValue(i[h].orgSname);drtDeptCode=i[h].orgCode}}drtDeptPID=i[0].orgPID}else{mini.get("drtDeptCode").setValue(i[0].orgSname);drtDeptCode=i[0].orgCode}}c&&c()}else{mini.get("enterpriseCode").loadList(i,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname);b.logic.get_list(riskorg_url,$("#drtDeptCode"),mini.get("enterpriseCode").data[0].orgId)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var h=0;h<i.length;h++){(function(j){if(j.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(j.orgSname);b.logic.get_list(riskorg_url,$("#drtDeptCode"),j.orgId)}})(i[h])}}c&&c()}}})},select_option:function(d,e,c){$.ajax({url:d,type:"GET",success:function(g){if(c&&(typeof c!="function")){mini.get("riskAreaCatgName").loadList(g,"categID","gcategID");b.logic.load_risk_menu("")}else{$(e).html("");$("#riskAreaCatg").find("option[value=S]").attr("selected",true);for(var f=0;f<g.length;f++){(function(i){if(i.key||i.key==0){var h=$('<option title="'+i.value+'" value="'+i.key+'">'+i.value.substring(0,20)+"</option>")}$(e).append(h)})(g[f])}c&&c()}}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){jQuery.validator.addMethod("ucode",function(d,c,f){var e=new RegExp(f);return e.test(d)},"请输入正确格式!");ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{enterpriseCode:{required:true},drtDeptCode:{required:true},riskAreaName:{required:true},pointID:{required:true},monitorTypeID:{required:true},siteName:{required:true},systemUID:{required:true},paramMesUnitID:{required:true},siteNumber:{required:true,ucode:/^[A-Za-z0-9\$\#\.\:\_\-]+$/},sortNum:{required:true,digits:true,min:0}}})}}};b.init();window.page=b});