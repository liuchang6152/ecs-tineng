var addUrl=ECS.api.bcUrl+"/riskRank";var getSingleUrl=ECS.api.bcUrl+"/riskRank";var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();b.logic.cbxOrgID();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});$("#isPickup").iCheck({checkboxClass:"icheckbox_minimal-blue"});$("#isSendSMS").iCheck({checkboxClass:"icheckbox_minimal-blue"});$("#isPhoneCall").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#lossRank").change(function(){$("#rankDisplay").val($(this).find("option:selected").text()+$("#possibilityRank").val())});$("#possibilityRank").change(function(){$("#rankDisplay").val($("#lossRank").find("option:selected").text()+$("#possibilityRank").val())})},logic:{save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var c=ECS.form.getData("AddOrEditModal");var d="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){d="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$.ajax({url:addUrl,async:false,type:d,data:$.param(c),dataType:"text",success:function(e){if(e.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(e.collection.error.message)}},error:function(e){var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},cbxOrgID:function(){if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){ECS.ui.getCombobox("enterpriseCode",enterpriseCodeUrl,{selectFirstRecord:true,keyField:"orgCode",valueField:"orgSname",async:false})}else{ECS.ui.getCombobox("enterpriseCode",enterpriseCodeUrl,{selectValue:ECS.sys.Context.SYS_ENTERPRISE_CODE,keyField:"orgCode",valueField:"orgSname",async:false});$("#enterpriseCode").attr("disabled",true)}},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;if(pageMode==PageModelEnum.NewAdd){$("#rankDisplay").val("A1");return}else{$("#enterpriseCode").attr("disabled","disabled")}$.ajax({url:getSingleUrl+"/"+c.riskRankID+"?now="+Math.random(),type:"get",async:true,dataType:"json",success:function(d){ECS.form.setData("AddOrEditModal",d);$("#isPickup").iCheck("update");$("#isSendSMS").iCheck("update");$("#isPhoneCall").iCheck("update");$("#inUse").iCheck("update")},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{enterpriseCode:{required:true},lossRank:{required:true},possibilityRank:{required:true},rankDisplay:{required:true}}})}}};b.init();window.page=b});