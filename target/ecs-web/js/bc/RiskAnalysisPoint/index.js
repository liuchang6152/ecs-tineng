var delUrl=ECS.api.bcUrl+"/riskAnalysisPoint";var searchUrl=ECS.api.bcUrl+"/riskAnalysisPoint";var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var drtDeptCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=3&isAll=true";var riskAreaEnumListUrl=ECS.api.bcUrl+"/riskArea/getRiskAreaEnumList?isAll=true";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/riskArea/getCategObj?isAll=true";var riskAreaNameUrl=ECS.api.bcUrl+"/riskArea/getAllList?isAll=true";var zoneCatgUrl=ECS.api.bcUrl+"/optlRiskZone/getOptlZoneCatgEnumList?isAll=true";var optlRiskNameUrl=ECS.api.bcUrl+"/optlRiskZone/getAllList?isAll=true";var riskAnlsObjCatgUrl=ECS.api.bcUrl+"/riskAnlsObj/getRiskObjCatgEnumList?isAll=true";var riskAnlsObjNameUrl=ECS.api.bcUrl+"/riskAnlsObj/getAllList?isAll=true";var inUseUrl=ECS.api.commonUrl+"/getInUse";var exportUrl=ECS.api.bcUrl+"/riskAnalysisPoint/ExportToExcel";var importUrl=ECS.api.bcUrl+"/riskAnalysisPoint/importExcelData";window.pageLoadMode=PageLoadMode.None;var uploader;var flag=false;var grid=null;var smCatg="";var mdCatg="";var bgCatg="";var enterpriseCode="";var drtDeptCode="";var riskAreaID="";var optlRiskZoneID="";pageflag=true;redisKey="";$(function(){var a={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS();$("#searchForm").find("input").val("");a.logic.inUse();a.logic.initTable();a.logic.upload();a.logic.initOrgCode(enterpriseCodeUrl,$("#enterpriseCode"));a.logic.cbxRiskAreaEnumList();a.logic.cbxRiskAreaCatg("");a.logic.cbxZoneCatg();a.logic.cbxRiskAnlsObjCatg();mini.get("riskAreaCode").disable();mini.get("optlRiskCode").disable();mini.get("riskAnlsObjCode").disable()},table:{},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnToggle").click(function(){if(flag){flag=!flag;$(this).html('<i class="icon-showMore"></i>');$(".search-unfixed").hide()}else{flag=!flag;$(this).html('<i class="icon-hideMore"></i>');$(".search-unfixed").show()}});$("#btnAdd").click(function(){a.logic.add("新增","",PageModelEnum.NewAdd)});$("#btnImp").click(function(){a.logic.imp()});$("#btnExport").click(function(){a.data.param={};a.data.param=ECS.form.getData("searchForm");a.data.param.areaBgCatg=bgCatg;a.data.param.areaMdCatg=mdCatg;a.data.param.areaSmCatg=smCatg;delete a.data.param.riskAreaCatgCode;a.data.param.enterpriseCode=enterpriseCode;a.data.param.drtDeptCode=drtDeptCode;if(mini.get("riskAreaCode").getSelected()&&mini.get("riskAreaCode").getSelected().riskAreaCode!="-1"){a.data.param.riskAreaCode=mini.get("riskAreaCode").getSelected().riskAreaCode}if(mini.get("optlRiskCode").getSelected()&&mini.get("optlRiskCode").getSelected().code!="-1"){a.data.param.optlRiskCode=mini.get("optlRiskCode").getSelected().code}if(mini.get("riskAnlsObjCode").getSelected()&&mini.get("riskAnlsObjCode").getSelected().code!="-1"){a.data.param.riskAnlsObjCode=mini.get("riskAnlsObjCode").getSelected().code}var b=a.logic.setUrlK(a.data.param);window.open(exportUrl+"?"+b)});mini.get("enterpriseCode").on("nodeclick",function(b){if(b.node.orgCode=="-1"){enterpriseCode=""}else{enterpriseCode=b.node.orgCode}a.logic.cbxDrtDeptCode(drtDeptCodeUrl,$("#drtDeptCode"),b.node.orgId)});mini.get("drtDeptCode").on("nodeclick",function(b){if(b.node.orgCode=="-1"){drtDeptCode=""}else{drtDeptCode=b.node.orgCode}a.logic.cbxRiskAreaName()});mini.get("riskAreaCatgCode").on("nodeclick",function(c){var b=c.node.code;if(c.node.categID.indexOf("sm")!=-1){smCatg=b;mdCatg="";bgCatg=""}if(c.node.categID.indexOf("md")!=-1){mdCatg=b;smCatg="";bgCatg=""}if(c.node.categID.indexOf("bg")!=-1){bgCatg=b;smCatg="";mdCatg=""}a.logic.cbxRiskAreaName()});mini.get("riskAreaCode").on("valuechanged",function(b){if(b.value==""||b.value=="-1"){mini.get("riskAreaCode").setValue("-1");riskAreaID=""}else{riskAreaID=b.selected.riskAreaID}a.logic.cbxOptlRiskName()});mini.get("optlRiskCode").on("valuechanged",function(b){if(b.value==""||b.value=="-1"){mini.get("optlRiskCode").setValue("-1");optlRiskZoneID=""}else{optlRiskZoneID=b.selected.optlRiskZoneID}a.logic.cbxRiskAnlsObjName()});$("#btnDel").click(function(){a.logic.delAll()});$("#btnExport").click(function(){window.open(exportUrl+"?enterpriseCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE)});$("#btnQuery").click(function(){a.logic.search()})},data:{param:{}},logic:{setUrlK:function(f){var d="",b,c;for(var e in f){if(f.hasOwnProperty(e)){b=e}c=f[e];d+="&"+b+"="+encodeURIComponent(c)}return d.substring(1,d.length)},initTable:function(){grid=mini.get("datagrid");grid.set({url:searchUrl,ajaxType:"get",dataField:"pageList"})},show_edit:function(b){return ECS.util.editRender(b.row.pointID)},initOrgCode:function(b,c){$.ajax({url:b,type:"get",success:function(e){mini.get("enterpriseCode").loadList(e,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname);a.logic.cbxDrtDeptCode(drtDeptCodeUrl,$("#drtDeptCode"),mini.get("enterpriseCode").data[0].orgId)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var d=0;d<e.length;d++){(function(f){if(f.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(f.orgSname);a.logic.cbxDrtDeptCode(drtDeptCodeUrl,$("#drtDeptCode"),f.orgId)}})(e[d])}}grid.load({enterpriseCode:enterpriseCode})}})},cbxDrtDeptCode:function(c,d,b){$.ajax({url:c+"&orgPID="+b,type:"get",success:function(e){mini.get("drtDeptCode").loadList(e,"orgId","orgPID");mini.get("drtDeptCode").setValue("全部");a.logic.cbxRiskAreaName()}})},cbxRiskAreaEnumList:function(){ECS.ui.getCombobox("riskAreaCatg",riskAreaEnumListUrl,{selectValue:""},null,a.logic.cbxRiskAreaCatg)},cbxRiskAreaCatg:function(b){$.ajax({url:riskAreaTypeNameUrl+"&riskAreaCatg="+b,type:"get",success:function(c){mini.get("riskAreaCatgCode").loadList(c,"categID","gcategID");mini.get("riskAreaCatgCode").setValue("全部")}});bgCatg="";mdCatg="";smCatg="";a.logic.cbxRiskAreaName()},selectCombox:function(b,c){$.ajax({url:b,type:"get",success:function(d){mini.get(c).load(d);mini.get(c).setValue("-1")}})},cbxRiskAreaName:function(){var c=$("#riskAreaCatg").val();if(drtDeptCode){var b=riskAreaNameUrl+"&enterpriseCode="+enterpriseCode+"&drtDeptCode="+drtDeptCode+"&areaSmCatg="+smCatg+"&areaMdCatg="+mdCatg+"&areaBgCatg="+bgCatg+"&riskAreaCatg="+c;a.logic.selectCombox(b,"#riskAreaCode");mini.get("riskAreaCode").enable()}else{mini.get("riskAreaCode").disable();mini.get("riskAreaCode").setValue("-1")}mini.get("optlRiskCode").disable();mini.get("optlRiskCode").setValue("-1");mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")},cbxZoneCatg:function(){ECS.ui.getCombobox("zoneCatg",zoneCatgUrl,{selectValue:"",},null,a.logic.cbxOptlRiskName)},cbxOptlRiskName:function(){var b=$("#zoneCatg").val();if(riskAreaID){a.logic.selectCombox(optlRiskNameUrl+"&riskAreaID="+riskAreaID+"&zoneCatg="+b,"#optlRiskCode");mini.get("optlRiskCode").enable()}else{mini.get("optlRiskCode").disable();mini.get("optlRiskCode").setValue("-1")}mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")},cbxRiskAnlsObjCatg:function(){ECS.ui.getCombobox("riskAnlsObjCatg",riskAnlsObjCatgUrl,{selectValue:"",},null,a.logic.cbxRiskAnlsObjName)},cbxRiskAnlsObjName:function(){var b=$("#riskAnlsObjCatg").val(),c=riskAnlsObjNameUrl+"&optlRiskZoneID="+optlRiskZoneID+"&riskAnlsObjCatg="+b;if(optlRiskZoneID){a.logic.selectCombox(c,"#riskAnlsObjCode");mini.get("riskAnlsObjCode").enable()}else{mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")}},inUse:function(){ECS.ui.getCombobox("inUse",inUseUrl,{selectValue:-1,data:{isAll:true}},null)},delAll:function(){var b=[];var c=grid.getSelecteds();$.each(c,function(d,e){b.push(e.pointID)});if(b.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:true,data:JSON.stringify(b),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",beforeSend:function(){layer.closeAll();ECS.showLoading()},success:function(d){ECS.hideLoading();if(d.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){grid.reload()})}else{d=JSON.parse(d);layer.msg(d.collection.error.message)}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},function(d){layer.close(d)})},upload:function(){uploader=new plupload.Uploader({browse_button:"btnImport",url:importUrl,filters:{mime_types:[{title:"xlsx files",extensions:"xlsx"}]}});uploader.init();uploader.bind("FilesAdded",function(c,b){if(b[0].name.length>50){c.removeFile(b[0]);layer.msg("文件名称不能超过50个字符！");return}if(c.files.length>0){c.start()}});uploader.bind("UploadProgress",function(c,b){layer.msg("正在导入文件请耐心等待！")});uploader.bind("FileUploaded",function(g,d,b){var e=JSON.parse(b.response);var f="";if(e[0].isSuccess){layer.msg("导入成功！");a.logic.search()}else{for(var c=0;c<e.length;c++){f+="<p>"+(parseInt(c)+1)+"、"+e[c].message+"</p>"}a.logic.importDetail("导入数据错误",f,PageModelEnum.Details)}})},importDetail:function(d,b,c){layer.open({type:2,closeBtn:0,area:["800px","400px"],skin:"new-class",shadeClose:false,title:false,content:"RiskAnalysisPointDataError.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,errorTip:b,};i.page.logic.setData(h)},end:function(){a.logic.search();window.pageLoadMode=PageLoadMode.Refresh}})},add:function(){var b=PageModelEnum.NewAdd;var c="风险分析点新增";a.logic.detail(c,"",b)},edit:function(d){var b=PageModelEnum.Edit;var c="风险分析点编辑";a.logic.detail(c,d,b)},detail:function(c,d,b){layer.open({type:2,closeBtn:0,area:["900px","500px"],skin:"new-class",shadeClose:false,title:false,content:"RiskAnalysisPointAddOrEdit.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:b,pointID:d,title:c};i.page.logic.setData(h)},end:function(){if(window.pageLoadMode==PageLoadMode.Refresh){a.logic.search(true);window.pageLoadMode=PageLoadMode.Refresh}else{if(window.pageLoadMode==PageLoadMode.Reload){a.logic.search(true);window.pageLoadMode=PageLoadMode.Reload}}}})},search:function(b){a.data.param={};a.data.param=ECS.form.getData("searchForm");a.data.param.areaBgCatg=bgCatg;a.data.param.areaMdCatg=mdCatg;a.data.param.areaSmCatg=smCatg;delete a.data.param.riskAreaCatgCode;if(b){a.data.param={};a.data.param.sortType=1}a.data.param.enterpriseCode=enterpriseCode;a.data.param.drtDeptCode=drtDeptCode;if(mini.get("riskAreaCode").getSelected()&&mini.get("riskAreaCode").getSelected().riskAreaCode!="-1"){a.data.param.riskAreaCode=mini.get("riskAreaCode").getSelected().riskAreaCode}if(mini.get("optlRiskCode").getSelected()&&mini.get("optlRiskCode").getSelected().code!="-1"){a.data.param.optlRiskCode=mini.get("optlRiskCode").getSelected().code}if(mini.get("riskAnlsObjCode").getSelected()&&mini.get("riskAnlsObjCode").getSelected().code!="-1"){a.data.param.riskAnlsObjCode=mini.get("riskAnlsObjCode").getSelected().code}grid.load(a.data.param)},imp:function(){var c=ECS.api.bcUrl+"/riskAnalysisPoint/importExcel";var b=ECS.api.bcUrl+"/riskAnalysisPoint/ExportExcel";var e=ECS.api.bcUrl+"/riskAnalysisPoint/importAddAll";var d="../UploadFile/UploadFile.html?"+Math.random();ECS.util.importExcel(c,b,e,d)}}};a.init();window.page=a});