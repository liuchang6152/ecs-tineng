var addUrl=ECS.api.bcUrl+"/riskAnalysisPoint";var getSingleUrl=ECS.api.bcUrl+"/riskAnalysisPoint";var enterpriseCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=2";var drtDeptCodeUrl=ECS.api.bcUrl+"/org/porgName?orgLvl=3";var riskAreaEnumListUrl=ECS.api.bcUrl+"/riskArea/getRiskAreaEnumList";var riskAreaTypeNameUrl=ECS.api.bcUrl+"/riskArea/getCategObj";var riskAreaNameUrl=ECS.api.bcUrl+"/riskArea/getAllList";var zoneCatgUrl=ECS.api.bcUrl+"/optlRiskZone/getOptlZoneCatgEnumList?showPleaseSelect=true";var optlRiskNameUrl=ECS.api.bcUrl+"/optlRiskZone/getAllList?showPleaseSelect=true";var riskAnlsObjCatgUrl=ECS.api.bcUrl+"/riskAnlsObj/getRiskObjCatgEnumList?showPleaseSelect=true";var riskAnlsObjNameUrl=ECS.api.bcUrl+"/riskAnlsObj/getAllList?showPleaseSelect=true";var disasterTypeUrl=ECS.api.bcUrl+"/riskAnalysisPoint/getListByParam?param=disasterType";var highRiskLvlUrl=ECS.api.bcUrl+"/riskAnalysisPoint/getListByParam?param=highRiskLvl";var pageMode=PageModelEnum.NewAdd;var editUserName=[];var usernameList=[];var userIDList=[];var smCatg="";var mdCatg="";var bgCatg="";var enterpriseCode="";var drtDeptCode="";var riskAreaID="";var optlRiskZoneID="";window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();ECS.sys.RefreshContextFromSYS();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();b.logic.initOrgCode(enterpriseCodeUrl,$("#enterpriseCode"));b.logic.cbxRiskAreaEnumList();b.logic.cbxRiskAreaType("S");b.logic.cbxDisasterType();b.logic.cbxZoneCatg();b.logic.cbxRiskAnlsObjCatg();mini.get("riskAreaCode").disable();mini.get("optlRiskCode").disable();mini.get("riskAnlsObjCode").disable()},bindUI:function(){$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});mini.get("enterpriseCode").on("nodeclick",function(c){enterpriseCode=c.node.orgCode;editUserName=[];$("#userName").html("");$("#userID").val("");$("input[name=enterpriseCode]").next(".has-error").remove();b.logic.cbxHighRiskLvl(c.node.orgCode);b.logic.cbxDrtDeptCode(drtDeptCodeUrl,$("#drtDeptCode"),c.node.orgId)});mini.get("drtDeptCode").on("nodeclick",function(c){drtDeptCode=c.node.orgCode;$("input[name=drtDeptCode]").next(".has-error").remove();b.logic.cbxRiskAreaName("")});mini.get("riskAreaCatgCode").on("nodeclick",function(d){$("input[name=riskAreaCatgCode]").next(".has-error").remove();var c=d.node.code;if(d.node.categID.indexOf("sm")!=-1){smCatg=c;mdCatg="";bgCatg=""}if(d.node.categID.indexOf("md")!=-1){mdCatg=c;smCatg="";bgCatg=""}if(d.node.categID.indexOf("bg")!=-1){bgCatg=c;smCatg="";mdCatg=""}b.logic.cbxRiskAreaName("")});mini.get("riskAreaCode").on("valuechanged",function(c){if(c.value==""||c.value=="-1"){mini.get("riskAreaCode").setValue("-1");riskAreaID=""}else{riskAreaID=c.selected.riskAreaID}$("input[name=riskAreaCode]").next(".has-error").remove();b.logic.cbxOptlRiskName("");b.logic.cbxRiskAnlsObjName("")});mini.get("optlRiskCode").on("valuechanged",function(c){if(c.value==""||c.value=="-1"){mini.get("optlRiskCode").setValue("-1");optlRiskZoneID=""}else{optlRiskZoneID=c.selected.optlRiskZoneID}$("input[name=optlRiskCode]").next(".has-error").remove();b.logic.cbxRiskAnlsObjName("")});$("#selectOwner").click(function(){b.logic.selectOwner("人员选择(多选)",PageModelEnum.Details)})},logic:{setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;if(pageMode==PageModelEnum.NewAdd){$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});$("#crtUserName").val(ECS.sys.Context.SYS_USER_NAME);$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);return}else{if(pageMode==PageModelEnum.Edit){$("#enterpriseCode-text").html('<input name="orgSname" type="text" class="form-control" id="orgSname" disabled="disabled" /><input name="enterpriseCode" type="hidden" id="enterpriseCode" />');$("#orgName-text").html('<input name="drtDeptSname" type="text" class="form-control" id="drtDeptSname" disabled="disabled" />');$("#riskAreaCatg").attr("disabled","disabled");$("#zoneCatg").attr("disabled","disabled");$("#riskAnlsObjCatg").attr("disabled","disabled")}}$.ajax({url:getSingleUrl+"/"+c.pointID+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(e){ECS.hideLoading();ECS.form.setData("AddOrEditModal",e);enterpriseCode=e.enterpriseCode;$("#mntUserName").val(ECS.sys.Context.SYS_USER_NAME);mini.get("sortNum").setValue(e.sortNum);if(e.smCategName){$("#riskAreaCatgName-text").html('<input name="smCategName" type="text" class="form-control" id="smCategName" value="'+e.smCategName+'" disabled="disabled" />')}else{if(e.mdCategName){$("#riskAreaCatgName-text").html('<input name="mdCategName" type="text" class="form-control" id="mdCategName" value="'+e.mdCategName+'" disabled="disabled" />')}else{if(e.bgCategName){$("#riskAreaCatgName-text").html('<input name="bgCategName" type="text" class="form-control" id="bgCategName" value="'+e.bgCategName+'" disabled="disabled" />')}}}editUserName=[];usernameList=[];userIDList=[];if(e.userMap){for(var f in e.userMap){usernameList+=e.userMap[f]+"<br/>"}for(var d in e.userMap){editUserName.push(e.userMap[d])}$("#userName").val(usernameList);for(var d in e.userMap){userIDList.push(d)}$("#userName").html(usernameList);$("#userID").val(userIDList)}$("#inUse").iCheck("update");b.logic.cbxRiskAreaName(e.riskAreaCode,e.riskAreaSname);b.logic.cbxOptlRiskName(e.optlRiskCode,e.optlRiskSname);b.logic.cbxRiskAnlsObjName(e.riskAnlsObjCode,e.riskAnlsObjName)},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},initOrgCode:function(c){$.ajax({url:c,type:"get",success:function(e){mini.get("enterpriseCode").loadList(e,"orgId","orgPID");if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){enterpriseCode=mini.get("enterpriseCode").data[0].orgCode;mini.get("enterpriseCode").setValue(mini.get("enterpriseCode").data[0].orgSname);b.logic.cbxDrtDeptCode(drtDeptCodeUrl,$("#drtDeptCode"),mini.get("enterpriseCode").data[0].orgId);b.logic.cbxHighRiskLvl(mini.get("enterpriseCode").data[0].orgCode)}else{enterpriseCode=ECS.sys.Context.SYS_ENTERPRISE_CODE;mini.get("enterpriseCode").disable();for(var d=0;d<e.length;d++){(function(f){if(f.orgCode==ECS.sys.Context.SYS_ENTERPRISE_CODE){mini.get("enterpriseCode").setValue(f.orgSname);b.logic.cbxHighRiskLvl(ECS.sys.Context.SYS_ENTERPRISE_CODE);b.logic.cbxDrtDeptCode(drtDeptCodeUrl,$("#drtDeptCode"),f.orgId)}})(e[d])}}}})},cbxDrtDeptCode:function(d,e,c){$.ajax({url:d+"&orgPID="+c,type:"get",success:function(f){mini.get("drtDeptCode").loadList(f,"orgId","orgPID")}})},cbxRiskAreaEnumList:function(){ECS.ui.getCombobox("riskAreaCatg",riskAreaEnumListUrl,{selectValue:"S",},null,b.logic.cbxRiskAreaType)},cbxRiskAreaType:function(c){$.ajax({url:riskAreaTypeNameUrl+"?riskAreaCatg="+c,type:"get",async:false,success:function(d){mini.get("riskAreaCatgCode").loadList(d,"categID","gcategID");b.logic.cbxRiskAreaName("")}})},selectCombox:function(c,d){$.ajax({url:c,type:"get",async:false,success:function(e){mini.get(d).load(e);mini.get(d).setValue("-1")}})},cbxRiskAreaName:function(e,f){if(e){mini.get("riskAreaCode").load([{riskAreaName:f,riskAreaCode:e}]);mini.get("riskAreaCode").setValue(e);return}var c=$("#riskAreaCatg").val();if(drtDeptCode){var d=riskAreaNameUrl+"?enterpriseCode="+enterpriseCode+"&drtDeptCode="+drtDeptCode+"&areaSmCatg="+smCatg+"&areaMdCatg="+mdCatg+"&areaBgCatg="+bgCatg+"&riskAreaCatg="+c;b.logic.selectCombox(d,"#riskAreaCode");mini.get("riskAreaCode").enable()}else{mini.get("riskAreaCode").disable();mini.get("riskAreaCode").setValue("-1")}mini.get("optlRiskCode").disable();mini.get("optlRiskCode").setValue("-1");mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")},cbxZoneCatg:function(){ECS.ui.getCombobox("zoneCatg",zoneCatgUrl,{selectValue:"",async:false},null,b.logic.cbxOptlRiskName)},cbxOptlRiskName:function(c,d){if(d){mini.get("optlRiskCode").load([{name:d,code:c}]);mini.get("optlRiskCode").setValue(c);return}var e=$("#zoneCatg").val();if(riskAreaID){b.logic.selectCombox(optlRiskNameUrl+"&riskAreaID="+riskAreaID+"&zoneCatg="+e,"#optlRiskCode");mini.get("optlRiskCode").enable()}else{mini.get("optlRiskCode").disable();mini.get("optlRiskCode").setValue("-1")}mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")},cbxRiskAnlsObjCatg:function(){ECS.ui.getCombobox("riskAnlsObjCatg",riskAnlsObjCatgUrl,{selectValue:"",},null,b.logic.cbxRiskAnlsObjName)},cbxRiskAnlsObjName:function(e,f){if(f){mini.get("riskAnlsObjCode").load([{name:f,code:e}]);mini.get("riskAnlsObjCode").setValue(e);return}var c=$("#riskAnlsObjCatg").val(),d=riskAnlsObjNameUrl+"&optlRiskZoneID="+optlRiskZoneID+"&riskAnlsObjCatg="+c;if(optlRiskZoneID){b.logic.selectCombox(d,"#riskAnlsObjCode");mini.get("riskAnlsObjCode").enable()}else{mini.get("riskAnlsObjCode").disable();mini.get("riskAnlsObjCode").setValue("-1")}},cbxDisasterType:function(){ECS.ui.getCombobox("disasterType",disasterTypeUrl,{keyField:"ID",valueField:"NAME",async:false},null)},cbxHighRiskLvl:function(c){ECS.ui.getCombobox("highRiskLvl",highRiskLvlUrl+"&name="+c,{keyField:"ID",valueField:"NAME",async:false},null)},selectOwner:function(d,c){layer.open({type:2,closeBtn:0,area:["700px","450px"],skin:"new-class",shadeClose:false,title:false,content:"SelectOwner.html?"+Math.random(),success:function(f,g){var e=layer.getChildFrame("body",g);var i=window[f.find("iframe")[0]["name"]];var h={pageMode:c,title:d,userId:$("#userID").val(),orgCode:enterpriseCode,userName:editUserName};i.page.logic.setData(h)},end:function(){editUserName=[];usernameList=[];userIDList=[];for(var f in window.ownDetail){usernameList+=window.ownDetail[f]+"<br/>"}for(var e in window.ownDetail){editUserName.push(window.ownDetail[e])}for(var e in window.ownDetail){userIDList.push(e)}$("#userName").html(usernameList);$("#userID").val(userIDList)}})},save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var g=ECS.form.getData("AddOrEditModal");g.enterpriseCode=enterpriseCode;var d=[];var c=[];if(g.userID.length>0){d=g.userID.split(",")}delete g.enterpriseName;delete g.riskAreaCatgName;delete g.riskAnlsObjCatg;delete g.riskAreaCatg;delete g.riskAreaCatgCode;delete g.zoneCatg;for(var f in g){g[f]=$.trim(g[f])}var h="POST";if(pageMode==PageModelEnum.NewAdd){if(d.length>0){for(var e=0;e<d.length;e++){c.push({userID:d[e]})}}window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){if(d.length>0){for(var e=0;e<d.length;e++){c.push({userID:d[e],pointID:$("#pointID").val()})}}h="PUT";window.pageLoadMode=PageLoadMode.Refresh}}g.rapUserEntity=c;delete g.userID;delete g.userName;$.ajax({url:addUrl,async:false,type:h,data:JSON.stringify(g),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(i){ECS.hideLoading();if(i.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(i.collection.error.message)}},error:function(i){$("#btnSave").attr("disabled",false);ECS.hideLoading();var j=$.parseJSON(i.responseText);layer.msg(j.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){jQuery.validator.addMethod("ucode",function(d,c,f){var e=new RegExp(f);return e.test(d)},"只能输入字母和数字!");ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{drtDeptCode:{required:true},riskAreaCatg:{required:true},riskAreaCatgCode:{required:true},riskAreaCode:{required:true},rapName:{required:true,maxlength:200},highRiskLvl:{required:true},disasterType:{required:true},rapDes:{maxlength:200},biasTerm:{maxlength:200},majConsequence:{maxlength:200},personnelLoss:{maxlength:200},propertyLoss:{maxlength:200},nonPropertyLoss:{maxlength:200},sortNum:{required:true,digits:true,min:0}}})}}};b.init();window.page=b});