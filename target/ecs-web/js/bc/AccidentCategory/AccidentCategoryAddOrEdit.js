var addUrl=ECS.api.bcUrl+"/accidentCategory";var getSingleUrl=ECS.api.bcUrl+"/accidentCategory";var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){this.bindUI()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("body").on("blur",".input",function(){$(this).closest(".form-groups").remove()});$("#btnSave").click(function(){if($("#firstName").val().length>0){layer.msg("您的“子类名称”输入区的最下边输入框存在内容，如需增加请点击加号，否则请清空后保存！！",{time:4000});return}b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});$("#addNewName").click(function(){if($("#firstName").val()!=""){$("#nameList").append('<div class="form-groups"><div class="col-xs-9"><input type="text" class="form-control required" maxlength="200" onblur="$(this).val($.trim($(this).val()))" value="'+$("#firstName").val()+'"/></div><span class="span-required">*</span><button class="btn btn-danger delName" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div>');$("#firstName").val("")}else{layer.msg("新增的子类名称不能为空！")}});$("#nameList").on("click",".delName",function(){$(this).closest(".form-groups").remove()})},logic:{setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;if(pageMode==PageModelEnum.NewAdd){return}$.ajax({url:getSingleUrl+"/"+c.accidentCategoryID+"?now="+Math.random(),type:"get",async:true,dataType:"json",beforeSend:function(){ECS.showLoading()},success:function(e){ECS.hideLoading();ECS.form.setData("AddOrEditModal",e);for(var d=0;d<e.accidentTypeEntityList.length;d++){$("#nameList").append('<div class="form-groups"><div class="col-xs-9"><input type="text" class="form-control required" onblur="$(this).val($.trim($(this).val()))" id="'+e.accidentTypeEntityList[d].accidentTypeID+'" maxlength="200" value="'+e.accidentTypeEntityList[d].accidentTypeName+'" /></div><span class="span-required">*</span><button class="btn btn-danger delName" type="button" title="删除"><span class="glyphicon glyphicon-minus"></span></button></div>')}},error:function(d){ECS.hideLoading();var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},save:function(){b.logic.formValidate();$("#AddOrEditModal").find("input[class=form-control]").each(function(){$(this).val($.trim($(this).val()))});if(!$("#AddOrEditModal").valid()){return}if($("#nameList").html()==""){layer.msg("请填写子类名称并点击增加按钮！");return}var f=[];var e="POST";if(pageMode==PageModelEnum.NewAdd){$("#nameList").find(".form-control").each(function(g){f.push({accidentTypeName:$(this).val(),inUse:"1",sortNum:g})});window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){$("#nameList").find(".form-control").each(function(g){f.push({accidentTypeID:$(this).attr("id"),accidentTypeName:$(this).val(),inUse:"1",sortNum:g,accidentCategoryID:$("#accidentCategoryID").val()})});e="PUT";window.pageLoadMode=PageLoadMode.Refresh}}$("#accidentTypeEntityList").val(JSON.stringify(f));var d=ECS.form.getData("AddOrEditModal");var c=JSON.parse(d.accidentTypeEntityList);d.accidentTypeEntityList=c;delete d.firstName;$.ajax({url:addUrl,async:false,type:e,data:JSON.stringify(d),dataType:"text",contentType:"application/json;charset=utf-8",beforeSend:function(){$("#btnSave").attr("disabled","disabled");ECS.showLoading()},success:function(g){ECS.hideLoading();if(g.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(g.collection.error.message)}},error:function(g){$("#btnSave").attr("disabled",false);ECS.hideLoading();var h=$.parseJSON(g.responseText);layer.msg(h.collection.error.message)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){ECS.form.formValidate("AddOrEditModal",{rules:{accidentCategoryName:{required:true,maxlength:200},firstName:{maxlength:200}}})}}};b.init();window.page=b});