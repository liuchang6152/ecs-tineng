var importUrl;var exportUrl;var confirmUrl;var pageMode=PageModelEnum.Details;window.pageLoadMode=PageLoadMode.None;var mini;var uploader;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();this.bindUI();ECS.sys.RefreshContextFromSYS()},table:{},data:{param:{}},bindUI:function(){$("#btnSave").click(function(){if(uploader.files.length>0){uploader.start()}});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(true)})},logic:{setData:function(c){$("#title-main").text(c.title);importUrl=c.url;exportUrl=c.exportUrl;confirmUrl=c.confirmUrl+"?orgCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE;b.logic.upload()},start:function(){},upload:function(){uploader=new plupload.Uploader({browse_button:"upload_btn",drop_element:"upload_box",url:importUrl,multipart_params:{},filters:{mime_types:[{title:"EXcel",extensions:"xls,xlsx"}],max_file_size:"40000kb",prevent_duplicates:true},init:{BeforeUpload:function(c,d){console.log("[BeforeUpload]","File: ",d);uploader.setOption("multipart_params",{orgCode:ECS.sys.Context.SYS_ENTERPRISE_CODE});uploader.settings.multipart_params.test_id=2;uploader.settings.multipart_params.test_author="Wang"}}});uploader.init();uploader.bind("FilesAdded",function(d,c){if(c[0].name.length>50){d.removeFile(c[0]);layer.msg("文件名称不能超过50个字符！");return}if(c[0].size>10485760){d.removeFile(c[0]);layer.msg("文件大小不能超过10MB！");return}$("#fileName").text("文件名："+c[0].name)});uploader.bind("UploadProgress",function(e,c){var d=c.percent;ECS.util.show_percent(d);if(d==100){ECS.util.hide_percent()}});uploader.bind("FileUploaded",function(g,e,d){var c=JSON.parse(d.response);var f="";ECS.util.hide_percent();if(c.resourceCode=="false"){layer.msg(c.message);$("#errorInfo").text("错误信息："+c.message);return}if(c.isSuccess){layer.confirm("数据效验成功，是否继续导入？",{btn:["确定","取消"]},function(){$.ajax({url:confirmUrl+"&redisKey="+c.result+"&status=true",async:false,data:{},dataType:"json",contentType:"application/json;charset=utf-8",type:"GET",success:function(h){layer.msg(h.message);b.logic.closeLayer(true)},error:function(h){layer.msg("系统繁忙")}})},function(h){$.ajax({url:confirmUrl+"&redisKey="+c.result+"&status=false",async:false,data:{},dataType:"json",contentType:"application/json;charset=utf-8",type:"GET",success:function(i){b.logic.closeLayer(true)},error:function(i){layer.msg("系统繁忙")}})})}else{layer.msg(c.message);window.parent.redisKey=c.result;b.logic.closeLayer(false)}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;window.parent.pageflag=c;parent.layer.close(a)},ExportExcel:function(e){var d=exportUrl+"?redisKey="+e;var f=$("<form>");f.attr("style","display:none");f.attr("target","");f.attr("method","get");f.attr("action",d);var c=$("<input>");c.attr("type","hidden");c.attr("name","exportData");c.attr("value",(new Date()).getMilliseconds());$("body").append(f);f.append(c);f.submit();var g=setInterval(function(){if(window.document.readyState!="loading"){try{clearTimeout(g)}catch(h){}}},3000)}}};b.init();window.page=b});