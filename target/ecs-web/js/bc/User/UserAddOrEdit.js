var addUrl=ECS.api.bcUrl+"/user";var getSingleUrl=ECS.api.bcUrl+"/user";var getOrgIdUrl=ECS.api.bcUrl+"/org/getOrgIdByCode";var postNames_url=ECS.api.bcUrl+"/user/getAllPost";var userSex_url=ECS.api.rttUrl+"/expert/getExpertSexEnumList";var userEducation_url=ECS.api.rttUrl+"/expert/getExpertEducationEnumList";var userAttribute_url=ECS.api.bcUrl+"/user/getAllUserAttribute";var userLvl_url=ECS.api.bcUrl+"/user/getAllUserLvl";var userNature_url=ECS.api.bcUrl+"/user/getAllUserNature";var porg_url=ECS.api.bcUrl+"/org/porgName";var org_url=ECS.api.bcUrl+"/org/porgNameOne";var dutyUrl=ECS.api.bcUrl+"/duty/list";var userOrgSet=[];var parentOrgID;var currentOrgId;var pageMode=PageModelEnum.NewAdd;window.pageLoadMode=PageLoadMode.None;$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-blue"});this.bindUI();ECS.sys.RefreshContextFromSYS()},bindUI:function(){$("input").blur(function(){$(this).val($.trim($(this).val()))});$("#btnSave").click(function(){b.logic.save()});$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)})},logic:{save:function(){b.logic.formValidate();if(!$("#AddOrEditModal").valid()){return}var f=ECS.form.getData("AddOrEditModal");f.userBirthday=mini.get("userBirthday").getFormValue();f.userJoinDatetime=mini.get("userJoinDatetime").getFormValue();var g="POST";if(pageMode==PageModelEnum.NewAdd){window.pageLoadMode=PageLoadMode.Reload}else{if(pageMode==PageModelEnum.Edit){g="PUT";window.pageLoadMode=PageLoadMode.Refresh}}if(mini.get("orgID").getSelectedNode()){f.userOrgSet=[{userID:$("#userID").val(),orgID:mini.get("orgID").getSelectedNode().orgId}]}else{f.userOrgSet=userOrgSet}f.userPostSet=[];if(mini.get("postID").getSelecteds().length>0){var d=mini.get("postID").getSelecteds();for(var e=0;e<d.length;e++){(function(h){var i={};i.postID=h.postID;i.userID=$("#userID").val();f.userPostSet.push(i);i=null})(d[e])}}f.dutyEntitySet=[];if(mini.get("dutyID").getSelecteds().length>0){var c=mini.get("dutyID").getSelecteds();for(var e=0;e<c.length;e++){(function(h){var i={};i.dutyID=h.dutyID;f.dutyEntitySet.push(i);i=null})(c[e])}}delete f.orgID;delete f.postID;delete f.dutyID;$.ajax({url:addUrl,async:false,type:g,dataType:"text",data:JSON.stringify(f),contentType:"application/json;charset=utf-8",success:function(h){if(h.indexOf("collection")<0){layer.msg("保存成功！",{time:1000},function(){b.logic.closeLayer(true)})}else{layer.msg(h.collection.error.message)}},error:function(h){var i=$.parseJSON(h.responseText);layer.msg(i.collection.error.message)}})},setData:function(c){$("#title-main").text(c.title);pageMode=c.pageMode;if(c.getNode>0){parentOrgID=c.getNode}else{parentOrgID=""}b.logic.load_sidebar();b.logic.select_option(userSex_url,"userSex");b.logic.select_option(userEducation_url,"userEducation");b.logic.select_option(userAttribute_url,"userAttributeID");b.logic.select_option(userLvl_url,"userLvlID");b.logic.select_option(userNature_url,"userNatureID");b.logic.selectDuty(dutyUrl+"?orgID="+currentOrgId,"dutyID");if(pageMode==PageModelEnum.NewAdd){b.logic.selectPost(postNames_url,"postID");$("#inUse").attr("disabled","disabled");$("#inUse").iCheck({checkboxClass:"icheckbox_minimal-grey"});return}$.ajax({url:getSingleUrl+"/"+c.userID+"?now="+Math.random(),type:"get",async:true,dataType:"json",success:function(d){ECS.form.setData("AddOrEditModal",d);b.logic.selectDuty(dutyUrl+"?orgID="+currentOrgId,"dutyID",d.dutyEntitySet);mini.get("userBirthday").setValue(ECS.util.timestampToTime(d.userBirthday).split("T")[0]);mini.get("userJoinDatetime").setValue(ECS.util.timestampToTime(d.userJoinDatetime).split("T")[0]);mini.get("orgID").setValue(d.orgName);b.logic.selectPost(postNames_url,"postID",d.userPostSet);$("#inUse").iCheck("update")},error:function(d){var e=$.parseJSON(d.responseText);layer.msg(e.collection.error.message)}})},selectPost:function(e,d,c){$.ajax({url:e,type:"GET",async:false,success:function(h){mini.get(d).load(h);if(c){var k="";for(var g=0;g<c.length;g++){for(var f=0;f<h.length;f++){if(h[f].postID==c[g].postID){k+=c[g].postID+","}}}mini.get(d).setValue(k)}}})},selectDuty:function(e,d,c){$.ajax({url:e,type:"GET",async:false,success:function(h){mini.get(d).load(h);if(c){var k="";for(var g=0;g<c.length;g++){for(var f=0;f<h.length;f++){if(h[f].dutyID==c[g].dutyID){k+=c[g].dutyID+","}}}mini.get(d).setValue(k)}}})},onCloseClick:function(d){var c=d.sender;c.setText("");c.setValue("")},load_sidebar:function(){var c;if(ECS.sys.isHQ(ECS.sys.Context.SYS_ENTERPRISE_CODE)){c=porg_url}else{c=org_url+"?orgCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE}$.ajax({url:c,type:"GET",async:false,success:function(d){if(d.length>0){mini.get("orgID").loadList(d,"orgId","orgPID")}}});$.ajax({url:getOrgIdUrl+"?orgCode="+ECS.sys.Context.SYS_ENTERPRISE_CODE,type:"GET",async:false,success:function(d){currentOrgId=d.orgId}})},select_option:function(d,e,c){$.ajax({url:d,type:"GET",async:false,success:function(g){if(c){mini.get("orgID").loadList(g,"orgId","orgPID");mini.get("orgID").setValue(parentOrgID);b.logic.selectDuty(dutyUrl+"?orgID="+parentOrgID,"dutyID")}else{$("#"+e).html("");for(var f=0;f<g.length;f++){(function(i){if(i.key||i.key==0){var h=$('<option value="'+i.key+'">'+i.value+"</option>")}if(e=="userAttributeID"){var h=$('<option value="'+i.UserAttributeID+'">'+i.userAttribute+"</option>")}if(e=="userLvlID"){var h=$('<option value="'+i.userLvlID+'">'+i.userLvl+"</option>")}if(i.userNatureID){var h=$('<option value="'+i.userNatureID+'">'+i.userNature+"</option>")}$("#"+e).append(h)})(g[f])}}}})},onDrawDate:function(f){var c=f.date;var g=new Date();if(c.getTime()>g.getTime()){f.allowSelect=false}},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)},formValidate:function(){jQuery.validator.addMethod("email",function(d,c,f){var e=new RegExp(f);return e.test(d)},"请输入正确的邮箱地址!");ECS.form.formValidate("AddOrEditModal",{ignore:"",rules:{userName:{required:true,rangelength:[0,200]},userUID:{required:true,rangelength:[0,200]},userCode:{rangelength:[0,200]},userIDCard:{idcard:true},userSex:{},orgID:{required:true},userMobile:{required:true,mobile:true},userPhone:{required:true,simplePhone:true},userEmail:{},userEducation:{},userAttributeID:{}}})}}};b.init();window.page=b});