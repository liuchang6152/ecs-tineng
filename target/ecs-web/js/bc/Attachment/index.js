var importUrl=ECS.api.bcUrl+"/attachment/uploadFile";var Load_list_url=ECS.api.bcUrl+"/attachment";var delUrl=ECS.api.bcUrl+"/attachment";var pageMode=PageModelEnum.Details;window.pageLoadMode=PageLoadMode.None;var mini;var uploader;var enterpriseCode="";var srcType="";var srcRef="";$(function(){var a=parent.layer.getFrameIndex(window.name);var b={init:function(){mini.parse();$(".btnClose").click(function(){window.pageLoadMode=PageLoadMode.None;b.logic.closeLayer(false)});ECS.sys.RefreshContextFromSYS();setTimeout(b.logic.loopServer,5000)},table:{},data:{param:{}},logic:{loopServer:function(){ECS.util.pingServer();setTimeout(window.page.logic.loopServer,1000)},setData:function(d){if(d){$("#title-main").text(d.title);var c=Load_list_url+"?enterpriseCode="+d.enterpriseCode+"&srcType="+d.srcType+"&srcRef="+d.srcRef;enterpriseCode=d.enterpriseCode;srcType=d.srcType;srcRef=d.srcRef;$("#title-first").html(ECS.util.ReturnTypeName(d.srcType));$("#title-second").html(d.name)}else{if(enterpriseCode&&srcType&&srcRef){var c=Load_list_url+"?enterpriseCode="+enterpriseCode+"&srcType="+srcType+"&srcRef="+srcRef}}mini.parse();grid=mini.get("datagrid");grid.set({url:c,ajaxType:"get",dataField:"pageList"});grid.load();b.logic.upload()},show_file:function(c){return'<a href="'+ECS.api.bcUrl+"/attachment/downloadFile?atchPath="+c.row.atchPath+"&atchName="+c.row.atchName+'">'+c.row.atchName+"</a>"},show_PersonAndTime:function(c){return ECS.util.DateRender(c.row.crtDate)+" by "+c.row.crtUserName},show_delbtn:function(c){return'<a href="javasript:;" class="btn btn-danger btn-sm" style="line-height:15px;height:15px;" title="删除" onclick="page.logic.delSingle('+c.row.atchID+')"><i class="icon-delete mr__5"></i> 删除</a>'},delSingle:function(d){var c=new Array();c.push(d);if(c.length==0){layer.msg("请选择要删除的数据!");return}layer.confirm("确定删除吗？",{btn:["确定","取消"]},function(){$.ajax({url:delUrl,async:false,data:JSON.stringify(c),dataType:"text",contentType:"application/json;charset=utf-8",type:"DELETE",success:function(e){if(e.indexOf("collection")<0){layer.msg("删除成功！",{time:1000},function(){grid.reload();if(uploader){uploader.destroy()}})}else{e=JSON.parse(e);layer.msg(e.collection.error.message)}},error:function(e){var f=$.parseJSON(e.responseText);layer.msg(f.collection.error.message)}})},function(e){layer.close(e)})},upload:function(){uploader=new plupload.Uploader({browse_button:"upload_btn",drop_element:"upload_box",url:importUrl,multipart_params:{enterpriseCode:enterpriseCode,srcType:srcType,srcRef:srcRef,crtUserId:ECS.sys.Context.SYS_USER_CODE,crtUserName:ECS.sys.Context.SYS_USER_NAME}});uploader.init();uploader.bind("FilesAdded",function(d,c){if(c[0].name.length>50){d.removeFile(c[0]);layer.msg("文件名称不能超过50个字符！");return}if(c[0].size>10485760){d.removeFile(c[0]);layer.msg("文件大小不能超过10MB！");return}if(d.files.length>0){d.start()}});uploader.bind("UploadProgress",function(e,c){var d=c.percent;ECS.util.show_percent(d);if(d==100){ECS.util.hide_percent()}});uploader.bind("FileUploaded",function(h,e,c){var f=JSON.parse(c.response);var g="";ECS.util.hide_percent();if(f.isSuccess){grid.reload()}else{for(var d=0;d<f.length;d++){g+="<p>"+(parseInt(d)+1)+"、"+f[d].message+"</p>"}b.logic.importDetail("上传数据错误",g,PageModelEnum.Details)}})},importDetail:function(e,c,d){layer.open({type:2,closeBtn:0,area:["800px","400px"],skin:"new-class",shadeClose:false,title:false,content:"AttachmentDataError.html?"+Math.random(),success:function(g,h){var f=layer.getChildFrame("body",h);var j=window[g.find("iframe")[0]["name"]];var i={pageMode:d,title:e,errorTip:c};j.page.logic.setData(i)},end:function(){grid.reload();window.pageLoadMode=PageLoadMode.Refresh}})},closeLayer:function(c){window.parent.pageLoadMode=window.pageLoadMode;parent.layer.close(a)}}};b.init();window.page=b});